import{b as tn,u as Dr,r as u,j as e,I as me,R as ie,d as sn,e as Rt,B as i,G as Ir,T as a,f as $,L as cs,h as ds,i as us,k as bt,l as Us,m as rn,D as ze,A as xe,M as Oe,n as Re,o as qe,p as Ct,q as kt,s as _t,F as se,t as ee,S as ye,v as U,w as q,x as Ue,y as Mt,z as K,C as wt,E as je,H as ce,J as De,K as Pr,N as vt,O as re,P as Wt,Q as nn,U as ln,V as an,W as on,X as He,Y as Yt,Z as Ie,_ as js,$ as ys,a0 as bs,a1 as Me,a2 as qt,a3 as cn,a4 as dn,a5 as un,a6 as hn,a7 as xn,a8 as mn,a9 as Bs,aa as pn,ab as gn,ac as fn,ad as Hs,ae as jn,af as Ar,ag as yn,ah as bn,ai as vn,aj as Vs,ak as Gs,al as Qs,am as Ys,an as wn,ao as Sn,ap as Cn}from"./mui-core-DTfZ_oZG.js";import{D as Er,L as kn,H as _n,a as vs,S as ws,b as zr,G as Ss,B as Or,c as Rr,A as Tr,Q as Lr,d as Ft,P as ot,E as Dn,e as In,W as Ut,f as Pn,K as An,g as be,h as pt,i as Zt,j as En,k as zn,F as On,C as Xt,l as gt,m as Rn,n as Nr,o as Tn,p as Ln,q as Ce,r as Cs,s as hs,t as mt,u as Zs,v as Dt,I as $r,w as ct,x as Js,y as Ge,z as dt,J as ks,M as _s,N as Ds,O as Ks,R as xs,T as Nn,U as Mr,V as $n,X as Mn,Y as Xs,Z as Wn,_ as qn,$ as Fn,a0 as Un,a1 as Is,a2 as Bn,a3 as Hn,a4 as Vn,a5 as Gn,a6 as Qn,a7 as Yn,a8 as Zn,a9 as Jn,aa as Kn,ab as Xn,ac as er,ad as el,ae as Wr,af as tl,ag as sl,ah as rl,ai as nl,aj as ll}from"./mui-icons-BdeMHTiq.js";import{c as il}from"./supabase-CitcseiR.js";import{N as Bt,u as Ps,a as As,R as Es,b as _e,B as al}from"./router-BZZePgjz.js";import{f as es}from"./utils-CSQe5d3I.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))l(r);new MutationObserver(r=>{for(const d of r)if(d.type==="childList")for(const o of d.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&l(o)}).observe(document,{childList:!0,subtree:!0});function s(r){const d={};return r.integrity&&(d.integrity=r.integrity),r.referrerPolicy&&(d.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?d.credentials="include":r.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function l(r){if(r.ep)return;r.ep=!0;const d=s(r);fetch(r.href,d)}})();var At={},tr;function ol(){if(tr)return At;tr=1;var n=tn();return At.createRoot=n.createRoot,At.hydrateRoot=n.hydrateRoot,At}var cl=ol();function dl(n){const{onClick:t,sx:s,...l}=n,{mode:r,setMode:d}=Dr(),[o,c]=u.useState(!1);return u.useEffect(()=>{c(!0)},[]),o?e.jsxs(me,{"data-screenshot":"toggle-mode",size:"sm",variant:"outlined",color:"neutral",...l,onClick:h=>{d(r==="light"?"dark":"light"),t?.(h)},sx:[r==="dark"?{"& > *:first-of-type":{display:"none"}}:{"& > *:first-of-type":{display:"initial"}},r==="light"?{"& > *:last-of-type":{display:"none"}}:{"& > *:last-of-type":{display:"initial"}},...Array.isArray(s)?s:[s]],children:[e.jsx(Er,{}),e.jsx(kn,{})]}):e.jsx(me,{size:"sm",variant:"outlined",color:"neutral",...l,sx:s,disabled:!0})}const qr="https://tfzvtzqybgbzxcxozdes.supabase.co",ms="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmenZ0enF5YmdienhjeG96ZGVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc4NTc2MDIsImV4cCI6MjA2MzQzMzYwMn0.hD2WdkvI8LY9N0IHP7HDQliyicQA0c-mspKjCJf0_Fc";console.log("[Supabase] URL:",qr);console.log("[Supabase] Anon Key:",ms.slice(0,6)+"..."+ms.slice(-6));const N=il(qr,ms);N.auth.onAuthStateChange((n,t)=>{console.log("[Auth State Change]",n,t),n==="SIGNED_IN"?console.log("User signed in:",t?.user):n==="SIGNED_OUT"&&console.log("User signed out")});let ts=!1;N.auth.onAuthStateChange((n,t)=>{ts||(ts=!0,console.log("[Auth State Change]",n,t),n==="SIGNED_IN"?console.log("User signed in:",t?.user):n==="SIGNED_OUT"&&(console.log("User signed out"),window.location.pathname!=="/login"&&(window.location.href="/login")),ts=!1)});const zs=n=>t=>{const[s,l]=ie.useState(null),[r,d]=ie.useState(!0);return ie.useEffect(()=>{async function o(){const{data:c}=await N.auth.getSession();l(c?.session||null),d(!1)}o()},[]),r?e.jsx("div",{children:"Loading..."}):s?e.jsx(n,{...t}):e.jsx(Bt,{to:"/login",replace:!0})},ul=[{label:"Home",icon:ie.createElement(_n),value:"home",route:"/",showInMobile:!0},{label:"Dashboard",icon:ie.createElement(vs),value:"dashboard",route:"/dashboard",showInMobile:!0},{label:"Orders",icon:ie.createElement(ws),value:"orders",route:"/orders",showInMobile:!0},{label:"Products",icon:ie.createElement(zr),value:"products",route:"/products",showInMobile:!0},{label:"Customers",icon:ie.createElement(Ss),value:"customers",route:"/customers",showInMobile:!0},{label:"Employees",icon:ie.createElement(Or),value:"employees",route:"/employees",showInMobile:!0},{label:"Suppliers",icon:ie.createElement(Rr),value:"suppliers",route:"/suppliers",showInMobile:!0},{label:"Purchase Orders",icon:ie.createElement(Tr),value:"purchaseorders",route:"/purchase-orders",showInMobile:!0},{label:"Tickets",icon:ie.createElement(Lr),value:"tickets",route:"/tickets",showInMobile:!0},{label:"SMS Campaigns",icon:ie.createElement(Ft),value:"smscampaigns",route:"/sms-campaigns",showInMobile:!0},{label:"Movements",icon:ie.createElement(Ft),value:"movements",route:"/movements",showInMobile:!0},{label:"My Profile",icon:ie.createElement(ot),value:"profile",route:"/settings",showInMobile:!0}],Tt={Sales:[{label:"Dashboard",icon:ie.createElement(vs),value:"dashboard",route:"/dashboard",showInMobile:!0},{label:"Orders",icon:ie.createElement(ws),value:"orders",route:"/orders",showInMobile:!0},{label:"Storefronts",icon:ie.createElement(Ut),value:"storefronts",route:"/storefronts",showInMobile:!0},{label:"Customers",icon:ie.createElement(Ss),value:"customers",route:"/customers",showInMobile:!0}],Support:[{label:"Tickets",icon:ie.createElement(Lr),value:"tickets",route:"/tickets",showInMobile:!0}],Marketing:[{label:"Products",icon:ie.createElement(zr),value:"products",route:"/products",showInMobile:!0},{label:"SMS Campaigns",icon:ie.createElement(Ft),value:"smscampaigns",route:"/sms-campaigns",showInMobile:!0}],Operations:[{label:"Suppliers",icon:ie.createElement(Rr),value:"suppliers",route:"/suppliers",showInMobile:!0},{label:"Purchase Orders",icon:ie.createElement(Tr),value:"purchaseorders",route:"/purchase-orders",showInMobile:!0},{label:"Movements",icon:ie.createElement(Ft),value:"movements",route:"/movements",showInMobile:!0}],Administration:[{label:"Employees",icon:ie.createElement(Or),value:"employees",route:"/employees",showInMobile:!0},{label:"Modules",icon:ie.createElement(Dn),value:"emailsettings",route:"/email-settings",showInMobile:!0},{label:"Functions",icon:ie.createElement(In),value:"functions",route:"/functions",showInMobile:!0},{label:"My Profile",icon:ie.createElement(ot),value:"profile",route:"/settings",showInMobile:!0}]};function Pe(){const n=sn(),t=Rt("(max-width:600px)"),s=Rt("(min-width:601px) and (max-width:1024px)"),l=Rt("(min-width:1025px)");return{isMobile:t,isTablet:s,isDesktop:l,isSmallScreen:t,isMediumScreen:s,isLargeScreen:l,breakpoints:{mobile:"600px",tablet:"1024px",desktop:"1025px"},theme:n}}function Fr(){const{isMobile:n,isTablet:t}=Pe();return{containerPadding:n?1:t?2:3,sectionPadding:n?2:t?3:4,itemPadding:n?1:2,smallGap:n?1:2,mediumGap:n?2:3,largeGap:n?3:4,sectionMargin:n?2:3,itemMargin:n?1:2}}function hl(){const{isMobile:n}=Pe();return{getModalSize:(s="medium")=>n?{width:"95vw",height:s==="fullscreen"?"95vh":"auto",maxHeight:"90vh",margin:1}:{small:{width:400,maxWidth:"90vw"},medium:{width:600,maxWidth:"90vw"},large:{width:800,maxWidth:"90vw"},fullscreen:{width:"90vw",height:"90vh"}}[s]}}function xl({setView:n,view:t}){const s=Ps(),l=As(),{isMobile:r,isTablet:d,isDesktop:o}=Pe(),[c,h]=u.useState(!1),[m,b]=u.useState([]),[f,y]=u.useState(null),[S,g]=u.useState(null);u.useEffect(()=>{async function p(){const{data:v,error:W}=await N.from("users").select("*");!W&&v&&b(v)}p();async function _(v){if(y(v),v){let{data:W}=await N.from("users").select("*").eq("id",v.id).single();W||(await N.from("users").upsert({id:v.id,email:v.email,name:v.user_metadata?.full_name||null,avatar_url:v.user_metadata?.avatar_url||null,role:"employee"}),W={...v,role:"employee"}),g(W)}else g(null)}N.auth.getUser().then(({data:v})=>_(v.user));const{data:B}=N.auth.onAuthStateChange((v,W)=>{_(W?.user??null)});return()=>{B?.subscription.unsubscribe()}},[]),u.useEffect(()=>{d&&h(!0)},[d,o]);const C=p=>{s(p.route),n(p.value),d&&h(!0)},w=()=>{h(!c)},E=(p,_)=>{C({value:_,route:p})},k=p=>l.pathname===p;return e.jsxs(i,{className:"Sidebar",sx:{display:r?"none":"flex",position:{xs:"fixed",md:"sticky"},transform:{xs:"translateX(calc(100% * (var(--SideNavigation-slideIn, 0) - 1)))",md:"none"},transition:"transform 0.4s, width 0.4s",zIndex:1e4,height:"100vh",maxHeight:"100vh",minHeight:"100vh",width:"var(--Sidebar-width)",top:0,p:2,flexShrink:0,flexDirection:"column",gap:2,borderRight:"1px solid",borderColor:"divider",background:"var(--joy-palette-background-surface, #fff)",overflow:"hidden",boxSizing:"border-box"},children:[e.jsx(Ir,{styles:p=>({":root":{"--Sidebar-width":c?"60px":"220px",[p.breakpoints.up("lg")]:{"--Sidebar-width":c?"60px":"240px"}}})}),e.jsx(i,{className:"Sidebar-overlay",sx:{position:"fixed",zIndex:9998,top:0,left:0,width:"100vw",height:"100vh",opacity:"var(--SideNavigation-slideIn)",backgroundColor:"var(--joy-palette-background-backdrop)",transition:"opacity 0.4s",transform:{xs:"translateX(calc(100% * (var(--SideNavigation-slideIn, 0) - 1) + var(--SideNavigation-slideIn, 0) * var(--Sidebar-width, 0px)))",lg:"translateX(-100%)"}}}),e.jsxs(i,{sx:{display:"flex",gap:1,alignItems:"center",flexShrink:0},children:[e.jsx(me,{size:"sm",variant:"plain",onClick:w,sx:{p:.5,borderRadius:1,"&:hover":{bgcolor:"neutral.100"}},children:e.jsx("img",{src:"/favicon.svg",alt:"Logo",style:{width:28,height:28,borderRadius:6}})}),!c&&e.jsxs(e.Fragment,{children:[e.jsx(a,{level:"title-lg",children:"Smartbuy"}),e.jsx(dl,{sx:{ml:"auto"}})]})]}),!c&&e.jsx(i,{sx:{flexShrink:0},children:e.jsx($,{size:"sm",startDecorator:e.jsx(Pn,{}),placeholder:"Search"})}),e.jsx(i,{sx:{minHeight:0,overflowY:"auto",overflowX:"hidden",flex:"1 1 auto",display:"flex",flexDirection:"column",[`& .${rn.root}`]:{gap:1.5}},children:e.jsx(cs,{size:"sm",sx:{gap:1,"--List-nestedInsetStart":"30px","--ListItem-radius":p=>p.vars.radius.sm},children:["Sales","Support","Operations","Marketing","Administration"].map(p=>e.jsx(ds,{nested:!0,children:e.jsx(ml,{defaultExpanded:!c,renderToggle:({open:_,setOpen:B})=>c?e.jsx(us,{title:p,placement:"right",arrow:!0,children:e.jsx(bt,{onClick:()=>B(!_),children:Tt[p][0]?.icon})}):e.jsxs(bt,{onClick:()=>B(!_),children:[Tt[p][0]?.icon,e.jsx(Us,{children:e.jsx(a,{level:"title-sm",children:p})}),e.jsx(An,{sx:[_?{transform:"rotate(180deg)"}:{transform:"none"}]})]}),children:e.jsx(cs,{sx:{gap:.5},children:Tt[p].map(_=>e.jsx(ds,{children:c?e.jsx(us,{title:_.label,placement:"right",arrow:!0,children:e.jsx(bt,{selected:k(_.route),onClick:()=>E(_.route,_.value),sx:{justifyContent:"center",px:1,width:"100%"},children:_.icon})}):e.jsxs(bt,{selected:k(_.route),onClick:()=>E(_.route,_.value),sx:{justifyContent:"flex-start",px:2,width:"100%"},children:[_.icon,e.jsx(Us,{children:e.jsx(a,{level:"body-sm",children:_.label})})]})},_.value))})})},p))})}),e.jsx(i,{sx:{flexShrink:0}}),e.jsx(ze,{sx:{flexShrink:0}}),e.jsxs(i,{sx:{display:"flex",gap:1,alignItems:"center",minHeight:48,flexShrink:0,cursor:"pointer",borderRadius:"sm","&:hover":{bgcolor:"neutral.50"}},onClick:()=>E("/settings","settings"),children:[e.jsx(xe,{variant:"outlined",size:"sm",src:S?.avatar_url||f?.user_metadata?.avatar_url||void 0,children:!S?.avatar_url&&!f?.user_metadata?.avatar_url&&(S?.first_name||S?.last_name?`${S.first_name?.[0]||""}${S.last_name?.[0]||""}`.toUpperCase():f?.user_metadata?.full_name?f.user_metadata.full_name.split(" ").map(p=>p[0]).slice(0,2).join("").toUpperCase():f?.email?f.email.substring(0,2).toUpperCase():"U")}),!c&&e.jsxs(i,{sx:{minWidth:0,flex:1},children:[e.jsx(a,{level:"title-sm",children:S?.first_name||S?.last_name?`${S.first_name||""} ${S.last_name||""}`.trim():f?.user_metadata?.full_name||f?.email||"Not signed in"}),e.jsx(a,{level:"body-xs",children:f?.email||""})]})]})]})}function ml({defaultExpanded:n=!1,renderToggle:t,children:s}){const[l,r]=u.useState(n);return e.jsxs(u.Fragment,{children:[t({open:l,setOpen:r}),e.jsx(i,{sx:{display:"grid",transition:"0.2s ease","& > *":{overflow:"hidden"},gridTemplateRows:l?"1fr":"0fr"},children:s})]})}const pl=zs(xl);function ke({children:n,variant:t="page",padding:s="medium",fullHeight:l=!1,className:r}){const{isMobile:d}=Pe(),o=Fr(),c=()=>s==="none"?0:{small:o.itemPadding,medium:o.containerPadding,large:o.sectionPadding}[s]||o.containerPadding,h=()=>{const m={p:c(),boxSizing:"border-box"};switch(t){case"page":return{...m,height:l?"100%":"auto",overflow:"auto",width:"100%"};case"dialog":return{...m,height:"auto",overflow:"visible"};case"form":return{...m,display:"flex",flexDirection:"column",gap:o.mediumGap};case"card":return{...m,borderRadius:1,bgcolor:"background.surface"};case"table-page":return{width:"100%",overflow:"visible",pt:d?1:2,pl:d?1:2,pr:d?1:2,pb:d?1:2,boxSizing:"border-box"};default:return m}};return e.jsx(i,{sx:h(),className:r,children:n})}function Ht({open:n,onClose:t,children:s,title:l,size:r="medium",showCloseButton:d=!0,actions:o}){const{getModalSize:c}=hl();return e.jsx(Oe,{open:n,onClose:t,children:e.jsxs(Re,{sx:c(r),children:[d&&e.jsx(qe,{}),l&&e.jsx(Ct,{children:l}),e.jsx(kt,{children:s}),o&&e.jsx(_t,{children:o})]})})}const Fe=({children:n})=>e.jsx(i,{sx:{display:"flex",flexDirection:"column",width:"100%",flex:1,bgcolor:"background.body"},children:n}),Je={currency:"DKK",locale:"da-DK",symbol:"kr"};function We(n){if(n==null||isNaN(n))return"0 kr";const t=n%1!==0;return new Intl.NumberFormat(Je.locale,{style:"currency",currency:Je.currency,minimumFractionDigits:t?2:0,maximumFractionDigits:2}).format(n)}function fe(n,t=!0){if(n==null||isNaN(n))return t?"0 kr":"kr 0";const s=n%1!==0,l=new Intl.NumberFormat(Je.locale,{minimumFractionDigits:s?2:0,maximumFractionDigits:2}).format(n);return t?`${l} kr`:`kr ${l}`}function sr(n){return{...n,salesprice_currency:Je.currency,salesprice_exchrate:1,costprice_currency:Je.currency,costprice_exchrate:1}}function gl(n){return{...n,unit_price_currency:Je.currency,unit_price_exchrate:1}}var rr={};const Lt={baseUrl:typeof window<"u"?window.location.origin:rr.VERCEL_URL?`https://${rr.VERCEL_URL}`:"http://localhost:3000",timeout:3e4,retry:{attempts:3,delay:1e3}},fl=n=>`${Lt.baseUrl}${n}`;class jl{async makeRequest(t,s={}){const{method:l="GET",body:r,headers:d={},timeout:o=Lt.timeout,retries:c=Lt.retry.attempts}=s,h=fl(t),m={"Content-Type":"application/json",...d};let b=null;for(let f=1;f<=c;f++)try{console.log(`🔄 API Request [Attempt ${f}]: ${l} ${h}`);const y=new AbortController,S=setTimeout(()=>y.abort(),o),g=await fetch(h,{method:l,headers:m,body:r?JSON.stringify(r):void 0,signal:y.signal});return clearTimeout(S),console.log(`📡 API Response: ${g.status} ${g.statusText}`),g.ok?{success:!0,data:await g.json(),statusCode:g.status}:{success:!1,error:await g.text()||`HTTP ${g.status}: ${g.statusText}`,statusCode:g.status}}catch(y){b=y,console.warn(`⚠️ API Request failed (attempt ${f}/${c}):`,y),f<c&&await new Promise(S=>setTimeout(S,Lt.retry.delay*f))}return{success:!1,error:`Request failed after ${c} attempts: ${b?.message}`,statusCode:0}}async sendOrderConfirmation(t,s,l){return this.makeRequest("/api/send-order-confirmation",{method:"POST",body:{orderUuid:t,testEmail:s,storefrontId:l}})}async sendSMSCampaign(t){return this.makeRequest("/api/send-sms-campaign",{method:"POST",body:t})}async request(t,s){return this.makeRequest(t,s)}async healthCheck(){return this.makeRequest("/api/health",{method:"GET"})}}const xt=new jl;async function Ur(n,t){try{const s=await xt.sendOrderConfirmation(n,void 0,t);if(!s.success){if(s.statusCode===404){console.warn('Email API not available. To test email functionality, run with "vercel dev" instead of "npm run dev".');return}throw new Error(s.error||`API error! status: ${s.statusCode}`)}}catch(s){if(s.message.includes("fetch")||s.name==="TypeError"){console.warn('Email API not available. To test email functionality, run with "vercel dev" instead of "npm run dev".');return}throw s}}async function yl(n,t=!0){try{const{data:s,error:l}=await N.from("Orders").insert({customer_name:n.customer_name,customer_email:n.customer_email,storefront_id:n.storefront_id||null,discount:n.discount||0,status:"Draft",date:new Date().toISOString()}).select().single();if(l)return console.error("Error creating order:",l),{success:!1,error:l.message};const r=s.uuid,d=n.orderItems.map(h=>({order_uuid:r,product_uuid:h.product_uuid,quantity:h.quantity,unitprice:h.unitprice,discount:h.discount||0})),{error:o}=await N.from("OrderItems").insert(d);if(o)return console.error("Error creating order items:",o),await N.from("Orders").delete().eq("uuid",r),{success:!1,error:o.message};const c={success:!0,order:{uuid:r,order_number_display:s.order_number_display||`Order #${s.order_number}`}};if(t&&n.customer_email)try{await Ur(r,n.storefront_id)}catch(h){console.warn("Failed to send confirmation email:",h)}return c}catch(s){return console.error("Error in createOrderWithItems:",s),{success:!1,error:s.message}}}async function bl(n,t){try{const{data:s,error:l}=await N.from("Orders").select("*").eq("uuid",n).single();if(l||!s)return{success:!1,error:"Order not found"};const r={status:"Paid"};t?.name&&(r.customer_name=t.name),t?.email&&(r.customer_email=t.email);const{error:d}=await N.from("Orders").update(r).eq("uuid",n);if(d)return{success:!1,error:d.message};const{data:o,error:c}=await N.from("OrderItems").select("product_uuid, quantity").eq("order_uuid",n);if(!c&&o&&o.length>0){const m=o.filter(b=>b.product_uuid).map(b=>({product_id:b.product_uuid,movement_type:"outgoing",quantity:b.quantity,date:new Date().toISOString(),reason:"Order Fulfillment",referenceuuid:n}));if(m.length>0){const{error:b}=await N.from("stock_movements").insert(m);b&&console.warn("Failed to create stock movements:",b)}}if(t?.email||s.customer_email)try{await Ur(n,s.storefront_id)}catch(m){console.warn("Failed to send confirmation email:",m)}return{success:!0}}catch(s){return console.error("Error completing order:",s),{success:!1,error:s.message}}}function vl({open:n,onClose:t,order:s,mode:l="add",onSaved:r,fetchOrderItems:d}){const[o,c]=u.useState(""),[h,m]=u.useState(new Date().toISOString().slice(0,10)),[b,f]=u.useState("Draft"),[y,S]=u.useState(""),[g,C]=u.useState(""),[w,E]=u.useState(""),[k,p]=u.useState("0"),[_,B]=u.useState(0),[v,W]=u.useState(""),[j,P]=u.useState([{id:crypto.randomUUID(),product:null,quantity:1,unitprice:0,discount:0}]),[T,F]=u.useState([]),[Q,x]=u.useState([]),[O,V]=u.useState(!1),[z,A]=u.useState([]),[H,ae]=u.useState(!1),[he,oe]=u.useState(!1),[X,de]=u.useState(!1),[Y,ne]=u.useState(null),[L,J]=u.useState(null);u.useEffect(()=>{n&&s?(c(s.order_number||""),m(s.date||new Date().toISOString().slice(0,10)),f(s.status||"Draft"),C(s.customer_name||""),E(s.customer_email||""),p(s.total?String(s.total):"0"),B(s.discount||0),W(s.notes||""),S(s.storefront_id||"")):n&&l==="add"&&(c(ve()),m(new Date().toISOString().slice(0,10)),f("Draft"),C(""),E(""),p("0"),B(0),W(""),S(""),P([{id:crypto.randomUUID(),product:null,quantity:1,unitprice:0,discount:0}])),ne(null)},[n,s,l]),u.useEffect(()=>{n&&(l==="edit"||l==="view")&&s?.uuid&&d&&(de(!0),d(s.uuid).then(D=>{F(D)}).catch(D=>{console.error("Error loading order items:",D),ne("Failed to load order items")}).finally(()=>de(!1)))},[n,l,s,d]),u.useEffect(()=>{n&&(ae(!0),(async()=>{try{const{data:G,error:te}=await N.from("storefronts").select("id, name, is_online");console.log("All storefronts in database:",G);const{data:Se,error:Be}=await N.from("storefronts").select("id, name, is_online").eq("is_online",!0).order("name",{ascending:!0});console.log("Storefronts loaded:",Se,"Error:",Be),!Be&&Se?A(Se):console.error("Error loading storefronts:",Be)}catch(G){console.error("Error loading storefronts:",G)}finally{ae(!1)}})())},[n]),u.useEffect(()=>{n&&(l==="add"||l==="edit")&&(V(!0),J(null),N.from("Products").select("*").then(({data:D,error:G})=>{!G&&D?(D.length===0&&J("No products available. Please add products first."),x(D.map(te=>({id:te.uuid||te.id,ProductName:te.ProductName,SalesPrice:te.SalesPrice??0})))):J("Failed to load products. Please try again later."),V(!1)}))},[n,l]);const ve=()=>{const D=new Date().toISOString().slice(0,10).replace(/-/g,""),G=Math.floor(1e3+Math.random()*9e3);return`ORD-${D}-${G}`},we=()=>j.reduce((D,G)=>{const te=G.quantity*G.unitprice,Se=te*(G.discount/100);return D+(te-Se)},0);u.useEffect(()=>{if(l==="add"||l==="edit"){const D=we(),G=D-D*(_/100);p(G.toFixed(2))}},[j,_,l]);const $e=()=>{P([...j,{id:crypto.randomUUID(),product:null,quantity:1,unitprice:0,discount:0}])},Ke=D=>{j.length>1&&P(j.filter(G=>G.id!==D))},M=(D,G,te)=>{P(j.map(Se=>Se.id===D?{...Se,[G]:te}:Se))},ue=(D,G)=>{P(j.map(te=>te.id===D?{...te,product:G,unitprice:G?.SalesPrice||0}:te))},R=async()=>{if(!g.trim()||!w.trim()){ne("Customer name and email are required");return}if(l==="add"&&j.filter(G=>G.product&&G.quantity>0).length===0){ne("Please add at least one valid order item");return}oe(!0),ne(null);try{if(l==="edit"&&s?.id){const D={order_number:o,date:h,status:b,customer_name:g.trim(),customer_email:w.trim(),discount:_,storefront_id:y||null},{error:G}=await N.from("Orders").update(D).eq("id",s.id);if(G)throw G}else if(l==="add"){const D=j.filter(Se=>Se.product&&Se.quantity>0),G={customer_name:g.trim(),customer_email:w.trim(),storefront_id:y||void 0,discount:_,orderItems:D.map(Se=>({product_uuid:Se.product.id,quantity:Se.quantity,unitprice:Se.unitprice,discount:Se.discount}))},te=await yl(G,!0);if(!te.success)throw new Error(te.error||"Failed to create order")}r&&r(),t()}catch(D){console.error("Error saving order:",D),ne(D.message||"Failed to save order")}finally{oe(!1)}},Z=l==="view",I=l==="view";return e.jsx(Oe,{open:n,onClose:t,children:e.jsxs(Re,{sx:{maxWidth:1200,width:"100%",maxHeight:"90vh",overflow:"auto"},children:[e.jsx(qe,{}),e.jsx(a,{level:"title-lg",sx:{mb:2},children:l==="add"?"Create Order":l==="edit"?"Edit Order":"Order Details"}),e.jsxs(i,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",md:"1fr 1fr"},gap:3,minHeight:"400px"},children:[e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:3},children:[e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(a,{level:"title-sm",children:"Order Information"}),l==="edit"&&e.jsxs(se,{children:[e.jsx(ee,{children:"Order Number"}),e.jsx($,{value:o,onChange:D=>c(D.target.value),disabled:Z,placeholder:"Auto-generated"})]}),e.jsxs(se,{children:[e.jsx(ee,{children:"Date"}),e.jsx($,{type:"date",value:h,onChange:D=>m(D.target.value),disabled:Z})]}),e.jsxs(se,{children:[e.jsx(ee,{children:"Status"}),e.jsxs(ye,{value:b,onChange:(D,G)=>f(G),disabled:Z,children:[e.jsx(U,{value:"Draft",children:"Draft"}),e.jsx(U,{value:"Paid",children:"Paid"}),e.jsx(U,{value:"Refunded",children:"Refunded"}),e.jsx(U,{value:"Cancelled",children:"Cancelled"})]})]})]}),e.jsx(ze,{}),e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(a,{level:"title-sm",children:"Customer Information"}),e.jsxs(se,{children:[e.jsx(ee,{children:"Customer Name"}),e.jsx($,{value:g,onChange:D=>C(D.target.value),disabled:Z,placeholder:"Customer name",required:!0})]}),e.jsxs(se,{children:[e.jsx(ee,{children:"Customer Email"}),e.jsx($,{type:"email",value:w,onChange:D=>E(D.target.value),disabled:Z,placeholder:"customer@example.com",required:!0})]}),e.jsxs(se,{children:[e.jsx(ee,{children:"Storefront"}),e.jsxs(ye,{value:y,onChange:(D,G)=>S(G||""),disabled:Z||H,placeholder:"Select a storefront (optional)",children:[e.jsx(U,{value:"",children:"No specific storefront"}),z.map(D=>e.jsx(U,{value:D.id,children:D.name},D.id))]})]})]}),e.jsx(ze,{}),e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(a,{level:"title-sm",children:"Order Summary"}),e.jsxs(se,{children:[e.jsx(ee,{children:"Order Discount (%)"}),e.jsx($,{type:"number",value:_,onChange:D=>B(parseFloat(D.target.value)||0),disabled:Z,slotProps:{input:{min:0,max:100,step:.01}}})]}),e.jsxs(se,{children:[e.jsx(ee,{children:"Total Amount"}),e.jsx($,{value:fe(parseFloat(k)),disabled:!0,sx:{fontWeight:"bold"}})]}),e.jsxs(se,{children:[e.jsx(ee,{children:"Notes"}),e.jsx($,{value:v,onChange:D=>W(D.target.value),disabled:Z,placeholder:"Order notes (optional)"})]})]})]}),e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(a,{level:"title-sm",children:I?"Ordered Items":"Order Items"}),!Z&&e.jsx(q,{startDecorator:e.jsx(be,{}),onClick:$e,size:"sm",variant:"outlined",children:"Add Item"})]}),I?X?e.jsx(a,{children:"Loading items..."}):e.jsxs(Ue,{size:"sm",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Product"}),e.jsx("th",{style:{textAlign:"right"},children:"Qty"}),e.jsx("th",{style:{textAlign:"right"},children:"Price"}),e.jsx("th",{style:{textAlign:"right"},children:"Disc %"}),e.jsx("th",{style:{textAlign:"right"},children:"Total"})]})}),e.jsx("tbody",{children:T.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,style:{textAlign:"center",padding:"16px"},children:e.jsx(a,{level:"body-sm",color:"neutral",children:"No items found for this order."})})}):T.map((D,G)=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx(a,{level:"body-sm",sx:{fontWeight:"bold"},children:D.ProductName||D.name||D.product_uuid})}),e.jsx("td",{style:{textAlign:"right"},children:e.jsx(a,{level:"body-sm",children:D.quantity})}),e.jsx("td",{style:{textAlign:"right"},children:e.jsx(a,{level:"body-sm",children:typeof D.unitprice=="number"||typeof D.unitprice=="string"?fe(Number(D.unitprice)):"-"})}),e.jsx("td",{style:{textAlign:"right"},children:e.jsx(a,{level:"body-sm",children:typeof D.discount=="number"||typeof D.discount=="string"?`${Number(D.discount).toFixed(1)}%`:"-"})}),e.jsx("td",{style:{textAlign:"right"},children:e.jsx(a,{level:"body-sm",sx:{fontWeight:"bold"},children:typeof D.price=="number"||typeof D.price=="string"?fe(Number(D.price)):"-"})})]},D.id||D.uuid||G))})]}):e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:2},children:[L&&e.jsx(a,{color:"warning",level:"body-sm",children:L}),e.jsx(i,{sx:{display:"flex",flexDirection:"column",gap:1,maxHeight:"400px",overflowY:"auto"},children:j.map(D=>e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:1,p:2,border:"1px solid",borderColor:"divider",borderRadius:"sm",bgcolor:"background.surface"},children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(a,{level:"body-sm",sx:{fontWeight:"bold"},children:["Item ",j.indexOf(D)+1]}),e.jsx(me,{onClick:()=>Ke(D.id),disabled:j.length===1,color:"danger",size:"sm",children:e.jsx(pt,{})})]}),e.jsx(Mt,{placeholder:"Select product",options:Q,getOptionLabel:G=>G.ProductName,value:D.product,onChange:(G,te)=>ue(D.id,te),loading:O,size:"sm"}),e.jsxs(i,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:1},children:[e.jsxs(i,{children:[e.jsx(ee,{sx:{fontSize:"xs"},children:"Quantity"}),e.jsx($,{type:"number",value:D.quantity,onChange:G=>M(D.id,"quantity",parseInt(G.target.value)||0),size:"sm",slotProps:{input:{min:1}}})]}),e.jsxs(i,{children:[e.jsx(ee,{sx:{fontSize:"xs"},children:"Unit Price"}),e.jsx($,{type:"number",value:D.unitprice,onChange:G=>M(D.id,"unitprice",parseFloat(G.target.value)||0),size:"sm",slotProps:{input:{min:0,step:.01}}})]}),e.jsxs(i,{children:[e.jsx(ee,{sx:{fontSize:"xs"},children:"Discount %"}),e.jsx($,{type:"number",value:D.discount,onChange:G=>M(D.id,"discount",parseFloat(G.target.value)||0),size:"sm",slotProps:{input:{min:0,max:100,step:.01}}})]})]}),D.product&&D.quantity>0&&e.jsx(i,{sx:{textAlign:"right",pt:1,borderTop:"1px solid",borderColor:"divider"},children:e.jsxs(a,{level:"body-sm",sx:{fontWeight:"bold"},children:["Item Total: ",fe(D.quantity*D.unitprice*(1-D.discount/100))]})})]},D.id))})]})]})]}),Y&&e.jsx(i,{sx:{mt:2},children:e.jsx(a,{color:"danger",level:"body-sm",children:Y})}),e.jsxs(i,{sx:{display:"flex",gap:2,justifyContent:"flex-end",mt:3,pt:2,borderTop:"1px solid",borderColor:"divider"},children:[e.jsx(q,{variant:"plain",onClick:t,disabled:he,children:Z?"Close":"Cancel"}),s&&s.status==="Paid"&&s.customer_email&&e.jsx(q,{variant:"outlined",color:"primary",onClick:async()=>{try{const D=await xt.sendOrderConfirmation(s.uuid,void 0,y);D.success?alert("Confirmation email sent successfully!"):D.statusCode===404?window.confirm(`Email API not available in development mode.

To test email functionality:
1. Run: node send-order-email.js ${s.order_number}
2. Or run: node test-email.js

Click OK to continue, or Cancel to skip.`)&&alert(`Run this command in terminal:
node send-order-email.js ${s.order_number}`):alert("Failed to send email: "+D.error)}catch{window.confirm(`Network error - likely in development mode.

To test email functionality:
1. Run: node send-order-email.js ${s.order_number}
2. Or run: node test-email.js

Click OK to continue, or Cancel to skip.`)&&alert(`Run this command in terminal:
node send-order-email.js ${s.order_number}`)}},disabled:he,children:"Resend Email"}),!Z&&e.jsx(q,{onClick:R,loading:he,disabled:!g.trim()||!w.trim(),children:l==="edit"?"Update Order":"Create Order"})]})]})})}function wl({customerInfo:n,onChange:t,onLogin:s}){const l=d=>o=>{t({...n,[d]:o.target.value})},r=()=>{s?s():console.log("Login functionality not available in this app")};return e.jsx(i,{sx:{width:"100%"},children:e.jsxs(K,{spacing:3,sx:{width:"100%"},children:[e.jsxs(i,{sx:{textAlign:"center"},children:[e.jsx(a,{level:"body-sm",color:"neutral",sx:{mb:2},children:"Already have an account? Sign in to auto-fill your information"}),e.jsx(q,{variant:"outlined",startDecorator:e.jsx(Zt,{}),onClick:r,disabled:!s,sx:{minWidth:150},children:"Login"})]}),e.jsx(ze,{sx:{my:1},children:e.jsx(a,{level:"body-xs",color:"neutral",children:"or continue as guest"})}),e.jsxs(i,{children:[e.jsx(a,{level:"h4",sx:{mb:3},children:"Contact"}),e.jsxs(K,{spacing:2,children:[e.jsxs(se,{required:!0,children:[e.jsx(ee,{children:"Email *"}),e.jsx($,{type:"email",value:n.email,onChange:l("email"),placeholder:"Enter email",variant:"outlined"})]}),e.jsxs(se,{children:[e.jsx(ee,{children:"Phone Number *"}),e.jsx($,{value:n.phone||"",onChange:l("phone"),placeholder:"Enter phone number",variant:"outlined"})]}),e.jsx(wt,{checked:n.newsletter||!1,onChange:d=>t({...n,newsletter:d.target.checked}),label:"I would like to receive newsletters",sx:{mt:1}})]})]}),e.jsxs(i,{children:[e.jsx(a,{level:"h4",sx:{mb:3},children:"Address"}),e.jsxs(K,{spacing:2,children:[e.jsxs(je,{container:!0,spacing:2,sx:{width:"100%",m:0},children:[e.jsx(je,{xs:12,md:6,children:e.jsxs(se,{required:!0,children:[e.jsx(ee,{children:"First Name *"}),e.jsx($,{value:n.firstName||"",onChange:l("firstName"),placeholder:"Enter first name",variant:"outlined"})]})}),e.jsx(je,{xs:12,md:6,children:e.jsxs(se,{required:!0,children:[e.jsx(ee,{children:"Last Name *"}),e.jsx($,{value:n.lastName||"",onChange:l("lastName"),placeholder:"Enter last name",variant:"outlined"})]})})]}),e.jsx(je,{container:!0,spacing:2,sx:{width:"100%",m:0},children:e.jsx(je,{xs:12,children:e.jsxs(se,{required:!0,children:[e.jsx(ee,{children:"Address*"}),e.jsx($,{value:n.address||"",onChange:l("address"),placeholder:"Enter address and house number",variant:"outlined"})]})})}),e.jsxs(je,{container:!0,spacing:2,sx:{width:"100%",m:0},children:[e.jsx(je,{xs:12,md:4,children:e.jsxs(se,{required:!0,children:[e.jsx(ee,{children:"Postal Code *"}),e.jsx($,{value:n.postalCode||"",onChange:l("postalCode"),placeholder:"Enter postal code",variant:"outlined"})]})}),e.jsx(je,{xs:12,md:8,children:e.jsxs(se,{required:!0,children:[e.jsx(ee,{children:"City *"}),e.jsx($,{value:n.city||"",onChange:l("city"),placeholder:"Enter city",variant:"outlined"})]})})]}),e.jsxs(se,{children:[e.jsx(ee,{children:"Reference"}),e.jsx($,{value:n.reference||"",onChange:l("reference"),placeholder:"Reference/employee number",variant:"outlined"})]}),e.jsxs(K,{spacing:1,sx:{mt:2},children:[e.jsx(wt,{label:"Log me in so I can easily shop again",sx:{fontSize:"sm"}}),e.jsx(wt,{label:"The addess is not my home address",sx:{fontSize:"sm"}})]})]})]})]})})}const nr=[{value:"standard",label:"Standard Delivery",description:"5-7 business days",cost:99,icon:e.jsx(En,{})},{value:"express",label:"Express Delivery",description:"2-3 business days",cost:199,icon:e.jsx(zn,{})},{value:"overnight",label:"Overnight Delivery",description:"Next business day",cost:349,icon:e.jsx(On,{})}];function Sl({deliveryInfo:n,onChange:t,subtotal:s=0}){const r=s>=1e3,d=(c,h)=>h==="standard"&&r?0:c,o=c=>{const h=nr.find(b=>b.value===c),m=d(h?.cost||0,c);t({...n,method:c,cost:m,estimatedDays:c==="overnight"?1:c==="express"?3:6})};return e.jsx(ce,{variant:"outlined",children:e.jsxs(De,{children:[e.jsx(a,{level:"h4",sx:{mb:2},children:"Delivery Method"}),(()=>{const c=Math.max(0,1e3-s),h=Math.min(100,s/1e3*100);return s<1e3?e.jsxs(i,{sx:{mb:3,p:2,backgroundColor:"neutral.50",borderRadius:"sm"},children:[e.jsxs(a,{level:"body-sm",sx:{mb:1,fontWeight:600},children:["🚚 Spend ",fe(c)," more for free standard shipping"]}),e.jsx(i,{sx:{position:"relative",width:"100%",height:8,backgroundColor:"#e5e5e5",borderRadius:4,overflow:"hidden",border:"1px solid #d4d4d8"},children:e.jsx(i,{sx:{position:"absolute",top:0,left:0,width:`${h}%`,height:"100%",backgroundColor:"#22c55e",borderRadius:3,transition:"width 0.3s ease-in-out"}})}),e.jsxs(a,{level:"body-xs",color:"neutral",sx:{mt:.5},children:[fe(s)," of ",fe(1e3)]})]}):e.jsx(i,{sx:{mb:3,p:2,backgroundColor:"success.50",borderRadius:"sm"},children:e.jsx(a,{level:"body-sm",color:"success",sx:{fontWeight:600},children:"🎉 You qualify for free standard shipping!"})})})(),e.jsx(Pr,{value:n.method,onChange:c=>o(c.target.value),children:e.jsx(K,{spacing:2,children:nr.map(c=>e.jsx(ce,{variant:n.method===c.value?"soft":"outlined",sx:{cursor:"pointer",transition:"all 0.2s","&:hover":{boxShadow:"sm"}},onClick:()=>o(c.value),children:e.jsxs(De,{children:[e.jsx(vt,{value:c.value,sx:{display:"none"}}),e.jsxs(K,{direction:"row",spacing:2,alignItems:"center",children:[e.jsx(i,{sx:{color:"primary.500"},children:c.icon}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(a,{level:"title-md",children:c.label}),e.jsx(a,{level:"body-sm",sx:{color:"text.secondary"},children:c.description})]}),e.jsx(i,{children:(()=>{const h=d(c.cost,c.value),m=c.cost;return h===0&&m>0?e.jsxs(K,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(re,{variant:"soft",color:"success",children:"Free"}),e.jsx(a,{level:"body-xs",sx:{textDecoration:"line-through",color:"text.secondary"},children:We(m)})]}):h>0?e.jsx(re,{variant:"soft",color:"primary",children:We(h)}):e.jsx(re,{variant:"soft",color:"success",children:"Free"})})()})]})]})},c.value))})})]})})}const Cl=({sx:n})=>e.jsx(i,{component:"img",src:"/mobilepay-icon.svg",alt:"MobilePay",sx:{width:24,height:24,...n}});function kl({paymentInfo:n,onChange:t}){const s=r=>{t({...n,method:r,cardNumber:r==="card"?n.cardNumber:"",cardHolder:r==="card"?n.cardHolder:"",expiryDate:r==="card"?n.expiryDate:"",cvv:r==="card"?n.cvv:"",bankAccount:"",routingNumber:""})},l=r=>d=>{let o=d.target.value;r==="cardNumber"&&(o=o.replace(/\s/g,"").replace(/(\d{4})/g,"$1 ").trim(),o.length>19&&(o=o.substring(0,19))),r==="expiryDate"&&(o=o.replace(/\D/g,""),o.length>=2&&(o=o.substring(0,2)+"/"+o.substring(2,4)),o.length>5&&(o=o.substring(0,5))),r==="cvv"&&(o=o.replace(/\D/g,"").substring(0,3)),t({...n,[r]:o})};return e.jsx(i,{sx:{width:"100%"},children:e.jsxs(K,{spacing:3,sx:{width:"100%"},children:[e.jsxs(se,{children:[e.jsx(ee,{children:"Select Payment Method"}),e.jsx(Pr,{value:n.method,onChange:r=>s(r.target.value),children:e.jsxs(K,{spacing:2,children:[e.jsx(ce,{variant:n.method==="card"?"solid":"outlined",color:n.method==="card"?"primary":"neutral",sx:{cursor:"pointer"},onClick:()=>s("card"),children:e.jsx(De,{children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(vt,{value:"card"}),e.jsxs(i,{children:[e.jsx(a,{level:"title-sm",children:"Cards"}),e.jsx(i,{sx:{display:"flex",justifyContent:"center",mt:1},children:e.jsx(Xt,{sx:{fontSize:32}})})]})]})})}),e.jsx(ce,{variant:n.method==="mobilepay"?"solid":"outlined",color:n.method==="mobilepay"?"primary":"neutral",sx:{cursor:"pointer"},onClick:()=>s("mobilepay"),children:e.jsx(De,{children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(vt,{value:"mobilepay"}),e.jsxs(i,{children:[e.jsx(a,{level:"title-sm",children:"MobilePay"}),e.jsx(i,{sx:{display:"flex",justifyContent:"center",mt:1},children:e.jsx(Cl,{sx:{width:32,height:32}})})]})]})})}),e.jsx(ce,{variant:n.method==="viabill"?"solid":"outlined",color:n.method==="viabill"?"primary":"neutral",sx:{cursor:"pointer"},onClick:()=>s("viabill"),children:e.jsx(De,{children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(vt,{value:"viabill"}),e.jsxs(i,{children:[e.jsx(a,{level:"title-sm",children:"Apple Pay / Google Pay"}),e.jsxs(i,{sx:{display:"flex",justifyContent:"center",gap:2,mt:1},children:[e.jsx(i,{component:"span",sx:{fontWeight:700,fontSize:18,color:"#000",px:1,borderRadius:1,background:"#fff",border:"1px solid #eee"},children:" Pay"}),e.jsx(i,{component:"span",sx:{fontWeight:700,fontSize:18,color:"#4285F4",px:1,borderRadius:1,background:"#fff",border:"1px solid #eee"},children:"G Pay"})]})]})]})})}),e.jsx(ce,{variant:n.method==="international"?"solid":"outlined",color:n.method==="international"?"primary":"neutral",sx:{cursor:"pointer"},onClick:()=>s("international"),children:e.jsx(De,{children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(vt,{value:"international"}),e.jsxs(i,{children:[e.jsx(a,{level:"title-sm",children:"International Credit Cards"}),e.jsx(i,{sx:{display:"flex",justifyContent:"center",mt:1},children:e.jsx(Xt,{sx:{fontSize:32}})})]})]})})})]})})]}),n.method==="card"&&e.jsx(ce,{variant:"outlined",children:e.jsx(De,{children:e.jsxs(K,{spacing:2,children:[e.jsxs(se,{required:!0,children:[e.jsx(ee,{children:"Card Number"}),e.jsx($,{value:n.cardNumber||"",onChange:l("cardNumber"),placeholder:"1234 5678 9012 3456",startDecorator:e.jsx(Xt,{})})]}),e.jsxs(se,{required:!0,children:[e.jsx(ee,{children:"Cardholder Name"}),e.jsx($,{value:n.cardHolder||"",onChange:l("cardHolder"),placeholder:"John Doe"})]}),e.jsxs(je,{container:!0,spacing:2,sx:{width:"100%",m:0},children:[e.jsx(je,{xs:8,children:e.jsxs(se,{required:!0,children:[e.jsx(ee,{children:"Expiry Date"}),e.jsx($,{value:n.expiryDate||"",onChange:l("expiryDate"),placeholder:"MM/YY"})]})}),e.jsx(je,{xs:4,children:e.jsxs(se,{required:!0,children:[e.jsx(ee,{children:"CVV"}),e.jsx($,{value:n.cvv||"",onChange:l("cvv"),placeholder:"123",type:"password"})]})})]})]})})})]})})}const ss=[{label:"Contact"},{label:"Delivery"},{label:"Payment"}];function _l({open:n,onClose:t,order:s,onSuccess:l}){const[r,d]=u.useState(0),[o,c]=u.useState([]),[h,m]=u.useState(!1),[b,f]=u.useState({name:s?.customer_name||"",email:s?.customer_email||"",phone:"",address:"",city:"",postalCode:"",country:"USA",firstName:"",lastName:"",newsletter:!1,reference:""}),[y,S]=u.useState({method:"standard"}),[g,C]=u.useState({method:"card",cardNumber:"",cardHolder:"",expiryDate:"",cvv:""}),[w,E]=u.useState(!1),[k,p]=u.useState(null),[_,B]=u.useState(!1);u.useEffect(()=>{n&&s&&(v(),d(0),B(!1),p(null),f(O=>{const V=s.customer_name||O.name,z=V.split(" ");return{...O,name:V,firstName:z[0]||"",lastName:z.slice(1).join(" ")||"",email:s.customer_email||O.email}}))},[n,s]);const v=async()=>{if(s){E(!0);try{const{data:O,error:V}=await N.from("OrderItems").select(`
          uuid,
          product_uuid,
          quantity,
          unitprice,
          discount,
          Products:product_uuid(ProductName)
        `).eq("order_uuid",s.uuid);if(V)throw V;const z=O?.map(A=>({...A,ProductName:A.Products?.ProductName||"Unknown Product"}))||[];c(z)}catch(O){p(O.message||"Failed to load order items")}finally{E(!1)}}},W=()=>{r<ss.length-1?d(r+1):P()},j=()=>{d(r-1)},P=async()=>{if(s){E(!0),p(null);try{const O=b.firstName&&b.lastName?`${b.firstName} ${b.lastName}`:b.name||"",V=await bl(s.uuid,{name:O,email:b.email});if(!V.success)throw new Error(V.error||"Failed to complete order");B(!0),setTimeout(()=>{l(),t()},2e3)}catch(O){p(O.message||"Failed to complete order")}finally{E(!1)}}},T=O=>{switch(O){case 0:return!!(b.email?.trim()&&b.phone?.trim()&&b.firstName?.trim()&&b.lastName?.trim()&&b.address?.trim()&&b.city?.trim()&&b.postalCode?.trim());case 1:return!0;case 2:return g.method==="card"?!!(g.cardNumber?.replace(/\s/g,"").length===16&&g.cardHolder?.trim()&&g.expiryDate?.length===5&&g.cvv?.length===3):!0;default:return!1}},F=O=>{switch(O){case 0:return e.jsx(wl,{customerInfo:b,onChange:f});case 1:return e.jsx(Sl,{deliveryInfo:y,onChange:S,subtotal:Q()});case 2:return e.jsx(kl,{paymentInfo:g,onChange:C});default:return null}},Q=()=>{const O=o.reduce((z,A)=>{const H=(A.unitprice||0)*A.quantity,ae=(A.discount||0)*A.quantity;return z+H-ae},0),V=s?.discount||0;return O-V},x=()=>{const O=Q(),V=y.cost||0;return O+V};return s?e.jsx(Oe,{open:n,onClose:t,sx:{display:"flex",justifyContent:"center",alignItems:"center",p:{xs:0,md:2},zIndex:10001},children:e.jsxs(Re,{size:"lg",sx:{width:{xs:"100vw",md:"90vw"},maxWidth:{xs:"none",md:1e3},height:{xs:"100vh",md:"90vh"},maxHeight:{xs:"none",md:750},overflow:"hidden",display:"flex",flexDirection:"column",m:0,borderRadius:{xs:0,md:"md"},p:0},children:[e.jsx(i,{sx:{display:{xs:"none",md:"flex"},justifyContent:"flex-end",alignItems:"center",p:2,borderBottom:"1px solid",borderColor:"divider"},children:e.jsx(qe,{})}),e.jsx(i,{sx:{display:{xs:"flex",md:"none"},justifyContent:"flex-end",alignItems:"center",p:1,position:"absolute",top:0,right:0,zIndex:1e3,backgroundColor:"background.surface"},children:e.jsx(qe,{})}),_?e.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",gap:2,p:3},children:[e.jsx(gt,{sx:{fontSize:80,color:"success.main"}}),e.jsx(a,{level:"h2",children:"Order Completed!"}),e.jsxs(a,{level:"body-lg",textAlign:"center",color:"neutral",children:["Thank you for your order! Order #",s.order_number_display," has been processed successfully."]})]}):e.jsxs(i,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},height:"100%",overflow:"hidden"},children:[e.jsxs(i,{sx:{display:{xs:"block",md:"none"},borderBottom:"1px solid",borderColor:"divider"},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",p:2,pr:6},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(a,{level:"title-md",children:"Order Summary"}),e.jsx(a,{level:"body-sm",color:"primary",children:fe(x())})]}),e.jsx(q,{variant:"plain",size:"sm",onClick:()=>m(!h),sx:{minWidth:"auto",p:1},children:h?e.jsx(Rn,{}):e.jsx(Nr,{})})]}),h&&e.jsxs(i,{sx:{p:2,backgroundColor:"background.level1",animation:"fadeIn 0.2s ease-in-out","@keyframes fadeIn":{from:{opacity:0,transform:"translateY(-10px)"},to:{opacity:1,transform:"translateY(0)"}}},children:[e.jsxs(a,{level:"body-sm",color:"neutral",sx:{mb:2},children:["Order #",s.order_number_display]}),w?e.jsx(i,{sx:{display:"flex",justifyContent:"center",my:2},children:e.jsx(Wt,{size:"sm"})}):e.jsx(K,{spacing:1,sx:{mb:2},children:o.map(O=>e.jsxs(i,{sx:{py:.5},children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",mb:.5},children:[e.jsx(a,{level:"body-sm",sx:{fontWeight:600},children:O.ProductName}),e.jsx(a,{level:"body-sm",sx:{fontWeight:600},children:fe((O.unitprice||0)*O.quantity-(O.discount||0)*O.quantity)})]}),e.jsxs(a,{level:"body-xs",color:"neutral",children:["Qty: ",O.quantity," × ",fe(O.unitprice||0)]})]},O.uuid))}),e.jsx(ze,{sx:{my:1}}),e.jsxs(K,{spacing:.5,children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(a,{level:"body-xs",children:"Shipping"}),e.jsx(a,{level:"body-xs",children:fe(y.cost||0)})]}),e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(a,{level:"body-xs",children:"VAT included"}),e.jsx(a,{level:"body-xs",children:fe(o.reduce((O,V)=>O+(V.unitprice||0)*V.quantity,0)*.2)})]})]}),e.jsx(ze,{sx:{my:1}}),e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(a,{level:"title-sm",sx:{fontWeight:700},children:"Total:"}),e.jsx(a,{level:"title-sm",sx:{fontWeight:700,color:"primary.main"},children:fe(x())})]})]})]}),e.jsxs(i,{sx:{display:{xs:"none",md:"block"},width:{md:"350px"},borderRight:"1px solid",borderColor:"divider",p:3,overflow:"auto"},children:[e.jsx(a,{level:"h4",sx:{mb:2},children:"Summary"}),e.jsxs(a,{level:"body-sm",color:"neutral",sx:{mb:2},children:["Order #",s.order_number_display]}),w?e.jsx(i,{sx:{display:"flex",justifyContent:"center",my:3},children:e.jsx(Wt,{})}):e.jsx(K,{spacing:1,sx:{mb:3},children:o.map(O=>e.jsxs(i,{sx:{py:1},children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",mb:.5},children:[e.jsx(a,{level:"body-sm",sx:{fontWeight:600},children:O.ProductName}),e.jsx(a,{level:"body-sm",sx:{fontWeight:600},children:fe((O.unitprice||0)*O.quantity-(O.discount||0)*O.quantity)})]}),e.jsxs(a,{level:"body-xs",color:"neutral",children:["Qty: ",O.quantity," × ",fe(O.unitprice||0),(O.discount||0)>0&&e.jsxs(i,{component:"span",sx:{color:"warning.main",ml:1},children:["(",O.discount,"% off)"]})]})]},O.uuid))}),e.jsx(ze,{sx:{my:2}}),e.jsxs(K,{spacing:.5,children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(a,{level:"body-sm",children:"Shipping: Delivery to your door"}),e.jsx(a,{level:"body-sm",children:fe(y.cost||0)})]}),e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(a,{level:"body-sm",children:"Subtotal:"}),e.jsx(a,{level:"body-sm",children:fe(o.reduce((O,V)=>O+(V.unitprice||0)*V.quantity,0))})]}),e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(a,{level:"body-sm",children:"VAT included:"}),e.jsx(a,{level:"body-sm",children:fe(o.reduce((O,V)=>O+(V.unitprice||0)*V.quantity,0)*.2)})]})]}),e.jsx(ze,{sx:{my:1}}),e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(a,{level:"title-md",sx:{fontWeight:700},children:"Total:"}),e.jsx(a,{level:"title-md",sx:{fontWeight:700,color:"primary.main"},children:fe(x())})]})]}),e.jsxs(i,{sx:{flex:1,display:"flex",flexDirection:"column",minHeight:0,overflow:"hidden"},children:[e.jsx(i,{sx:{p:{xs:1,md:3},pb:{xs:1,md:2},borderBottom:"1px solid",borderColor:"divider",flexShrink:0},children:e.jsx(nn,{sx:{mb:0},children:ss.map((O,V)=>e.jsx(ln,{indicator:e.jsx(on,{variant:r===V||r>V?"solid":"outlined",color:r>V?"success":"primary",sx:{width:{xs:8,md:12},height:{xs:8,md:12},minWidth:{xs:8,md:12},fontSize:0,"--StepIndicator-size":{xs:"8px",md:"12px"}}}),children:e.jsx(an,{onClick:()=>d(V),children:e.jsx(a,{level:"body-sm",sx:{fontSize:{xs:"0.75rem",md:"0.875rem"}},children:O.label})})},O.label))})}),k&&e.jsx(i,{sx:{p:{xs:1,md:3},pt:0,flexShrink:0},children:e.jsx(He,{color:"danger",children:k})}),e.jsx(i,{sx:{flex:1,overflow:"auto",p:{xs:1,md:3},pt:{xs:2,md:3},minHeight:0},children:F(r)}),e.jsxs(i,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},justifyContent:{xs:"stretch",md:r===0?"flex-end":"space-between"},p:{xs:1,md:3},borderTop:"1px solid",borderColor:"divider",gap:{xs:1,md:2},backgroundColor:"background.surface",flexShrink:0,position:{xs:"sticky",md:"static"},bottom:0,zIndex:1e4},children:[e.jsx(q,{variant:"solid",endDecorator:e.jsx(Tn,{}),onClick:W,loading:w,disabled:!T(r)||w,size:"lg",sx:{width:{xs:"100%",md:"auto"},minHeight:"48px",order:{xs:1,md:2},fontWeight:600},children:r===ss.length-1?"Approve and pay":"Next"}),r>0&&e.jsx(q,{variant:"outlined",startDecorator:e.jsx(Ln,{}),onClick:j,size:"lg",sx:{width:{xs:"100%",md:"auto"},minHeight:"48px",order:{xs:2,md:1}},children:"Back"})]})]})]})]})}):null}const le={sizes:{small:"0.875rem",xlarge:"1.5rem"}},Te={fontSize:le.sizes.small},Dl=()=>{const{isMobile:n}=Pe(),[t,s]=u.useState([]),[l,r]=u.useState(!1),[d,o]=u.useState(""),[c,h]=u.useState(""),[m,b]=u.useState(""),[f,y]=u.useState(""),[S,g]=u.useState(!1),[C,w]=u.useState(!1),[E,k]=u.useState(!1),[p,_]=u.useState(null),[B,v]=u.useState("add"),[W,j]=u.useState(!1),[P,T]=u.useState(!1),[F,Q]=u.useState(""),[x,O]=u.useState("success"),V=(I,D="success")=>{Q(I),O(D),T(!0)},z=I=>{switch(I){case"Draft":return"neutral";case"Paid":return"success";case"Refunded":return"warning";case"Cancelled":return"danger";default:return"neutral"}},A=I=>{switch(I){case"Draft":return e.jsx(mt,{});case"Paid":return e.jsx(Zs,{});case"Refunded":return e.jsx(Zs,{});case"Cancelled":return e.jsx(mt,{});default:return e.jsx(mt,{})}},H=async()=>{r(!0);try{const{data:I,error:D}=await N.from("Orders").select("*");if(D){console.error("Error fetching orders:",D),V("Failed to fetch orders","danger");return}if(I){const G=I.map(te=>({uuid:te.uuid,date:te.date||te.created_at||te["Created at"]||"",status:te.status||"Paid",customer:te.customer||{initial:te.customer_initial||(te.customer_name?te.customer_name[0]:"?"),name:te.customer_name||"Unknown",email:te.customer_email||""},order_number_display:te.order_number_display,order_total:typeof te.order_total=="number"?te.order_total:0,created_by:te.created_by||"",created_by_name:te.created_by_name||"",created_by_email:te.created_by_email||"",category:te.category||"purchase"})).sort((te,Se)=>{const Be=new Date(te.date||0);return new Date(Se.date||0).getTime()-Be.getTime()});s(G)}}catch(I){console.error("Error fetching orders:",I),V("Failed to fetch orders","danger")}finally{r(!1)}},ae=async I=>{try{const{data:D,error:G}=await N.from("OrderItems").select("*, Products:product_uuid(ProductName)").eq("order_uuid",I);return G?(console.error("Error fetching order items:",G),[]):D?.map(te=>({...te,product_name:te.Products?.ProductName||te.product_uuid}))||[]}catch(D){return console.error("Error fetching order items:",D),[]}};u.useEffect(()=>{H()},[]);const he=t.filter(I=>{const D=!d||I.order_number_display?.toString().toLowerCase().includes(d.toLowerCase())||I.customer.name.toLowerCase().includes(d.toLowerCase())||I.customer.email.toLowerCase().includes(d.toLowerCase()),G=!c||I.status===c,te=!m||I.category===m,Se=!f||I.customer.name===f;return D&&G&&te&&Se}),oe=Array.from(new Set(t.map(I=>I.status))),X=Array.from(new Set(t.map(I=>I.category||"purchase"))),de=Array.from(new Set(t.map(I=>I.customer.name))),Y=()=>{_(null),v("add"),w(!0)},ne=I=>{_(I),v("view"),w(!0)},L=()=>{w(!1),_(null)},J=()=>{H()},ve=I=>({id:I.uuid,uuid:I.uuid,order_number:I.order_number_display,date:I.date,status:I.status,customer_name:I.customer.name,customer_email:I.customer.email,total:I.order_total}),we=I=>{const D=t.find(G=>G.uuid===I||G.order_number_display===I);D&&ne(D)},$e=I=>{_(I),k(!0)},Ke=()=>{Y()},M=()=>{g(!1)},ue=()=>{h(""),b(""),y("")},R=()=>e.jsxs(i,{sx:{pb:2},children:[e.jsxs(ke,{variant:"page",padding:"medium",children:[e.jsxs(i,{sx:{display:"flex",gap:1,mb:2},children:[e.jsx($,{placeholder:"Search orders...",value:d,onChange:I=>o(I.target.value),startDecorator:e.jsx(Ce,{}),sx:{flex:1,fontSize:"16px"}}),e.jsx(me,{variant:"soft",onClick:()=>g(!0),sx:{flexShrink:0},children:e.jsx(Cs,{})})]}),(c||m||f)&&e.jsxs(i,{sx:{display:"flex",gap:1,mb:2,flexWrap:"wrap"},children:[c&&e.jsxs(re,{size:"sm",variant:"soft",color:"primary",children:["Status: ",c]}),m&&e.jsxs(re,{size:"sm",variant:"soft",color:"primary",children:["Category: ",m]}),f&&e.jsxs(re,{size:"sm",variant:"soft",color:"primary",children:["Customer: ",f]})]}),l&&e.jsx(Ie,{sx:{mb:2}})]}),e.jsx(i,{children:he.length===0?e.jsx(i,{sx:{textAlign:"center",py:6},children:e.jsx(a,{color:"neutral",children:l?"Loading orders...":"No orders found"})}):he.map(I=>e.jsxs(i,{sx:{p:2,borderBottom:"1px solid",borderColor:"divider",cursor:"pointer","&:hover":{bgcolor:"background.level1"}},onClick:()=>we(I.uuid),children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:[e.jsx(i,{sx:{width:32,height:32,borderRadius:"50%",bgcolor:`${z(I.status)}.100`,color:`${z(I.status)}.600`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"14px",fontWeight:"bold",flexShrink:0},children:A(I.status)}),e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:.5},children:[e.jsxs(a,{level:"title-sm",sx:{fontWeight:"bold",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"60%"},children:["Order #",I.order_number_display||I.uuid.substring(0,8)]}),e.jsx(re,{size:"sm",color:z(I.status),variant:"soft",sx:{fontWeight:"bold",minWidth:"fit-content"},children:I.status})]}),e.jsxs(a,{level:"body-xs",color:"neutral",sx:{mb:.5},children:[I.customer.name," • ",new Date(I.date).toLocaleDateString()]}),I.order_total&&e.jsx(a,{level:"body-xs",sx:{fontWeight:"bold",color:"primary.600"},children:We(I.order_total)})]})]}),e.jsx(i,{sx:{display:"flex",gap:1,justifyContent:"flex-end"},children:I.status==="Draft"&&e.jsx(q,{size:"sm",variant:"solid",color:"primary",onClick:D=>{D.stopPropagation(),$e(I)},startDecorator:e.jsx(hs,{}),children:"Checkout"})})]},I.uuid))}),e.jsx(me,{color:"primary",variant:"soft",size:"sm",sx:{position:"fixed",bottom:80,right:16,zIndex:1e3,borderRadius:"8px",width:40,height:40,boxShadow:"sm",bgcolor:"primary.100","&:hover":{bgcolor:"primary.200",boxShadow:"md"}},onClick:Ke,children:e.jsx(be,{fontSize:"small"})})]}),Z=()=>e.jsxs(ke,{variant:"table-page",children:[e.jsx(a,{level:"h2",sx:{mb:2,fontSize:le.sizes.xlarge},children:"Orders"}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx($,{placeholder:"Search orders...",sx:{flex:1,fontSize:le.sizes.small},value:d,onChange:I=>o(I.target.value),startDecorator:e.jsx(Ce,{})}),e.jsxs(ye,{placeholder:"Filter status",value:c,onChange:(I,D)=>h(D||""),sx:{minWidth:160,fontSize:le.sizes.small},children:[e.jsx(U,{value:"",children:"All Statuses"}),oe.map(I=>e.jsx(U,{value:I,children:I},I))]}),e.jsx(q,{variant:"solid",startDecorator:e.jsx(be,{}),onClick:Ke,sx:{fontSize:le.sizes.small},children:"Create Order"})]}),e.jsxs(ce,{sx:{overflow:"visible"},children:[l&&e.jsx(Ie,{}),e.jsxs(Ue,{"aria-label":"Orders",sx:{tableLayout:"auto"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:Te,children:"Order #"}),e.jsx("th",{style:Te,children:"Date"}),e.jsx("th",{style:Te,children:"Customer"}),e.jsx("th",{style:Te,children:"Status"}),e.jsx("th",{style:Te,children:"Total"}),e.jsx("th",{style:Te,children:"Actions"})]})}),e.jsxs("tbody",{children:[he.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,style:{textAlign:"center",color:"#888",...Te},children:l?"Loading orders...":"No orders found."})}),he.map(I=>e.jsxs("tr",{style:{cursor:"pointer"},onClick:()=>we(I.uuid),children:[e.jsx("td",{style:Te,children:I.order_number_display||I.uuid.substring(0,8)}),e.jsx("td",{style:Te,children:new Date(I.date).toLocaleDateString()}),e.jsx("td",{style:Te,children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(i,{sx:{width:24,height:24,borderRadius:"50%",bgcolor:"primary.100",color:"primary.600",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"12px",fontWeight:"bold"},children:I.customer.initial}),e.jsxs(i,{children:[e.jsx(a,{level:"body-sm",sx:{fontWeight:"bold"},children:I.customer.name}),e.jsx(a,{level:"body-xs",color:"neutral",children:I.customer.email})]})]})}),e.jsx("td",{style:Te,children:e.jsx(re,{size:"sm",variant:"soft",color:z(I.status),children:I.status})}),e.jsx("td",{style:Te,children:e.jsx(a,{level:"body-sm",sx:{fontWeight:"bold"},children:I.order_total?We(I.order_total):"N/A"})}),e.jsx("td",{style:Te,children:e.jsx(i,{sx:{display:"flex",gap:1},children:I.status==="Draft"&&e.jsx(q,{size:"sm",variant:"solid",color:"primary",onClick:D=>{D.stopPropagation(),$e(I)},startDecorator:e.jsx(hs,{}),children:"Checkout"})})})]},I.uuid))]})]})]})]});return e.jsxs(Fe,{children:[n?e.jsx(R,{}):e.jsx(Z,{}),e.jsx(vl,{open:C,onClose:L,order:p?ve(p):void 0,mode:B,onSaved:J,fetchOrderItems:ae}),e.jsx(_l,{open:E,onClose:()=>k(!1),order:p?{uuid:p.uuid,order_number_display:p.order_number_display,order_total:p.order_total,customer_name:p.customer.name,customer_email:p.customer.email}:null,onSuccess:()=>{k(!1),H(),V("Order completed successfully!","success")}}),n&&e.jsx(Ht,{open:S,onClose:M,title:"Filter Orders",size:"medium",actions:e.jsxs(i,{sx:{display:"flex",gap:2},children:[e.jsx(q,{variant:"plain",onClick:ue,sx:Te,children:"Clear All"}),e.jsx(q,{variant:"solid",onClick:M,sx:Te,children:"Apply"})]}),children:e.jsxs(K,{spacing:2,children:[e.jsxs(se,{children:[e.jsx(ee,{children:"Status"}),e.jsxs(ye,{placeholder:"All statuses",value:c,onChange:(I,D)=>h(D||""),children:[e.jsx(U,{value:"",children:"All Statuses"}),oe.map(I=>e.jsx(U,{value:I,children:I},I))]})]}),e.jsxs(se,{children:[e.jsx(ee,{children:"Category"}),e.jsxs(ye,{placeholder:"All categories",value:m,onChange:(I,D)=>b(D||""),children:[e.jsx(U,{value:"",children:"All Categories"}),X.map(I=>e.jsx(U,{value:I,children:I},I))]})]}),e.jsxs(se,{children:[e.jsx(ee,{children:"Customer"}),e.jsxs(ye,{placeholder:"All customers",value:f,onChange:(I,D)=>y(D||""),children:[e.jsx(U,{value:"",children:"All Customers"}),de.map(I=>e.jsx(U,{value:I,children:I},I))]})]})]})}),e.jsx(Yt,{open:P,onClose:()=>T(!1),autoHideDuration:4e3,anchorOrigin:{vertical:"top",horizontal:"center"},sx:{top:16,zIndex:2e3},children:e.jsx(He,{color:x,variant:"solid",sx:{width:"100%"},children:F})})]})};function Il({open:n,onClose:t,product:s,onSave:l,mode:r="add",onEdit:d}){const[o,c]=u.useState({ProductName:s?.ProductName||"",SalesPrice:s?.SalesPrice?.toString()||"",CostPrice:s?.CostPrice?.toString()||"",image_url:s?.image_url||"",min_stock:s?.min_stock?.toString()||"",max_stock:s?.max_stock?.toString()||"",reorder_amount:s?.reorder_amount?.toString()||""}),[h,m]=u.useState(!1),[b,f]=u.useState(!1),y=u.useRef(null);u.useEffect(()=>{c({ProductName:s?.ProductName||"",SalesPrice:s?.SalesPrice?.toString()||"",CostPrice:s?.CostPrice?.toString()||"",image_url:s?.image_url||"",min_stock:s?.min_stock?.toString()||"",max_stock:s?.max_stock?.toString()||"",reorder_amount:s?.reorder_amount?.toString()||""})},[s]);const S=async w=>{const E=w.target.files?.[0];if(E){if(!E.type.startsWith("image/")){alert("Please select a valid image file");return}if(E.size>5*1024*1024){alert("Image size must be less than 5MB");return}try{f(!0);const k=E.name.split(".").pop(),_=`products/${`product-${Date.now()}.${k}`}`,{data:B,error:v}=await N.storage.from("productimages").upload(_,E,{cacheControl:"3600",upsert:!0});if(v)throw new Error(`Upload failed: ${v.message}`);const{data:{publicUrl:W}}=N.storage.from("productimages").getPublicUrl(_);c(j=>({...j,image_url:W}))}catch(k){console.error("Image upload failed:",k),alert("Failed to upload image. Please try again.")}finally{f(!1),w.target&&(w.target.value="")}}},g=()=>{c(w=>({...w,image_url:""}))},C=async()=>{m(!0),await l(o),m(!1)};return e.jsx(Oe,{open:n,onClose:t,"aria-labelledby":"dialog-products-title",children:e.jsxs(Re,{sx:{minWidth:{xs:"90vw",sm:500}},children:[e.jsx(Ct,{id:"dialog-products-title",children:r==="view"?"Product Details":s?"Edit Product":"Add Product"}),e.jsx(kt,{children:e.jsxs(K,{spacing:2,children:[e.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:1},children:[e.jsx(a,{level:"body-sm",sx:{alignSelf:"flex-start"},children:"Product Image"}),o.image_url?e.jsxs(i,{sx:{position:"relative"},children:[e.jsx(xe,{src:o.image_url,alt:"Product",variant:"soft",sx:{width:120,height:120,borderRadius:2,border:"2px solid",borderColor:"neutral.300"}}),r!=="view"&&e.jsx(me,{size:"sm",variant:"solid",color:"danger",onClick:g,sx:{position:"absolute",top:-8,right:-8,minHeight:24,minWidth:24},children:e.jsx(pt,{fontSize:"small"})})]}):e.jsx(i,{sx:{width:120,height:120,borderRadius:2,border:"2px dashed",borderColor:"neutral.300",display:"flex",alignItems:"center",justifyContent:"center",cursor:r==="view"?"default":"pointer","&:hover":r==="view"?{}:{borderColor:"primary.500",backgroundColor:"primary.50"}},onClick:r==="view"?void 0:()=>y.current?.click(),children:e.jsx(Dt,{sx:{fontSize:32,color:"neutral.400"}})}),e.jsx("input",{ref:y,type:"file",accept:"image/*",onChange:S,style:{display:"none"},disabled:r==="view"}),r!=="view"&&e.jsxs(K,{direction:"row",spacing:1,children:[e.jsx(q,{size:"sm",variant:"outlined",onClick:()=>y.current?.click(),loading:b,disabled:b,children:o.image_url?"Change Image":"Upload Image"}),o.image_url&&e.jsx(q,{size:"sm",variant:"plain",color:"danger",onClick:g,children:"Remove"})]})]}),e.jsx($,{name:"ProductName",value:o.ProductName,onChange:w=>c({...o,ProductName:w.target.value}),placeholder:"Product Name",readOnly:r==="view"}),e.jsx($,{name:"SalesPrice",value:o.SalesPrice,onChange:w=>c({...o,SalesPrice:w.target.value}),placeholder:"Sales Price",type:"number",readOnly:r==="view"}),e.jsx($,{name:"CostPrice",value:o.CostPrice,onChange:w=>c({...o,CostPrice:w.target.value}),placeholder:"Cost Price",type:"number",readOnly:r==="view"}),e.jsxs(i,{sx:{mt:3,mb:2},children:[e.jsxs(a,{level:"title-md",sx:{mb:2,display:"flex",alignItems:"center",gap:1},children:[e.jsx($r,{}),"Inventory Management"]}),e.jsxs(K,{spacing:2,children:[e.jsx($,{name:"min_stock",value:o.min_stock,onChange:w=>c({...o,min_stock:w.target.value}),placeholder:"Minimum Stock Level",type:"number",startDecorator:e.jsx(a,{level:"body-sm",children:"Min:"}),readOnly:r==="view"}),e.jsx($,{name:"max_stock",value:o.max_stock,onChange:w=>c({...o,max_stock:w.target.value}),placeholder:"Maximum Stock Level",type:"number",startDecorator:e.jsx(a,{level:"body-sm",children:"Max:"}),readOnly:r==="view"}),e.jsx($,{name:"reorder_amount",value:o.reorder_amount,onChange:w=>c({...o,reorder_amount:w.target.value}),placeholder:"Reorder Amount",type:"number",startDecorator:e.jsx(a,{level:"body-sm",children:"Reorder:"}),readOnly:r==="view"})]})]})]})}),e.jsxs(_t,{children:[e.jsx(q,{onClick:t,variant:"plain",disabled:h||b,children:r==="view"?"Close":"Cancel"}),r==="view"?d&&e.jsx(q,{onClick:d,variant:"solid",startDecorator:e.jsx(ct,{}),children:"Edit"}):e.jsx(q,{onClick:C,variant:"solid",loading:h,disabled:h||b,children:"Save"})]})]})})}const rs=zs(Il),Ae={fontSize:le.sizes.small},Pl=()=>{const{isMobile:n}=Pe(),[t,s]=u.useState([]),[l,r]=u.useState({}),[d,o]=u.useState(!1),[c,h]=u.useState(!1),[m,b]=u.useState(!1),[f,y]=u.useState(""),[S,g]=u.useState(""),[C,w]=u.useState(!1),[E,k]=u.useState(!1),[p,_]=u.useState(!1),[B,v]=u.useState(!1),[W,j]=u.useState(null),[P,T]=u.useState(null),[F,Q]=u.useState(!1),[x,O]=u.useState(""),[V,z]=u.useState("success"),A=(R,Z="success")=>{O(R),z(Z),Q(!0)},H=R=>R<=0?{status:"Out of Stock",color:"danger"}:R<=10?{status:"Low Stock",color:"warning"}:{status:"In Stock",color:"success"},ae=R=>{const Z=H(R);return e.jsx(i,{sx:{width:20,height:20,borderRadius:"50%",bgcolor:`${Z.color}.100`,color:`${Z.color}.600`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"12px",fontWeight:"bold"},children:e.jsx($r,{sx:{fontSize:"12px"}})})},he=async()=>{o(!0);try{const{data:R,error:Z}=await N.from("Products").select("*").order("CreatedAt",{ascending:!1});if(Z){console.error("Error fetching products:",Z),A("Failed to fetch products","danger");return}R&&(s(R),await oe(R))}catch(R){console.error("Error fetching products:",R),A("Failed to fetch products","danger")}finally{o(!1)}},oe=async R=>{h(!0);try{const{data:Z,error:I}=await N.from("stock_movements").select("product_id, movement_type, quantity");if(I){console.error("Error fetching stock data:",I);return}if(Z){const D={};R.forEach(G=>{const Se=Z.filter(Be=>Be.product_id===G.uuid).reduce((Be,Pt)=>{switch(Pt.movement_type){case"incoming":case"adjustment":return Be+(Pt.quantity||0);case"outgoing":return Be-(Pt.quantity||0);default:return Be}},0);D[G.uuid]=Se}),r(D)}}catch(Z){console.error("Error fetching stock levels:",Z)}finally{h(!1)}};u.useEffect(()=>{he()},[]);const X=t.filter(R=>{const Z=!f||R.ProductName.toLowerCase().includes(f.toLowerCase())||R.ProductID?.toLowerCase().includes(f.toLowerCase()),I=l[R.uuid]||0,D=!S||S==="in-stock"&&I>10||S==="low-stock"&&I>0&&I<=10||S==="out-of-stock"&&I<=0;return Z&&D}),de=()=>{k(!0)},Y=R=>{j(R),_(!0)},ne=R=>{T(R),v(!0)},L=()=>{P&&(j(P),v(!1),T(null),_(!0))},J=async R=>{if(confirm("Are you sure you want to delete this product?")){b(!0);try{const{error:Z}=await N.from("Products").delete().eq("uuid",R);if(Z){console.error("Error deleting product:",Z),A("Failed to delete product","danger");return}s(t.filter(I=>I.uuid!==R)),A("Product deleted successfully","success")}catch(Z){console.error("Error deleting product:",Z),A("Failed to delete product","danger")}finally{b(!1)}}},ve=async R=>{b(!0);try{const Z=sr({ProductName:R.ProductName,SalesPrice:parseFloat(R.SalesPrice),CostPrice:parseFloat(R.CostPrice),image_url:R.image_url||null,min_stock:R.min_stock?parseInt(R.min_stock):null,max_stock:R.max_stock?parseInt(R.max_stock):null,reorder_amount:R.reorder_amount?parseInt(R.reorder_amount):null,CreatedAt:new Date().toISOString()}),{data:I,error:D}=await N.from("Products").insert([Z]).select().single();if(D){console.error("Error adding product:",D),A("Failed to add product","danger");return}A("Product added successfully","success"),k(!1),he()}catch(Z){console.error("Error adding product:",Z),A("Failed to add product","danger")}finally{b(!1)}},we=async R=>{if(W){b(!0);try{const Z=sr({ProductName:R.ProductName,SalesPrice:parseFloat(R.SalesPrice),CostPrice:parseFloat(R.CostPrice),image_url:R.image_url||null,min_stock:R.min_stock?parseInt(R.min_stock):null,max_stock:R.max_stock?parseInt(R.max_stock):null,reorder_amount:R.reorder_amount?parseInt(R.reorder_amount):null}),{error:I}=await N.from("Products").update(Z).eq("uuid",W.uuid);if(I){console.error("Error updating product:",I),A("Failed to update product","danger");return}A("Product updated successfully","success"),_(!1),j(null),he()}catch(Z){console.error("Error updating product:",Z),A("Failed to update product","danger")}finally{b(!1)}}},$e=()=>{w(!1)},Ke=()=>{g("")},M=()=>e.jsxs(i,{sx:{pb:2},children:[e.jsxs(ke,{variant:"page",padding:"medium",children:[e.jsxs(i,{sx:{display:"flex",gap:1,mb:2},children:[e.jsx($,{placeholder:"Search products...",value:f,onChange:R=>y(R.target.value),startDecorator:e.jsx(Ce,{}),sx:{flex:1,fontSize:"16px"}}),e.jsx(me,{variant:"soft",onClick:()=>w(!0),sx:{flexShrink:0},children:e.jsx(Cs,{})})]}),S&&e.jsx(i,{sx:{display:"flex",gap:1,mb:2,flexWrap:"wrap"},children:e.jsxs(re,{size:"sm",variant:"soft",color:"primary",children:["Stock: ",S.replace("-"," ")]})}),d&&e.jsx(Ie,{sx:{mb:2}})]}),e.jsx(i,{children:X.length===0?e.jsx(i,{sx:{textAlign:"center",py:6},children:e.jsx(a,{color:"neutral",children:d?"Loading products...":"No products found"})}):X.map(R=>e.jsx(i,{sx:{p:2,borderBottom:"1px solid",borderColor:"divider",cursor:"pointer","&:hover":{bgcolor:"background.level1"}},onClick:()=>ne(R),children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(i,{sx:{flexShrink:0},children:R.image_url?e.jsx(xe,{src:R.image_url,sx:{width:48,height:48},alt:R.ProductName}):e.jsx(xe,{sx:{width:48,height:48,bgcolor:"neutral.100"},children:e.jsx(Js,{})})}),e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:.5},children:[e.jsx(a,{level:"title-sm",sx:{fontWeight:"bold",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"60%"},children:R.ProductName}),e.jsx(i,{sx:{display:"flex",alignItems:"center",gap:1},children:c?e.jsx(a,{level:"body-xs",color:"neutral",children:"..."}):e.jsxs(e.Fragment,{children:[ae(l[R.uuid]||0),e.jsx(re,{size:"sm",color:H(l[R.uuid]||0).color,variant:"soft",sx:{fontSize:"10px",minWidth:"fit-content"},children:l[R.uuid]||0})]})})]}),e.jsxs(a,{level:"body-xs",color:"neutral",sx:{mb:.5},children:["ID: ",R.ProductID||"N/A"," • ",new Date(R.CreatedAt).toLocaleDateString()]}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(i,{children:[e.jsxs(a,{level:"body-xs",sx:{fontWeight:"bold",color:"success.600"},children:["Sale: ",We(R.SalesPrice)]}),e.jsxs(a,{level:"body-xs",color:"neutral",children:["Cost: ",We(R.CostPrice)]})]}),e.jsxs(i,{sx:{display:"flex",gap:.5},children:[e.jsx(me,{size:"sm",variant:"soft",color:"primary",onClick:Z=>{Z.stopPropagation(),Y(R)},children:e.jsx(ct,{})}),e.jsx(me,{size:"sm",variant:"soft",color:"danger",onClick:Z=>{Z.stopPropagation(),J(R.uuid)},disabled:m,children:e.jsx(pt,{})})]})]})]})]})},R.uuid))}),e.jsx(me,{color:"primary",variant:"soft",size:"sm",sx:{position:"fixed",bottom:80,right:16,zIndex:1e3,borderRadius:"8px",width:40,height:40,boxShadow:"sm",bgcolor:"primary.100","&:hover":{bgcolor:"primary.200",boxShadow:"md"}},onClick:de,children:e.jsx(be,{fontSize:"small"})})]}),ue=()=>e.jsxs(ke,{variant:"table-page",children:[e.jsx(a,{level:"h2",sx:{mb:2,fontSize:le.sizes.xlarge},children:"Products"}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx($,{placeholder:"Search products...",sx:{flex:1,fontSize:le.sizes.small},value:f,onChange:R=>y(R.target.value),startDecorator:e.jsx(Ce,{})}),e.jsxs(ye,{placeholder:"Filter by stock",value:S,onChange:(R,Z)=>g(Z||""),sx:{minWidth:160,fontSize:le.sizes.small},children:[e.jsx(U,{value:"",children:"All Stock Levels"}),e.jsx(U,{value:"in-stock",children:"In Stock"}),e.jsx(U,{value:"low-stock",children:"Low Stock"}),e.jsx(U,{value:"out-of-stock",children:"Out of Stock"})]}),e.jsx(q,{variant:"solid",startDecorator:e.jsx(be,{}),onClick:de,sx:{fontSize:le.sizes.small},children:"Add Product"})]}),e.jsxs(ce,{sx:{overflow:"visible"},children:[d&&e.jsx(Ie,{}),e.jsxs(Ue,{"aria-label":"Products",sx:{tableLayout:"auto","& tbody tr":{cursor:"pointer","&:hover":{backgroundColor:"background.level1"}}},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:Ae,children:"Image"}),e.jsx("th",{style:Ae,children:"Name"}),e.jsx("th",{style:Ae,children:"Stock"}),e.jsx("th",{style:Ae,children:"Sales Price"}),e.jsx("th",{style:Ae,children:"Cost Price"}),e.jsx("th",{style:Ae,children:"Created"}),e.jsx("th",{style:Ae,children:"Actions"})]})}),e.jsxs("tbody",{children:[X.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,style:{textAlign:"center",color:"#888",...Ae},children:d?"Loading products...":"No products found."})}),X.map(R=>e.jsxs("tr",{onClick:()=>ne(R),children:[e.jsx("td",{style:Ae,children:R.image_url?e.jsx(xe,{src:R.image_url,sx:{width:32,height:32},alt:R.ProductName}):e.jsx(xe,{sx:{width:32,height:32,bgcolor:"neutral.100"},children:e.jsx(Js,{sx:{fontSize:"16px"}})})}),e.jsx("td",{style:Ae,children:e.jsxs(i,{children:[e.jsx(a,{level:"body-sm",sx:{fontWeight:"bold"},children:R.ProductName}),e.jsxs(a,{level:"body-xs",color:"neutral",children:["ID: ",R.ProductID||"N/A"]})]})}),e.jsx("td",{style:Ae,children:c?e.jsx(a,{level:"body-sm",sx:{color:"neutral.500"},children:"Loading..."}):e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(re,{size:"sm",variant:"soft",color:H(l[R.uuid]||0).color,children:H(l[R.uuid]||0).status}),e.jsx(us,{title:`Current stock level: ${l[R.uuid]||0} units`,arrow:!0,children:e.jsx(a,{level:"body-sm",sx:{fontWeight:"bold",color:H(l[R.uuid]||0).color==="danger"?"danger.500":H(l[R.uuid]||0).color==="warning"?"warning.600":"success.600"},children:l[R.uuid]||0})}),e.jsx(i,{sx:{width:40,height:4,bgcolor:"neutral.200",borderRadius:2,overflow:"hidden"},children:e.jsx(i,{sx:{width:`${Math.min(100,Math.max(0,(l[R.uuid]||0)/50*100))}%`,height:"100%",bgcolor:H(l[R.uuid]||0).color==="danger"?"danger.400":H(l[R.uuid]||0).color==="warning"?"warning.400":"success.400",borderRadius:2}})})]})}),e.jsx("td",{style:Ae,children:e.jsx(a,{level:"body-sm",sx:{fontWeight:"bold",color:"success.600"},children:We(R.SalesPrice)})}),e.jsx("td",{style:Ae,children:e.jsx(a,{level:"body-sm",color:"neutral",children:We(R.CostPrice)})}),e.jsx("td",{style:Ae,children:new Date(R.CreatedAt).toLocaleDateString()}),e.jsx("td",{style:Ae,children:e.jsxs(i,{sx:{display:"flex",gap:.5},children:[e.jsx(me,{size:"sm",variant:"soft",color:"primary",onClick:Z=>{Z.stopPropagation(),Y(R)},children:e.jsx(ct,{})}),e.jsx(me,{size:"sm",variant:"soft",color:"danger",onClick:Z=>{Z.stopPropagation(),J(R.uuid)},disabled:m,children:e.jsx(pt,{})})]})})]},R.uuid))]})]})]})]});return e.jsxs(Fe,{children:[n?e.jsx(M,{}):e.jsx(ue,{}),e.jsx(rs,{open:E,onClose:()=>k(!1),product:null,mode:"add",onSave:ve}),e.jsx(rs,{open:p,onClose:()=>{_(!1),j(null)},product:W,mode:"edit",onSave:we}),e.jsx(rs,{open:B,onClose:()=>{v(!1),T(null)},product:P,mode:"view",onSave:()=>{},onEdit:L}),n&&e.jsx(Ht,{open:C,onClose:$e,title:"Filter Products",size:"medium",actions:e.jsxs(i,{sx:{display:"flex",gap:2},children:[e.jsx(q,{variant:"plain",onClick:Ke,sx:Ae,children:"Clear All"}),e.jsx(q,{variant:"solid",onClick:$e,sx:Ae,children:"Apply"})]}),children:e.jsx(K,{spacing:2,children:e.jsxs(se,{children:[e.jsx(ee,{children:"Stock Level"}),e.jsxs(ye,{placeholder:"All stock levels",value:S,onChange:(R,Z)=>g(Z||""),children:[e.jsx(U,{value:"",children:"All Stock Levels"}),e.jsx(U,{value:"in-stock",children:"In Stock"}),e.jsx(U,{value:"low-stock",children:"Low Stock"}),e.jsx(U,{value:"out-of-stock",children:"Out of Stock"})]})]})})}),e.jsx(Yt,{open:F,onClose:()=>Q(!1),autoHideDuration:4e3,anchorOrigin:{vertical:"top",horizontal:"center"},sx:{top:16,zIndex:2e3},children:e.jsx(He,{color:V,variant:"solid",sx:{width:"100%"},children:x})})]})},Xe={fontSize:le.sizes.small},rt={...Xe,fontWeight:600,borderBottom:"1.5px solid #e0e0e0",background:"inherit"},lr=n=>{switch(n?.toLowerCase()){case"admin":return"danger";case"manager":return"warning";case"user":return"primary";case"staff":return"success";default:return"neutral"}},ir=(n,t,s)=>{const r=`${n||""} ${t||""}`.trim()||s;let d=0;for(let c=0;c<r.length;c++)d=r.charCodeAt(c)+((d<<5)-d);const o=["primary","success","warning","danger","neutral"];return o[Math.abs(d)%o.length]},ar=(n,t,s)=>{if(n||t){const l=n?.[0]||"",r=t?.[0]||"";return(l+r).toUpperCase()}return s.substring(0,2).toUpperCase()};function Al(){return e.jsxs(js,{children:[e.jsx(ys,{slots:{root:me},slotProps:{root:{variant:"plain",color:"neutral",size:"sm"}},children:e.jsx(_s,{})}),e.jsxs(bs,{size:"sm",sx:{minWidth:140},children:[e.jsx(Me,{children:"Edit"}),e.jsx(Me,{children:"Reset Password"}),e.jsx(Me,{children:"Disable"}),e.jsx(Me,{color:"danger",children:"Delete"})]})]})}const El=()=>{const{isMobile:n}=Pe(),[t,s]=u.useState([]),[l,r]=u.useState(!1),[d,o]=u.useState(null),[c,h]=u.useState(""),[m,b]=u.useState("all"),[f,y]=u.useState(!1),S=async()=>{r(!0),o(null);try{const{data:p,error:_}=await N.from("users").select("*");if(_)throw _;if(p){const B=p.map(v=>({id:v.id,first_name:v.first_name||null,last_name:v.last_name||null,email:v.email,role:v.role||null,created_at:v.created_at||null,last_login:v.last_login||null,phone_number:v.phone_number||null,avatar_url:v.avatar_url||null}));console.log("User avatar URLs:",B.map(v=>({email:v.email,avatar_url:v.avatar_url}))),s(B)}}catch(p){console.error("Error fetching users:",p),o(p.message||"Failed to fetch users")}finally{r(!1)}},g=Array.from(new Set(t.map(p=>p.role).filter(Boolean))),w=[...t.filter(p=>{const B=`${p.first_name||""} ${p.last_name||""}`.trim().toLowerCase().includes(c.toLowerCase())||p.email.toLowerCase().includes(c.toLowerCase()),v=m==="all"||p.role===m;return B&&v})].sort((p,_)=>{const B=`${p.first_name||""} ${p.last_name||""}`.trim()||p.email,v=`${_.first_name||""} ${_.last_name||""}`.trim()||_.email;return B.localeCompare(v)});u.useEffect(()=>{S()},[]);const E=()=>e.jsxs(i,{sx:{width:"100%",minHeight:"100vh"},children:[e.jsxs(ke,{padding:"medium",children:[e.jsx(a,{level:"h2",sx:{mb:2,fontSize:le.sizes.xlarge},children:"Users"}),e.jsxs(i,{sx:{display:"flex",gap:1,mb:2},children:[e.jsx($,{placeholder:"Search users...",value:c,onChange:p=>h(p.target.value),startDecorator:e.jsx(Ce,{}),sx:{flex:1}}),e.jsxs(ye,{placeholder:"Role",value:m,onChange:(p,_)=>b(_??"all"),sx:{minWidth:120},children:[e.jsx(U,{value:"all",children:"All"}),g.map(p=>e.jsx(U,{value:p,children:p},p))]})]}),e.jsx(q,{variant:"solid",startDecorator:e.jsx(be,{}),onClick:()=>y(!0),sx:{width:"100%",mb:2},children:"Create User"})]}),l&&e.jsx(Ie,{}),d&&e.jsx(i,{sx:{p:2},children:e.jsxs(a,{color:"danger",children:["Error: ",d]})}),e.jsx(i,{children:w.length===0?e.jsx(i,{sx:{textAlign:"center",py:6},children:e.jsx(a,{color:"neutral",children:"No users found"})}):w.map(p=>e.jsx(i,{sx:{p:2,borderBottom:"1px solid",borderColor:"divider","&:hover":{bgcolor:"background.level1"}},children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(xe,{size:"md",src:p.avatar_url||void 0,color:ir(p.first_name,p.last_name,p.email),sx:{flexShrink:0},children:!p.avatar_url&&ar(p.first_name,p.last_name,p.email)}),e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:.5},children:[e.jsx(a,{level:"title-sm",sx:{fontWeight:"bold",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"60%"},children:`${p.first_name||""} ${p.last_name||""}`.trim()||"Unnamed User"}),p.role&&e.jsx(re,{size:"sm",color:lr(p.role),variant:"soft",sx:{fontWeight:"bold",minWidth:"fit-content",textTransform:"capitalize"},children:p.role})]}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(Ge,{sx:{fontSize:14,color:"text.tertiary"}}),e.jsx(a,{level:"body-xs",color:"neutral",children:p.email})]}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:.5},children:[p.phone_number&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(dt,{sx:{fontSize:14,color:"text.tertiary"}}),e.jsx(a,{level:"body-xs",color:"neutral",children:p.phone_number})]}),p.last_login&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(Zt,{sx:{fontSize:14,color:"text.tertiary"}}),e.jsx(a,{level:"body-xs",color:"neutral",children:new Date(p.last_login).toLocaleDateString()})]})]}),p.created_at&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(ks,{sx:{fontSize:14,color:"text.tertiary"}}),e.jsxs(a,{level:"body-xs",color:"neutral",children:["Joined ",new Date(p.created_at).toLocaleDateString()]})]})]})]})},p.id))})]}),k=()=>e.jsxs(ke,{variant:"table-page",children:[e.jsx(a,{level:"h2",sx:{mb:2,fontSize:le.sizes.xlarge},children:"Users"}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx($,{placeholder:"Search users...",sx:{flex:1},value:c,onChange:p=>h(p.target.value),startDecorator:e.jsx(Ce,{})}),e.jsxs(ye,{placeholder:"Filter role",value:m,onChange:(p,_)=>b(_??"all"),sx:{minWidth:160},children:[e.jsx(U,{value:"all",children:"All Roles"}),g.map(p=>e.jsx(U,{value:p,children:p},p))]}),e.jsx(q,{onClick:()=>y(!0),variant:"solid",startDecorator:e.jsx(be,{}),children:"Create User"})]}),e.jsxs(ce,{sx:{overflow:"visible"},children:[l&&e.jsx(Ie,{}),d&&e.jsxs(a,{color:"danger",children:["Error: ",d]}),e.jsxs(Ue,{"aria-label":"Users",sx:{tableLayout:"auto"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:rt,children:"Name"}),e.jsx("th",{style:rt,children:"Email"}),e.jsx("th",{style:rt,children:"Role"}),e.jsx("th",{style:rt,children:"Created At"}),e.jsx("th",{style:rt,children:"Last Login"}),e.jsx("th",{style:rt,children:"Phone"}),e.jsx("th",{style:{width:120,...rt},children:"Actions"})]})}),e.jsxs("tbody",{children:[w.length===0&&!l&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,style:{textAlign:"center",color:"#888",...Xe},children:"No users found."})}),w.map(p=>e.jsxs("tr",{style:{cursor:"pointer",height:48},children:[e.jsx("td",{style:Xe,children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:["                ",e.jsx(xe,{size:"sm",src:p.avatar_url||void 0,color:ir(p.first_name,p.last_name,p.email),children:!p.avatar_url&&ar(p.first_name,p.last_name,p.email)}),e.jsx(a,{level:"body-sm",fontWeight:"md",children:`${p.first_name||""} ${p.last_name||""}`.trim()||"Unnamed User"})]})}),e.jsx("td",{style:Xe,children:p.email}),e.jsx("td",{style:Xe,children:p.role?e.jsx(re,{size:"sm",color:lr(p.role),variant:"soft",sx:{textTransform:"capitalize"},children:p.role}):"-"}),e.jsx("td",{style:Xe,children:p.created_at?new Date(p.created_at).toLocaleDateString():"-"}),e.jsx("td",{style:Xe,children:p.last_login?new Date(p.last_login).toLocaleDateString():"-"}),e.jsx("td",{style:Xe,children:p.phone_number||"-"}),e.jsx("td",{children:e.jsx(Al,{})})]},p.id))]})]})]})]});return e.jsxs(Fe,{children:[n?e.jsx(E,{}):e.jsx(k,{}),e.jsx(Oe,{open:f,onClose:()=>y(!1),"aria-labelledby":"create-user-modal",children:e.jsxs(Re,{"aria-labelledby":"create-user-modal",sx:{maxWidth:600,width:"100%"},children:[e.jsx(qe,{}),e.jsx(a,{id:"create-user-modal",level:"title-md",fontWeight:"lg",sx:{mb:2},children:"Create User"}),e.jsx(a,{level:"body-sm",sx:{mb:2},children:"User creation functionality will be implemented here."}),e.jsx(q,{onClick:()=>y(!1),variant:"outlined",children:"Close"})]})})]})};function zl({open:n,onClose:t,customer:s,mode:l="add",onSaved:r}){const[d,o]=u.useState(s?.first_name||""),[c,h]=u.useState(s?.last_name||""),[m,b]=u.useState(s?.email||""),[f,y]=u.useState(s?.phone_number||""),[S,g]=u.useState(s?.role||"customer"),[C,w]=u.useState(s?.address||""),[E,k]=u.useState(s?.city||""),[p,_]=u.useState(s?.postal_code||""),[B,v]=u.useState(s?.country||""),[W,j]=u.useState(s?.notes||""),[P,T]=u.useState(s?.avatar_url||""),[F,Q]=u.useState(!1),[x,O]=u.useState(!1),[V,z]=u.useState(null),A=u.useRef(null);u.useEffect(()=>{n&&s?(o(s.first_name||""),h(s.last_name||""),b(s.email||""),y(s.phone_number||""),g(s.role||"customer"),w(s.address||""),k(s.city||""),_(s.postal_code||""),v(s.country||""),j(s.notes||""),T(s.avatar_url||"")):n&&l==="add"&&(o(""),h(""),b(""),y(""),g("customer"),w(""),k(""),_(""),v(""),j(""),T("")),z(null)},[n,s,l]);const H=async X=>{const de=X.target.files?.[0];if(de){if(!de.type.startsWith("image/")){z("Please select a valid image file");return}if(de.size>5*1024*1024){z("Image size must be less than 5MB");return}O(!0),z(null);try{const Y=de.name.split(".").pop()?.replace(/\./,"")||"png",ne=`avatars/customer_${Date.now()}.${Y}`,L=await N.storage.from("avatars").upload(ne,de,{upsert:!0,contentType:de.type});if(L.error)throw L.error;const{data:{publicUrl:J}}=N.storage.from("avatars").getPublicUrl(ne);J&&T(J)}catch(Y){z("Failed to upload avatar. Please try again."),console.error("Avatar upload failed:",Y)}finally{O(!1)}}},ae=async()=>{if(!d.trim()||!c.trim()||!m.trim()){z("First name, last name, and email are required");return}Q(!0),z(null);try{const X={first_name:d.trim(),last_name:c.trim(),email:m.trim(),phone_number:f.trim()||null,role:S,address:C.trim()||null,city:E.trim()||null,postal_code:p.trim()||null,country:B.trim()||null,notes:W.trim()||null,avatar_url:P||null};if(l==="edit"&&s?.id){const{error:de}=await N.from("users").update(X).eq("id",s.id);if(de)throw de}else{const{error:de}=await N.from("users").insert([X]);if(de)throw de}r&&r(),t()}catch(X){console.error("Error saving customer:",X),z(X.message||"Failed to save customer")}finally{Q(!1)}},he=`${d} ${c}`.trim()||"Customer",oe=l==="view";return e.jsx(Oe,{open:n,onClose:t,children:e.jsxs(Re,{sx:{maxWidth:700,width:"100%",maxHeight:"90vh",overflow:"auto"},children:[e.jsx(Ct,{children:l==="add"?"Add Customer":l==="edit"?"Edit Customer":"Customer Details"}),e.jsxs(kt,{sx:{display:"flex",flexDirection:"column",gap:3},children:[e.jsxs(i,{sx:{display:"flex",flexDirection:"row",gap:3,alignItems:"flex-start"},children:[e.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",minWidth:110},children:[e.jsx(xe,{src:P,alt:he,sx:{width:96,height:96,mb:1},children:!P&&he.substring(0,2).toUpperCase()}),!oe&&e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"file",accept:"image/*",style:{display:"none"},ref:A,onChange:H,disabled:x}),e.jsx(me,{component:"span",onClick:()=>A.current?.click(),disabled:x,title:"Upload avatar",size:"sm",sx:{mt:1},children:e.jsx(Dt,{})})]}),s?.last_login&&e.jsxs(a,{level:"body-xs",sx:{mt:1,textAlign:"center"},children:["Last login:",e.jsx("br",{}),new Date(s.last_login).toLocaleString()]})]}),e.jsx(ze,{orientation:"vertical",sx:{mx:1,alignSelf:"stretch"}}),e.jsxs(i,{sx:{flex:1,display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(i,{sx:{display:"flex",gap:2},children:[e.jsxs(i,{sx:{flex:1},children:[e.jsx(a,{level:"body-sm",sx:{mb:1},children:"First Name"}),e.jsx($,{placeholder:"First name",value:d,onChange:X=>o(X.target.value),disabled:oe,required:!0})]}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(a,{level:"body-sm",sx:{mb:1},children:"Last Name"}),e.jsx($,{placeholder:"Last name",value:c,onChange:X=>h(X.target.value),disabled:oe,required:!0})]})]}),e.jsxs(i,{children:[e.jsx(a,{level:"body-sm",sx:{mb:1},children:"Email"}),e.jsx($,{placeholder:"Email address",type:"email",value:m,onChange:X=>b(X.target.value),disabled:oe,required:!0})]}),e.jsxs(i,{sx:{display:"flex",gap:2},children:[e.jsxs(i,{sx:{flex:1},children:[e.jsx(a,{level:"body-sm",sx:{mb:1},children:"Phone Number"}),e.jsx($,{placeholder:"Phone number",type:"tel",value:f,onChange:X=>y(X.target.value),disabled:oe})]}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(a,{level:"body-sm",sx:{mb:1},children:"Customer Tier"}),e.jsxs(ye,{value:S,onChange:(X,de)=>g(de),disabled:oe,children:[e.jsx(U,{value:"customer",children:"Customer"}),e.jsx(U,{value:"vip",children:"VIP"}),e.jsx(U,{value:"premium",children:"Premium"})]})]})]})]})]}),e.jsxs(i,{children:[e.jsx(a,{level:"title-sm",sx:{mb:2},children:"Address Information"}),e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(i,{children:[e.jsx(a,{level:"body-sm",sx:{mb:1},children:"Street Address"}),e.jsx($,{placeholder:"Street address",value:C,onChange:X=>w(X.target.value),disabled:oe})]}),e.jsxs(i,{sx:{display:"flex",gap:2},children:[e.jsxs(i,{sx:{flex:1},children:[e.jsx(a,{level:"body-sm",sx:{mb:1},children:"City"}),e.jsx($,{placeholder:"City",value:E,onChange:X=>k(X.target.value),disabled:oe})]}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(a,{level:"body-sm",sx:{mb:1},children:"Postal Code"}),e.jsx($,{placeholder:"Postal code",value:p,onChange:X=>_(X.target.value),disabled:oe})]}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(a,{level:"body-sm",sx:{mb:1},children:"Country"}),e.jsx($,{placeholder:"Country",value:B,onChange:X=>v(X.target.value),disabled:oe})]})]})]})]}),e.jsxs(i,{children:[e.jsx(a,{level:"title-sm",sx:{mb:2},children:"Additional Information"}),e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(i,{children:[e.jsx(a,{level:"body-sm",sx:{mb:1},children:"Avatar URL"}),e.jsx($,{placeholder:"Avatar image URL",value:P,onChange:X=>T(X.target.value),disabled:oe})]}),e.jsxs(i,{children:[e.jsx(a,{level:"body-sm",sx:{mb:1},children:"Notes"}),e.jsx(qt,{placeholder:"Customer notes or special instructions...",value:W,onChange:X=>j(X.target.value),disabled:oe,minRows:3})]})]})]}),V&&e.jsx(a,{color:"danger",sx:{mt:1},children:V})]}),e.jsxs(_t,{children:[e.jsx(q,{variant:"plain",onClick:t,disabled:F||x,children:"Cancel"}),!oe&&e.jsxs(q,{onClick:ae,disabled:F||x||!d.trim()||!c.trim()||!m.trim(),loading:F,children:[l==="edit"?"Update":"Create"," Customer"]})]})]})})}const et={fontSize:le.sizes.small},nt={...et,fontWeight:600,borderBottom:"1.5px solid #e0e0e0",background:"inherit"},or=n=>{switch(n?.toLowerCase()){case"customer":return"primary";case"vip":return"warning";case"premium":return"success";default:return"neutral"}},cr=(n,t,s)=>{const r=`${n||""} ${t||""}`.trim()||s;let d=0;for(let c=0;c<r.length;c++)d=r.charCodeAt(c)+((d<<5)-d);const o=["primary","success","warning","danger","neutral"];return o[Math.abs(d)%o.length]},dr=(n,t,s)=>{if(n||t){const l=n?.[0]||"",r=t?.[0]||"";return(l+r).toUpperCase()}return s.substring(0,2).toUpperCase()};function Ol({onEdit:n,onView:t}){return e.jsxs(js,{children:[e.jsx(ys,{slots:{root:me},slotProps:{root:{variant:"plain",color:"neutral",size:"sm"}},children:e.jsx(_s,{})}),e.jsxs(bs,{size:"sm",sx:{minWidth:140},children:[e.jsx(Me,{onClick:t,children:"View Orders"}),e.jsx(Me,{onClick:n,children:"Edit Customer"}),e.jsx(Me,{children:"Send Message"}),e.jsx(Me,{color:"danger",children:"Deactivate"})]})]})}const Rl=()=>{const{isMobile:n}=Pe(),[t,s]=u.useState([]),[l,r]=u.useState(!1),[d,o]=u.useState(null),[c,h]=u.useState(""),[m,b]=u.useState("all"),[f,y]=u.useState(!1),[S,g]=u.useState(),[C,w]=u.useState("add"),E=async()=>{r(!0),o(null);try{const{data:x,error:O}=await N.from("users").select("*").in("role",["customer","vip","premium",null]);if(O)throw O;if(x){const V=x.map(z=>({id:z.id,first_name:z.first_name||null,last_name:z.last_name||null,email:z.email,role:z.role||"customer",created_at:z.created_at||null,last_login:z.last_login||null,phone_number:z.phone_number||null,avatar_url:z.avatar_url||null}));s(V)}}catch(x){console.error("Error fetching customers:",x),o(x.message||"Failed to fetch customers")}finally{r(!1)}},k=()=>{g(void 0),w("add"),y(!0)},p=x=>{g(x),w("edit"),y(!0)},_=x=>{g(x),w("view"),y(!0)},B=()=>{y(!1),g(void 0)},v=()=>{E()},W=x=>({id:x.id,first_name:x.first_name||void 0,last_name:x.last_name||void 0,email:x.email,role:x.role,avatar_url:x.avatar_url||void 0,last_login:x.last_login||void 0,phone_number:x.phone_number||void 0}),j=Array.from(new Set(t.map(x=>x.role).filter(Boolean))),T=[...t.filter(x=>{const V=`${x.first_name||""} ${x.last_name||""}`.trim().toLowerCase().includes(c.toLowerCase())||x.email.toLowerCase().includes(c.toLowerCase()),z=m==="all"||x.role===m;return V&&z})].sort((x,O)=>{const V=`${x.first_name||""} ${x.last_name||""}`.trim()||x.email,z=`${O.first_name||""} ${O.last_name||""}`.trim()||O.email;return V.localeCompare(z)});u.useEffect(()=>{E()},[]);const F=()=>e.jsxs(i,{sx:{width:"100%",minHeight:"100vh"},children:[e.jsxs(ke,{padding:"medium",children:[e.jsx(a,{level:"h2",sx:{mb:2,fontSize:le.sizes.xlarge},children:"Customers"}),e.jsxs(i,{sx:{display:"flex",gap:1,mb:2},children:[e.jsx($,{placeholder:"Search customers...",value:c,onChange:x=>h(x.target.value),startDecorator:e.jsx(Ce,{}),sx:{flex:1}}),e.jsxs(ye,{placeholder:"Type",value:m,onChange:(x,O)=>b(O??"all"),sx:{minWidth:120},children:[e.jsx(U,{value:"all",children:"All"}),j.map(x=>e.jsx(U,{value:x,children:x},x))]})]}),e.jsx(q,{variant:"solid",startDecorator:e.jsx(be,{}),onClick:k,sx:{width:"100%",mb:2},children:"Add Customer"})]}),l&&e.jsx(Ie,{}),d&&e.jsx(i,{sx:{p:2},children:e.jsxs(a,{color:"danger",children:["Error: ",d]})}),e.jsx(i,{children:T.length===0?e.jsx(i,{sx:{textAlign:"center",py:6},children:e.jsx(a,{color:"neutral",children:"No customers found"})}):T.map(x=>e.jsx(i,{sx:{p:2,borderBottom:"1px solid",borderColor:"divider","&:hover":{bgcolor:"background.level1"}},children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(xe,{size:"md",src:x.avatar_url||void 0,color:cr(x.first_name,x.last_name,x.email),sx:{flexShrink:0},children:!x.avatar_url&&dr(x.first_name,x.last_name,x.email)}),e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:.5},children:[e.jsx(a,{level:"title-sm",sx:{fontWeight:"bold",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"60%"},children:`${x.first_name||""} ${x.last_name||""}`.trim()||"Unnamed Customer"}),x.role&&e.jsx(re,{size:"sm",color:or(x.role),variant:"soft",sx:{fontWeight:"bold",minWidth:"fit-content",textTransform:"capitalize"},children:x.role})]}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(Ge,{sx:{fontSize:14,color:"text.tertiary"}}),e.jsx(a,{level:"body-xs",color:"neutral",children:x.email})]}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:.5},children:[x.phone_number&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(dt,{sx:{fontSize:14,color:"text.tertiary"}}),e.jsx(a,{level:"body-xs",color:"neutral",children:x.phone_number})]}),x.last_login&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(Zt,{sx:{fontSize:14,color:"text.tertiary"}}),e.jsx(a,{level:"body-xs",color:"neutral",children:new Date(x.last_login).toLocaleDateString()})]})]}),x.created_at&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(ks,{sx:{fontSize:14,color:"text.tertiary"}}),e.jsxs(a,{level:"body-xs",color:"neutral",children:["Joined ",new Date(x.created_at).toLocaleDateString()]})]})]})]})},x.id))})]}),Q=()=>e.jsxs(ke,{variant:"table-page",children:[e.jsx(a,{level:"h2",sx:{mb:2,fontSize:le.sizes.xlarge},children:"Customers"}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx($,{placeholder:"Search customers...",sx:{flex:1},value:c,onChange:x=>h(x.target.value),startDecorator:e.jsx(Ce,{})}),e.jsxs(ye,{placeholder:"Filter type",value:m,onChange:(x,O)=>b(O??"all"),sx:{minWidth:160},children:[e.jsx(U,{value:"all",children:"All Types"}),j.map(x=>e.jsx(U,{value:x,children:x},x))]}),e.jsx(q,{onClick:k,variant:"solid",startDecorator:e.jsx(be,{}),children:"Add Customer"})]}),e.jsxs(ce,{sx:{overflow:"visible"},children:[l&&e.jsx(Ie,{}),d&&e.jsxs(a,{color:"danger",children:["Error: ",d]}),e.jsxs(Ue,{"aria-label":"Customers",sx:{tableLayout:"auto"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:nt,children:"Name"}),e.jsx("th",{style:nt,children:"Email"}),e.jsx("th",{style:nt,children:"Type"}),e.jsx("th",{style:nt,children:"Joined"}),e.jsx("th",{style:nt,children:"Last Login"}),e.jsx("th",{style:nt,children:"Phone"}),e.jsx("th",{style:{width:120,...nt},children:"Actions"})]})}),e.jsxs("tbody",{children:[T.length===0&&!l&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,style:{textAlign:"center",color:"#888",...et},children:"No customers found."})}),T.map(x=>e.jsxs("tr",{style:{cursor:"pointer",height:48},children:[e.jsx("td",{style:et,children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(xe,{size:"sm",src:x.avatar_url||void 0,color:cr(x.first_name,x.last_name,x.email),children:!x.avatar_url&&dr(x.first_name,x.last_name,x.email)}),e.jsx(a,{level:"body-sm",fontWeight:"md",children:`${x.first_name||""} ${x.last_name||""}`.trim()||"Unnamed Customer"})]})}),e.jsx("td",{style:et,children:x.email}),e.jsx("td",{style:et,children:x.role?e.jsx(re,{size:"sm",color:or(x.role),variant:"soft",sx:{textTransform:"capitalize"},children:x.role}):"-"}),e.jsx("td",{style:et,children:x.created_at?new Date(x.created_at).toLocaleDateString():"-"}),e.jsx("td",{style:et,children:x.last_login?new Date(x.last_login).toLocaleDateString():"-"}),e.jsx("td",{style:et,children:x.phone_number||"-"}),e.jsx("td",{children:e.jsx(Ol,{onEdit:()=>p(x),onView:()=>_(x)})})]},x.id))]})]})]})]});return e.jsxs(Fe,{children:[n?e.jsx(F,{}):e.jsx(Q,{}),e.jsx(zl,{open:f,onClose:B,customer:S?W(S):void 0,mode:C,onSaved:v})]})};function Tl({open:n,onClose:t,employee:s,mode:l="add",onSaved:r}){const[d,o]=u.useState(s?.first_name||""),[c,h]=u.useState(s?.last_name||""),[m,b]=u.useState(s?.email||""),[f,y]=u.useState(s?.phone_number||""),[S,g]=u.useState(s?.role||"employee"),[C,w]=u.useState(s?.department||""),[E,k]=u.useState(s?.position||""),[p,_]=u.useState(s?.avatar_url||""),[B,v]=u.useState(!1),[W,j]=u.useState(!1),[P,T]=u.useState(null),F=u.useRef(null);u.useEffect(()=>{n&&s?(o(s.first_name||""),h(s.last_name||""),b(s.email||""),y(s.phone_number||""),g(s.role||"employee"),w(s.department||""),k(s.position||""),_(s.avatar_url||"")):n&&l==="add"&&(o(""),h(""),b(""),y(""),g("employee"),w(""),k(""),_("")),T(null)},[n,s,l]);const Q=async z=>{const A=z.target.files?.[0];if(A){if(!A.type.startsWith("image/")){T("Please select a valid image file");return}if(A.size>5*1024*1024){T("Image size must be less than 5MB");return}j(!0),T(null);try{const H=A.name.split(".").pop()?.replace(/\./,"")||"png",ae=`avatars/employee_${Date.now()}.${H}`,he=await N.storage.from("avatars").upload(ae,A,{upsert:!0,contentType:A.type});if(he.error)throw he.error;const{data:{publicUrl:oe}}=N.storage.from("avatars").getPublicUrl(ae);oe&&_(oe)}catch(H){T("Failed to upload avatar. Please try again."),console.error("Avatar upload failed:",H)}finally{j(!1)}}},x=async()=>{if(!d.trim()||!c.trim()||!m.trim()){T("First name, last name, and email are required");return}v(!0),T(null);try{const z={first_name:d.trim(),last_name:c.trim(),email:m.trim(),phone_number:f.trim()||null,role:S,department:C.trim()||null,position:E.trim()||null,avatar_url:p||null};if(l==="edit"&&s?.id){const{error:A}=await N.from("users").update(z).eq("id",s.id);if(A)throw A}else{const{error:A}=await N.from("users").insert([z]);if(A)throw A}r&&r(),t()}catch(z){console.error("Error saving employee:",z),T(z.message||"Failed to save employee")}finally{v(!1)}},O=`${d} ${c}`.trim()||"Employee",V=l==="view";return e.jsx(Oe,{open:n,onClose:t,children:e.jsxs(Re,{sx:{maxWidth:600,width:"100%"},children:[e.jsx(Ct,{children:l==="add"?"Add Employee":l==="edit"?"Edit Employee":"Employee Details"}),e.jsxs(kt,{sx:{display:"flex",flexDirection:"row",gap:3,alignItems:"flex-start"},children:[e.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",minWidth:110},children:[e.jsx(xe,{src:p,alt:O,sx:{width:96,height:96,mb:1},children:!p&&O.substring(0,2).toUpperCase()}),!V&&e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"file",accept:"image/*",style:{display:"none"},ref:F,onChange:Q,disabled:W}),e.jsx(me,{component:"span",onClick:()=>F.current?.click(),disabled:W,title:"Upload avatar",size:"sm",sx:{mt:1},children:e.jsx(Dt,{})})]}),s?.last_login&&e.jsxs(a,{level:"body-xs",sx:{mt:1,textAlign:"center"},children:["Last login:",e.jsx("br",{}),new Date(s.last_login).toLocaleString()]})]}),e.jsx(ze,{orientation:"vertical",sx:{mx:1,alignSelf:"stretch"}}),e.jsxs(i,{sx:{flex:1,display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(i,{sx:{display:"flex",gap:2},children:[e.jsxs(i,{sx:{flex:1},children:[e.jsx(a,{level:"body-sm",sx:{mb:1},children:"First Name"}),e.jsx($,{placeholder:"First name",value:d,onChange:z=>o(z.target.value),disabled:V,required:!0})]}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(a,{level:"body-sm",sx:{mb:1},children:"Last Name"}),e.jsx($,{placeholder:"Last name",value:c,onChange:z=>h(z.target.value),disabled:V,required:!0})]})]}),e.jsxs(i,{children:[e.jsx(a,{level:"body-sm",sx:{mb:1},children:"Email"}),e.jsx($,{placeholder:"Email address",type:"email",value:m,onChange:z=>b(z.target.value),disabled:V,required:!0})]}),e.jsxs(i,{children:[e.jsx(a,{level:"body-sm",sx:{mb:1},children:"Phone Number"}),e.jsx($,{placeholder:"Phone number",type:"tel",value:f,onChange:z=>y(z.target.value),disabled:V})]}),e.jsxs(i,{sx:{display:"flex",gap:2},children:[e.jsxs(i,{sx:{flex:1},children:[e.jsx(a,{level:"body-sm",sx:{mb:1},children:"Role"}),e.jsxs(ye,{value:S,onChange:(z,A)=>g(A),disabled:V,children:[e.jsx(U,{value:"employee",children:"Employee"}),e.jsx(U,{value:"staff",children:"Staff"}),e.jsx(U,{value:"manager",children:"Manager"}),e.jsx(U,{value:"admin",children:"Admin"})]})]}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(a,{level:"body-sm",sx:{mb:1},children:"Department"}),e.jsx($,{placeholder:"Department",value:C,onChange:z=>w(z.target.value),disabled:V})]})]}),e.jsxs(i,{children:[e.jsx(a,{level:"body-sm",sx:{mb:1},children:"Position"}),e.jsx($,{placeholder:"Job position",value:E,onChange:z=>k(z.target.value),disabled:V})]}),e.jsxs(i,{children:[e.jsx(a,{level:"body-sm",sx:{mb:1},children:"Avatar URL"}),e.jsx($,{placeholder:"Avatar image URL",value:p,onChange:z=>_(z.target.value),disabled:V})]}),P&&e.jsx(a,{color:"danger",sx:{mt:1},children:P})]})]}),e.jsxs(_t,{children:[e.jsx(q,{variant:"plain",onClick:t,disabled:B||W,children:"Cancel"}),!V&&e.jsxs(q,{onClick:x,disabled:B||W||!d.trim()||!c.trim()||!m.trim(),loading:B,children:[l==="edit"?"Update":"Create"," Employee"]})]})]})})}const tt={fontSize:le.sizes.small},lt={...tt,fontWeight:600,borderBottom:"1.5px solid #e0e0e0",background:"inherit"},ur=n=>{switch(n?.toLowerCase()){case"admin":return"danger";case"manager":return"warning";case"staff":return"success";case"employee":return"primary";case"user":return"neutral";default:return"neutral"}},hr=(n,t,s)=>{const r=`${n||""} ${t||""}`.trim()||s;let d=0;for(let c=0;c<r.length;c++)d=r.charCodeAt(c)+((d<<5)-d);const o=["primary","success","warning","danger","neutral"];return o[Math.abs(d)%o.length]},xr=(n,t,s)=>{if(n||t){const l=n?.[0]||"",r=t?.[0]||"";return(l+r).toUpperCase()}return s.substring(0,2).toUpperCase()};function Ll({employee:n,onEdit:t,onView:s}){return e.jsxs(js,{children:[e.jsx(ys,{slots:{root:me},slotProps:{root:{variant:"plain",color:"neutral",size:"sm"}},children:e.jsx(_s,{})}),e.jsxs(bs,{size:"sm",sx:{minWidth:140},children:[e.jsx(Me,{onClick:()=>t(n),children:"Edit Employee"}),e.jsx(Me,{onClick:()=>s(n),children:"View Details"}),e.jsx(Me,{children:"Change Role"}),e.jsx(Me,{children:"Reset Password"}),e.jsx(Me,{children:"Deactivate"}),e.jsx(Me,{color:"danger",children:"Remove"})]})]})}const Nl=()=>{const{isMobile:n}=Pe(),[t,s]=u.useState([]),[l,r]=u.useState(!1),[d,o]=u.useState(null),[c,h]=u.useState(""),[m,b]=u.useState("all"),[f,y]=u.useState(!1),[S,g]=u.useState(),[C,w]=u.useState("add"),E=async()=>{r(!0),o(null);try{const{data:x,error:O}=await N.from("users").select("*").in("role",["admin","manager","staff","employee","user"]);if(O)throw O;if(x){const V=x.map(z=>({id:z.id,first_name:z.first_name||null,last_name:z.last_name||null,email:z.email,role:z.role||"employee",created_at:z.created_at||null,last_login:z.last_login||null,phone_number:z.phone_number||null,avatar_url:z.avatar_url||null}));s(V)}}catch(x){console.error("Error fetching employees:",x),o(x.message||"Failed to fetch employees")}finally{r(!1)}},k=()=>{g(void 0),w("add"),y(!0)},p=x=>{g(x),w("edit"),y(!0)},_=x=>{g(x),w("view"),y(!0)},B=()=>{y(!1),g(void 0)},v=()=>{E()},W=x=>({id:x.id,first_name:x.first_name||void 0,last_name:x.last_name||void 0,email:x.email,role:x.role,avatar_url:x.avatar_url||void 0,last_login:x.last_login||void 0,phone_number:x.phone_number||void 0}),j=Array.from(new Set(t.map(x=>x.role).filter(Boolean))),T=[...t.filter(x=>{const V=`${x.first_name||""} ${x.last_name||""}`.trim().toLowerCase().includes(c.toLowerCase())||x.email.toLowerCase().includes(c.toLowerCase()),z=m==="all"||x.role===m;return V&&z})].sort((x,O)=>{const V=`${x.first_name||""} ${x.last_name||""}`.trim()||x.email,z=`${O.first_name||""} ${O.last_name||""}`.trim()||O.email;return V.localeCompare(z)});u.useEffect(()=>{E()},[]);const F=()=>e.jsxs(i,{sx:{width:"100%",minHeight:"100vh"},children:[e.jsxs(ke,{padding:"medium",children:[e.jsx(a,{level:"h2",sx:{mb:2,fontSize:le.sizes.xlarge},children:"Employees"}),e.jsxs(i,{sx:{display:"flex",gap:1,mb:2},children:[e.jsx($,{placeholder:"Search employees...",value:c,onChange:x=>h(x.target.value),startDecorator:e.jsx(Ce,{}),sx:{flex:1}}),e.jsxs(ye,{placeholder:"Role",value:m,onChange:(x,O)=>b(O??"all"),sx:{minWidth:120},children:[e.jsx(U,{value:"all",children:"All"}),j.map(x=>e.jsx(U,{value:x,children:x},x))]})]}),e.jsx(q,{variant:"solid",startDecorator:e.jsx(be,{}),onClick:k,sx:{width:"100%",mb:2},children:"Add Employee"})]}),l&&e.jsx(Ie,{}),d&&e.jsx(i,{sx:{p:2},children:e.jsxs(a,{color:"danger",children:["Error: ",d]})}),e.jsx(i,{children:T.length===0?e.jsx(i,{sx:{textAlign:"center",py:6},children:e.jsx(a,{color:"neutral",children:"No employees found"})}):T.map(x=>e.jsx(i,{sx:{p:2,borderBottom:"1px solid",borderColor:"divider","&:hover":{bgcolor:"background.level1"}},children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(xe,{size:"md",src:x.avatar_url||void 0,color:hr(x.first_name,x.last_name,x.email),sx:{flexShrink:0},children:!x.avatar_url&&xr(x.first_name,x.last_name,x.email)}),e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:.5},children:[e.jsx(a,{level:"title-sm",sx:{fontWeight:"bold",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"60%"},children:`${x.first_name||""} ${x.last_name||""}`.trim()||"Unnamed Employee"}),x.role&&e.jsx(re,{size:"sm",color:ur(x.role),variant:"soft",sx:{fontWeight:"bold",minWidth:"fit-content",textTransform:"capitalize"},children:x.role})]}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(Ge,{sx:{fontSize:14,color:"text.tertiary"}}),e.jsx(a,{level:"body-xs",color:"neutral",children:x.email})]}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:.5},children:[x.phone_number&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(dt,{sx:{fontSize:14,color:"text.tertiary"}}),e.jsx(a,{level:"body-xs",color:"neutral",children:x.phone_number})]}),x.last_login&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(Zt,{sx:{fontSize:14,color:"text.tertiary"}}),e.jsx(a,{level:"body-xs",color:"neutral",children:new Date(x.last_login).toLocaleDateString()})]})]}),x.created_at&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(ks,{sx:{fontSize:14,color:"text.tertiary"}}),e.jsxs(a,{level:"body-xs",color:"neutral",children:["Hired ",new Date(x.created_at).toLocaleDateString()]})]})]})]})},x.id))})]}),Q=()=>e.jsxs(ke,{variant:"table-page",children:[e.jsx(a,{level:"h2",sx:{mb:2,fontSize:le.sizes.xlarge},children:"Employees"}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx($,{placeholder:"Search employees...",sx:{flex:1},value:c,onChange:x=>h(x.target.value),startDecorator:e.jsx(Ce,{})}),e.jsxs(ye,{placeholder:"Filter role",value:m,onChange:(x,O)=>b(O??"all"),sx:{minWidth:160},children:[e.jsx(U,{value:"all",children:"All Roles"}),j.map(x=>e.jsx(U,{value:x,children:x},x))]}),e.jsx(q,{onClick:k,variant:"solid",startDecorator:e.jsx(be,{}),children:"Add Employee"})]}),e.jsxs(ce,{sx:{overflow:"visible"},children:[l&&e.jsx(Ie,{}),d&&e.jsxs(a,{color:"danger",children:["Error: ",d]}),e.jsxs(Ue,{"aria-label":"Employees",sx:{tableLayout:"auto"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:lt,children:"Name"}),e.jsx("th",{style:lt,children:"Email"}),e.jsx("th",{style:lt,children:"Role"}),e.jsx("th",{style:lt,children:"Hired"}),e.jsx("th",{style:lt,children:"Last Login"}),e.jsx("th",{style:lt,children:"Phone"}),e.jsx("th",{style:{width:120,...lt},children:"Actions"})]})}),e.jsxs("tbody",{children:[T.length===0&&!l&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,style:{textAlign:"center",color:"#888",...tt},children:"No employees found."})}),T.map(x=>e.jsxs("tr",{style:{cursor:"pointer",height:48},children:[e.jsx("td",{style:tt,children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(xe,{size:"sm",src:x.avatar_url||void 0,color:hr(x.first_name,x.last_name,x.email),children:!x.avatar_url&&xr(x.first_name,x.last_name,x.email)}),e.jsx(a,{level:"body-sm",fontWeight:"md",children:`${x.first_name||""} ${x.last_name||""}`.trim()||"Unnamed Employee"})]})}),e.jsx("td",{style:tt,children:x.email}),e.jsx("td",{style:tt,children:x.role?e.jsx(re,{size:"sm",color:ur(x.role),variant:"soft",sx:{textTransform:"capitalize"},children:x.role}):"-"}),e.jsx("td",{style:tt,children:x.created_at?new Date(x.created_at).toLocaleDateString():"-"}),e.jsx("td",{style:tt,children:x.last_login?new Date(x.last_login).toLocaleDateString():"-"}),e.jsx("td",{style:tt,children:x.phone_number||"-"}),e.jsx("td",{children:e.jsx(Ll,{employee:x,onEdit:p,onView:_})})]},x.id))]})]})]})]});return e.jsxs(Fe,{children:[n?e.jsx(F,{}):e.jsx(Q,{}),e.jsx(Tl,{open:f,onClose:B,employee:S?W(S):void 0,mode:C,onSaved:v})]})};function $l({orderId:n,editable:t,onItemsChange:s,initialItems:l=[]}){const[r,d]=u.useState(l),[o,c]=u.useState([]),[h,m]=u.useState(!1);u.useEffect(()=>{m(!0),N.from("Products").select("uuid, ProductName").then(({data:g,error:C})=>{C?console.error("Failed to fetch products:",C.message):c(g||[]),m(!1)})},[]);const b=(g,C,w)=>{d(E=>{const k=E.map((p,_)=>_===g?{...p,[C]:w}:p);return s&&s(k),k})},f=()=>{d(g=>{const C=[...g,{product_id:null,quantity_ordered:1,unit_price:0}];return s&&s(C),C})},y=g=>{d(C=>{const w=C.filter((E,k)=>k!==g);return s&&s(w),w})},S=()=>r.reduce((g,C)=>g+C.quantity_ordered*C.unit_price,0);return e.jsxs(i,{sx:{mt:0},children:[e.jsxs(i,{sx:{display:{xs:"block",md:"none"}},children:[r.length===0?e.jsx(a,{color:"neutral",textAlign:"center",sx:{py:4},children:"No items added yet"}):r.map((g,C)=>e.jsxs(i,{sx:{mb:2,p:2,border:"1px solid",borderColor:"divider",borderRadius:"md"},children:[e.jsxs(i,{sx:{mb:2},children:[e.jsx(a,{level:"body-sm",sx:{mb:1},children:"Product:"}),e.jsx(Mt,{options:o,getOptionLabel:w=>w.ProductName,value:o.find(w=>w.uuid===g.product_id)||null,onChange:(w,E)=>b(C,"product_id",E?E.uuid:null),disabled:!t,sx:{width:"100%"},isOptionEqualToValue:(w,E)=>w.uuid===E.uuid,required:!0})]}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2},children:[e.jsxs(i,{sx:{flex:1},children:[e.jsx(a,{level:"body-sm",sx:{mb:1},children:"Quantity:"}),e.jsx($,{type:"number",value:g.quantity_ordered??1,onChange:w=>b(C,"quantity_ordered",Math.max(1,Number(w.target.value))),disabled:!t,sx:{width:"100%"},required:!0})]}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(a,{level:"body-sm",sx:{mb:1},children:"Unit Price:"}),e.jsx($,{type:"number",value:g.unit_price??0,onChange:w=>b(C,"unit_price",Math.max(0,Number(w.target.value))),disabled:!t,sx:{width:"100%"},required:!0})]})]}),e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(i,{children:[e.jsx(a,{level:"body-sm",color:"neutral",children:"Total:"}),e.jsx(a,{level:"title-sm",children:fe(g.quantity_ordered*g.unit_price)})]}),t&&e.jsx(q,{size:"sm",color:"danger",onClick:()=>y(C),children:"Remove"})]})]},C)),r.length>0&&e.jsx(i,{sx:{mt:2,p:2,backgroundColor:"background.level1",borderRadius:"md",border:"1px solid",borderColor:"divider"},children:e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(a,{level:"title-sm",sx:{fontWeight:600},children:"Total:"}),e.jsx(a,{level:"title-sm",sx:{fontWeight:600,color:"primary.main"},children:fe(S())})]})}),t&&e.jsx(q,{size:"sm",variant:"soft",onClick:f,sx:{mt:1},fullWidth:!0,children:"Add Item"})]}),e.jsxs(i,{sx:{display:{xs:"none",md:"block"}},children:[e.jsxs(Ue,{size:"sm",sx:{minWidth:500,"& th":{padding:"12px 8px",fontSize:"0.875rem",fontWeight:600,borderBottom:"2px solid",borderColor:"divider"},"& td":{padding:"8px",verticalAlign:"middle"}},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:"40%"},children:"Product"}),e.jsx("th",{style:{width:"15%",textAlign:"center"},children:"Qty"}),e.jsx("th",{style:{width:"20%",textAlign:"center"},children:"Unit Price"}),e.jsx("th",{style:{width:"15%",textAlign:"right"},children:"Total"}),t&&e.jsx("th",{style:{width:"10%",textAlign:"center"}})]})}),e.jsx("tbody",{children:r.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:t?5:4,style:{textAlign:"center",padding:"2rem",color:"#888"},children:"No items added yet"})}):r.map((g,C)=>e.jsxs("tr",{children:[e.jsx("td",{style:{padding:"8px"},children:e.jsx(Mt,{options:o,getOptionLabel:w=>w.ProductName,value:o.find(w=>w.uuid===g.product_id)||null,onChange:(w,E)=>b(C,"product_id",E?E.uuid:null),disabled:!t,sx:{width:"100%"},isOptionEqualToValue:(w,E)=>w.uuid===E.uuid,required:!0})}),e.jsx("td",{style:{padding:"8px",textAlign:"center"},children:e.jsx($,{type:"number",value:g.quantity_ordered??1,onChange:w=>b(C,"quantity_ordered",Math.max(1,Number(w.target.value))),disabled:!t,sx:{width:"100%",maxWidth:100},required:!0})}),e.jsx("td",{style:{padding:"8px",textAlign:"center"},children:e.jsx($,{type:"number",value:g.unit_price??0,onChange:w=>b(C,"unit_price",Math.max(0,Number(w.target.value))),disabled:!t,sx:{width:"100%",maxWidth:120},required:!0})}),e.jsx("td",{style:{padding:"8px",textAlign:"right",fontWeight:500},children:fe(g.quantity_ordered*g.unit_price)}),t&&e.jsx("td",{style:{padding:"8px",textAlign:"center"},children:e.jsx(q,{size:"sm",color:"danger",onClick:()=>y(C),children:"Remove"})})]},C))})]}),t&&e.jsx(q,{size:"sm",variant:"soft",onClick:f,sx:{mt:2},children:"Add Item"})]})]})}const ns=["Pending","Approved","Received","Cancelled"];function Nt({open:n,onClose:t,onCreated:s,mode:l="add",order:r}){const[d,o]=u.useState(r?.order_number||""),[c,h]=u.useState(r?.order_date||new Date().toISOString().slice(0,10)),[m,b]=u.useState(r?.status||"Pending"),[f,y]=u.useState(r?.total?String(r.total):""),[S,g]=u.useState(r?.notes||""),[C,w]=u.useState(r?.supplier_id||null),[E,k]=u.useState(!1),[p,_]=u.useState(null),[B,v]=u.useState([]),[W,j]=u.useState(""),[P,T]=u.useState(!1),[F,Q]=u.useState([{product_id:null,quantity_ordered:1,unit_price:0}]);u.useRef(null),u.useEffect(()=>{n?(console.log("[DialogPurchaseOrder] Modal opened"),N.from("Suppliers").select("id, name").then(({data:A})=>{v(A||[])}),(l==="edit"||l==="view")&&r?.id?N.from("purchaseorderitems").select("*").eq("purchase_order_id",r.id).then(({data:A})=>{Q(A||[])}):l==="add"&&Q([{product_id:null,quantity_ordered:1,unit_price:0}])):console.log("[DialogPurchaseOrder] Modal closed")},[n,l,r]),u.useEffect(()=>{n&&r?(o(r.order_number||""),h(r.order_date||new Date().toISOString().slice(0,10)),b(r.status||"Pending"),y(r.total?String(r.total):""),g(r.notes||""),w(r.supplier_id||null)):n&&l==="add"&&(o(""),h(new Date().toISOString().slice(0,10)),b("Pending"),y(""),g(""),w(null),j(""))},[n,r,l]);const x=async A=>{console.log("[DialogPurchaseOrder] handleSupplierAdded called");const{data:H}=await N.from("Suppliers").select("id, name");v(H||[]),A&&(w(String(A)),console.log("[DialogPurchaseOrder] New supplier set:",A)),T(!1),console.log("[DialogPurchaseOrder] DialogSupplier closed")},O=()=>{const A=new Date().toISOString().slice(0,10).replace(/-/g,""),H=Math.floor(1e3+Math.random()*9e3);return`PO-${A}-${H}`},V=()=>F.reduce((A,H)=>A+H.quantity_ordered*H.unit_price,0);u.useEffect(()=>{const A=V();y(A.toString())},[F]);const z=async()=>{console.log("[DialogPurchaseOrder] handleSave called"),k(!0),_(null);const A={order_date:c,status:m,notes:S,supplier_id:C,total:f?parseFloat(f):null};l==="edit"?A.order_number=d:l==="add"&&(A.order_number=O());let H,ae=r?.id;if(l==="add"?(H=await N.from("PurchaseOrders").insert([A]).select(),!H.error&&H.data&&H.data[0]&&(ae=H.data[0].id)):r&&(H=await N.from("PurchaseOrders").update(A).eq("id",r.id)),H&&!H.error&&l==="add"&&ae&&F.length>0){const he=F.filter(X=>X.product_id).map(X=>gl({purchase_order_id:ae,product_id:X.product_id,quantity_ordered:X.quantity_ordered,unit_price:X.unit_price,notes:X.notes||null}));if(he.length===0){_("Please select a product for each item before saving."),k(!1);return}const oe=await N.from("purchaseorderitems").insert(he);if(oe.error){_("Failed to save items: "+oe.error.message),k(!1);return}}k(!1),H?.error?(_(H.error.message),console.log("[DialogPurchaseOrder] Save error:",H.error.message)):(s(),t(),o(""),h(new Date().toISOString().slice(0,10)),b("Pending"),y(""),g(""),w(null),j(""),console.log("[DialogPurchaseOrder] Purchase order saved and modal closed"))};return e.jsx(Oe,{open:n,onClose:t,"aria-labelledby":"purchase-order-form-title",children:e.jsxs(Re,{size:"lg",sx:{width:{xs:"100vw",md:"90vw"},maxWidth:{xs:"none",md:1200},height:{xs:"100vh",md:"90vh"},maxHeight:{xs:"none",md:800},overflow:"hidden",display:"flex",flexDirection:"column",m:0,borderRadius:{xs:0,md:"md"},p:0},children:[e.jsxs(i,{sx:{display:{xs:"none",md:"flex"},justifyContent:"space-between",alignItems:"center",p:2,borderBottom:"1px solid",borderColor:"divider"},children:[e.jsxs(a,{id:"purchase-order-form-title",level:"title-md",children:[l==="edit"?"Edit":l==="view"?"View":"Add"," Purchase Order"]}),e.jsx(qe,{})]}),e.jsxs(i,{sx:{display:{xs:"flex",md:"none"},justifyContent:"space-between",alignItems:"center",p:2,borderBottom:"1px solid",borderColor:"divider"},children:[e.jsxs(a,{id:"purchase-order-form-title",level:"title-md",children:[l==="edit"?"Edit":l==="view"?"View":"Add"," Purchase Order"]}),e.jsx(qe,{})]}),e.jsxs(i,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},height:"100%",overflow:"hidden"},children:[e.jsxs(i,{sx:{width:{xs:"100%",md:"400px"},borderRight:{xs:"none",md:"1px solid"},borderBottom:{xs:"1px solid",md:"none"},borderColor:"divider",p:3,overflow:"auto",flexShrink:0},children:[e.jsx(a,{level:"title-sm",sx:{mb:2},children:"Order Information"}),e.jsxs("form",{onSubmit:A=>{A.preventDefault(),l!=="view"&&z()},children:[e.jsx($,{type:"date",value:c,onChange:A=>h(A.target.value),sx:{mb:2},required:!0,readOnly:l==="view",startDecorator:e.jsx(a,{level:"body-sm",sx:{minWidth:80},children:"Date:"})}),(l==="edit"||l==="view")&&e.jsxs(i,{sx:{mb:2},children:[e.jsx(a,{level:"body-sm",sx:{mb:1},children:"Status:"}),e.jsx(re,{variant:"soft",color:m==="Approved"?"success":m==="Received"?"primary":m==="Cancelled"?"danger":"neutral",sx:{textTransform:"capitalize",fontWeight:600,fontSize:"md",px:1.5,py:.5},onClick:l==="view"?void 0:()=>{const A=ns.indexOf(m);b(ns[(A+1)%ns.length])},children:m})]}),e.jsxs(i,{sx:{mb:2},children:[e.jsx(a,{level:"body-sm",sx:{mb:1},children:"Supplier:"}),e.jsxs(i,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(Mt,{options:B,getOptionLabel:A=>A.name,value:B.find(A=>A.id===C)||null,onChange:(A,H)=>w(H?H.id:null),inputValue:W,onInputChange:(A,H)=>j(H),placeholder:"Select supplier",sx:{flex:1,mb:0},isOptionEqualToValue:(A,H)=>A.id===H.id,required:!0,readOnly:l==="view"}),l!=="view"&&e.jsx(me,{color:"primary",sx:{ml:1},onClick:()=>T(!0),children:e.jsx(be,{})})]})]}),(l==="edit"||l==="view")&&e.jsxs(e.Fragment,{children:[e.jsx($,{placeholder:"Order Number",value:d,onChange:A=>o(A.target.value),sx:{mb:2},readOnly:l==="view",startDecorator:e.jsx(a,{level:"body-sm",sx:{minWidth:80},children:"Number:"})}),e.jsx($,{placeholder:"Total",value:f,onChange:A=>y(A.target.value),sx:{mb:2},type:"number",readOnly:!0,startDecorator:e.jsx(a,{level:"body-sm",sx:{minWidth:80},children:"Total:"})})]}),e.jsx($,{placeholder:"Notes",value:S,onChange:A=>g(A.target.value),sx:{mb:2},readOnly:l==="view",startDecorator:e.jsx(a,{level:"body-sm",sx:{minWidth:80},children:"Notes:"})}),l!=="view"&&e.jsxs(i,{sx:{mt:3},children:[p&&e.jsx(a,{color:"danger",sx:{mb:2},children:p}),e.jsx(q,{type:"submit",loading:E,disabled:E,variant:"solid",fullWidth:!0,children:"Save Purchase Order"})]})]}),e.jsx(Os,{open:P,onClose:()=>T(!1),onSaved:x,mode:"add"})]}),e.jsxs(i,{sx:{flex:1,display:"flex",flexDirection:"column",minHeight:0,overflow:"hidden"},children:[e.jsx(i,{sx:{p:1,borderBottom:"0px solid",borderColor:"divider",flexShrink:0},children:e.jsx(a,{level:"title-sm",children:"Order Items"})}),e.jsx(i,{sx:{flex:1,overflow:"auto",p:2,paddingBottom:0},children:e.jsx($l,{orderId:r?.id,editable:l==="add"||l==="edit",onItemsChange:Q,initialItems:F})}),e.jsx(i,{sx:{borderTop:"1px solid",borderColor:"divider",p:3,flexShrink:0,backgroundColor:"background.level1"},children:e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",maxWidth:{xs:"100%",md:"400px"},ml:"auto"},children:[e.jsx(a,{level:"title-md",sx:{fontWeight:600},children:"Total:"}),e.jsx(a,{level:"title-md",sx:{fontWeight:600,color:"primary.main"},children:fe(V())})]})})]})]})]})})}function Os({open:n,onClose:t,onSaved:s,mode:l="add",supplier:r,onDelete:d,onEdit:o}){const[c,h]=u.useState(r?.name||""),[m,b]=u.useState(r?.contact_name||""),[f,y]=u.useState(r?.email||""),[S,g]=u.useState(r?.phone||""),[C,w]=u.useState(r?.address||""),[E,k]=u.useState(r?.image_url||""),[p,_]=u.useState(!1),[B,v]=u.useState(!1),[W,j]=u.useState(null),P=u.useRef(null),[T,F]=u.useState([]),[Q,x]=u.useState(!1),[O,V]=u.useState(null),[z,A]=u.useState(!1);u.useEffect(()=>{n&&(l==="edit"||l==="view")&&r?(h(r.name||""),b(r.contact_name||""),y(r.email||""),g(r.phone||""),w(r.address||""),k(r.image_url||""),l==="view"&&H()):n&&l==="add"&&(h(""),b(""),y(""),g(""),w(""),k(""))},[n,l,r]);const H=async()=>{if(r?.id){x(!0),V(null);try{const{data:Y,error:ne}=await N.from("PurchaseOrders").select("id, order_number, order_date, status, total, notes").eq("supplier_id",r.id).order("order_date",{ascending:!1});if(ne)throw ne;Y&&F(Y)}catch(Y){console.error("Error fetching purchase orders:",Y),V(Y.message||"Failed to fetch purchase orders")}finally{x(!1)}}},ae=()=>{A(!1),l==="view"&&H()},he=async Y=>{const ne=Y.target.files?.[0];if(ne){if(!ne.type.startsWith("image/")){j("Please select a valid image file");return}if(ne.size>5*1024*1024){j("Image size must be less than 5MB");return}try{v(!0),j(null);const L=ne.name.split(".").pop(),J=`${Date.now()}-${Math.random().toString(36).substring(2)}.${L}`,{data:ve,error:we}=await N.storage.from("supplierimages").upload(J,ne);if(we)throw we;const{data:{publicUrl:$e}}=N.storage.from("supplierimages").getPublicUrl(J);k($e)}catch(L){console.error("Error uploading image:",L),j(L.message||"Failed to upload image")}finally{v(!1)}}},oe=async()=>{if(E)try{v(!0);const Y=E.split("/").pop();Y&&await N.storage.from("supplierimages").remove([Y]),k("")}catch(Y){console.error("Error removing image:",Y),j(Y.message||"Failed to remove image")}finally{v(!1)}},X=async()=>{if(!c.trim()||!f.trim()){j("Name and email are required");return}try{_(!0),j(null);const Y={name:c.trim(),contact_name:m.trim()||null,email:f.trim(),phone:S.trim()||null,address:C.trim()||null,image_url:E||null};if(l==="edit"&&r?.id){const{error:ne}=await N.from("Suppliers").update(Y).eq("id",r.id);if(ne)throw ne}else{const{data:ne,error:L}=await N.from("Suppliers").insert([Y]).select();if(L)throw L;ne?.[0]&&s(ne[0].id)}s(),t()}catch(Y){console.error("Error saving supplier:",Y),j(Y.message||"Failed to save supplier")}finally{_(!1)}},de=async()=>{if(!(!r?.id||!d)&&confirm("Are you sure you want to delete this supplier?"))try{const{error:Y}=await N.from("Suppliers").delete().eq("id",r.id);if(Y)throw Y;d(r.id),t()}catch(Y){j(Y.message||"Failed to delete supplier")}};return e.jsxs(e.Fragment,{children:[e.jsx(Oe,{open:n,onClose:t,children:e.jsxs(Re,{sx:{minWidth:l==="view"?{xs:"90vw",sm:"80vw",md:"1000px"}:400,maxWidth:l==="view"?{xs:"95vw",sm:"90vw",md:"1200px"}:500,minHeight:l==="view"?"70vh":"auto",maxHeight:"90vh",overflow:"hidden"},children:[e.jsx(qe,{}),e.jsxs(a,{level:"title-md",sx:{mb:2},children:[l==="view"?"Supplier Details":l==="edit"?"Edit":"Add",l!=="view"?" Supplier":""]}),l==="view"?e.jsxs(i,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},gap:3,height:"100%",overflow:"hidden"},children:[e.jsxs(i,{sx:{flex:1,display:"flex",flexDirection:"column",gap:3,minWidth:{xs:"100%",md:"340px"},maxWidth:{xs:"100%",md:"420px"},borderRight:{md:"1px solid"},borderColor:"divider",pr:{md:3}},children:[e.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:[e.jsx(xe,{size:"lg",src:E,sx:{width:80,height:80},children:!E&&c&&c.substring(0,2).toUpperCase()}),e.jsx(a,{level:"h3",textAlign:"center",children:c})]}),e.jsxs(ce,{variant:"soft",children:[e.jsx(a,{level:"h4",sx:{mb:0},children:"Company"}),e.jsx(ze,{sx:{mb:0}}),e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:1},children:[e.jsxs(a,{level:"body-md",children:[e.jsx("strong",{children:"Name:"})," ",c]}),e.jsxs(a,{level:"body-md",children:[e.jsx("strong",{children:"Address:"})," ",C||"N/A"]})]})]}),e.jsxs(ce,{variant:"soft",children:[e.jsx(a,{level:"h4",sx:{mb:0},children:"Contact"}),e.jsx(ze,{sx:{mb:0}}),e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:1},children:[e.jsxs(a,{level:"body-md",children:[e.jsx("strong",{children:"Contact Name:"})," ",m||"N/A"]}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1},children:[e.jsxs(a,{level:"body-md",sx:{flex:1,minWidth:0},children:[e.jsx("strong",{children:"Email:"})," ",f||"N/A"]}),f&&e.jsx(q,{size:"sm",variant:"outlined",startDecorator:e.jsx(Ge,{}),onClick:()=>window.open(`mailto:${f}`,"_self"),sx:{flexShrink:0},children:"Email"})]}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1},children:[e.jsxs(a,{level:"body-md",sx:{flex:1,minWidth:0},children:[e.jsx("strong",{children:"Phone:"})," ",S||"N/A"]}),S&&e.jsx(q,{size:"sm",variant:"outlined",startDecorator:e.jsx(dt,{}),onClick:()=>window.open(`tel:${S}`,"_self"),sx:{flexShrink:0},children:"Call"})]})]})]}),e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:2,mt:"auto"},children:[e.jsx(q,{variant:"solid",startDecorator:e.jsx(be,{}),onClick:()=>A(!0),sx:{width:"100%"},children:"Add Purchase Order"}),e.jsx(q,{variant:"outlined",startDecorator:e.jsx(ct,{}),onClick:o,sx:{width:"100%"},children:"Edit Supplier"})]})]}),e.jsxs(i,{sx:{flex:2,display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsx(a,{level:"h3",sx:{mb:2},children:"Purchase Orders"}),Q&&e.jsx(a,{children:"Loading purchase orders..."}),O&&e.jsxs(a,{color:"danger",children:["Error: ",O]}),e.jsx(i,{sx:{flex:1,overflow:"auto"},children:e.jsxs(Ue,{stickyHeader:!0,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Order #"}),e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Total"}),e.jsx("th",{children:"Notes"})]})}),e.jsxs("tbody",{children:[T.map(Y=>e.jsxs("tr",{children:[e.jsx("td",{children:Y.order_number}),e.jsx("td",{children:Y.order_date}),e.jsx("td",{children:Y.status}),e.jsx("td",{children:Y.total!=null?fe(Y.total):"—"}),e.jsx("td",{children:Y.notes||""})]},Y.id)),T.length===0&&!Q&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,style:{textAlign:"center",color:"#888"},children:"No purchase orders for this supplier."})})]})]})})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",mb:3,gap:2},children:[e.jsx(a,{level:"body-sm",children:"Supplier Avatar"}),e.jsxs(i,{sx:{position:"relative"},children:[e.jsx(xe,{size:"lg",src:E,sx:{width:80,height:80},children:!E&&c&&c.substring(0,2).toUpperCase()}),E&&e.jsx(me,{size:"sm",variant:"solid",color:"danger",sx:{position:"absolute",top:-8,right:-8,width:24,height:24},onClick:oe,children:e.jsx(Ds,{sx:{fontSize:14}})})]}),e.jsxs(i,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx("input",{type:"file",accept:"image/*",onChange:he,style:{display:"none"},ref:P,disabled:B}),e.jsx(q,{variant:"outlined",size:"sm",loading:B,onClick:()=>P.current?.click(),startDecorator:e.jsx(Dt,{}),children:E?"Change Image":"Upload Image"})]}),e.jsx(a,{level:"body-xs",color:"neutral",sx:{textAlign:"center"},children:"Max 5MB (JPG, PNG, GIF)"})]}),e.jsxs("form",{onSubmit:Y=>{Y.preventDefault(),Y.stopPropagation(),X()},children:[e.jsx($,{placeholder:"Name",value:c,onChange:Y=>h(Y.target.value),sx:{mb:2},required:!0}),e.jsx($,{placeholder:"Contact Name",value:m,onChange:Y=>b(Y.target.value),sx:{mb:2}}),e.jsx($,{placeholder:"Email",value:f,onChange:Y=>y(Y.target.value),sx:{mb:2},type:"email",required:!0}),e.jsx($,{placeholder:"Phone",value:S,onChange:Y=>g(Y.target.value),sx:{mb:2},type:"tel"}),e.jsx($,{placeholder:"Address",value:C,onChange:Y=>w(Y.target.value),sx:{mb:2}}),W&&e.jsx(a,{color:"danger",sx:{mb:1},children:W}),e.jsxs(i,{sx:{display:"flex",gap:1,justifyContent:"space-between"},children:[e.jsx(q,{type:"submit",loading:p,disabled:p,variant:"solid",sx:{flex:1},children:l==="edit"?"Update":"Save"}),l==="edit"&&r?.id&&d&&e.jsx(q,{variant:"outlined",color:"danger",startDecorator:e.jsx(pt,{}),onClick:de,disabled:p,children:"Delete"})]})]})]})]})}),e.jsx(Nt,{open:z,onClose:()=>A(!1),onCreated:ae,mode:"add",order:r?.id?{id:"",order_number:"",order_date:"",status:"",total:0,notes:"",supplier_id:r.id.toString()}:void 0})]})}const mr=n=>{let t=0;for(let l=0;l<n.length;l++)t=n.charCodeAt(l)+((t<<5)-t);const s=["primary","success","warning","danger","neutral"];return s[Math.abs(t)%s.length]},pr=n=>{const t=n.split(" ");return t.length>=2?(t[0][0]+t[1][0]).toUpperCase():n.substring(0,2).toUpperCase()},Ml=()=>{const{isMobile:n}=Pe(),[t,s]=u.useState([]),[l,r]=u.useState(!1),[d,o]=u.useState(null),[c,h]=u.useState(""),[m,b]=u.useState(!1),[f,y]=u.useState(null),[S,g]=u.useState("view"),C=async()=>{r(!0),o(null);try{const{data:j,error:P}=await N.from("Suppliers").select("*");if(P)throw P;j&&s(j)}catch(j){console.error("Error fetching suppliers:",j),o(j.message||"Failed to fetch suppliers")}finally{r(!1)}},w=j=>{y(j),g("view"),b(!0)},E=()=>{g("edit")},k=async j=>{await C()},p=async()=>{b(!1),await C()},B=[...t.filter(j=>j.name?.toLowerCase().includes(c.toLowerCase())||j.contact_name?.toLowerCase().includes(c.toLowerCase())||j.email?.toLowerCase().includes(c.toLowerCase())||j.phone?.toLowerCase().includes(c.toLowerCase())||j.address?.toLowerCase().includes(c.toLowerCase()))].sort((j,P)=>j.name.localeCompare(P.name));u.useEffect(()=>{C()},[]);const v=()=>e.jsxs(i,{sx:{pb:2},children:[e.jsxs(ke,{padding:"medium",children:[e.jsx(a,{level:"h2",sx:{mb:2,fontSize:le.sizes.xlarge},children:"Suppliers"}),e.jsx(i,{sx:{display:"flex",gap:1,mb:2},children:e.jsx($,{placeholder:"Search suppliers...",value:c,onChange:j=>h(j.target.value),startDecorator:e.jsx(Ce,{}),sx:{flex:1}})}),e.jsx(q,{variant:"solid",startDecorator:e.jsx(be,{}),onClick:()=>{y(null),g("add"),b(!0)},sx:{width:"100%",mb:2},children:"Add Supplier"})]}),l&&e.jsx(Ie,{}),d&&e.jsx(i,{sx:{p:2},children:e.jsxs(a,{color:"danger",children:["Error: ",d]})}),e.jsx(i,{children:B.length===0?e.jsx(i,{sx:{textAlign:"center",py:6},children:e.jsx(a,{color:"neutral",children:"No suppliers found"})}):B.map(j=>e.jsx(ce,{variant:"outlined",sx:{mx:2,mb:2,cursor:"pointer","&:hover":{boxShadow:"md",transform:"translateY(-2px)",transition:"all 0.2s ease-in-out"}},onClick:()=>w(j),children:e.jsx(De,{sx:{p:2},children:e.jsxs(i,{sx:{display:"flex",alignItems:"flex-start",gap:2},children:[e.jsx(xe,{size:"md",src:j.image_url,color:mr(j.name),sx:{flexShrink:0},children:!j.image_url&&pr(j.name)}),e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsx(i,{sx:{mb:1},children:e.jsx(a,{level:"title-md",sx:{fontWeight:"bold",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:j.name})}),e.jsxs(K,{spacing:.5,children:[j.contact_name&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ot,{sx:{fontSize:16,color:"text.tertiary"}}),e.jsx(a,{level:"body-sm",color:"neutral",children:j.contact_name})]}),j.email&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ge,{sx:{fontSize:16,color:"text.tertiary"}}),e.jsx(a,{level:"body-sm",color:"neutral",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:j.email})]}),j.phone&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(dt,{sx:{fontSize:16,color:"text.tertiary"}}),e.jsx(a,{level:"body-sm",color:"neutral",children:j.phone})]}),j.address&&e.jsxs(i,{sx:{display:"flex",alignItems:"flex-start",gap:1,mt:.5},children:[e.jsx(Ks,{sx:{fontSize:16,color:"text.tertiary",mt:.25}}),e.jsx(a,{level:"body-sm",color:"neutral",sx:{overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",lineHeight:1.2},children:j.address})]})]})]})]})})},j.id))})]}),W=()=>e.jsxs(ke,{variant:"table-page",children:[e.jsx(a,{level:"h2",sx:{mb:2,fontSize:le.sizes.xlarge},children:"Suppliers"}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2,alignItems:"center"},children:[e.jsx($,{placeholder:"Search suppliers...",value:c,onChange:j=>h(j.target.value),startDecorator:e.jsx(Ce,{}),sx:{flex:1}}),e.jsx(q,{variant:"solid",startDecorator:e.jsx(be,{}),onClick:()=>{y(null),g("add"),b(!0)},sx:{minWidth:140,flexShrink:0},children:"Add Supplier"})]}),l&&e.jsx(Ie,{sx:{mb:2}}),d&&e.jsxs(a,{color:"danger",sx:{mb:2},children:["Error: ",d]}),e.jsx(je,{container:!0,spacing:2,sx:{width:"calc(100% + 16px)",ml:"-8px",mt:"-8px"},children:B.length===0?e.jsx(je,{xs:12,sx:{width:"100%"},children:e.jsx(i,{sx:{textAlign:"center",py:6},children:e.jsx(a,{color:"neutral",children:"No suppliers found"})})}):B.map(j=>e.jsx(je,{xs:12,sm:6,lg:4,xl:3,sx:{display:"flex",width:"100%"},children:e.jsx(ce,{variant:"outlined",sx:{width:"100%",minHeight:"200px",cursor:"pointer",display:"flex",flexDirection:"column","&:hover":{boxShadow:"md",transform:"translateY(-2px)",transition:"all 0.2s ease-in-out"}},onClick:()=>w(j),children:e.jsxs(De,{sx:{flex:1,display:"flex",flexDirection:"column",p:2},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:[e.jsx(xe,{size:"md",src:j.image_url,color:mr(j.name),sx:{flexShrink:0},children:!j.image_url&&pr(j.name)}),e.jsx(a,{level:"title-md",fontWeight:"bold",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1,minWidth:0},children:j.name})]}),e.jsxs(K,{spacing:1.5,sx:{flex:1},children:[j.contact_name&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(ot,{sx:{fontSize:16,color:"text.tertiary",flexShrink:0}}),e.jsx(a,{level:"body-sm",color:"neutral",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1,minWidth:0},children:j.contact_name})]}),j.email&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(Ge,{sx:{fontSize:16,color:"text.tertiary",flexShrink:0}}),e.jsx(a,{level:"body-sm",color:"neutral",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1,minWidth:0},children:j.email})]}),j.phone&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(dt,{sx:{fontSize:16,color:"text.tertiary",flexShrink:0}}),e.jsx(a,{level:"body-sm",color:"neutral",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1,minWidth:0},children:j.phone})]}),j.address&&e.jsxs(i,{sx:{display:"flex",alignItems:"flex-start",gap:1.5},children:[e.jsx(Ks,{sx:{fontSize:16,color:"text.tertiary",flexShrink:0,mt:.25}}),e.jsx(a,{level:"body-sm",color:"neutral",sx:{overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",lineHeight:1.3,flex:1,minWidth:0},children:j.address})]})]})]})})},j.id))})]});return e.jsxs(Fe,{children:[n?e.jsx(v,{}):e.jsx(W,{}),e.jsx(Os,{open:m,onClose:()=>b(!1),supplier:f,onSaved:p,mode:S==="edit"||S==="add"||S==="view"?S:void 0,onDelete:S==="edit"?k:void 0,onEdit:E})]})};function Wl({open:n,onClose:t,onSaved:s,mode:l="add",storefront:r,onDelete:d,onEdit:o}){const[c,h]=u.useState(r?.name||""),[m,b]=u.useState(r?.url||""),[f,y]=u.useState(r?.logo_url||""),[S,g]=u.useState(r?.is_online||!1),[C,w]=u.useState(!1),[E,k]=u.useState(!1),[p,_]=u.useState(null),B=u.useRef(null);u.useEffect(()=>{n&&(l==="edit"||l==="view")&&r?(h(r.name||""),b(r.url||""),y(r.logo_url||""),g(r.is_online||!1)):n&&l==="add"&&(h(""),b(""),y(""),g(!1)),_(null)},[n,l,r]);const v=async Q=>{const x=Q.target.files?.[0];if(x){if(!x.type.startsWith("image/")){_("Please select a valid image file");return}if(x.size>5*1024*1024){_("Image size must be less than 5MB");return}try{k(!0),_(null);const O=x.name.split(".").pop(),V=`${Date.now()}-${Math.random().toString(36).substring(2)}.${O}`,{data:z,error:A}=await N.storage.from("storefrontlogos").upload(V,x);if(A)throw A;const{data:{publicUrl:H}}=N.storage.from("storefrontlogos").getPublicUrl(V);y(H)}catch(O){console.error("Error uploading logo:",O),_(O.message||"Failed to upload logo")}finally{k(!1)}}},W=async()=>{if(f)try{k(!0);const Q=f.split("/").pop();Q&&await N.storage.from("storefrontlogos").remove([Q]),y("")}catch(Q){console.error("Error removing logo:",Q),_(Q.message||"Failed to remove logo")}finally{k(!1)}},j=async()=>{if(!c.trim()){_("Name is required");return}try{w(!0),_(null);const Q={name:c.trim(),url:m.trim()||null,logo_url:f||null,is_online:S};if(l==="edit"&&r?.id){const{error:x}=await N.from("storefronts").update(Q).eq("id",r.id);if(x)throw x}else{const{data:x,error:O}=await N.from("storefronts").insert([Q]).select();if(O)throw O;x?.[0]&&s(x[0].id)}s(),t()}catch(Q){console.error("Error saving storefront:",Q),_(Q.message||"Failed to save storefront")}finally{w(!1)}},P=async()=>{if(!(!r?.id||!d)&&confirm("Are you sure you want to delete this storefront?"))try{const{error:Q}=await N.from("storefronts").delete().eq("id",r.id);if(Q)throw Q;d(r.id),t()}catch(Q){_(Q.message||"Failed to delete storefront")}},T=Q=>Q.split(" ").map(x=>x.charAt(0)).join("").toUpperCase().substring(0,2),F=Q=>{const x=["primary","danger","success","warning","neutral"],O=Q.split("").reduce((V,z)=>z.charCodeAt(0)+V,0);return x[O%x.length]};return e.jsx(Oe,{open:n,onClose:t,children:e.jsxs(Re,{sx:{minWidth:l==="view"?{xs:"90vw",sm:"600px"}:400,maxWidth:l==="view"?{xs:"95vw",sm:"800px"}:500,maxHeight:"90vh",overflow:"auto"},children:[e.jsx(qe,{}),e.jsxs(a,{level:"title-md",sx:{mb:2},children:[l==="view"?"Storefront Details":l==="edit"?"Edit":"Add",l!=="view"?" Storefront":""]}),l==="view"?e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:3},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:3},children:[e.jsx(xe,{size:"lg",src:f,color:F(c),sx:{width:80,height:80},children:!f&&T(c)}),e.jsxs(i,{sx:{flex:1},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2,mb:1},children:[e.jsx(a,{level:"title-lg",fontWeight:"bold",children:c}),e.jsx(re,{size:"sm",color:S?"success":"neutral",startDecorator:e.jsx(xs,{sx:{fontSize:12}}),children:S?"Online":"Offline"})]}),m&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(Ut,{sx:{fontSize:16,color:"text.tertiary"}}),e.jsx(a,{level:"body-sm",color:"neutral",component:"a",href:m.startsWith("http")?m:`https://${m}`,target:"_blank",rel:"noopener noreferrer",sx:{textDecoration:"none","&:hover":{textDecoration:"underline"}},children:m}),e.jsx(me,{size:"sm",variant:"plain",component:"a",href:m.startsWith("http")?m:`https://${m}`,target:"_blank",rel:"noopener noreferrer",children:e.jsx(Nn,{sx:{fontSize:16}})})]})]})]}),e.jsx(ze,{}),e.jsxs(i,{sx:{display:"flex",gap:2,justifyContent:"flex-end"},children:[o&&e.jsx(q,{variant:"outlined",startDecorator:e.jsx(ct,{}),onClick:o,children:"Edit"}),d&&e.jsx(q,{variant:"outlined",color:"danger",startDecorator:e.jsx(pt,{}),onClick:P,children:"Delete"})]})]}):e.jsxs(K,{spacing:2,children:[e.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:[e.jsx(xe,{size:"lg",src:f,color:c?F(c):"neutral",sx:{width:80,height:80},children:!f&&c&&T(c)}),e.jsxs(i,{sx:{display:"flex",gap:1},children:[e.jsx("input",{type:"file",accept:"image/*",onChange:v,style:{display:"none"},ref:B}),e.jsx(q,{size:"sm",variant:"outlined",startDecorator:e.jsx(Dt,{}),onClick:()=>B.current?.click(),disabled:E,loading:E,children:"Upload Logo"}),f&&e.jsx(me,{size:"sm",variant:"outlined",color:"danger",onClick:W,disabled:E,children:e.jsx(Ds,{})})]})]}),e.jsxs(se,{required:!0,children:[e.jsx(ee,{children:"Name"}),e.jsx($,{value:c,onChange:Q=>h(Q.target.value),placeholder:"Enter storefront name"})]}),e.jsxs(se,{children:[e.jsx(ee,{children:"Website URL"}),e.jsx($,{value:m,onChange:Q=>b(Q.target.value),placeholder:"https://example.com"})]}),e.jsxs(se,{children:[e.jsx(ee,{children:"Status"}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(cn,{checked:S,onChange:Q=>g(Q.target.checked)}),e.jsx(a,{level:"body-sm",children:S?"Online":"Offline"})]})]}),p&&e.jsx(a,{color:"danger",level:"body-sm",children:p}),e.jsxs(i,{sx:{display:"flex",gap:2,justifyContent:"flex-end",mt:2},children:[e.jsx(q,{variant:"outlined",onClick:t,children:"Cancel"}),e.jsxs(q,{variant:"solid",onClick:j,loading:C,disabled:!c.trim(),children:[l==="edit"?"Update":"Add"," Storefront"]})]})]})]})})}const gr=n=>{const t=["primary","danger","success","warning","neutral"],s=n.split("").reduce((l,r)=>r.charCodeAt(0)+l,0);return t[s%t.length]},fr=n=>n.split(" ").map(t=>t.charAt(0)).join("").toUpperCase().substring(0,2),ql=()=>{const[n,t]=u.useState([]),[s,l]=u.useState(!0),[r,d]=u.useState(null),[o,c]=u.useState(""),[h,m]=u.useState(!1),[b,f]=u.useState(null),[y,S]=u.useState("add"),{isMobile:g}=Pe(),C=async()=>{try{l(!0);const{data:j,error:P}=await N.from("storefronts").select("*").order("name",{ascending:!0});if(P)throw P;t(j||[])}catch(j){d(j.message)}finally{l(!1)}};u.useEffect(()=>{C()},[]);const E=[...n.filter(j=>j.name.toLowerCase().includes(o.toLowerCase())||j.url&&j.url.toLowerCase().includes(o.toLowerCase()))].sort((j,P)=>j.is_online!==P.is_online?j.is_online?-1:1:j.name.localeCompare(P.name)),k=j=>{f(j),S("view"),m(!0)},p=()=>{S("edit")},_=()=>{C(),m(!1)},B=()=>{C(),m(!1)},v=()=>e.jsxs(i,{sx:{p:2},children:[e.jsx(a,{level:"h2",sx:{mb:2,fontSize:le.sizes.xlarge},children:"Storefronts"}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2,alignItems:"center"},children:[e.jsx($,{placeholder:"Search storefronts...",value:o,onChange:j=>c(j.target.value),startDecorator:e.jsx(Ce,{}),sx:{flex:1}}),e.jsx(q,{variant:"solid",startDecorator:e.jsx(be,{}),onClick:()=>{f(null),S("add"),m(!0)},sx:{minWidth:100,flexShrink:0},children:"Add"})]}),s&&e.jsx(Ie,{sx:{mb:2}}),r&&e.jsxs(a,{color:"danger",sx:{mb:2},children:["Error: ",r]}),e.jsx(i,{children:E.length===0?e.jsx(i,{sx:{textAlign:"center",py:6},children:e.jsx(a,{color:"neutral",children:"No storefronts found"})}):E.map(j=>e.jsx(ce,{variant:"outlined",sx:{mx:2,mb:2,cursor:"pointer","&:hover":{boxShadow:"md",transform:"translateY(-2px)",transition:"all 0.2s ease-in-out"}},onClick:()=>k(j),children:e.jsx(De,{sx:{p:2},children:e.jsxs(i,{sx:{display:"flex",alignItems:"flex-start",gap:2},children:[e.jsx(xe,{size:"md",src:j.logo_url,color:gr(j.name),sx:{flexShrink:0},children:!j.logo_url&&fr(j.name)}),e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsxs(i,{sx:{mb:1,display:"flex",alignItems:"center",gap:1},children:[e.jsx(a,{level:"title-md",sx:{fontWeight:"bold",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1},children:j.name}),e.jsx(re,{size:"sm",color:j.is_online?"success":"neutral",startDecorator:e.jsx(xs,{sx:{fontSize:12}}),children:j.is_online?"Online":"Offline"})]}),e.jsx(K,{spacing:.5,children:j.url&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ut,{sx:{fontSize:16,color:"text.tertiary"}}),e.jsx(a,{level:"body-sm",color:"neutral",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:j.url})]})})]})]})})},j.id))})]}),W=()=>e.jsxs(ke,{variant:"table-page",children:[e.jsx(a,{level:"h2",sx:{mb:2,fontSize:le.sizes.xlarge},children:"Storefronts"}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2,alignItems:"center"},children:[e.jsx($,{placeholder:"Search storefronts...",value:o,onChange:j=>c(j.target.value),startDecorator:e.jsx(Ce,{}),sx:{flex:1}}),e.jsx(q,{variant:"solid",startDecorator:e.jsx(be,{}),onClick:()=>{f(null),S("add"),m(!0)},sx:{minWidth:140,flexShrink:0},children:"Add Storefront"})]}),s&&e.jsx(Ie,{sx:{mb:2}}),r&&e.jsxs(a,{color:"danger",sx:{mb:2},children:["Error: ",r]}),e.jsx(je,{container:!0,spacing:2,sx:{width:"calc(100% + 16px)",ml:"-8px",mt:"-8px"},children:E.length===0?e.jsx(je,{xs:12,sx:{width:"100%"},children:e.jsx(i,{sx:{textAlign:"center",py:6},children:e.jsx(a,{color:"neutral",children:"No storefronts found"})})}):E.map(j=>e.jsx(je,{xs:12,sm:6,lg:4,xl:3,sx:{display:"flex",width:"100%"},children:e.jsx(ce,{variant:"outlined",sx:{width:"100%",minHeight:"160px",cursor:"pointer",display:"flex",flexDirection:"column","&:hover":{boxShadow:"md",transform:"translateY(-2px)",transition:"all 0.2s ease-in-out"}},onClick:()=>k(j),children:e.jsxs(De,{sx:{flex:1,display:"flex",flexDirection:"column",p:2},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:[e.jsx(xe,{size:"md",src:j.logo_url,color:gr(j.name),sx:{flexShrink:0},children:!j.logo_url&&fr(j.name)}),e.jsx(a,{level:"title-md",fontWeight:"bold",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1,minWidth:0},children:j.name})]}),e.jsxs(K,{spacing:1.5,sx:{flex:1},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(xs,{sx:{fontSize:16,color:j.is_online?"success.main":"neutral.main",flexShrink:0}}),e.jsx(re,{size:"sm",color:j.is_online?"success":"neutral",children:j.is_online?"Online":"Offline"})]}),j.url&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(Ut,{sx:{fontSize:16,color:"text.tertiary",flexShrink:0}}),e.jsx(a,{level:"body-sm",color:"neutral",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1,minWidth:0},children:j.url})]})]})]})})},j.id))})]});return e.jsxs(Fe,{children:[g?e.jsx(v,{}):e.jsx(W,{}),e.jsx(Wl,{open:h,onClose:()=>m(!1),storefront:b,onSaved:_,mode:y==="edit"||y==="add"||y==="view"?y:void 0,onDelete:y==="edit"?B:void 0,onEdit:p})]})},Fl=({open:n,onClose:t,poId:s,orderNumber:l,items:r,onConfirm:d})=>{const[o,c]=u.useState([]),[h,m]=u.useState(!0),[b,f]=u.useState(!1);u.useEffect(()=>{n&&(m(!0),c(r.map(g=>({id:g.id,product_id:g.product_id,ProductName:g.ProductName,quantity_ordered:g.quantity_ordered??0,quantity_received:g.quantity_received??g.quantity_ordered??0}))),m(!1))},[r,n]);const y=(g,C)=>{let w=0;if(C==="")w=0;else if(/^\d+$/.test(C))w=parseInt(C,10);else return;c(E=>E.map(k=>k.id===g?{...k,quantity_received:w}:k))},S=async()=>{try{const g=o.map(({product_id:w,quantity_received:E})=>({product_id:String(w),quantity_received:E})),C=await fetch("/api/receive-purchase-order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({purchaseOrderId:String(s),items:g})});if(!C.ok)throw new Error(`HTTP ${C.status}: ${C.statusText}`);d(o.map(w=>({id:w.id,quantity_received:w.quantity_received}))),f(!0),t()}catch(g){console.error("Error receiving purchase order:",g),alert("Failed to receive purchase order. Please try again.")}};return e.jsxs(e.Fragment,{children:[e.jsx(Oe,{open:n,onClose:t,"aria-labelledby":"receive-po-dialog-title",children:e.jsxs(Re,{sx:{minWidth:400},children:[e.jsx(qe,{}),e.jsxs(a,{id:"receive-po-dialog-title",level:"h4",sx:{mb:2},children:["Receive Purchase Order #",l??s]}),h?e.jsx(a,{children:"Loading items..."}):o.length===0?e.jsx(a,{children:"No items found for this purchase order."}):e.jsxs(Ue,{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Product"}),e.jsx("th",{children:"Ordered"}),e.jsx("th",{children:"Received"}),e.jsx("th",{children:"Status"})]})}),e.jsx("tbody",{children:o.map(g=>e.jsxs("tr",{children:[e.jsx("td",{children:g.ProductName}),e.jsx("td",{children:g.quantity_ordered}),e.jsx("td",{children:e.jsx($,{type:"number",value:g.quantity_received===0&&o.find(C=>C.id===g.id)?.quantity_received===0?"0":g.quantity_received,onChange:C=>y(g.id,C.target.value),sx:{width:80},slotProps:{input:{min:0,max:g.quantity_ordered}}})}),e.jsx("td",{style:{textAlign:"center"},children:g.quantity_received===g.quantity_ordered?e.jsx(gt,{sx:{color:"#2e7d32"},titleAccess:"Received in full"}):e.jsx(Mr,{sx:{color:"#d32f2f"},titleAccess:"Not fully received"})})]},g.id))})]}),e.jsxs(i,{sx:{display:"flex",justifyContent:"flex-end",gap:2,mt:3},children:[e.jsx(q,{variant:"plain",onClick:t,children:"Cancel"}),e.jsx(q,{variant:"solid",onClick:S,children:"Receive"})]})]})}),e.jsx(Yt,{open:b,autoHideDuration:3e3,onClose:()=>f(!1),color:"success",variant:"soft",anchorOrigin:{vertical:"top",horizontal:"center"},children:"Purchase order received successfully!"})]})};function Ul({open:n,onClose:t,order:s,onConfirm:l}){const[r,d]=u.useState(null),[o,c]=u.useState(!1),[h,m]=u.useState(!1),[b,f]=u.useState(null),[y,S]=u.useState(!1),[g,C]=u.useState(""),[w,E]=u.useState("");u.useEffect(()=>{n&&s?.supplier_id&&k()},[n,s]);const k=async()=>{if(s?.supplier_id){c(!0),f(null);try{const{data:v,error:W}=await N.from("Suppliers").select("*").eq("id",s.supplier_id).single();if(W)throw W;d(v);const{data:{user:j}}=await N.auth.getUser();j?.email&&E(j.email)}catch(v){console.error("Error fetching data:",v),f(v.message||"Failed to fetch supplier information")}finally{c(!1)}}},p=async()=>{if(!(!s||!r)){m(!0),f(null);try{const{error:v}=await N.from("PurchaseOrders").update({status:"Ordered"}).eq("id",s.id);if(v)throw v;console.log("Purchase order would be emailed to:",{to:r.email,cc:_(),subject:`Purchase Order ${s.order_number}`,orderDetails:s}),l(),t()}catch(v){console.error("Error submitting order:",v),f(v.message||"Failed to submit purchase order")}finally{m(!1)}}},_=()=>{const v=[];if(y&&w&&v.push(w),g.trim()){const W=g.split(",").map(j=>j.trim()).filter(j=>j.length>0);v.push(...W)}return v},B=()=>{S(!1),C(""),d(null),f(null),t()};return s?e.jsx(Oe,{open:n,onClose:B,children:e.jsxs(Re,{size:"md",sx:{maxWidth:600,width:"100%"},children:[e.jsx(qe,{}),e.jsx(a,{level:"h3",sx:{mb:2},children:"Submit Purchase Order"}),o?e.jsx(i,{sx:{p:3,textAlign:"center"},children:e.jsx(a,{children:"Loading supplier information..."})}):e.jsxs(K,{spacing:3,children:[e.jsxs(He,{startDecorator:e.jsx($n,{}),variant:"soft",color:"warning",children:[e.jsx(a,{level:"title-sm",children:"Email Submission"}),e.jsx(a,{level:"body-sm",children:"This will submit the purchase order via email to the supplier. Make sure all order details are correct before proceeding."})]}),r&&e.jsxs(ce,{variant:"soft",children:[e.jsx(a,{level:"title-md",sx:{mb:2},children:"Supplier Information"}),e.jsxs(K,{spacing:2,children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(Mn,{sx:{color:"text.tertiary"}}),e.jsxs(i,{children:[e.jsx(a,{level:"body-sm",color:"neutral",children:"Company"}),e.jsx(a,{level:"title-sm",children:r.name})]})]}),r.contact_name&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(ot,{sx:{color:"text.tertiary"}}),e.jsxs(i,{children:[e.jsx(a,{level:"body-sm",color:"neutral",children:"Contact Person"}),e.jsx(a,{level:"title-sm",children:r.contact_name})]})]}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(Ge,{sx:{color:"text.tertiary"}}),e.jsxs(i,{children:[e.jsx(a,{level:"body-sm",color:"neutral",children:"Email"}),e.jsx(a,{level:"title-sm",color:r.email?void 0:"danger",children:r.email||"No email address on file"})]})]}),r.phone&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(dt,{sx:{color:"text.tertiary"}}),e.jsxs(i,{children:[e.jsx(a,{level:"body-sm",color:"neutral",children:"Phone"}),e.jsx(a,{level:"title-sm",children:r.phone})]})]})]})]}),e.jsx(ze,{}),e.jsxs(i,{children:[e.jsx(a,{level:"title-md",sx:{mb:2},children:"Order Details"}),e.jsxs(K,{spacing:1,children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(a,{level:"body-sm",color:"neutral",children:"Order Number:"}),e.jsx(a,{level:"body-sm",children:s.order_number})]}),e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(a,{level:"body-sm",color:"neutral",children:"Order Date:"}),e.jsx(a,{level:"body-sm",children:new Date(s.order_date).toLocaleDateString()})]}),e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(a,{level:"body-sm",color:"neutral",children:"Total:"}),e.jsx(a,{level:"body-sm",sx:{fontWeight:"bold"},children:fe(s.total)})]})]})]}),e.jsx(ze,{}),e.jsxs(i,{children:[e.jsx(a,{level:"title-md",sx:{mb:2},children:"Email Options"}),e.jsxs(K,{spacing:2,children:[w&&e.jsx(wt,{checked:y,onChange:v=>S(v.target.checked),label:`CC me (${w})`}),e.jsxs(se,{children:[e.jsx(ee,{children:"Additional CC Recipients"}),e.jsx($,{placeholder:"email1@example.com, email2@example.com",value:g,onChange:v=>C(v.target.value),sx:{width:"100%"}}),e.jsx(a,{level:"body-xs",color:"neutral",sx:{mt:.5},children:"Separate multiple email addresses with commas"})]})]})]}),b&&e.jsx(He,{variant:"soft",color:"danger",children:e.jsx(a,{level:"body-sm",children:b})}),e.jsxs(i,{sx:{display:"flex",gap:2,justifyContent:"flex-end"},children:[e.jsx(q,{variant:"plain",onClick:B,disabled:h,children:"Cancel"}),e.jsx(q,{variant:"solid",color:"primary",onClick:p,loading:h,disabled:h||!r?.email,startDecorator:e.jsx(Ge,{}),children:"Submit Order"})]})]})]})}):null}const jr={Pending:0,Ordered:1,Approved:2,Received:3,Cancelled:4},st={fontSize:le.sizes.small},it={...st,fontWeight:600,borderBottom:"1.5px solid #e0e0e0",background:"inherit"},Et=n=>{switch(n){case"Pending":return"warning";case"Ordered":return"primary";case"Approved":return"primary";case"Received":return"success";case"Cancelled":return"danger";default:return"neutral"}},Bl=n=>{switch(n){case"Pending":return e.jsx(Xs,{});case"Ordered":return e.jsx(mt,{});case"Approved":return e.jsx(mt,{});case"Received":return e.jsx(gt,{});case"Cancelled":return e.jsx(Mr,{});default:return e.jsx(Xs,{})}},Hl=()=>{const{isMobile:n}=Pe(),[t,s]=u.useState([]),[l,r]=u.useState(!1),[d,o]=u.useState(null),[c,h]=u.useState(""),[m,b]=u.useState(""),[f,y]=u.useState(!1),[S,g]=u.useState(!1),[C,w]=u.useState(!1),[E,k]=u.useState(!1),[p,_]=u.useState(null),[B,v]=u.useState([]),[W,j]=u.useState(!1),[P,T]=u.useState(null),[F,Q]=u.useState(!1),x=async()=>{r(!0),o(null);try{const{data:L,error:J}=await N.from("PurchaseOrders").select(`
          id, 
          order_number, 
          order_date, 
          status, 
          total, 
          notes,
          supplier_id,
          Suppliers(name)
        `).order("order_date",{ascending:!1});if(J)throw J;if(L){const ve=L.map(we=>({...we,supplier_name:we.Suppliers?.name||"N/A",Suppliers:void 0}));s(ve)}}catch(L){o(L.message||"Failed to fetch purchase orders")}finally{r(!1)}},O=async L=>{try{const{data:J,error:ve}=await N.from("purchaseorderitems").select("id, product_id, Products(ProductName), quantity_ordered, quantity_received").eq("purchase_order_id",L);if(ve)throw ve;if(J){const we=J.map($e=>({...$e,ProductName:$e.Products?.ProductName||"Unknown Product"}));v(we)}}catch(J){console.error("Error fetching PO items:",J)}},V=async()=>{await x()},z=async(L,J)=>{{const ve=t.find(we=>we.id===L);ve&&(_(ve),Q(!0))}},A=async()=>{await x()},H=async L=>{_(L),await O(L.id),w(!0)},ae=async L=>{try{w(!1),_(null),await x()}catch(J){o(J.message||"Failed to receive order")}},he=async L=>{if(L)try{const{data:J,error:ve}=await N.from("Suppliers").select("*").eq("id",L).single();if(ve)throw ve;J&&(T(J),j(!0))}catch(J){console.error("Error fetching supplier:",J),o(J.message||"Failed to fetch supplier details")}},oe=L=>{_(L),L.status==="Pending"?g(!0):k(!0)},de=[...t.filter(L=>{const J=L.order_number?.toString().toLowerCase().includes(c.toLowerCase())||L.supplier_name?.toLowerCase().includes(c.toLowerCase()),ve=m?L.status===m:!0;return J&&ve})].sort((L,J)=>{const ve=jr[L.status]??99,we=jr[J.status]??99;return ve!==we?ve-we:new Date(J.order_date).getTime()-new Date(L.order_date).getTime()});u.useEffect(()=>{x()},[]);const Y=()=>e.jsxs(i,{sx:{width:"100%",minHeight:"100vh"},children:[e.jsxs(ke,{padding:"medium",children:[e.jsx(a,{level:"h2",sx:{mb:2,fontSize:le.sizes.xlarge},children:"Purchase Orders"}),e.jsxs(i,{sx:{display:"flex",gap:1,mb:2},children:[e.jsx($,{placeholder:"Search orders...",value:c,onChange:L=>h(L.target.value),startDecorator:e.jsx(Ce,{}),sx:{flex:1}}),e.jsxs(ye,{placeholder:"Status",value:m,onChange:(L,J)=>b(J??""),sx:{minWidth:120},children:[e.jsx(U,{value:"",children:"All"}),e.jsx(U,{value:"Pending",children:"Pending"}),e.jsx(U,{value:"Ordered",children:"Ordered"}),e.jsx(U,{value:"Approved",children:"Approved"}),e.jsx(U,{value:"Received",children:"Received"}),e.jsx(U,{value:"Cancelled",children:"Cancelled"})]})]}),e.jsx(q,{variant:"solid",startDecorator:e.jsx(be,{}),onClick:()=>y(!0),sx:{width:"100%",mb:2},children:"Add Purchase Order"})]}),l&&e.jsx(Ie,{}),d&&e.jsx(i,{sx:{p:2},children:e.jsxs(a,{color:"danger",children:["Error: ",d]})}),e.jsx(i,{children:de.length===0?e.jsx(i,{sx:{textAlign:"center",py:6},children:e.jsx(a,{color:"neutral",children:"No purchase orders found"})}):de.map(L=>e.jsx(i,{sx:{p:2,borderBottom:"1px solid",borderColor:"divider","&:hover":{bgcolor:"background.level1"}},onClick:()=>oe(L),title:L.status==="Pending"?"Tap to edit (pending orders are editable)":"Tap to view details",children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(i,{sx:{width:32,height:32,borderRadius:"50%",bgcolor:`${Et(L.status)}.100`,color:`${Et(L.status)}.600`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"18px",flexShrink:0},children:Bl(L.status)}),e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:.5},children:[e.jsx(a,{level:"title-sm",sx:{fontWeight:"bold",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"60%"},children:L.order_number?`Order #${L.order_number}`:e.jsx(a,{component:"span",sx:{color:"neutral.400",fontStyle:"italic"},children:"No order number"})}),e.jsx(re,{size:"sm",color:Et(L.status),variant:"soft",sx:{fontWeight:"bold",minWidth:"fit-content"},children:L.status})]}),e.jsxs(a,{level:"body-xs",color:"neutral",sx:{mb:.5},children:[e.jsx(a,{component:"span",sx:{cursor:L.supplier_id?"pointer":"default",color:L.supplier_id?"primary.600":"inherit",textDecoration:L.supplier_id?"underline":"none","&:hover":L.supplier_id?{color:"primary.800"}:{}},onClick:J=>{L.supplier_id&&(J.stopPropagation(),he(L.supplier_id))},children:L.supplier_name})," • ",new Date(L.order_date).toLocaleDateString()]}),e.jsxs(a,{level:"body-sm",sx:{fontWeight:"bold",color:"text.primary"},children:["Total: ",fe(L.total||0)]}),e.jsx(i,{sx:{display:"flex",gap:1,mt:1},children:L.status==="Pending"?e.jsx(q,{size:"sm",variant:"outlined",onClick:J=>{J.stopPropagation(),z(L.id)},children:"Order"}):e.jsx(q,{size:"sm",variant:"outlined",onClick:J=>{J.stopPropagation(),H(L)},disabled:L.status!=="Approved"&&L.status!=="Ordered",children:"Receive"})})]})]})},L.id))})]}),ne=()=>e.jsxs(ke,{variant:"table-page",children:[e.jsx(a,{level:"h2",sx:{mb:2,fontSize:le.sizes.xlarge},children:"Purchase Orders"}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx($,{placeholder:"Search purchase orders...",sx:{flex:1},value:c,onChange:L=>h(L.target.value),startDecorator:e.jsx(Ce,{})}),e.jsxs(ye,{placeholder:"Filter status",value:m,onChange:(L,J)=>b(J??""),sx:{minWidth:160},children:[e.jsx(U,{value:"",children:"All Statuses"}),e.jsx(U,{value:"Pending",children:"Pending"}),e.jsx(U,{value:"Ordered",children:"Ordered"}),e.jsx(U,{value:"Approved",children:"Approved"}),e.jsx(U,{value:"Received",children:"Received"}),e.jsx(U,{value:"Cancelled",children:"Cancelled"})]}),e.jsx(q,{onClick:()=>y(!0),variant:"solid",startDecorator:e.jsx(be,{}),children:"Add Purchase Order"})]}),e.jsxs(ce,{sx:{overflow:"visible"},children:[l&&e.jsx(Ie,{}),d&&e.jsxs(a,{color:"danger",children:["Error: ",d]}),e.jsxs(Ue,{"aria-label":"Purchase Orders",sx:{tableLayout:"auto"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:it,children:"Order Number"}),e.jsx("th",{style:it,children:"Order Date"}),e.jsx("th",{style:it,children:"Status"}),e.jsx("th",{style:it,children:"Total"}),e.jsx("th",{style:it,children:"Supplier"}),e.jsx("th",{style:it,children:"Notes"}),e.jsx("th",{style:{width:120,...it},children:"Actions"})]})}),e.jsxs("tbody",{children:[de.length===0&&!l&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,style:{textAlign:"center",color:"#888",...st},children:"No purchase orders found."})}),de.map(L=>e.jsxs("tr",{style:{cursor:"pointer",height:48},onClick:()=>oe(L),title:L.status==="Pending"?"Click to edit (pending orders are editable)":"Click to view details",children:[e.jsx("td",{style:st,children:L.order_number||e.jsx(a,{component:"span",sx:{color:"neutral.400",fontStyle:"italic"},children:"No order number"})}),e.jsx("td",{style:st,children:new Date(L.order_date).toLocaleDateString()}),e.jsx("td",{style:st,children:e.jsx(re,{size:"sm",color:Et(L.status),variant:"soft",children:L.status})}),e.jsx("td",{style:st,children:fe(L.total||0)}),e.jsx("td",{style:st,children:e.jsx(a,{component:"span",sx:{cursor:L.supplier_id?"pointer":"default",color:L.supplier_id?"primary.600":"inherit",textDecoration:L.supplier_id?"underline":"none",fontSize:le.sizes.small,"&:hover":L.supplier_id?{color:"primary.800"}:{}},onClick:J=>{L.supplier_id&&(J.stopPropagation(),he(L.supplier_id))},children:L.supplier_name})}),e.jsx("td",{style:st,children:L.notes||"-"}),e.jsx("td",{children:L.status==="Pending"?e.jsx(q,{size:"sm",variant:"outlined",onClick:J=>{J.stopPropagation(),z(L.id)},children:"Order"}):e.jsx(q,{size:"sm",variant:"outlined",onClick:J=>{J.stopPropagation(),H(L)},disabled:L.status!=="Approved"&&L.status!=="Ordered",children:"Receive"})})]},L.id))]})]})]})]});return e.jsxs(Fe,{children:[n?e.jsx(Y,{}):e.jsx(ne,{}),e.jsx(Nt,{open:f,onClose:()=>y(!1),onCreated:V,mode:"add",order:void 0}),e.jsx(Nt,{open:S,onClose:()=>{g(!1),_(null)},onCreated:V,mode:"edit",order:p?{id:p.id,order_number:p.order_number,order_date:p.order_date,status:p.status,total:p.total,notes:p.notes||"",supplier_id:p.supplier_id||""}:void 0}),e.jsx(Nt,{open:E,onClose:()=>{k(!1),_(null)},onCreated:()=>{},mode:"view",order:p?{id:p.id,order_number:p.order_number,order_date:p.order_date,status:p.status,total:p.total,notes:p.notes||"",supplier_id:p.supplier_id||""}:void 0}),e.jsx(Fl,{open:C&&!!p?.id,onClose:()=>{w(!1),_(null)},poId:p?.id||"",orderNumber:p?.order_number||"",items:B.filter(L=>!!L.id&&!!L.product_id),onConfirm:ae}),e.jsx(Os,{open:W,onClose:()=>{j(!1),T(null)},supplier:P,onSaved:()=>{},mode:"view",onEdit:()=>{}}),e.jsx(Ul,{open:F,onClose:()=>{Q(!1),_(null)},order:p?{id:p.id,order_number:p.order_number,supplier_id:p.supplier_id||"",order_date:p.order_date,total:p.total||0}:null,onConfirm:A})]})};function Vl({value:n,onChange:t,toggleSidebar:s}){const l=As(),[r,d]=u.useState(!1),[o,c]=u.useState("Sales");if(l.pathname==="/login")return null;const h=u.useMemo(()=>dn({components:{MuiTableRow:{styleOverrides:{root:{"&:hover":{backgroundColor:"rgba(0, 0, 0, 0.04)"}}}}}}),[]);ul.filter(f=>f.showInMobile);const m=o?Tt[o].filter(f=>f.showInMobile):[],b=async f=>{const{data:y}=await N.auth.getSession();if(!y&&["orders","products","users","suppliers","purchaseorders","tickets","smscampaigns","movements"].includes(f)){console.warn("Authentication required for this page"),t("home");return}t(f)};return e.jsxs(un,{theme:h,children:[e.jsxs(hn,{open:r,onClose:()=>d(!1),children:[e.jsx(xn,{children:"Select Area"}),e.jsx(mn,{children:["Sales","Support","Marketing","Operations"].map(f=>e.jsx(Bs,{fullWidth:!0,variant:o===f?"contained":"outlined",onClick:()=>{c(f),d(!1)},sx:{my:1},children:f},f))}),e.jsx(pn,{children:e.jsx(Bs,{onClick:()=>d(!1),children:"Close"})})]}),e.jsx(gn,{sx:{position:"fixed",bottom:0,left:0,right:0,zIndex:9999,backgroundColor:"rgba(0, 0, 255, 0.2)",overflow:"hidden"},children:e.jsx("div",{style:{display:"flex",flexDirection:"row",overflowX:"auto"},children:e.jsxs(fn,{showLabels:!0,value:n,onChange:(f,y)=>{b(y)},sx:{minWidth:"max-content",flex:1},children:[m.map(f=>e.jsx(Hs,{label:f.label,icon:f.icon,value:f.value,onClick:()=>b(f.value)},f.value)),e.jsx(Hs,{label:o||"",icon:e.jsx(Wn,{}),onClick:f=>{f.stopPropagation(),d(!0)}})]})})})]})}function ls({open:n,onClose:t,onCreated:s}){const[l,r]=u.useState(""),[d,o]=u.useState(""),[c,h]=u.useState(!1),[m,b]=u.useState(null),f=async y=>{y.preventDefault(),h(!0),b(null);const S={subject:l,requester_name:d,status:"Open"};console.log("[ActionDialogTicketCreate] Creating ticket with payload:",S);const{error:g,data:C}=await N.from("tickets").insert(S);g&&(b(g.message||JSON.stringify(g)),console.error("[ActionDialogTicketCreate] Error creating ticket:",g)),h(!1),g||(r(""),o(""),t(),s&&s())};return e.jsx(Oe,{open:n,onClose:t,children:e.jsxs(Re,{sx:{minWidth:400},children:[e.jsx(a,{level:"title-md",sx:{mb:2},children:"Create Ticket"}),e.jsxs("form",{onSubmit:f,children:[e.jsx($,{placeholder:"Subject",value:l,onChange:y=>r(y.target.value),sx:{mb:2},required:!0}),e.jsx($,{placeholder:"Requester Name",value:d,onChange:y=>o(y.target.value),sx:{mb:2},required:!0}),m&&e.jsx(a,{color:"danger",sx:{mb:1},children:m}),e.jsx(q,{type:"submit",loading:c,disabled:c||!l||!d,variant:"solid",children:"Create"})]})]})})}const Gl=["Refund issued","Replacement sent","Order cancelled","Technical support provided","Information provided","Awaiting customer response","Other"],Ql=({open:n,onClose:t,onSubmit:s})=>{const[l,r]=ie.useState(""),[d,o]=ie.useState("");return ie.useEffect(()=>{n||(r(""),o(""))},[n]),e.jsx(Oe,{open:n,onClose:t,children:e.jsxs(Re,{children:[e.jsx(Ct,{children:"Resolve Ticket"}),e.jsxs(kt,{sx:{display:"flex",flexDirection:"column",gap:2,minWidth:320},children:[e.jsx(ye,{value:l,onChange:(c,h)=>r(h||""),placeholder:"Select resolution",required:!0,children:Gl.map(c=>e.jsx(U,{value:c,children:c},c))}),e.jsx(qt,{minRows:3,placeholder:"Resolution comment to customer...",value:d,onChange:c=>o(c.target.value)})]}),e.jsxs(_t,{children:[e.jsx(q,{variant:"plain",onClick:t,children:"Cancel"}),e.jsx(q,{variant:"solid",color:"primary",disabled:!l,onClick:()=>{try{s(l,d),t()}catch(c){console.error("Error during form submission:",c)}},children:"Submit"})]})]})})},is=zs(Ql),yr=n=>{if(!n)return"";const t=new Date(n),l=Math.floor((new Date().getTime()-t.getTime())/1e3);if(l<60)return"Just now";const r=Math.floor(l/60);if(r<60)return`${r} min ago`;const d=Math.floor(r/60);if(d<24)return`${d} hour${d>1?"s":""} ago`;const o=Math.floor(d/24);if(o<7)return`${o} day${o>1?"s":""} ago`;const c=Math.floor(o/7);if(c<4)return`${c} week${c>1?"s":""} ago`;const h=Math.floor(o/30);return`${h} month${h>1?"s":""} ago`},ft={Open:{color:"success",label:"Open"},Pending:{color:"warning",label:"Pending"},Closed:{color:"neutral",label:"Closed"}};function Yl(){const{isMobile:n}=Pe(),[t,s]=u.useState([]),[l,r]=u.useState(null),[d,o]=u.useState([]),[c,h]=u.useState(""),[m,b]=u.useState(""),[f,y]=u.useState("Open"),[S,g]=u.useState(!1),[C,w]=u.useState(!1),[E,k]=u.useState(!1);u.useEffect(()=>{(async()=>{const{data:T,error:F}=await N.from("tickets").select("*").order("created_at",{ascending:!1});F||s(T||[])})()},[]),u.useEffect(()=>{if(!l){o([]);return}(async()=>{const{data:T,error:F}=await N.from("ticketactivities").select("*").eq("ticket_id",l).order("timestamp",{ascending:!0});F||o(T||[])})()},[l]);const p=async()=>{const{data:P,error:T}=await N.from("tickets").select("*").order("created_at",{ascending:!1});T||s(P||[])},_=async()=>{if(c.trim()&&l){console.log("Sending message:",{ticket_id:l,message:c,activity_type:"chat",sender_name:"You"});const{error:P,data:T}=await N.from("ticketactivities").insert({ticket_id:l,message:c,activity_type:"chat",sender_name:"You"}).select();if(P){console.error("Error sending message:",P),alert("Failed to send message: "+P.message);return}console.log("Message sent successfully:",T),h("");const{data:F,error:Q}=await N.from("ticketactivities").select("*").eq("ticket_id",l).order("timestamp",{ascending:!0});Q?console.error("Error fetching activities:",Q):(console.log("Refreshed activities:",F),o(F||[]))}},B=async(P,T)=>{if(l)try{const{error:F}=await N.from("tickets").update({status:"Closed"}).eq("id",l);if(F){console.error("Error updating ticket status:",F),alert("Failed to resolve ticket: "+F.message);return}const{error:Q}=await N.from("ticketactivities").insert({ticket_id:l,message:`Ticket resolved: ${P}${T?` - ${T}`:""}`,activity_type:"chat",sender_name:"You"});Q&&console.error("Error adding resolution activity:",Q),await p();const{data:x}=await N.from("ticketactivities").select("*").eq("ticket_id",l).order("timestamp",{ascending:!0});o(x||[])}catch(F){console.error("Error resolving ticket:",F),alert("Failed to resolve ticket")}},v=P=>{r(P),k(!0)},W=()=>{k(!1),r(null)},j=t.filter(P=>{if(f!=="All"&&P.status!==f)return!1;if(!m)return!0;const T=m.toLowerCase();return P.subject?.toLowerCase().includes(T)||P.requester_name?.toLowerCase().includes(T)||P.status?.toLowerCase().includes(T)});if(n){const P=t.length>0&&t.every(T=>T.status==="Closed")&&f==="Open";if(E&&l){const T=t.find(F=>F.id===l);return e.jsxs(Fe,{children:[e.jsxs(i,{sx:{display:"flex",flexDirection:"column",height:"100vh"},children:[e.jsxs(i,{sx:{px:2,py:1.5,borderBottom:"1px solid",borderColor:"divider",display:"flex",alignItems:"center",gap:2,bgcolor:"background.surface"},children:[e.jsx(me,{size:"sm",variant:"plain",onClick:W,children:e.jsx(qn,{})}),e.jsx(xe,{size:"sm",sx:{bgcolor:"primary.100",color:"primary.700",fontWeight:600},children:T?.requester_name?.[0]?.toUpperCase()||"?"}),e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsx(a,{level:"title-sm",sx:{fontWeight:600,mb:.5},children:T?.subject||"Untitled"}),e.jsx(a,{level:"body-xs",color:"neutral",children:T?.requester_name})]}),e.jsx(re,{variant:"soft",size:"sm",color:ft[T?.status||"Open"]?.color,sx:{fontWeight:600},children:ft[T?.status||"Open"]?.label}),T?.status!=="Closed"&&e.jsx(q,{variant:"solid",color:"primary",size:"sm",onClick:()=>w(!0),children:"Resolve"})]}),e.jsx(i,{sx:{flex:1,overflowY:"auto",px:2,py:2},children:e.jsx(K,{spacing:3,children:d.map((F,Q)=>{const x=F.sender_name==="You";return e.jsxs(i,{children:[Q===0||new Date(F.timestamp||"").toDateString()!==new Date(d[Q-1]?.timestamp||"").toDateString()?e.jsxs(i,{sx:{display:"flex",alignItems:"center",mb:2},children:[e.jsx(i,{sx:{flex:1,height:"1px",bgcolor:"divider"}}),e.jsx(a,{level:"body-xs",sx:{mx:2,color:"text.secondary"},children:F.timestamp?new Date(F.timestamp).toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"}):""}),e.jsx(i,{sx:{flex:1,height:"1px",bgcolor:"divider"}})]}):null,e.jsxs(K,{direction:"row",spacing:1,sx:{alignItems:"flex-start"},children:[!x&&e.jsx(xe,{size:"sm",sx:{bgcolor:"primary.100",color:"primary.700",fontWeight:600},children:F.sender_name?.[0]?.toUpperCase()||"?"}),e.jsx(i,{sx:{flex:1,display:"flex",flexDirection:x?"row-reverse":"row"},children:e.jsxs(i,{sx:{maxWidth:"85%",bgcolor:x?"primary.500":"neutral.50",color:x?"white":"text.primary",borderRadius:x?"18px 18px 4px 18px":"18px 18px 18px 4px",px:2,py:1.5,position:"relative",boxShadow:"sm"},children:[!x&&e.jsx(a,{level:"body-xs",sx:{fontWeight:600,mb:.5,color:x?"white":"text.primary"},children:F.sender_name}),e.jsx(a,{level:"body-sm",sx:{lineHeight:1.4,color:x?"white":"text.primary"},children:F.message})]})}),x&&e.jsx(xe,{size:"sm",sx:{bgcolor:"primary.100",color:"primary.700",fontWeight:600},children:F.sender_name?.[0]?.toUpperCase()||"?"})]}),e.jsx(i,{sx:{display:"flex",justifyContent:x?"flex-end":"flex-start",mt:.5,ml:x?0:5},children:e.jsx(a,{level:"body-xs",sx:{color:"text.tertiary"},children:F.timestamp?new Date(F.timestamp).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0}):""})})]},F.id)})})}),e.jsx(i,{sx:{px:2,py:1.5,borderTop:"1px solid",borderColor:"divider",bgcolor:"background.surface"},children:e.jsxs(K,{direction:"row",spacing:1,alignItems:"flex-end",children:[e.jsx(i,{sx:{flex:1},children:e.jsx(qt,{placeholder:"Type something here...",value:c,onChange:F=>h(F.target.value),minRows:1,maxRows:3,sx:{borderRadius:"20px",border:"1px solid",borderColor:"neutral.300","&:focus-within":{borderColor:"primary.500"},"& textarea":{border:"none",outline:"none",resize:"none",px:2,py:1}},onKeyDown:F=>{F.key==="Enter"&&!F.shiftKey&&(F.preventDefault(),_())}})}),e.jsx(q,{onClick:_,disabled:!c.trim(),variant:"solid",color:"primary",size:"sm",sx:{borderRadius:"20px",minWidth:50,height:36,fontWeight:600},children:"Send"})]})})]}),e.jsx(ls,{open:S,onClose:()=>g(!1),onCreated:p}),e.jsx(is,{open:C,onClose:()=>w(!1),onSubmit:B})]})}return e.jsxs(Fe,{children:[e.jsxs(i,{sx:{p:2},children:[e.jsx(a,{level:"h2",sx:{mb:3,fontWeight:600},children:"Tickets"}),e.jsxs(K,{spacing:2,sx:{mb:2},children:[e.jsxs(K,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx($,{placeholder:"Search tickets...",startDecorator:e.jsx(Ce,{}),value:m,onChange:T=>b(T.target.value),size:"sm",sx:{flex:1}}),e.jsx(me,{size:"sm",variant:"soft",color:"primary",onClick:()=>g(!0),children:e.jsx(be,{})})]}),e.jsxs(ye,{value:f,onChange:(T,F)=>y(F),size:"sm",placeholder:"Filter by status",children:[e.jsx(U,{value:"All",children:"All Tickets"}),e.jsx(U,{value:"Open",children:"Open"}),e.jsx(U,{value:"Pending",children:"Pending"}),e.jsx(U,{value:"Closed",children:"Closed"})]})]}),P?e.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"60vh",gap:2},children:[e.jsx(Fn,{sx:{fontSize:80,color:"primary.500"}}),e.jsx(a,{level:"h3",sx:{fontWeight:700,textAlign:"center"},children:"All done, you can now go to the beach"})]}):e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:0},children:[j.map((T,F)=>e.jsxs(u.Fragment,{children:[e.jsxs(i,{sx:{p:2,display:"flex",alignItems:"flex-start",gap:2,cursor:"pointer",background:"transparent",borderRadius:1,transition:"all 0.2s","&:hover":{bgcolor:"neutral.50"}},onClick:()=>v(T.id),children:[e.jsx(xe,{size:"sm",sx:{bgcolor:"primary.100",color:"primary.700",fontWeight:600,mt:.5},children:T.requester_name?.[0]?.toUpperCase()||"?"}),e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsx(a,{level:"title-sm",sx:{fontWeight:600,mb:.5,wordBreak:"break-word"},children:T.subject||"Untitled"}),e.jsx(a,{level:"body-xs",color:"neutral",sx:{mb:.5,wordBreak:"break-word"},children:T.requester_name}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(a,{level:"body-xs",color:"neutral",children:yr(T.updated_at)}),e.jsx(a,{level:"body-xs",color:"neutral",children:"•"}),e.jsxs(a,{level:"body-xs",color:"neutral",sx:{wordBreak:"break-all"},children:[T.id?.slice(0,8),"..."]})]})]}),e.jsx(re,{variant:"soft",size:"sm",color:ft[T.status||"Open"]?.color,sx:{fontWeight:600,px:1.5,py:.5,ml:1},children:ft[T.status||"Open"]?.label})]}),F<j.length-1&&e.jsx(ze,{sx:{my:.5}})]},T.id)),j.length===0&&e.jsx(a,{color:"neutral",sx:{textAlign:"center",mt:4},children:"No tickets found."})]})]}),e.jsx(ls,{open:S,onClose:()=>g(!1),onCreated:p}),e.jsx(is,{open:C,onClose:()=>w(!1),onSubmit:B})]})}return e.jsxs(i,{sx:{display:"flex",flexDirection:"column",minHeight:"100vh"},children:[e.jsxs(i,{sx:{display:"flex",flex:1},children:[e.jsxs(i,{sx:{width:390,borderRight:"1px solid",borderColor:"divider",display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsxs(i,{sx:{px:2,py:1,borderBottom:"1px solid",borderColor:"divider",flexShrink:0},children:[e.jsxs(K,{direction:"row",justifyContent:"space-between",alignItems:"center",sx:{mb:2},children:[e.jsxs(K,{direction:"row",alignItems:"center",spacing:1,children:[e.jsx(a,{level:"title-lg",children:"Messages"}),e.jsx(re,{size:"sm",variant:"soft",color:"neutral",children:j.length})]}),e.jsx(me,{size:"sm",variant:"soft",color:"primary",onClick:()=>g(!0),children:e.jsx(be,{})})]}),e.jsx($,{placeholder:"Search",startDecorator:e.jsx(Ce,{}),value:m,onChange:P=>b(P.target.value),size:"sm",sx:{width:"100%",mb:1}}),e.jsxs(ye,{value:f,onChange:(P,T)=>y(T),size:"sm",sx:{width:"100%"},placeholder:"Filter by status",children:[e.jsx(U,{value:"All",children:"All Tickets"}),e.jsx(U,{value:"Open",children:"Open"}),e.jsx(U,{value:"Pending",children:"Pending"}),e.jsx(U,{value:"Closed",children:"Closed"})]})]}),e.jsx(i,{sx:{flex:1,overflowY:"auto",overflowX:"hidden",pt:1},children:e.jsx(cs,{size:"sm",sx:{gap:0},children:j.map(P=>e.jsxs(u.Fragment,{children:[e.jsx(ds,{sx:{p:0},children:e.jsx(bt,{selected:l===P.id,onClick:()=>r(P.id),sx:{py:1,px:2},children:e.jsxs(K,{direction:"row",spacing:1.5,alignItems:"flex-start",sx:{width:"100%"},children:[e.jsx(i,{sx:{position:"relative"},children:e.jsx(xe,{size:"sm",sx:{bgcolor:"primary.100",color:"primary.700",fontWeight:600},children:P.requester_name?.[0]?.toUpperCase()||"?"})}),e.jsxs(i,{sx:{flex:1,minWidth:0,pr:1},children:[e.jsxs(K,{direction:"row",justifyContent:"space-between",alignItems:"flex-start",sx:{mb:.5},children:[e.jsx(a,{level:"body-md",noWrap:!0,sx:{flex:1,pr:1},children:P.subject||"Untitled"}),P.status&&e.jsx(re,{size:"sm",color:ft[P.status]?.color,variant:"soft",sx:{flexShrink:0},children:P.status})]}),e.jsx(a,{level:"body-sm",sx:{display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden",textOverflow:"ellipsis",mb:.5},children:P.requester_name||""}),e.jsx(i,{sx:{display:"flex",justifyContent:"flex-end"},children:e.jsx(a,{level:"body-xs",sx:{color:"text.tertiary"},children:yr(P.updated_at)})})]})]})})}),e.jsx(jn,{component:"li",sx:{margin:0}})]},P.id))})})]}),e.jsxs(i,{sx:{flex:1,display:"flex",flexDirection:"column"},children:[l&&e.jsx(i,{sx:{px:3,py:2,borderBottom:"1px solid",borderColor:"divider",flexShrink:0},children:e.jsxs(K,{direction:"row",alignItems:"center",spacing:2,children:[e.jsx(xe,{size:"sm",sx:{bgcolor:"primary.100",color:"primary.700",fontWeight:600},children:t.find(P=>P.id===l)?.requester_name?.[0]?.toUpperCase()||"?"}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(a,{level:"title-sm",sx:{fontWeight:600},children:t.find(P=>P.id===l)?.requester_name||"Unknown User"}),e.jsx(a,{level:"body-xs",sx:{color:"text.secondary"},children:t.find(P=>P.id===l)?.status||"Unknown Status"})]}),e.jsx(q,{variant:"outlined",size:"sm",sx:{borderRadius:"16px"},children:"View profile"}),t.find(P=>P.id===l)?.status!=="Closed"&&e.jsx(q,{variant:"solid",color:"primary",size:"sm",sx:{borderRadius:"16px"},onClick:()=>w(!0),children:"Resolve"})]})}),e.jsx(i,{sx:{flex:1,overflowY:"auto",px:3,py:2},children:l?e.jsx(K,{spacing:3,children:d.map((P,T)=>{const F=P.sender_name==="You";return e.jsxs(i,{children:[T===0||new Date(P.timestamp||"").toDateString()!==new Date(d[T-1]?.timestamp||"").toDateString()?e.jsxs(i,{sx:{display:"flex",alignItems:"center",mb:2},children:[e.jsx(i,{sx:{flex:1,height:"1px",bgcolor:"divider"}}),e.jsx(a,{level:"body-xs",sx:{mx:2,color:"text.secondary"},children:P.timestamp?new Date(P.timestamp).toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"}):""}),e.jsx(i,{sx:{flex:1,height:"1px",bgcolor:"divider"}})]}):null,e.jsxs(K,{direction:"row",spacing:1,sx:{alignItems:"flex-start"},children:[!F&&e.jsx(xe,{size:"sm",sx:{bgcolor:"primary.100",color:"primary.700",fontWeight:600},children:P.sender_name?.[0]?.toUpperCase()||"?"}),e.jsx(i,{sx:{flex:1,display:"flex",flexDirection:F?"row-reverse":"row"},children:e.jsxs(i,{sx:{maxWidth:"70%",bgcolor:F?"primary.500":"neutral.50",color:F?"white":"text.primary",borderRadius:F?"18px 18px 4px 18px":"18px 18px 18px 4px",px:2,py:1.5,position:"relative",boxShadow:"sm"},children:[!F&&e.jsx(a,{level:"body-xs",sx:{fontWeight:600,mb:.5,color:F?"white":"text.primary"},children:P.sender_name}),e.jsx(a,{level:"body-sm",sx:{lineHeight:1.4,color:F?"white":"text.primary"},children:P.message})]})}),F&&e.jsx(xe,{size:"sm",sx:{bgcolor:"primary.100",color:"primary.700",fontWeight:600},children:P.sender_name?.[0]?.toUpperCase()||"?"})]}),e.jsx(i,{sx:{display:"flex",justifyContent:F?"flex-end":"flex-start",mt:.5,ml:F?0:5},children:e.jsx(a,{level:"body-xs",sx:{color:"text.tertiary"},children:P.timestamp?new Date(P.timestamp).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0}):""})})]},P.id)})}):e.jsx(i,{sx:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%"},children:e.jsx(a,{level:"body-md",sx:{color:"text.secondary"},children:"Select a ticket to view messages"})})}),l&&e.jsx(i,{sx:{px:3,py:2,borderTop:"1px solid",borderColor:"divider",flexShrink:0},children:e.jsxs(K,{direction:"row",spacing:1,alignItems:"flex-end",children:[e.jsx(i,{sx:{flex:1},children:e.jsx(qt,{placeholder:"Type something here...",value:c,onChange:P=>h(P.target.value),minRows:1,maxRows:4,sx:{borderRadius:"20px",border:"1px solid",borderColor:"neutral.300","&:focus-within":{borderColor:"primary.500"},"& textarea":{border:"none",outline:"none",resize:"none",px:2,py:1}},onKeyDown:P=>{P.key==="Enter"&&!P.shiftKey&&(P.preventDefault(),_())}})}),e.jsx(q,{onClick:_,disabled:!c.trim(),variant:"solid",color:"primary",sx:{borderRadius:"20px",minWidth:60,height:40,fontWeight:600},children:"Send"})]})})]})]}),e.jsx(ls,{open:S,onClose:()=>g(!1),onCreated:p}),e.jsx(is,{open:C,onClose:()=>w(!1),onSubmit:B})]})}const br={draft:0,scheduled:1,sent:2,failed:3},Qe={fontSize:le.sizes.small},at={...Qe,fontWeight:600,borderBottom:"1.5px solid #e0e0e0",background:"inherit"},zt=n=>{switch(n){case"draft":return"neutral";case"scheduled":return"warning";case"sent":return"success";case"failed":return"danger";default:return"neutral"}},Zl=n=>{switch(n){case"draft":return e.jsx(Hn,{});case"scheduled":return e.jsx(Bn,{});case"sent":return e.jsx(gt,{});case"failed":return e.jsx(Is,{});default:return e.jsx(Un,{})}},Jl=()=>{const{isMobile:n}=Pe(),[t,s]=u.useState([]),[l,r]=u.useState(!1),[d,o]=u.useState(null),[c,h]=u.useState(""),[m,b]=u.useState(""),[f,y]=u.useState(!1),S=async()=>{r(!0),o(null);try{const{data:k,error:p}=await N.from("sms_campaigns").select("*").order("created_at",{ascending:!1});if(p)throw p;k&&s(k)}catch(k){console.error("Error fetching campaigns:",k),o(k.message||"Failed to fetch campaigns")}finally{r(!1)}},C=[...t.filter(k=>{const p=k.name.toLowerCase().includes(c.toLowerCase())||k.CampaignNumber?.toLowerCase().includes(c.toLowerCase()),_=m?k.status===m:!0;return p&&_})].sort((k,p)=>{const _=br[k.status]??99,B=br[p.status]??99;return _!==B?_-B:new Date(p.created_at).getTime()-new Date(k.created_at).getTime()});u.useEffect(()=>{S()},[]);const w=()=>e.jsxs(i,{sx:{width:"100%",minHeight:"100vh"},children:[e.jsxs(ke,{padding:"medium",children:[e.jsx(a,{level:"h2",sx:{mb:2,fontSize:le.sizes.xlarge},children:"SMS Campaigns"}),e.jsxs(i,{sx:{display:"flex",gap:1,mb:2},children:[e.jsx($,{placeholder:"Search campaigns...",value:c,onChange:k=>h(k.target.value),startDecorator:e.jsx(Ce,{}),sx:{flex:1}}),e.jsxs(ye,{placeholder:"Status",value:m,onChange:(k,p)=>b(p??""),sx:{minWidth:120},children:[e.jsx(U,{value:"",children:"All"}),e.jsx(U,{value:"draft",children:"Draft"}),e.jsx(U,{value:"scheduled",children:"Scheduled"}),e.jsx(U,{value:"sent",children:"Sent"}),e.jsx(U,{value:"failed",children:"Failed"})]})]}),e.jsx(q,{variant:"solid",startDecorator:e.jsx(be,{}),onClick:()=>y(!0),sx:{width:"100%",mb:2},children:"Create Campaign"})]}),l&&e.jsx(Ie,{}),d&&e.jsx(i,{sx:{p:2},children:e.jsxs(a,{color:"danger",children:["Error: ",d]})}),e.jsx(i,{children:C.length===0?e.jsx(i,{sx:{textAlign:"center",py:6},children:e.jsx(a,{color:"neutral",children:"No SMS campaigns found"})}):C.map(k=>e.jsx(i,{sx:{p:2,borderBottom:"1px solid",borderColor:"divider","&:hover":{bgcolor:"background.level1"}},children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(i,{sx:{width:32,height:32,borderRadius:"50%",bgcolor:`${zt(k.status)}.100`,color:`${zt(k.status)}.600`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"18px",flexShrink:0},children:Zl(k.status)}),e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:.5},children:[e.jsx(a,{level:"title-sm",sx:{fontWeight:"bold",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"60%"},children:k.name}),e.jsx(re,{size:"sm",color:zt(k.status),variant:"soft",sx:{fontWeight:"bold",minWidth:"fit-content",textTransform:"capitalize"},children:k.status})]}),e.jsxs(a,{level:"body-xs",color:"neutral",sx:{mb:.5},children:["Campaign #",k.CampaignNumber," • ",new Date(k.created_at).toLocaleDateString()]}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:.5},children:[e.jsxs(a,{level:"body-xs",color:"neutral",children:["Recipients: ",k.recipients?.length??0]}),k.scheduled_at&&e.jsxs(a,{level:"body-xs",color:"neutral",children:["Scheduled: ",es(new Date(k.scheduled_at),"MMM dd, HH:mm")]})]}),k.message&&e.jsxs(a,{level:"body-xs",color:"neutral",sx:{fontStyle:"italic",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"100%"},children:['"',k.message,'"']})]})]})},k.id))})]}),E=()=>e.jsxs(ke,{variant:"table-page",children:[e.jsx(a,{level:"h2",sx:{mb:2,fontSize:le.sizes.xlarge},children:"SMS Campaigns"}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx($,{placeholder:"Search campaigns...",sx:{flex:1},value:c,onChange:k=>h(k.target.value),startDecorator:e.jsx(Ce,{})}),e.jsxs(ye,{placeholder:"Filter status",value:m,onChange:(k,p)=>b(p??""),sx:{minWidth:160},children:[e.jsx(U,{value:"",children:"All Statuses"}),e.jsx(U,{value:"draft",children:"Draft"}),e.jsx(U,{value:"scheduled",children:"Scheduled"}),e.jsx(U,{value:"sent",children:"Sent"}),e.jsx(U,{value:"failed",children:"Failed"})]}),e.jsx(q,{onClick:()=>y(!0),variant:"solid",startDecorator:e.jsx(be,{}),children:"Create Campaign"})]}),e.jsxs(ce,{sx:{overflow:"visible"},children:[l&&e.jsx(Ie,{}),d&&e.jsxs(a,{color:"danger",children:["Error: ",d]}),e.jsxs(Ue,{"aria-label":"SMS Campaigns",sx:{tableLayout:"auto"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:at,children:"Campaign #"}),e.jsx("th",{style:at,children:"Name"}),e.jsx("th",{style:at,children:"Status"}),e.jsx("th",{style:at,children:"Scheduled"}),e.jsx("th",{style:at,children:"Sent"}),e.jsx("th",{style:at,children:"Recipients"}),e.jsx("th",{style:at,children:"Message"})]})}),e.jsxs("tbody",{children:[C.length===0&&!l&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,style:{textAlign:"center",color:"#888",...Qe},children:"No campaigns found."})}),C.map(k=>e.jsxs("tr",{style:{cursor:"pointer",height:48},children:[e.jsx("td",{style:Qe,children:k.CampaignNumber}),e.jsx("td",{style:Qe,children:k.name}),e.jsx("td",{style:Qe,children:e.jsx(re,{size:"sm",color:zt(k.status),variant:"soft",sx:{textTransform:"capitalize"},children:k.status})}),e.jsx("td",{style:Qe,children:k.scheduled_at?es(new Date(k.scheduled_at),"yyyy-MM-dd HH:mm"):"-"}),e.jsx("td",{style:Qe,children:k.sent_at?es(new Date(k.sent_at),"yyyy-MM-dd HH:mm"):"-"}),e.jsx("td",{style:Qe,children:k.recipients?.length??0}),e.jsx("td",{style:Qe,children:e.jsx(a,{level:"body-sm",sx:{maxWidth:200,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:k.message||"-"})})]},k.id))]})]})]})]});return e.jsxs(Fe,{children:[n?e.jsx(w,{}):e.jsx(E,{}),e.jsx(Oe,{open:f,onClose:()=>y(!1),children:e.jsxs(Re,{children:[e.jsx(qe,{}),e.jsx(a,{level:"h4",children:"Create New Campaign"}),e.jsx(a,{level:"body-sm",sx:{mt:1,mb:2},children:"Campaign creation functionality will be implemented here."}),e.jsx(q,{onClick:()=>y(!1),variant:"outlined",children:"Close"})]})})]})};function as(n,t){return t===0?n>0?100:0:(n-t)/t*100}function os(n){return n==null?"—":`${n>0?"+":n<0?"−":""}${Math.abs(Math.round(n))}%`}async function Kl(){const n=new Date,t=n.toISOString().slice(0,10),s=new Date(n.getTime()-30*24*60*60*1e3).toISOString().slice(0,10),l=new Date(n.getTime()-60*24*60*60*1e3).toISOString().slice(0,10),r=new Date(n.getTime()-30*24*60*60*1e3-1).toISOString().slice(0,10),d=await N.from("Orders").select("order_total, customer_email, date",{count:"exact"}).not("order_total","is",null);if(d.error||!d.data)throw new Error("Failed to fetch order stats");const o=d.data,c=o.filter(C=>C.date&&C.date>=s&&C.date<=t),h=o.filter(C=>C.date&&C.date>=l&&C.date<=r),m=c.reduce((C,w)=>C+(typeof w.order_total=="number"?w.order_total:0),0),b=h.reduce((C,w)=>C+(typeof w.order_total=="number"?w.order_total:0),0),f=c.length,y=h.length,S=new Set(c.map(C=>C.customer_email).filter(Boolean)),g=new Set(h.map(C=>C.customer_email).filter(Boolean));return{totalSales:m,orderCount:f,customerCount:S.size,salesChange:as(m,b),ordersChange:as(f,y),customersChange:as(S.size,g.size)}}const Xl=()=>{const[n,t]=u.useState(null),[s,l]=u.useState(null),[r,d]=u.useState(null),[o,c]=u.useState(null),[h,m]=u.useState(null),[b,f]=u.useState(null),[y,S]=u.useState(!0),[g,C]=u.useState(null);return Rt("(max-width:600px)"),u.useEffect(()=>{let w=!0,E=!0;async function k(){E&&S(!0),C(null);try{const{totalSales:_,orderCount:B,customerCount:v,salesChange:W,ordersChange:j,customersChange:P}=await Kl();w&&(t(_),l(B),d(v),c(W),m(j),f(P))}catch(_){w&&C(_.message)}finally{E&&S(!1),E=!1}}k();const p=setInterval(k,1e4);return()=>{w=!1,clearInterval(p)}},[]),e.jsxs(i,{sx:{p:{xs:2,md:3},pt:{xs:2,md:3},height:"100%",overflow:"auto"},children:[e.jsx(a,{level:"h2",sx:{mb:2},children:"Dashboard"}),e.jsxs(je,{container:!0,spacing:2,children:[e.jsx(je,{xs:12,md:4,children:e.jsxs(ce,{variant:"outlined",children:[e.jsx(a,{level:"h4",children:"Total Sales"}),e.jsx(a,{level:"h2",color:"success",children:y?"Loading...":g?"—":fe(n)}),e.jsxs(a,{level:"body-sm",color:"neutral",children:[y?"":os(o)," from last 30 days"]})]})}),e.jsx(je,{xs:12,md:4,children:e.jsxs(ce,{variant:"outlined",children:[e.jsx(a,{level:"h4",children:"Orders"}),e.jsx(a,{level:"h2",color:"primary",children:y?"Loading...":g?"—":s?.toLocaleString()}),e.jsxs(a,{level:"body-sm",color:"neutral",children:[y?"":os(h)," from last 30 days"]})]})}),e.jsx(je,{xs:12,md:4,children:e.jsxs(ce,{variant:"outlined",children:[e.jsx(a,{level:"h4",children:"Customers"}),e.jsx(a,{level:"h2",color:"warning",children:y?"Loading...":g?"—":r?.toLocaleString()}),e.jsxs(a,{level:"body-sm",color:"neutral",children:[y?"":os(b)," new last 30 days"]})]})})]})]})},Le=({children:n})=>{const[t,s]=u.useState(null),[l,r]=u.useState(!0);return u.useEffect(()=>{async function d(){const{data:o}=await N.auth.getSession();s(o?.session||null),r(!1)}d()},[]),l?e.jsx("div",{children:"Loading..."}):t?e.jsx(e.Fragment,{children:n}):e.jsx(Bt,{to:"/",replace:!0})};function ei(n){const{onClick:t,...s}=n,{mode:l,setMode:r}=Dr(),[d,o]=u.useState(!1);return u.useEffect(()=>o(!0),[]),e.jsx(me,{"aria-label":"toggle light/dark mode",size:"sm",variant:"outlined",disabled:!d,onClick:c=>{r(l==="light"?"dark":"light"),t?.(c)},...s,children:l==="light"?e.jsx(Er,{}):e.jsx(Gn,{})})}function ti({onLogin:n}){const t=Ps(),[s,l]=u.useState(""),[r,d]=u.useState(""),[o,c]=u.useState(!1),[h,m]=u.useState(null);u.useEffect(()=>{if(window.location.pathname==="/login"){async function f(){const{data:y}=await N.auth.getSession();y?.session&&t("/dashboard")}f()}},[t]);async function b(f){f.preventDefault(),c(!0),m(null);const{data:y,error:S}=await N.auth.signInWithPassword({email:s,password:r});if(S){console.error("[Login] Auth error:",S),m(S.message),c(!1);return}const g=y.user?.id;if(!g){m("Login failed: No user ID."),c(!1);return}let{data:C,error:w}=await N.from("users").select("*").eq("id",g).single();if(w||!C){console.error("[Login] User fetch error:",w);const k=(y.user.user_metadata?.full_name||y.user.user_metadata?.name||"").split(" "),{error:p}=await N.from("users").upsert({id:g,email:y.user.email,first_name:k[0]||"",last_name:k.slice(1).join(" ")||null,role:"employee"});if(p){console.error("Upsert failed:",p),m("Upsert failed: "+p.message),c(!1);return}let _=3,B,v;for(;_>0;){await new Promise(P=>setTimeout(P,300));const{data:W,error:j}=await N.from("users").select("*").eq("id",g).single();if(B=W,v=j,v&&console.error("[Login] Retry user fetch error:",v),B&&!v){C=B,w=null;break}_--}if(w||!C){m("Access denied: User not found."),await N.auth.signOut(),c(!1);return}}if(C.role!=="employee"){m("Access denied: Only employees can access this app."),await N.auth.signOut(),c(!1);return}c(!1),n(),t("/dashboard")}return e.jsxs(Ar,{disableTransitionOnChange:!0,children:[e.jsx(yn,{}),e.jsx(Ir,{styles:{":root":{"--Form-maxWidth":"800px","--Transition-duration":"0.4s"}}}),e.jsx(i,{sx:f=>({width:{xs:"100%",md:"50vw"},transition:"width var(--Transition-duration)",transitionDelay:"calc(var(--Transition-duration) + 0.1s)",position:"relative",zIndex:1,display:"flex",justifyContent:"flex-end",backdropFilter:"blur(12px)",backgroundColor:"rgba(255 255 255 / 0.2)",[f.getColorSchemeSelector("dark")]:{backgroundColor:"rgba(19 19 24 / 0.4)"}}),children:e.jsxs(i,{sx:{display:"flex",flexDirection:"column",minHeight:"100dvh",width:"100%",px:2},children:[e.jsxs(i,{component:"header",sx:{py:3,display:"flex",justifyContent:"space-between"},children:[e.jsxs(i,{sx:{gap:2,display:"flex",alignItems:"center"},children:[e.jsx(me,{variant:"soft",color:"primary",size:"sm",children:e.jsx(Vn,{})}),e.jsx(a,{level:"title-lg",children:"SmartBack"})]}),e.jsx(ei,{})]}),e.jsxs(i,{component:"main",sx:{my:"auto",py:2,pb:5,display:"flex",flexDirection:"column",gap:2,width:400,maxWidth:"100%",mx:"auto",borderRadius:"sm","& form":{display:"flex",flexDirection:"column",gap:2},"& .MuiFormLabel-asterisk":{visibility:"hidden"}},children:[e.jsx(K,{sx:{gap:4,mb:2},children:e.jsxs(K,{sx:{gap:1},children:[e.jsx(a,{component:"h1",level:"h3",children:"Sign in"}),e.jsx(a,{level:"body-sm",children:"Welcome back to SmartBack! Please sign in to continue."})]})}),e.jsx(K,{sx:{gap:4,mt:2},children:e.jsxs("form",{onSubmit:b,children:[e.jsxs(se,{required:!0,children:[e.jsx(ee,{children:"Email"}),e.jsx($,{type:"email",name:"email",value:s,onChange:f=>l(f.target.value),placeholder:"your@email.com",disabled:o})]}),e.jsxs(se,{required:!0,children:[e.jsx(ee,{children:"Password"}),e.jsx($,{type:"password",name:"password",value:r,onChange:f=>d(f.target.value),placeholder:"••••••",disabled:o})]}),e.jsxs(K,{sx:{gap:4,mt:2},children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(wt,{size:"sm",label:"Remember me",name:"persistent"}),e.jsx(bn,{level:"title-sm",href:"#forgot-password",children:"Forgot your password?"})]}),e.jsx(q,{type:"submit",fullWidth:!0,loading:o,children:"Sign in"})]})]})}),h&&e.jsx(i,{sx:{mt:2},children:e.jsx(a,{level:"body-sm",color:"danger",children:h})})]}),e.jsx(i,{component:"footer",sx:{py:3},children:e.jsxs(a,{level:"body-xs",sx:{textAlign:"center"},children:["© SmartBack ",new Date().getFullYear()]})})]})}),e.jsx(i,{sx:f=>({height:"100%",position:"fixed",right:0,top:0,bottom:0,left:{xs:0,md:"50vw"},transition:"background-image var(--Transition-duration), left var(--Transition-duration) !important",transitionDelay:"calc(var(--Transition-duration) + 0.1s)",backgroundColor:"background.level1",backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat",backgroundImage:"url(https://images.unsplash.com/photo-1527181152855-fc03fc7949c8?auto=format&w=1000&dpr=2)",[f.getColorSchemeSelector("dark")]:{backgroundImage:"url(https://images.unsplash.com/photo-1572072393749-3ca9c8ea0831?auto=format&w=1000&dpr=2)"}})})]})}function si(){return e.jsx(Es,{children:e.jsx(_e,{path:"*",element:e.jsx(ti,{onLogin:()=>{}})})})}const Ee={fontSize:le.sizes.small},ri=()=>{const{isMobile:n}=Pe();Fr();const[t,s]=u.useState([]),[l,r]=u.useState([]),[d,o]=u.useState(""),[c,h]=u.useState(!1),[m,b]=u.useState(!1),[f,y]=u.useState(""),[S,g]=u.useState(""),[C,w]=u.useState(""),[E,k]=u.useState(""),[p,_]=u.useState(null),[B,v]=u.useState(!1),[W,j]=u.useState(""),[P,T]=u.useState(""),[F,Q]=u.useState(!1),[x,O]=u.useState(!1),[V,z]=u.useState(""),[A,H]=u.useState("success"),ae=(M,ue="success")=>{z(M),H(ue),O(!0)},he=async()=>{try{const{data:M,error:ue}=await N.from("stock_movements").select(`
                    *,
                    Products (
                        ProductName,
                        ProductID
                    )
                `).order("date",{ascending:!1});ue?(console.error("Error fetching movements:",ue),s([]),ae("Failed to load movements","danger")):s(M||[])}catch(M){console.error("Unexpected error:",M),s([]),ae("An unexpected error occurred","danger")}},oe=async()=>{try{const{data:M,error:ue}=await N.from("Products").select("*").order("ProductName");ue?(console.error("Error fetching products:",ue),r([])):r(M||[])}catch(M){console.error("Unexpected error:",M),r([])}},X=async M=>{if(!M){_(null);return}v(!0);try{const{data:ue,error:R}=await N.from("stock_movements").select("movement_type, quantity").eq("product_id",M);if(R)console.error("Error fetching stock movements:",R),_(null);else{const Z=(ue||[]).reduce((I,D)=>{switch(D.movement_type){case"incoming":return I+D.quantity;case"outgoing":return I-D.quantity;case"adjustment":return I+D.quantity;default:return I}},0);_(Z)}}catch(ue){console.error("Error calculating stock:",ue),_(null)}finally{v(!1)}};u.useEffect(()=>{E?X(E):_(null)},[E]);const de=async()=>{if(!E||W===""||p===null){ae("Please select a product and enter a valid stock level","warning");return}const ue=Number(W)-p;if(ue===0){ae("No adjustment needed - the stock level is already at the specified amount","warning");return}Q(!0);try{const{error:R}=await N.from("stock_movements").insert({product_id:E,movement_type:"adjustment",quantity:ue,reason:`Manual adjustment: ${P||"Stock level correction"}`,date:new Date().toISOString()});R?(console.error("Error creating adjustment:",R),ae("Failed to create adjustment: "+R.message,"danger")):(k(""),j(""),T(""),_(null),h(!1),he(),ae("Stock adjustment created successfully!","success"))}catch(R){console.error("Unexpected error:",R),ae("An unexpected error occurred","danger")}finally{Q(!1)}};u.useEffect(()=>{he(),oe()},[]);const Y=t.filter(M=>{const ue=d.toLowerCase(),R=d===""||M.id.toLowerCase().includes(ue)||M.product_id.toLowerCase().includes(ue)||M.movement_type.toLowerCase().includes(ue)||(M.reason?.toLowerCase().includes(ue)??!1)||(M.Products?.ProductName?.toLowerCase().includes(ue)??!1),Z=f===""||M.movement_type===f,I=S===""||M.product_id===S,D=C===""||(()=>{const G=M.reason?.toLowerCase()||"";switch(C){case"manual":return G.includes("manual")||G.includes("adjustment")||G.includes("correction");case"damage":return G.includes("damage")||G.includes("broken")||G.includes("defect");case"loss":return G.includes("loss")||G.includes("lost")||G.includes("missing");case"found":return G.includes("found")||G.includes("surplus")||G.includes("extra");case"po":return G.includes("po")||G.includes("purchase")||G.includes("receipt");default:return!0}})();return R&&Z&&I&&D}),ne=M=>{switch(M.movement_type){case"incoming":return"success";case"outgoing":return"danger";case"adjustment":return M.quantity>=0?"success":"danger";default:return"neutral"}},L=M=>{switch(M.movement_type){case"incoming":return"↑";case"outgoing":return"↓";case"adjustment":return"⚖";default:return"•"}},J=M=>{switch(M.movement_type){case"incoming":return`+${M.quantity}`;case"outgoing":return`-${M.quantity}`;case"adjustment":return M.quantity>=0?`+${M.quantity}`:`${M.quantity}`;default:return M.quantity}},ve=()=>{y(""),g(""),w("")},we=f!==""||S!==""||C!=="",$e=()=>e.jsxs(i,{sx:{width:"100%",minHeight:"100vh"},children:[e.jsxs(ke,{padding:"medium",children:[e.jsx(a,{level:"h2",sx:{mb:2,fontSize:le.sizes.xlarge},children:"Stock Movements"}),e.jsxs(i,{sx:{display:"flex",gap:1,mb:2},children:[e.jsx($,{placeholder:"Search movements...",value:d,onChange:M=>o(M.target.value),startDecorator:e.jsx(Ce,{}),sx:{flex:1}}),e.jsx(me,{variant:we?"solid":"soft",color:we?"primary":"neutral",size:"sm",onClick:()=>b(!0),children:e.jsx(Cs,{})})]}),we&&e.jsxs(i,{sx:{mb:2,display:"flex",gap:1,flexWrap:"wrap"},children:[f&&e.jsxs(re,{size:"sm",variant:"soft",color:"primary",children:["Type: ",f]}),S&&e.jsxs(re,{size:"sm",variant:"soft",color:"primary",children:["Product: ",l.find(M=>M.uuid===S)?.ProductName||"Selected"]}),C&&e.jsxs(re,{size:"sm",variant:"soft",color:"primary",children:["Reason: ",C]})]})]}),e.jsx(i,{children:Y.length===0?e.jsx(i,{sx:{textAlign:"center",py:6},children:e.jsx(a,{color:"neutral",children:"No stock movements found"})}):Y.map(M=>e.jsx(i,{sx:{p:2,borderBottom:"1px solid",borderColor:"divider","&:hover":{bgcolor:"background.level1"}},children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(i,{sx:{width:32,height:32,borderRadius:"50%",bgcolor:`${ne(M)}.100`,color:`${ne(M)}.600`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"14px",fontWeight:"bold",flexShrink:0},children:L(M)}),e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:.5},children:[e.jsx(a,{level:"title-sm",sx:{fontWeight:"bold",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"60%"},children:M.Products?.ProductName||"Unknown Product"}),e.jsx(re,{size:"sm",color:ne(M),variant:"soft",sx:{fontWeight:"bold",minWidth:"fit-content"},children:J(M)})]}),e.jsxs(a,{level:"body-xs",color:"neutral",sx:{mb:.5},children:["ID: ",M.Products?.ProductID||"N/A"," • ",new Date(M.date).toLocaleDateString()]}),M.reason&&e.jsx(a,{level:"body-xs",color:"neutral",sx:{fontStyle:"italic",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:M.reason})]})]})},M.id))}),e.jsx(me,{color:"primary",variant:"soft",size:"sm",sx:{position:"fixed",bottom:80,right:16,zIndex:1e3,borderRadius:"8px",width:40,height:40,boxShadow:"sm",bgcolor:"primary.100","&:hover":{bgcolor:"primary.200",boxShadow:"md"}},onClick:()=>h(!0),children:e.jsx(be,{fontSize:"small"})})]}),Ke=()=>e.jsxs(ke,{variant:"table-page",children:[e.jsx(a,{level:"h2",sx:{mb:2,fontSize:le.sizes.xlarge},children:"Stock Movements"}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx($,{placeholder:"Search movements...",sx:{flex:1,fontSize:le.sizes.small},value:d,onChange:M=>o(M.target.value),startDecorator:e.jsx(Ce,{})}),e.jsx(q,{variant:"solid",startDecorator:e.jsx(be,{}),onClick:()=>h(!0),sx:{fontSize:le.sizes.small},children:"Adjust"})]}),e.jsx(ce,{sx:{overflow:"visible"},children:e.jsxs(Ue,{"aria-label":"Stock Movements",sx:{tableLayout:"auto"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:Ee,children:"ID"}),e.jsx("th",{style:Ee,children:"Product"}),e.jsx("th",{style:Ee,children:"Movement Type"}),e.jsx("th",{style:Ee,children:"Quantity"}),e.jsx("th",{style:Ee,children:"Reason"}),e.jsx("th",{style:Ee,children:"Date"})]})}),e.jsxs("tbody",{children:[Y.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,style:{textAlign:"center",color:"#888",...Ee},children:"No stock movements found."})}),Y.map(M=>e.jsxs("tr",{style:{cursor:"pointer"},children:[e.jsxs("td",{style:Ee,children:[M.id.substring(0,8),"..."]}),e.jsx("td",{style:Ee,children:M.Products?e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:"bold"},children:M.Products.ProductName}),e.jsxs("div",{style:{fontSize:"0.8em",color:"#666"},children:["ID: ",M.Products.ProductID]})]}):e.jsx("span",{style:{color:"#999",fontStyle:"italic"},children:"Unknown Product"})}),e.jsx("td",{style:Ee,children:e.jsx(re,{size:"sm",variant:"soft",color:ne(M),children:M.movement_type==="incoming"?"↑ Incoming":M.movement_type==="outgoing"?"↓ Outgoing":"⚖ Adjustment"})}),e.jsx("td",{style:Ee,children:e.jsx("span",{style:{fontWeight:"bold",color:ne(M)==="success"?"#059669":ne(M)==="danger"?"#dc2626":"#666"},children:J(M)})}),e.jsx("td",{style:Ee,children:M.reason||"N/A"}),e.jsx("td",{style:Ee,children:new Date(M.date).toLocaleString()})]},M.id))]})]})})]});return e.jsxs(Fe,{children:[n?e.jsx($e,{}):e.jsx(Ke,{}),e.jsx(Ht,{open:c,onClose:()=>h(!1),title:"Manual Stock Adjustment",size:"medium",actions:e.jsxs(i,{sx:{display:"flex",gap:2},children:[e.jsx(q,{variant:"plain",onClick:()=>h(!1),sx:Ee,children:"Cancel"}),e.jsx(q,{variant:"solid",onClick:de,loading:F,disabled:!E||W===""||p===null||Number(W)===p,sx:Ee,children:"Create Adjustment"})]}),children:e.jsxs(K,{spacing:2,children:[e.jsxs(se,{children:[e.jsx(ee,{children:"Product"}),e.jsx(ye,{placeholder:"Select a product...",value:E,onChange:(M,ue)=>k(ue||""),children:l.map(M=>e.jsxs(U,{value:M.uuid,children:[M.ProductName," (ID: ",M.ProductID,")"]},M.uuid))})]}),E&&e.jsxs(se,{children:[e.jsx(ee,{children:"Current Stock Level"}),e.jsx($,{value:B?"Loading...":p!==null?p:"N/A",readOnly:!0,sx:{bgcolor:"neutral.100",color:p!==null&&p<=0?"danger.500":"neutral.600"}}),p!==null&&p<=0&&e.jsx(a,{level:"body-sm",sx:{color:"danger.500",mt:.5},children:"⚠️ Warning: Product is at or below zero stock level"})]}),p!==null&&e.jsxs(se,{children:[e.jsx(ee,{children:"Actual Stock Level"}),e.jsx($,{type:"number",placeholder:"Enter the actual stock level...",value:W,onChange:M=>j(M.target.value),sx:{...Ee},slotProps:{input:{min:0,max:999999}}}),W!==""&&p!==null&&e.jsx(a,{level:"body-sm",sx:{mt:.5,color:Number(W)>p?"success.600":Number(W)<p?"danger.600":"neutral.600"},children:Number(W)>p?`+${Number(W)-p} (increase)`:Number(W)<p?`${Number(W)-p} (decrease)`:"No change needed"})]}),e.jsxs(se,{children:[e.jsx(ee,{children:"Reason for Adjustment"}),e.jsx($,{placeholder:"e.g., damage, loss, found inventory, physical count correction...",value:P,onChange:M=>T(M.target.value),sx:{...Ee}})]})]})}),n&&e.jsx(Ht,{open:m,onClose:()=>b(!1),title:"Filter Movements",size:"medium",actions:e.jsxs(i,{sx:{display:"flex",gap:1,justifyContent:"space-between",width:"100%"},children:[e.jsx(q,{variant:"plain",color:"neutral",onClick:ve,disabled:!we,children:"Clear All"}),e.jsx(q,{onClick:()=>b(!1),children:"Apply Filters"})]}),children:e.jsxs(K,{spacing:2,children:[e.jsxs(se,{children:[e.jsx(ee,{children:"Movement Type"}),e.jsxs(ye,{placeholder:"All types",value:f,onChange:(M,ue)=>y(ue||""),children:[e.jsx(U,{value:"",children:"All Types"}),e.jsx(U,{value:"incoming",children:"Incoming"}),e.jsx(U,{value:"outgoing",children:"Outgoing"}),e.jsx(U,{value:"adjustment",children:"Adjustment"})]})]}),e.jsxs(se,{children:[e.jsx(ee,{children:"Product"}),e.jsxs(ye,{placeholder:"All products",value:S,onChange:(M,ue)=>g(ue||""),children:[e.jsx(U,{value:"",children:"All Products"}),l.map(M=>e.jsx(U,{value:M.uuid,children:M.ProductName},M.uuid))]})]}),e.jsxs(se,{children:[e.jsx(ee,{children:"Reason Category"}),e.jsxs(ye,{placeholder:"All reasons",value:C,onChange:(M,ue)=>w(ue||""),children:[e.jsx(U,{value:"",children:"All Reasons"}),e.jsx(U,{value:"manual",children:"Manual Adjustment"}),e.jsx(U,{value:"damage",children:"Damage/Defect"}),e.jsx(U,{value:"loss",children:"Loss/Missing"}),e.jsx(U,{value:"found",children:"Found/Surplus"}),e.jsx(U,{value:"po",children:"Purchase Order"})]})]})]})}),e.jsx(Yt,{open:x,onClose:()=>O(!1),autoHideDuration:4e3,anchorOrigin:{vertical:"top",horizontal:"center"},sx:{top:16,zIndex:2e3},children:e.jsx(He,{color:A,variant:"solid",sx:{width:"100%"},children:V})})]})};function ni(){const[n,t]=u.useState([]),[s,l]=u.useState(""),[r,d]=u.useState(""),[o,c]=u.useState(!1),[h,m]=u.useState(null),[b,f]=u.useState(!1),[y,S]=u.useState(!1),g=[{id:"email-config",name:"Email Configuration",description:"Configure order confirmation emails and SendGrid integration",icon:e.jsx(Ge,{}),status:"available",category:"communication",onClick:()=>S(!0)},{id:"payment-gateway",name:"Payment Gateway",description:"Stripe, PayPal, and other payment processor integrations",icon:e.jsx(hs,{}),status:"coming-soon",category:"payments"},{id:"shopping-cart",name:"Shopping Cart Widget",description:"Customizable cart component for storefronts",icon:e.jsx(mt,{}),status:"coming-soon",category:"integration"},{id:"live-chat",name:"Live Chat Support",description:"Real-time customer support chat widget",icon:e.jsx(Yn,{}),status:"coming-soon",category:"communication"},{id:"analytics",name:"Analytics Dashboard",description:"Google Analytics and custom tracking integration",icon:e.jsx(Zn,{}),status:"coming-soon",category:"analytics"},{id:"security",name:"Security Module",description:"SSL certificates, security headers, and fraud protection",icon:e.jsx(Jn,{}),status:"coming-soon",category:"security"},{id:"notifications",name:"Push Notifications",description:"Browser push notifications for order updates",icon:e.jsx(Kn,{}),status:"coming-soon",category:"communication"},{id:"api-integrations",name:"API Integrations",description:"Connect with external services and webhooks",icon:e.jsx(Xn,{}),status:"coming-soon",category:"integration"}];u.useEffect(()=>{C(),w()},[]);const C=async()=>{try{const{data:v,error:W}=await N.from("storefronts").select("*").order("name",{ascending:!0});if(W)throw W;t(v||[]),v&&v.length>0&&l(v[0].id)}catch(v){console.error("Error fetching storefronts:",v)}},w=async()=>{try{const v=await fetch("/api/check-sendgrid-config");if(v.ok){const W=v.headers.get("content-type");if(W&&W.includes("application/json")){const j=await v.json();f(j.configured)}else f(!0)}else f(!0)}catch(v){console.error("Error checking SendGrid config:",v),f(!0)}},E=async()=>{if(!r.trim()){m({success:!1,message:"Please enter a test email address",timestamp:new Date});return}c(!0),m(null);try{const v=await fetch("/api/send-order-confirmation",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({testEmail:r.trim(),storefrontId:s||null})}),W=v.headers.get("content-type");if(!W||!W.includes("application/json")){const P=await v.text();P.includes("Authentication Required")||P.includes("Vercel Authentication")?m({success:!1,message:"API endpoints require authentication. Please disable Vercel protection for API routes or authenticate.",timestamp:new Date}):m({success:!1,message:"API endpoints not available in development. Deploy to Vercel to test email functionality.",timestamp:new Date});return}if(!v.ok)throw new Error(`HTTP ${v.status}: ${v.statusText}`);const j=await v.json();m({success:j.success,message:j.message||(j.success?"Test email sent successfully!":"Failed to send test email"),timestamp:new Date})}catch(v){v.message.includes("Unexpected token")?m({success:!1,message:"API endpoints require authentication or are not available. Please check Vercel project settings.",timestamp:new Date}):m({success:!1,message:v.message||"Error sending test email",timestamp:new Date})}finally{c(!1)}},k=v=>{switch(v){case"available":return"success";case"configured":return"primary";case"coming-soon":return"neutral";default:return"neutral"}},p=v=>{switch(v){case"available":return"Available";case"configured":return"Configured";case"coming-soon":return"Coming Soon";default:return"Unknown"}},_=v=>{switch(v){case"communication":return"#2196F3";case"payments":return"#4CAF50";case"analytics":return"#FF9800";case"security":return"#F44336";case"integration":return"#9C27B0";default:return"#757575"}},B=n.find(v=>v.id===s);return e.jsxs(i,{sx:{p:3,maxWidth:"1400px",mx:"auto"},children:[e.jsx(a,{level:"h2",sx:{mb:1},children:"Storefront Modules"}),e.jsx(a,{level:"body-lg",sx:{mb:4,color:"text.secondary"},children:"Enhance your storefronts with powerful modules and integrations"}),e.jsx(je,{container:!0,spacing:3,children:g.map(v=>e.jsx(je,{xs:12,sm:6,md:4,lg:3,children:e.jsx(ce,{variant:"outlined",sx:{height:"100%",cursor:v.status==="available"?"pointer":"default",transition:"all 0.2s ease-in-out",position:"relative","&:hover":v.status==="available"?{transform:"translateY(-2px)",boxShadow:"lg",borderColor:_(v.category)}:{},opacity:v.status==="coming-soon"?.7:1},onClick:v.onClick,children:e.jsx(vn,{ratio:"1",sx:{bgcolor:"background.level1"},children:e.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",p:2,height:"100%"},children:[e.jsx(i,{sx:{fontSize:"3rem",color:_(v.category),mb:2},children:v.icon}),e.jsx(a,{level:"title-md",textAlign:"center",sx:{mb:1},children:v.name}),e.jsx(a,{level:"body-sm",textAlign:"center",sx:{color:"text.secondary",mb:2},children:v.description}),e.jsx(re,{color:k(v.status),size:"sm",variant:"soft",children:p(v.status)})]})})})},v.id))}),e.jsxs(i,{sx:{mt:4,pt:3,borderTop:"1px solid",borderColor:"divider"},children:[e.jsx(a,{level:"title-sm",sx:{mb:2},children:"Module Categories"}),e.jsx(i,{sx:{display:"flex",flexWrap:"wrap",gap:2},children:["communication","payments","analytics","security","integration"].map(v=>e.jsx(re,{variant:"outlined",sx:{borderColor:_(v),color:_(v)},children:v.charAt(0).toUpperCase()+v.slice(1)},v))})]}),e.jsx(Oe,{open:y,onClose:()=>S(!1),children:e.jsxs(Re,{size:"lg",sx:{maxWidth:"800px",maxHeight:"90vh",overflow:"auto"},children:[e.jsx(qe,{}),e.jsxs(a,{level:"h3",sx:{mb:3,display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ge,{}),"Email Configuration"]}),e.jsxs(K,{spacing:4,children:[e.jsx(ce,{variant:"outlined",children:e.jsxs(De,{children:[e.jsx(a,{level:"title-md",sx:{mb:2},children:"SendGrid Configuration"}),e.jsx(i,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:e.jsx(re,{color:b?"success":"warning",variant:"soft",startDecorator:b?e.jsx(gt,{}):e.jsx(Is,{}),children:b?"Ready for Testing":"Development Mode"})}),!b&&e.jsx(He,{color:"neutral",sx:{mb:2},children:e.jsxs("div",{children:[e.jsx(a,{level:"title-sm",children:"Development Mode"}),e.jsx(a,{level:"body-sm",children:"Configuration check unavailable in development. Ensure these environment variables are set:"}),e.jsxs("ul",{style:{margin:"8px 0",paddingLeft:"20px"},children:[e.jsxs("li",{children:[e.jsx("code",{children:"SENDGRID_API_KEY"})," - Your SendGrid API key"]}),e.jsxs("li",{children:[e.jsx("code",{children:"SENDGRID_FROM_EMAIL"})," - The sender email address"]})]})]})}),e.jsx(a,{level:"body-sm",color:"neutral",children:"Order confirmation emails are automatically sent when customers complete checkout. Each storefront can have its own branding in the email template."})]})}),e.jsx(ce,{variant:"outlined",children:e.jsxs(De,{children:[e.jsx(a,{level:"title-md",sx:{mb:3},children:"Test Order Confirmation Email"}),e.jsxs(je,{container:!0,spacing:3,children:[e.jsx(je,{xs:12,md:6,children:e.jsxs(K,{spacing:2,children:[e.jsxs(se,{children:[e.jsx(ee,{children:"Select Storefront"}),e.jsxs("select",{value:s,onChange:v=>l(v.target.value),style:{padding:"8px 12px",borderRadius:"6px",border:"1px solid #ccc",fontSize:"14px"},children:[e.jsx("option",{value:"",children:"Default (No Storefront)"}),n.map(v=>e.jsx("option",{value:v.id,children:v.name},v.id))]})]}),e.jsxs(se,{children:[e.jsx(ee,{children:"Test Email Address"}),e.jsx($,{type:"email",placeholder:"test@example.com",value:r,onChange:v=>d(v.target.value)})]}),e.jsx(q,{variant:"solid",startDecorator:o?e.jsx(Wt,{size:"sm"}):e.jsx(Qn,{}),onClick:E,disabled:o||!b,sx:{mt:1},children:o?"Sending...":"Send Test Email"})]})}),e.jsx(je,{xs:12,md:6,children:B&&e.jsx(ce,{variant:"soft",children:e.jsxs(De,{children:[e.jsx(a,{level:"title-sm",sx:{mb:2},children:"Selected Storefront Preview"}),e.jsxs(K,{spacing:1,children:[e.jsxs(a,{level:"body-sm",children:[e.jsx("strong",{children:"Name:"})," ",B.name]}),B.url&&e.jsxs(a,{level:"body-sm",children:[e.jsx("strong",{children:"URL:"})," ",B.url]}),B.logo_url&&e.jsxs(a,{level:"body-sm",children:[e.jsx("strong",{children:"Logo:"})," Configured"]}),e.jsxs(a,{level:"body-sm",children:[e.jsx("strong",{children:"Status:"})," ",B.is_online?"Online":"Offline"]})]})]})})})]}),h&&e.jsx(He,{color:h.success?"success":"danger",sx:{mt:3},children:e.jsxs("div",{children:[e.jsx(a,{level:"title-sm",children:h.success?"Success!":"Error"}),e.jsx(a,{level:"body-sm",children:h.message}),e.jsx(a,{level:"body-xs",sx:{mt:1,opacity:.7},children:h.timestamp.toLocaleString()})]})})]})})]})]})})]})}function Rs(){return{async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null}}var ht=Rs();function Br(n){ht=n}var St={exec:()=>null};function pe(n,t=""){let s=typeof n=="string"?n:n.source,l={replace:(r,d)=>{let o=typeof d=="string"?d:d.source;return o=o.replace(Ne.caret,"$1"),s=s.replace(r,o),l},getRegex:()=>new RegExp(s,t)};return l}var Ne={codeRemoveIndent:/^(?: {1,4}| {0,3}\t)/gm,outputLinkReplace:/\\([\[\]])/g,indentCodeCompensation:/^(\s+)(?:```)/,beginningSpace:/^\s+/,endingHash:/#$/,startingSpaceChar:/^ /,endingSpaceChar:/ $/,nonSpaceChar:/[^ ]/,newLineCharGlobal:/\n/g,tabCharGlobal:/\t/g,multipleSpaceGlobal:/\s+/g,blankLine:/^[ \t]*$/,doubleBlankLine:/\n[ \t]*\n[ \t]*$/,blockquoteStart:/^ {0,3}>/,blockquoteSetextReplace:/\n {0,3}((?:=+|-+) *)(?=\n|$)/g,blockquoteSetextReplace2:/^ {0,3}>[ \t]?/gm,listReplaceTabs:/^\t+/,listReplaceNesting:/^ {1,4}(?=( {4})*[^ ])/g,listIsTask:/^\[[ xX]\] /,listReplaceTask:/^\[[ xX]\] +/,anyLine:/\n.*\n/,hrefBrackets:/^<(.*)>$/,tableDelimiter:/[:|]/,tableAlignChars:/^\||\| *$/g,tableRowBlankLine:/\n[ \t]*$/,tableAlignRight:/^ *-+: *$/,tableAlignCenter:/^ *:-+: *$/,tableAlignLeft:/^ *:-+ *$/,startATag:/^<a /i,endATag:/^<\/a>/i,startPreScriptTag:/^<(pre|code|kbd|script)(\s|>)/i,endPreScriptTag:/^<\/(pre|code|kbd|script)(\s|>)/i,startAngleBracket:/^</,endAngleBracket:/>$/,pedanticHrefTitle:/^([^'"]*[^\s])\s+(['"])(.*)\2/,unicodeAlphaNumeric:/[\p{L}\p{N}]/u,escapeTest:/[&<>"']/,escapeReplace:/[&<>"']/g,escapeTestNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/,escapeReplaceNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/g,unescapeTest:/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/ig,caret:/(^|[^\[])\^/g,percentDecode:/%25/g,findPipe:/\|/g,splitPipe:/ \|/,slashPipe:/\\\|/g,carriageReturn:/\r\n|\r/g,spaceLine:/^ +$/gm,notSpaceStart:/^\S*/,endingNewline:/\n$/,listItemRegex:n=>new RegExp(`^( {0,3}${n})((?:[	 ][^\\n]*)?(?:\\n|$))`),nextBulletRegex:n=>new RegExp(`^ {0,${Math.min(3,n-1)}}(?:[*+-]|\\d{1,9}[.)])((?:[ 	][^\\n]*)?(?:\\n|$))`),hrRegex:n=>new RegExp(`^ {0,${Math.min(3,n-1)}}((?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$)`),fencesBeginRegex:n=>new RegExp(`^ {0,${Math.min(3,n-1)}}(?:\`\`\`|~~~)`),headingBeginRegex:n=>new RegExp(`^ {0,${Math.min(3,n-1)}}#`),htmlBeginRegex:n=>new RegExp(`^ {0,${Math.min(3,n-1)}}<(?:[a-z].*>|!--)`,"i")},li=/^(?:[ \t]*(?:\n|$))+/,ii=/^((?: {4}| {0,3}\t)[^\n]+(?:\n(?:[ \t]*(?:\n|$))*)?)+/,ai=/^ {0,3}(`{3,}(?=[^`\n]*(?:\n|$))|~{3,})([^\n]*)(?:\n|$)(?:|([\s\S]*?)(?:\n|$))(?: {0,3}\1[~`]* *(?=\n|$)|$)/,It=/^ {0,3}((?:-[\t ]*){3,}|(?:_[ \t]*){3,}|(?:\*[ \t]*){3,})(?:\n+|$)/,oi=/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,Ts=/(?:[*+-]|\d{1,9}[.)])/,Hr=/^(?!bull |blockCode|fences|blockquote|heading|html|table)((?:.|\n(?!\s*?\n|bull |blockCode|fences|blockquote|heading|html|table))+?)\n {0,3}(=+|-+) *(?:\n+|$)/,Vr=pe(Hr).replace(/bull/g,Ts).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/\|table/g,"").getRegex(),ci=pe(Hr).replace(/bull/g,Ts).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/table/g,/ {0,3}\|?(?:[:\- ]*\|)+[\:\- ]*\n/).getRegex(),Ls=/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,di=/^[^\n]+/,Ns=/(?!\s*\])(?:\\.|[^\[\]\\])+/,ui=pe(/^ {0,3}\[(label)\]: *(?:\n[ \t]*)?([^<\s][^\s]*|<.*?>)(?:(?: +(?:\n[ \t]*)?| *\n[ \t]*)(title))? *(?:\n+|$)/).replace("label",Ns).replace("title",/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/).getRegex(),hi=pe(/^( {0,3}bull)([ \t][^\n]+?)?(?:\n|$)/).replace(/bull/g,Ts).getRegex(),Jt="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|search|section|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",$s=/<!--(?:-?>|[\s\S]*?(?:-->|$))/,xi=pe("^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$))","i").replace("comment",$s).replace("tag",Jt).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),Gr=pe(Ls).replace("hr",It).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",Jt).getRegex(),mi=pe(/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/).replace("paragraph",Gr).getRegex(),Ms={blockquote:mi,code:ii,def:ui,fences:ai,heading:oi,hr:It,html:xi,lheading:Vr,list:hi,newline:li,paragraph:Gr,table:St,text:di},vr=pe("^ *([^\\n ].*)\\n {0,3}((?:\\| *)?:?-+:? *(?:\\| *:?-+:? *)*(?:\\| *)?)(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)").replace("hr",It).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("blockquote"," {0,3}>").replace("code","(?: {4}| {0,3}	)[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",Jt).getRegex(),pi={...Ms,lheading:ci,table:vr,paragraph:pe(Ls).replace("hr",It).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("table",vr).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",Jt).getRegex()},gi={...Ms,html:pe(`^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:"[^"]*"|'[^']*'|\\s[^'"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))`).replace("comment",$s).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:St,lheading:/^(.+?)\n {0,3}(=+|-+) *(?:\n+|$)/,paragraph:pe(Ls).replace("hr",It).replace("heading",` *#{1,6} *[^
]`).replace("lheading",Vr).replace("|table","").replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").replace("|tag","").getRegex()},fi=/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,ji=/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,Qr=/^( {2,}|\\)\n(?!\s*$)/,yi=/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,Kt=/[\p{P}\p{S}]/u,Ws=/[\s\p{P}\p{S}]/u,Yr=/[^\s\p{P}\p{S}]/u,bi=pe(/^((?![*_])punctSpace)/,"u").replace(/punctSpace/g,Ws).getRegex(),Zr=/(?!~)[\p{P}\p{S}]/u,vi=/(?!~)[\s\p{P}\p{S}]/u,wi=/(?:[^\s\p{P}\p{S}]|~)/u,Si=/\[[^[\]]*?\]\((?:\\.|[^\\\(\)]|\((?:\\.|[^\\\(\)])*\))*\)|`[^`]*?`|<[^<>]*?>/g,Jr=/^(?:\*+(?:((?!\*)punct)|[^\s*]))|^_+(?:((?!_)punct)|([^\s_]))/,Ci=pe(Jr,"u").replace(/punct/g,Kt).getRegex(),ki=pe(Jr,"u").replace(/punct/g,Zr).getRegex(),Kr="^[^_*]*?__[^_*]*?\\*[^_*]*?(?=__)|[^*]+(?=[^*])|(?!\\*)punct(\\*+)(?=[\\s]|$)|notPunctSpace(\\*+)(?!\\*)(?=punctSpace|$)|(?!\\*)punctSpace(\\*+)(?=notPunctSpace)|[\\s](\\*+)(?!\\*)(?=punct)|(?!\\*)punct(\\*+)(?!\\*)(?=punct)|notPunctSpace(\\*+)(?=notPunctSpace)",_i=pe(Kr,"gu").replace(/notPunctSpace/g,Yr).replace(/punctSpace/g,Ws).replace(/punct/g,Kt).getRegex(),Di=pe(Kr,"gu").replace(/notPunctSpace/g,wi).replace(/punctSpace/g,vi).replace(/punct/g,Zr).getRegex(),Ii=pe("^[^_*]*?\\*\\*[^_*]*?_[^_*]*?(?=\\*\\*)|[^_]+(?=[^_])|(?!_)punct(_+)(?=[\\s]|$)|notPunctSpace(_+)(?!_)(?=punctSpace|$)|(?!_)punctSpace(_+)(?=notPunctSpace)|[\\s](_+)(?!_)(?=punct)|(?!_)punct(_+)(?!_)(?=punct)","gu").replace(/notPunctSpace/g,Yr).replace(/punctSpace/g,Ws).replace(/punct/g,Kt).getRegex(),Pi=pe(/\\(punct)/,"gu").replace(/punct/g,Kt).getRegex(),Ai=pe(/^<(scheme:[^\s\x00-\x1f<>]*|email)>/).replace("scheme",/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/).replace("email",/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/).getRegex(),Ei=pe($s).replace("(?:-->|$)","-->").getRegex(),zi=pe("^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>").replace("comment",Ei).replace("attribute",/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/).getRegex(),Vt=/(?:\[(?:\\.|[^\[\]\\])*\]|\\.|`[^`]*`|[^\[\]\\`])*?/,Oi=pe(/^!?\[(label)\]\(\s*(href)(?:(?:[ \t]*(?:\n[ \t]*)?)(title))?\s*\)/).replace("label",Vt).replace("href",/<(?:\\.|[^\n<>\\])+>|[^ \t\n\x00-\x1f]*/).replace("title",/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/).getRegex(),Xr=pe(/^!?\[(label)\]\[(ref)\]/).replace("label",Vt).replace("ref",Ns).getRegex(),en=pe(/^!?\[(ref)\](?:\[\])?/).replace("ref",Ns).getRegex(),Ri=pe("reflink|nolink(?!\\()","g").replace("reflink",Xr).replace("nolink",en).getRegex(),qs={_backpedal:St,anyPunctuation:Pi,autolink:Ai,blockSkip:Si,br:Qr,code:ji,del:St,emStrongLDelim:Ci,emStrongRDelimAst:_i,emStrongRDelimUnd:Ii,escape:fi,link:Oi,nolink:en,punctuation:bi,reflink:Xr,reflinkSearch:Ri,tag:zi,text:yi,url:St},Ti={...qs,link:pe(/^!?\[(label)\]\((.*?)\)/).replace("label",Vt).getRegex(),reflink:pe(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",Vt).getRegex()},ps={...qs,emStrongRDelimAst:Di,emStrongLDelim:ki,url:pe(/^((?:ftp|https?):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/,"i").replace("email",/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/).getRegex(),_backpedal:/(?:[^?!.,:;*_'"~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_'"~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])((?:\\.|[^\\])*?(?:\\.|[^\s~\\]))\1(?=[^~]|$)/,text:/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|https?:\/\/|ftp:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/},Li={...ps,br:pe(Qr).replace("{2,}","*").getRegex(),text:pe(ps.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()},Ot={normal:Ms,gfm:pi,pedantic:gi},jt={normal:qs,gfm:ps,breaks:Li,pedantic:Ti},Ni={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},wr=n=>Ni[n];function Ve(n,t){if(t){if(Ne.escapeTest.test(n))return n.replace(Ne.escapeReplace,wr)}else if(Ne.escapeTestNoEncode.test(n))return n.replace(Ne.escapeReplaceNoEncode,wr);return n}function Sr(n){try{n=encodeURI(n).replace(Ne.percentDecode,"%")}catch{return null}return n}function Cr(n,t){let s=n.replace(Ne.findPipe,(d,o,c)=>{let h=!1,m=o;for(;--m>=0&&c[m]==="\\";)h=!h;return h?"|":" |"}),l=s.split(Ne.splitPipe),r=0;if(l[0].trim()||l.shift(),l.length>0&&!l.at(-1)?.trim()&&l.pop(),t)if(l.length>t)l.splice(t);else for(;l.length<t;)l.push("");for(;r<l.length;r++)l[r]=l[r].trim().replace(Ne.slashPipe,"|");return l}function yt(n,t,s){let l=n.length;if(l===0)return"";let r=0;for(;r<l&&n.charAt(l-r-1)===t;)r++;return n.slice(0,l-r)}function $i(n,t){if(n.indexOf(t[1])===-1)return-1;let s=0;for(let l=0;l<n.length;l++)if(n[l]==="\\")l++;else if(n[l]===t[0])s++;else if(n[l]===t[1]&&(s--,s<0))return l;return s>0?-2:-1}function kr(n,t,s,l,r){let d=t.href,o=t.title||null,c=n[1].replace(r.other.outputLinkReplace,"$1");l.state.inLink=!0;let h={type:n[0].charAt(0)==="!"?"image":"link",raw:s,href:d,title:o,text:c,tokens:l.inlineTokens(c)};return l.state.inLink=!1,h}function Mi(n,t,s){let l=n.match(s.other.indentCodeCompensation);if(l===null)return t;let r=l[1];return t.split(`
`).map(d=>{let o=d.match(s.other.beginningSpace);if(o===null)return d;let[c]=o;return c.length>=r.length?d.slice(r.length):d}).join(`
`)}var Gt=class{options;rules;lexer;constructor(n){this.options=n||ht}space(n){let t=this.rules.block.newline.exec(n);if(t&&t[0].length>0)return{type:"space",raw:t[0]}}code(n){let t=this.rules.block.code.exec(n);if(t){let s=t[0].replace(this.rules.other.codeRemoveIndent,"");return{type:"code",raw:t[0],codeBlockStyle:"indented",text:this.options.pedantic?s:yt(s,`
`)}}}fences(n){let t=this.rules.block.fences.exec(n);if(t){let s=t[0],l=Mi(s,t[3]||"",this.rules);return{type:"code",raw:s,lang:t[2]?t[2].trim().replace(this.rules.inline.anyPunctuation,"$1"):t[2],text:l}}}heading(n){let t=this.rules.block.heading.exec(n);if(t){let s=t[2].trim();if(this.rules.other.endingHash.test(s)){let l=yt(s,"#");(this.options.pedantic||!l||this.rules.other.endingSpaceChar.test(l))&&(s=l.trim())}return{type:"heading",raw:t[0],depth:t[1].length,text:s,tokens:this.lexer.inline(s)}}}hr(n){let t=this.rules.block.hr.exec(n);if(t)return{type:"hr",raw:yt(t[0],`
`)}}blockquote(n){let t=this.rules.block.blockquote.exec(n);if(t){let s=yt(t[0],`
`).split(`
`),l="",r="",d=[];for(;s.length>0;){let o=!1,c=[],h;for(h=0;h<s.length;h++)if(this.rules.other.blockquoteStart.test(s[h]))c.push(s[h]),o=!0;else if(!o)c.push(s[h]);else break;s=s.slice(h);let m=c.join(`
`),b=m.replace(this.rules.other.blockquoteSetextReplace,`
    $1`).replace(this.rules.other.blockquoteSetextReplace2,"");l=l?`${l}
${m}`:m,r=r?`${r}
${b}`:b;let f=this.lexer.state.top;if(this.lexer.state.top=!0,this.lexer.blockTokens(b,d,!0),this.lexer.state.top=f,s.length===0)break;let y=d.at(-1);if(y?.type==="code")break;if(y?.type==="blockquote"){let S=y,g=S.raw+`
`+s.join(`
`),C=this.blockquote(g);d[d.length-1]=C,l=l.substring(0,l.length-S.raw.length)+C.raw,r=r.substring(0,r.length-S.text.length)+C.text;break}else if(y?.type==="list"){let S=y,g=S.raw+`
`+s.join(`
`),C=this.list(g);d[d.length-1]=C,l=l.substring(0,l.length-y.raw.length)+C.raw,r=r.substring(0,r.length-S.raw.length)+C.raw,s=g.substring(d.at(-1).raw.length).split(`
`);continue}}return{type:"blockquote",raw:l,tokens:d,text:r}}}list(n){let t=this.rules.block.list.exec(n);if(t){let s=t[1].trim(),l=s.length>1,r={type:"list",raw:"",ordered:l,start:l?+s.slice(0,-1):"",loose:!1,items:[]};s=l?`\\d{1,9}\\${s.slice(-1)}`:`\\${s}`,this.options.pedantic&&(s=l?s:"[*+-]");let d=this.rules.other.listItemRegex(s),o=!1;for(;n;){let h=!1,m="",b="";if(!(t=d.exec(n))||this.rules.block.hr.test(n))break;m=t[0],n=n.substring(m.length);let f=t[2].split(`
`,1)[0].replace(this.rules.other.listReplaceTabs,E=>" ".repeat(3*E.length)),y=n.split(`
`,1)[0],S=!f.trim(),g=0;if(this.options.pedantic?(g=2,b=f.trimStart()):S?g=t[1].length+1:(g=t[2].search(this.rules.other.nonSpaceChar),g=g>4?1:g,b=f.slice(g),g+=t[1].length),S&&this.rules.other.blankLine.test(y)&&(m+=y+`
`,n=n.substring(y.length+1),h=!0),!h){let E=this.rules.other.nextBulletRegex(g),k=this.rules.other.hrRegex(g),p=this.rules.other.fencesBeginRegex(g),_=this.rules.other.headingBeginRegex(g),B=this.rules.other.htmlBeginRegex(g);for(;n;){let v=n.split(`
`,1)[0],W;if(y=v,this.options.pedantic?(y=y.replace(this.rules.other.listReplaceNesting,"  "),W=y):W=y.replace(this.rules.other.tabCharGlobal,"    "),p.test(y)||_.test(y)||B.test(y)||E.test(y)||k.test(y))break;if(W.search(this.rules.other.nonSpaceChar)>=g||!y.trim())b+=`
`+W.slice(g);else{if(S||f.replace(this.rules.other.tabCharGlobal,"    ").search(this.rules.other.nonSpaceChar)>=4||p.test(f)||_.test(f)||k.test(f))break;b+=`
`+y}!S&&!y.trim()&&(S=!0),m+=v+`
`,n=n.substring(v.length+1),f=W.slice(g)}}r.loose||(o?r.loose=!0:this.rules.other.doubleBlankLine.test(m)&&(o=!0));let C=null,w;this.options.gfm&&(C=this.rules.other.listIsTask.exec(b),C&&(w=C[0]!=="[ ] ",b=b.replace(this.rules.other.listReplaceTask,""))),r.items.push({type:"list_item",raw:m,task:!!C,checked:w,loose:!1,text:b,tokens:[]}),r.raw+=m}let c=r.items.at(-1);if(c)c.raw=c.raw.trimEnd(),c.text=c.text.trimEnd();else return;r.raw=r.raw.trimEnd();for(let h=0;h<r.items.length;h++)if(this.lexer.state.top=!1,r.items[h].tokens=this.lexer.blockTokens(r.items[h].text,[]),!r.loose){let m=r.items[h].tokens.filter(f=>f.type==="space"),b=m.length>0&&m.some(f=>this.rules.other.anyLine.test(f.raw));r.loose=b}if(r.loose)for(let h=0;h<r.items.length;h++)r.items[h].loose=!0;return r}}html(n){let t=this.rules.block.html.exec(n);if(t)return{type:"html",block:!0,raw:t[0],pre:t[1]==="pre"||t[1]==="script"||t[1]==="style",text:t[0]}}def(n){let t=this.rules.block.def.exec(n);if(t){let s=t[1].toLowerCase().replace(this.rules.other.multipleSpaceGlobal," "),l=t[2]?t[2].replace(this.rules.other.hrefBrackets,"$1").replace(this.rules.inline.anyPunctuation,"$1"):"",r=t[3]?t[3].substring(1,t[3].length-1).replace(this.rules.inline.anyPunctuation,"$1"):t[3];return{type:"def",tag:s,raw:t[0],href:l,title:r}}}table(n){let t=this.rules.block.table.exec(n);if(!t||!this.rules.other.tableDelimiter.test(t[2]))return;let s=Cr(t[1]),l=t[2].replace(this.rules.other.tableAlignChars,"").split("|"),r=t[3]?.trim()?t[3].replace(this.rules.other.tableRowBlankLine,"").split(`
`):[],d={type:"table",raw:t[0],header:[],align:[],rows:[]};if(s.length===l.length){for(let o of l)this.rules.other.tableAlignRight.test(o)?d.align.push("right"):this.rules.other.tableAlignCenter.test(o)?d.align.push("center"):this.rules.other.tableAlignLeft.test(o)?d.align.push("left"):d.align.push(null);for(let o=0;o<s.length;o++)d.header.push({text:s[o],tokens:this.lexer.inline(s[o]),header:!0,align:d.align[o]});for(let o of r)d.rows.push(Cr(o,d.header.length).map((c,h)=>({text:c,tokens:this.lexer.inline(c),header:!1,align:d.align[h]})));return d}}lheading(n){let t=this.rules.block.lheading.exec(n);if(t)return{type:"heading",raw:t[0],depth:t[2].charAt(0)==="="?1:2,text:t[1],tokens:this.lexer.inline(t[1])}}paragraph(n){let t=this.rules.block.paragraph.exec(n);if(t){let s=t[1].charAt(t[1].length-1)===`
`?t[1].slice(0,-1):t[1];return{type:"paragraph",raw:t[0],text:s,tokens:this.lexer.inline(s)}}}text(n){let t=this.rules.block.text.exec(n);if(t)return{type:"text",raw:t[0],text:t[0],tokens:this.lexer.inline(t[0])}}escape(n){let t=this.rules.inline.escape.exec(n);if(t)return{type:"escape",raw:t[0],text:t[1]}}tag(n){let t=this.rules.inline.tag.exec(n);if(t)return!this.lexer.state.inLink&&this.rules.other.startATag.test(t[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&this.rules.other.endATag.test(t[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&this.rules.other.startPreScriptTag.test(t[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&this.rules.other.endPreScriptTag.test(t[0])&&(this.lexer.state.inRawBlock=!1),{type:"html",raw:t[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,block:!1,text:t[0]}}link(n){let t=this.rules.inline.link.exec(n);if(t){let s=t[2].trim();if(!this.options.pedantic&&this.rules.other.startAngleBracket.test(s)){if(!this.rules.other.endAngleBracket.test(s))return;let d=yt(s.slice(0,-1),"\\");if((s.length-d.length)%2===0)return}else{let d=$i(t[2],"()");if(d===-2)return;if(d>-1){let o=(t[0].indexOf("!")===0?5:4)+t[1].length+d;t[2]=t[2].substring(0,d),t[0]=t[0].substring(0,o).trim(),t[3]=""}}let l=t[2],r="";if(this.options.pedantic){let d=this.rules.other.pedanticHrefTitle.exec(l);d&&(l=d[1],r=d[3])}else r=t[3]?t[3].slice(1,-1):"";return l=l.trim(),this.rules.other.startAngleBracket.test(l)&&(this.options.pedantic&&!this.rules.other.endAngleBracket.test(s)?l=l.slice(1):l=l.slice(1,-1)),kr(t,{href:l&&l.replace(this.rules.inline.anyPunctuation,"$1"),title:r&&r.replace(this.rules.inline.anyPunctuation,"$1")},t[0],this.lexer,this.rules)}}reflink(n,t){let s;if((s=this.rules.inline.reflink.exec(n))||(s=this.rules.inline.nolink.exec(n))){let l=(s[2]||s[1]).replace(this.rules.other.multipleSpaceGlobal," "),r=t[l.toLowerCase()];if(!r){let d=s[0].charAt(0);return{type:"text",raw:d,text:d}}return kr(s,r,s[0],this.lexer,this.rules)}}emStrong(n,t,s=""){let l=this.rules.inline.emStrongLDelim.exec(n);if(!(!l||l[3]&&s.match(this.rules.other.unicodeAlphaNumeric))&&(!(l[1]||l[2])||!s||this.rules.inline.punctuation.exec(s))){let r=[...l[0]].length-1,d,o,c=r,h=0,m=l[0][0]==="*"?this.rules.inline.emStrongRDelimAst:this.rules.inline.emStrongRDelimUnd;for(m.lastIndex=0,t=t.slice(-1*n.length+r);(l=m.exec(t))!=null;){if(d=l[1]||l[2]||l[3]||l[4]||l[5]||l[6],!d)continue;if(o=[...d].length,l[3]||l[4]){c+=o;continue}else if((l[5]||l[6])&&r%3&&!((r+o)%3)){h+=o;continue}if(c-=o,c>0)continue;o=Math.min(o,o+c+h);let b=[...l[0]][0].length,f=n.slice(0,r+l.index+b+o);if(Math.min(r,o)%2){let S=f.slice(1,-1);return{type:"em",raw:f,text:S,tokens:this.lexer.inlineTokens(S)}}let y=f.slice(2,-2);return{type:"strong",raw:f,text:y,tokens:this.lexer.inlineTokens(y)}}}}codespan(n){let t=this.rules.inline.code.exec(n);if(t){let s=t[2].replace(this.rules.other.newLineCharGlobal," "),l=this.rules.other.nonSpaceChar.test(s),r=this.rules.other.startingSpaceChar.test(s)&&this.rules.other.endingSpaceChar.test(s);return l&&r&&(s=s.substring(1,s.length-1)),{type:"codespan",raw:t[0],text:s}}}br(n){let t=this.rules.inline.br.exec(n);if(t)return{type:"br",raw:t[0]}}del(n){let t=this.rules.inline.del.exec(n);if(t)return{type:"del",raw:t[0],text:t[2],tokens:this.lexer.inlineTokens(t[2])}}autolink(n){let t=this.rules.inline.autolink.exec(n);if(t){let s,l;return t[2]==="@"?(s=t[1],l="mailto:"+s):(s=t[1],l=s),{type:"link",raw:t[0],text:s,href:l,tokens:[{type:"text",raw:s,text:s}]}}}url(n){let t;if(t=this.rules.inline.url.exec(n)){let s,l;if(t[2]==="@")s=t[0],l="mailto:"+s;else{let r;do r=t[0],t[0]=this.rules.inline._backpedal.exec(t[0])?.[0]??"";while(r!==t[0]);s=t[0],t[1]==="www."?l="http://"+t[0]:l=t[0]}return{type:"link",raw:t[0],text:s,href:l,tokens:[{type:"text",raw:s,text:s}]}}}inlineText(n){let t=this.rules.inline.text.exec(n);if(t){let s=this.lexer.state.inRawBlock;return{type:"text",raw:t[0],text:t[0],escaped:s}}}},Ye=class gs{tokens;options;state;tokenizer;inlineQueue;constructor(t){this.tokens=[],this.tokens.links=Object.create(null),this.options=t||ht,this.options.tokenizer=this.options.tokenizer||new Gt,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};let s={other:Ne,block:Ot.normal,inline:jt.normal};this.options.pedantic?(s.block=Ot.pedantic,s.inline=jt.pedantic):this.options.gfm&&(s.block=Ot.gfm,this.options.breaks?s.inline=jt.breaks:s.inline=jt.gfm),this.tokenizer.rules=s}static get rules(){return{block:Ot,inline:jt}}static lex(t,s){return new gs(s).lex(t)}static lexInline(t,s){return new gs(s).inlineTokens(t)}lex(t){t=t.replace(Ne.carriageReturn,`
`),this.blockTokens(t,this.tokens);for(let s=0;s<this.inlineQueue.length;s++){let l=this.inlineQueue[s];this.inlineTokens(l.src,l.tokens)}return this.inlineQueue=[],this.tokens}blockTokens(t,s=[],l=!1){for(this.options.pedantic&&(t=t.replace(Ne.tabCharGlobal,"    ").replace(Ne.spaceLine,""));t;){let r;if(this.options.extensions?.block?.some(o=>(r=o.call({lexer:this},t,s))?(t=t.substring(r.raw.length),s.push(r),!0):!1))continue;if(r=this.tokenizer.space(t)){t=t.substring(r.raw.length);let o=s.at(-1);r.raw.length===1&&o!==void 0?o.raw+=`
`:s.push(r);continue}if(r=this.tokenizer.code(t)){t=t.substring(r.raw.length);let o=s.at(-1);o?.type==="paragraph"||o?.type==="text"?(o.raw+=`
`+r.raw,o.text+=`
`+r.text,this.inlineQueue.at(-1).src=o.text):s.push(r);continue}if(r=this.tokenizer.fences(t)){t=t.substring(r.raw.length),s.push(r);continue}if(r=this.tokenizer.heading(t)){t=t.substring(r.raw.length),s.push(r);continue}if(r=this.tokenizer.hr(t)){t=t.substring(r.raw.length),s.push(r);continue}if(r=this.tokenizer.blockquote(t)){t=t.substring(r.raw.length),s.push(r);continue}if(r=this.tokenizer.list(t)){t=t.substring(r.raw.length),s.push(r);continue}if(r=this.tokenizer.html(t)){t=t.substring(r.raw.length),s.push(r);continue}if(r=this.tokenizer.def(t)){t=t.substring(r.raw.length);let o=s.at(-1);o?.type==="paragraph"||o?.type==="text"?(o.raw+=`
`+r.raw,o.text+=`
`+r.raw,this.inlineQueue.at(-1).src=o.text):this.tokens.links[r.tag]||(this.tokens.links[r.tag]={href:r.href,title:r.title});continue}if(r=this.tokenizer.table(t)){t=t.substring(r.raw.length),s.push(r);continue}if(r=this.tokenizer.lheading(t)){t=t.substring(r.raw.length),s.push(r);continue}let d=t;if(this.options.extensions?.startBlock){let o=1/0,c=t.slice(1),h;this.options.extensions.startBlock.forEach(m=>{h=m.call({lexer:this},c),typeof h=="number"&&h>=0&&(o=Math.min(o,h))}),o<1/0&&o>=0&&(d=t.substring(0,o+1))}if(this.state.top&&(r=this.tokenizer.paragraph(d))){let o=s.at(-1);l&&o?.type==="paragraph"?(o.raw+=`
`+r.raw,o.text+=`
`+r.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=o.text):s.push(r),l=d.length!==t.length,t=t.substring(r.raw.length);continue}if(r=this.tokenizer.text(t)){t=t.substring(r.raw.length);let o=s.at(-1);o?.type==="text"?(o.raw+=`
`+r.raw,o.text+=`
`+r.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=o.text):s.push(r);continue}if(t){let o="Infinite loop on byte: "+t.charCodeAt(0);if(this.options.silent){console.error(o);break}else throw new Error(o)}}return this.state.top=!0,s}inline(t,s=[]){return this.inlineQueue.push({src:t,tokens:s}),s}inlineTokens(t,s=[]){let l=t,r=null;if(this.tokens.links){let c=Object.keys(this.tokens.links);if(c.length>0)for(;(r=this.tokenizer.rules.inline.reflinkSearch.exec(l))!=null;)c.includes(r[0].slice(r[0].lastIndexOf("[")+1,-1))&&(l=l.slice(0,r.index)+"["+"a".repeat(r[0].length-2)+"]"+l.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;(r=this.tokenizer.rules.inline.anyPunctuation.exec(l))!=null;)l=l.slice(0,r.index)+"++"+l.slice(this.tokenizer.rules.inline.anyPunctuation.lastIndex);for(;(r=this.tokenizer.rules.inline.blockSkip.exec(l))!=null;)l=l.slice(0,r.index)+"["+"a".repeat(r[0].length-2)+"]"+l.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);let d=!1,o="";for(;t;){d||(o=""),d=!1;let c;if(this.options.extensions?.inline?.some(m=>(c=m.call({lexer:this},t,s))?(t=t.substring(c.raw.length),s.push(c),!0):!1))continue;if(c=this.tokenizer.escape(t)){t=t.substring(c.raw.length),s.push(c);continue}if(c=this.tokenizer.tag(t)){t=t.substring(c.raw.length),s.push(c);continue}if(c=this.tokenizer.link(t)){t=t.substring(c.raw.length),s.push(c);continue}if(c=this.tokenizer.reflink(t,this.tokens.links)){t=t.substring(c.raw.length);let m=s.at(-1);c.type==="text"&&m?.type==="text"?(m.raw+=c.raw,m.text+=c.text):s.push(c);continue}if(c=this.tokenizer.emStrong(t,l,o)){t=t.substring(c.raw.length),s.push(c);continue}if(c=this.tokenizer.codespan(t)){t=t.substring(c.raw.length),s.push(c);continue}if(c=this.tokenizer.br(t)){t=t.substring(c.raw.length),s.push(c);continue}if(c=this.tokenizer.del(t)){t=t.substring(c.raw.length),s.push(c);continue}if(c=this.tokenizer.autolink(t)){t=t.substring(c.raw.length),s.push(c);continue}if(!this.state.inLink&&(c=this.tokenizer.url(t))){t=t.substring(c.raw.length),s.push(c);continue}let h=t;if(this.options.extensions?.startInline){let m=1/0,b=t.slice(1),f;this.options.extensions.startInline.forEach(y=>{f=y.call({lexer:this},b),typeof f=="number"&&f>=0&&(m=Math.min(m,f))}),m<1/0&&m>=0&&(h=t.substring(0,m+1))}if(c=this.tokenizer.inlineText(h)){t=t.substring(c.raw.length),c.raw.slice(-1)!=="_"&&(o=c.raw.slice(-1)),d=!0;let m=s.at(-1);m?.type==="text"?(m.raw+=c.raw,m.text+=c.text):s.push(c);continue}if(t){let m="Infinite loop on byte: "+t.charCodeAt(0);if(this.options.silent){console.error(m);break}else throw new Error(m)}}return s}},Qt=class{options;parser;constructor(n){this.options=n||ht}space(n){return""}code({text:n,lang:t,escaped:s}){let l=(t||"").match(Ne.notSpaceStart)?.[0],r=n.replace(Ne.endingNewline,"")+`
`;return l?'<pre><code class="language-'+Ve(l)+'">'+(s?r:Ve(r,!0))+`</code></pre>
`:"<pre><code>"+(s?r:Ve(r,!0))+`</code></pre>
`}blockquote({tokens:n}){return`<blockquote>
${this.parser.parse(n)}</blockquote>
`}html({text:n}){return n}heading({tokens:n,depth:t}){return`<h${t}>${this.parser.parseInline(n)}</h${t}>
`}hr(n){return`<hr>
`}list(n){let t=n.ordered,s=n.start,l="";for(let o=0;o<n.items.length;o++){let c=n.items[o];l+=this.listitem(c)}let r=t?"ol":"ul",d=t&&s!==1?' start="'+s+'"':"";return"<"+r+d+`>
`+l+"</"+r+`>
`}listitem(n){let t="";if(n.task){let s=this.checkbox({checked:!!n.checked});n.loose?n.tokens[0]?.type==="paragraph"?(n.tokens[0].text=s+" "+n.tokens[0].text,n.tokens[0].tokens&&n.tokens[0].tokens.length>0&&n.tokens[0].tokens[0].type==="text"&&(n.tokens[0].tokens[0].text=s+" "+Ve(n.tokens[0].tokens[0].text),n.tokens[0].tokens[0].escaped=!0)):n.tokens.unshift({type:"text",raw:s+" ",text:s+" ",escaped:!0}):t+=s+" "}return t+=this.parser.parse(n.tokens,!!n.loose),`<li>${t}</li>
`}checkbox({checked:n}){return"<input "+(n?'checked="" ':"")+'disabled="" type="checkbox">'}paragraph({tokens:n}){return`<p>${this.parser.parseInline(n)}</p>
`}table(n){let t="",s="";for(let r=0;r<n.header.length;r++)s+=this.tablecell(n.header[r]);t+=this.tablerow({text:s});let l="";for(let r=0;r<n.rows.length;r++){let d=n.rows[r];s="";for(let o=0;o<d.length;o++)s+=this.tablecell(d[o]);l+=this.tablerow({text:s})}return l&&(l=`<tbody>${l}</tbody>`),`<table>
<thead>
`+t+`</thead>
`+l+`</table>
`}tablerow({text:n}){return`<tr>
${n}</tr>
`}tablecell(n){let t=this.parser.parseInline(n.tokens),s=n.header?"th":"td";return(n.align?`<${s} align="${n.align}">`:`<${s}>`)+t+`</${s}>
`}strong({tokens:n}){return`<strong>${this.parser.parseInline(n)}</strong>`}em({tokens:n}){return`<em>${this.parser.parseInline(n)}</em>`}codespan({text:n}){return`<code>${Ve(n,!0)}</code>`}br(n){return"<br>"}del({tokens:n}){return`<del>${this.parser.parseInline(n)}</del>`}link({href:n,title:t,tokens:s}){let l=this.parser.parseInline(s),r=Sr(n);if(r===null)return l;n=r;let d='<a href="'+n+'"';return t&&(d+=' title="'+Ve(t)+'"'),d+=">"+l+"</a>",d}image({href:n,title:t,text:s,tokens:l}){l&&(s=this.parser.parseInline(l,this.parser.textRenderer));let r=Sr(n);if(r===null)return Ve(s);n=r;let d=`<img src="${n}" alt="${s}"`;return t&&(d+=` title="${Ve(t)}"`),d+=">",d}text(n){return"tokens"in n&&n.tokens?this.parser.parseInline(n.tokens):"escaped"in n&&n.escaped?n.text:Ve(n.text)}},Fs=class{strong({text:n}){return n}em({text:n}){return n}codespan({text:n}){return n}del({text:n}){return n}html({text:n}){return n}text({text:n}){return n}link({text:n}){return""+n}image({text:n}){return""+n}br(){return""}},Ze=class fs{options;renderer;textRenderer;constructor(t){this.options=t||ht,this.options.renderer=this.options.renderer||new Qt,this.renderer=this.options.renderer,this.renderer.options=this.options,this.renderer.parser=this,this.textRenderer=new Fs}static parse(t,s){return new fs(s).parse(t)}static parseInline(t,s){return new fs(s).parseInline(t)}parse(t,s=!0){let l="";for(let r=0;r<t.length;r++){let d=t[r];if(this.options.extensions?.renderers?.[d.type]){let c=d,h=this.options.extensions.renderers[c.type].call({parser:this},c);if(h!==!1||!["space","hr","heading","code","table","blockquote","list","html","paragraph","text"].includes(c.type)){l+=h||"";continue}}let o=d;switch(o.type){case"space":{l+=this.renderer.space(o);continue}case"hr":{l+=this.renderer.hr(o);continue}case"heading":{l+=this.renderer.heading(o);continue}case"code":{l+=this.renderer.code(o);continue}case"table":{l+=this.renderer.table(o);continue}case"blockquote":{l+=this.renderer.blockquote(o);continue}case"list":{l+=this.renderer.list(o);continue}case"html":{l+=this.renderer.html(o);continue}case"paragraph":{l+=this.renderer.paragraph(o);continue}case"text":{let c=o,h=this.renderer.text(c);for(;r+1<t.length&&t[r+1].type==="text";)c=t[++r],h+=`
`+this.renderer.text(c);s?l+=this.renderer.paragraph({type:"paragraph",raw:h,text:h,tokens:[{type:"text",raw:h,text:h,escaped:!0}]}):l+=h;continue}default:{let c='Token with "'+o.type+'" type was not found.';if(this.options.silent)return console.error(c),"";throw new Error(c)}}}return l}parseInline(t,s=this.renderer){let l="";for(let r=0;r<t.length;r++){let d=t[r];if(this.options.extensions?.renderers?.[d.type]){let c=this.options.extensions.renderers[d.type].call({parser:this},d);if(c!==!1||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(d.type)){l+=c||"";continue}}let o=d;switch(o.type){case"escape":{l+=s.text(o);break}case"html":{l+=s.html(o);break}case"link":{l+=s.link(o);break}case"image":{l+=s.image(o);break}case"strong":{l+=s.strong(o);break}case"em":{l+=s.em(o);break}case"codespan":{l+=s.codespan(o);break}case"br":{l+=s.br(o);break}case"del":{l+=s.del(o);break}case"text":{l+=s.text(o);break}default:{let c='Token with "'+o.type+'" type was not found.';if(this.options.silent)return console.error(c),"";throw new Error(c)}}}return l}},$t=class{options;block;constructor(n){this.options=n||ht}static passThroughHooks=new Set(["preprocess","postprocess","processAllTokens"]);preprocess(n){return n}postprocess(n){return n}processAllTokens(n){return n}provideLexer(){return this.block?Ye.lex:Ye.lexInline}provideParser(){return this.block?Ze.parse:Ze.parseInline}},Wi=class{defaults=Rs();options=this.setOptions;parse=this.parseMarkdown(!0);parseInline=this.parseMarkdown(!1);Parser=Ze;Renderer=Qt;TextRenderer=Fs;Lexer=Ye;Tokenizer=Gt;Hooks=$t;constructor(...n){this.use(...n)}walkTokens(n,t){let s=[];for(let l of n)switch(s=s.concat(t.call(this,l)),l.type){case"table":{let r=l;for(let d of r.header)s=s.concat(this.walkTokens(d.tokens,t));for(let d of r.rows)for(let o of d)s=s.concat(this.walkTokens(o.tokens,t));break}case"list":{let r=l;s=s.concat(this.walkTokens(r.items,t));break}default:{let r=l;this.defaults.extensions?.childTokens?.[r.type]?this.defaults.extensions.childTokens[r.type].forEach(d=>{let o=r[d].flat(1/0);s=s.concat(this.walkTokens(o,t))}):r.tokens&&(s=s.concat(this.walkTokens(r.tokens,t)))}}return s}use(...n){let t=this.defaults.extensions||{renderers:{},childTokens:{}};return n.forEach(s=>{let l={...s};if(l.async=this.defaults.async||l.async||!1,s.extensions&&(s.extensions.forEach(r=>{if(!r.name)throw new Error("extension name required");if("renderer"in r){let d=t.renderers[r.name];d?t.renderers[r.name]=function(...o){let c=r.renderer.apply(this,o);return c===!1&&(c=d.apply(this,o)),c}:t.renderers[r.name]=r.renderer}if("tokenizer"in r){if(!r.level||r.level!=="block"&&r.level!=="inline")throw new Error("extension level must be 'block' or 'inline'");let d=t[r.level];d?d.unshift(r.tokenizer):t[r.level]=[r.tokenizer],r.start&&(r.level==="block"?t.startBlock?t.startBlock.push(r.start):t.startBlock=[r.start]:r.level==="inline"&&(t.startInline?t.startInline.push(r.start):t.startInline=[r.start]))}"childTokens"in r&&r.childTokens&&(t.childTokens[r.name]=r.childTokens)}),l.extensions=t),s.renderer){let r=this.defaults.renderer||new Qt(this.defaults);for(let d in s.renderer){if(!(d in r))throw new Error(`renderer '${d}' does not exist`);if(["options","parser"].includes(d))continue;let o=d,c=s.renderer[o],h=r[o];r[o]=(...m)=>{let b=c.apply(r,m);return b===!1&&(b=h.apply(r,m)),b||""}}l.renderer=r}if(s.tokenizer){let r=this.defaults.tokenizer||new Gt(this.defaults);for(let d in s.tokenizer){if(!(d in r))throw new Error(`tokenizer '${d}' does not exist`);if(["options","rules","lexer"].includes(d))continue;let o=d,c=s.tokenizer[o],h=r[o];r[o]=(...m)=>{let b=c.apply(r,m);return b===!1&&(b=h.apply(r,m)),b}}l.tokenizer=r}if(s.hooks){let r=this.defaults.hooks||new $t;for(let d in s.hooks){if(!(d in r))throw new Error(`hook '${d}' does not exist`);if(["options","block"].includes(d))continue;let o=d,c=s.hooks[o],h=r[o];$t.passThroughHooks.has(d)?r[o]=m=>{if(this.defaults.async)return Promise.resolve(c.call(r,m)).then(f=>h.call(r,f));let b=c.call(r,m);return h.call(r,b)}:r[o]=(...m)=>{let b=c.apply(r,m);return b===!1&&(b=h.apply(r,m)),b}}l.hooks=r}if(s.walkTokens){let r=this.defaults.walkTokens,d=s.walkTokens;l.walkTokens=function(o){let c=[];return c.push(d.call(this,o)),r&&(c=c.concat(r.call(this,o))),c}}this.defaults={...this.defaults,...l}}),this}setOptions(n){return this.defaults={...this.defaults,...n},this}lexer(n,t){return Ye.lex(n,t??this.defaults)}parser(n,t){return Ze.parse(n,t??this.defaults)}parseMarkdown(n){return(t,s)=>{let l={...s},r={...this.defaults,...l},d=this.onError(!!r.silent,!!r.async);if(this.defaults.async===!0&&l.async===!1)return d(new Error("marked(): The async option was set to true by an extension. Remove async: false from the parse options object to return a Promise."));if(typeof t>"u"||t===null)return d(new Error("marked(): input parameter is undefined or null"));if(typeof t!="string")return d(new Error("marked(): input parameter is of type "+Object.prototype.toString.call(t)+", string expected"));r.hooks&&(r.hooks.options=r,r.hooks.block=n);let o=r.hooks?r.hooks.provideLexer():n?Ye.lex:Ye.lexInline,c=r.hooks?r.hooks.provideParser():n?Ze.parse:Ze.parseInline;if(r.async)return Promise.resolve(r.hooks?r.hooks.preprocess(t):t).then(h=>o(h,r)).then(h=>r.hooks?r.hooks.processAllTokens(h):h).then(h=>r.walkTokens?Promise.all(this.walkTokens(h,r.walkTokens)).then(()=>h):h).then(h=>c(h,r)).then(h=>r.hooks?r.hooks.postprocess(h):h).catch(d);try{r.hooks&&(t=r.hooks.preprocess(t));let h=o(t,r);r.hooks&&(h=r.hooks.processAllTokens(h)),r.walkTokens&&this.walkTokens(h,r.walkTokens);let m=c(h,r);return r.hooks&&(m=r.hooks.postprocess(m)),m}catch(h){return d(h)}}}onError(n,t){return s=>{if(s.message+=`
Please report this to https://github.com/markedjs/marked.`,n){let l="<p>An error occurred:</p><pre>"+Ve(s.message+"",!0)+"</pre>";return t?Promise.resolve(l):l}if(t)return Promise.reject(s);throw s}}},ut=new Wi;function ge(n,t){return ut.parse(n,t)}ge.options=ge.setOptions=function(n){return ut.setOptions(n),ge.defaults=ut.defaults,Br(ge.defaults),ge};ge.getDefaults=Rs;ge.defaults=ht;ge.use=function(...n){return ut.use(...n),ge.defaults=ut.defaults,Br(ge.defaults),ge};ge.walkTokens=function(n,t){return ut.walkTokens(n,t)};ge.parseInline=ut.parseInline;ge.Parser=Ze;ge.parser=Ze.parse;ge.Renderer=Qt;ge.TextRenderer=Fs;ge.Lexer=Ye;ge.lexer=Ye.lex;ge.Tokenizer=Gt;ge.Hooks=$t;ge.parse=ge;ge.options;ge.setOptions;ge.use;ge.walkTokens;ge.parseInline;Ze.parse;Ye.lex;function qi(){const[n,t]=u.useState(null),[s,l]=u.useState(null),[r,d]=u.useState(!0),[o,c]=u.useState(!1),[h,m]=u.useState(!1),[b,f]=u.useState(!1),[y,S]=u.useState(null),[g,C]=u.useState(""),[w,E]=u.useState(""),[k,p]=u.useState(""),[_,B]=u.useState(""),[v,W]=u.useState(""),[j,P]=u.useState(""),[T,F]=u.useState("");u.useEffect(()=>{Q()},[]);const Q=async()=>{try{d(!0);const{data:z}=await N.auth.getUser(),A=z.user;if(A){t(A),p(A.email||"");const{data:H}=await N.from("users").select("*").eq("id",A.id).single();H&&(l(H),C(H.first_name||""),E(H.last_name||""),B(H.role||"UI Developer"),W(H.department||""),P(H.avatar_url||""),F(H.phone_number||"")),!H?.phone_number&&A.user_metadata?.phone_number&&F(A.user_metadata.phone_number),A.user_metadata&&(!H?.first_name&&A.user_metadata.first_name&&C(A.user_metadata.first_name),!H?.last_name&&A.user_metadata.last_name&&E(A.user_metadata.last_name))}}catch(z){console.error("Error loading user data:",z),S({type:"danger",text:"Failed to load user data"})}finally{d(!1)}},x=async()=>{if(!n)return;if(T&&!/^\+[1-9]\d{7,}$/.test(T)){S({type:"danger",text:"Phone number must include country code and be valid (e.g., +4512345678, +1234567890)"});return}if(!g.trim()){S({type:"danger",text:"First name is required"});return}try{m(!0);const{error:A}=await N.from("users").update({role:_.trim()||null,department:v.trim()||null,avatar_url:j.trim()||null,phone_number:T.trim()||null,first_name:g.trim(),last_name:w.trim()||null}).eq("id",n.id);if(A)throw A;const{error:H}=await N.auth.updateUser({data:{first_name:g.trim(),last_name:w.trim()||null,full_name:`${g.trim()} ${w.trim()}`.trim(),phone_number:T.trim()||null}});H&&console.warn("Failed to update auth.users metadata:",H),await Q(),c(!1),S({type:"success",text:"Profile updated successfully"}),setTimeout(()=>S(null),3e3)}catch(A){console.error("Error saving profile:",A);let H="Failed to save profile";A instanceof Error&&(A.message.includes("phone_number_format_check")?H="Phone number format is invalid. Please use international format with country code (e.g., +4512345678)":H=`Failed to save profile: ${A.message}`),S({type:"danger",text:H})}finally{m(!1)}},O=async z=>{const A=z.target.files?.[0];if(!(!A||!n)){if(!A.type.startsWith("image/")){S({type:"danger",text:"Please select a valid image file"});return}if(A.size>5*1024*1024){S({type:"danger",text:"Image size must be less than 5MB"});return}try{f(!0),S(null);const H=A.name.split(".").pop(),he=`${n.id}-${Date.now()}.${H}`,{data:oe,error:X}=await N.storage.from("avatars").upload(he,A,{cacheControl:"3600",upsert:!0});if(X)throw new Error(`Upload failed: ${X.message}`);const{data:{publicUrl:de}}=N.storage.from("avatars").getPublicUrl(he);P(de);const{error:Y}=await N.from("users").update({avatar_url:de}).eq("id",n.id);if(Y)throw new Error(`Database update failed: ${Y.message}`);await Q(),S({type:"success",text:"Avatar uploaded successfully"}),setTimeout(()=>S(null),3e3)}catch(H){let ae="Failed to upload avatar";H instanceof Error&&(H.message.includes("not found")?ae="Storage bucket not configured. Please contact admin.":H.message.includes("permission")?ae="Permission denied. Please contact admin.":ae=`Upload failed: ${H.message}`),S({type:"danger",text:ae})}finally{f(!1),z.target.value=""}}},V=()=>{C(s?.first_name||""),E(s?.last_name||""),B(s?.role||"UI Developer"),W(s?.department||""),P(s?.avatar_url||""),F(s?.phone_number||""),c(!1),S(null)};return r?e.jsx(ce,{children:e.jsx(De,{children:e.jsx(a,{level:"body-sm",color:"neutral",children:"Loading profile..."})})}):e.jsx(ce,{children:e.jsxs(De,{children:[e.jsx(a,{level:"h4",sx:{mb:1},children:"Personal info"}),e.jsx(a,{level:"body-sm",color:"neutral",sx:{mb:3},children:"Your profile information."}),y&&e.jsx(He,{color:y.type,sx:{mb:2},children:y.text}),e.jsxs(i,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},gap:3,alignItems:{xs:"center",sm:"stretch"},width:"100%",maxWidth:"100%",overflow:"hidden"},children:[e.jsx(i,{sx:{flex:{xs:"none",sm:"1"},maxWidth:{xs:"100%",sm:"300px"},display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",position:"relative",minHeight:{xs:"auto",sm:"400px"},width:{xs:"100%",sm:"auto"}},children:e.jsxs(i,{sx:{position:"relative",display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsxs(xe,{size:"lg",src:j||s?.avatar_url||n?.user_metadata?.avatar_url,sx:{width:160,height:160},children:[g?.[0],w?.[0]]},`avatar-${j}-${s?.avatar_url}`),o&&e.jsxs(i,{sx:{mt:2,display:"flex",flexDirection:"column",alignItems:"center",gap:1},children:[e.jsxs(me,{component:"label",size:"sm",variant:"solid",color:"primary",loading:b,sx:{borderRadius:"8px",px:2,py:1},children:[e.jsx(ct,{fontSize:"small",sx:{mr:1}}),"Upload Avatar",e.jsx("input",{type:"file",accept:"image/*",onChange:O,style:{display:"none"}})]}),e.jsx(a,{level:"body-xs",color:"neutral",sx:{textAlign:"center",maxWidth:180,lineHeight:1.4},children:"Max 5MB (JPG, PNG, GIF)"})]})]})}),e.jsxs(i,{sx:{flex:{xs:"none",sm:"2"},maxWidth:{xs:"100%",sm:"calc(100% - 300px - 24px)"},width:{xs:"100%",sm:"auto"},minWidth:0},children:[e.jsxs(K,{spacing:2,children:[e.jsxs(i,{children:[e.jsx(ee,{sx:{mb:1},children:"Name"}),e.jsxs(i,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},gap:2},children:[e.jsx($,{placeholder:"First name",value:g,onChange:z=>C(z.target.value),disabled:!o,sx:{flex:1}}),e.jsx($,{placeholder:"Last name",value:w,onChange:z=>E(z.target.value),disabled:!o,sx:{flex:1}})]})]}),e.jsxs(se,{children:[e.jsx(ee,{children:"Phone Number"}),e.jsx($,{value:T,onChange:z=>F(z.target.value),disabled:!o,placeholder:"e.g., +4512345678, +1234567890",startDecorator:"📞"}),o&&e.jsx(a,{level:"body-xs",color:"neutral",sx:{mt:.5},children:"Include country code (e.g., +45 for Denmark, +1 for US/Canada)"})]}),e.jsxs(i,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},gap:2},children:[e.jsxs(se,{sx:{flex:1},children:[e.jsx(ee,{children:"Role"}),e.jsx($,{value:_,onChange:z=>B(z.target.value),disabled:!o})]}),e.jsxs(se,{sx:{flex:1},children:[e.jsx(ee,{children:"Department"}),e.jsx($,{value:v,onChange:z=>W(z.target.value),disabled:!o,placeholder:"e.g., Engineering, Sales, Marketing"})]})]}),e.jsxs(se,{children:[e.jsx(ee,{children:"Email"}),e.jsx($,{value:k,disabled:!0,startDecorator:"✉️"})]}),e.jsxs(se,{children:[e.jsx(ee,{children:"Avatar URL"}),e.jsx($,{value:j,onChange:z=>P(z.target.value),disabled:!o,placeholder:"https://example.com/avatar.jpg",startDecorator:"🖼️"})]}),s&&e.jsxs(i,{sx:{mt:2,p:2,bgcolor:"background.level1",borderRadius:"sm"},children:[e.jsx(a,{level:"body-sm",color:"neutral",sx:{mb:1},children:"Account Information"}),e.jsxs(K,{spacing:1,children:[s.created_at&&e.jsxs(a,{level:"body-sm",children:[e.jsx("strong",{children:"Member since:"})," ",new Date(s.created_at).toLocaleDateString()]}),s.last_login&&e.jsxs(a,{level:"body-sm",children:[e.jsx("strong",{children:"Last login:"})," ",new Date(s.last_login).toLocaleDateString()]}),(s.phone_number||T)&&e.jsxs(a,{level:"body-sm",children:[e.jsx("strong",{children:"Phone (stored):"})," ",s.phone_number||T]}),e.jsxs(a,{level:"body-sm",children:[e.jsx("strong",{children:"User ID:"})," ",s.id]})]})]})]}),e.jsx(i,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},gap:1,mt:3,justifyContent:{xs:"stretch",sm:"flex-end"}},children:o?e.jsxs(e.Fragment,{children:[e.jsx(q,{variant:"outlined",onClick:V,disabled:h,startDecorator:e.jsx(Ds,{}),sx:{order:{xs:2,sm:1}},children:"Cancel"}),e.jsx(q,{variant:"solid",onClick:x,loading:h,startDecorator:e.jsx(tl,{}),sx:{order:{xs:1,sm:2}},children:"Save"})]}):e.jsx(q,{variant:"outlined",onClick:()=>c(!0),startDecorator:e.jsx(ct,{}),children:"Edit Profile"})})]})]})]})})}function Fi(){const[n,t]=ie.useState(""),[s,l]=ie.useState(!0),[r,d]=ie.useState(!1),o=`## Latest Release
**Version 2.1.2** - July 6, 2025

### Recent Updates
- Modern Login Page Redesign with Split Layout
- Glassmorphism effect with backdrop blur and semi-transparent backgrounds
- Dynamic mountain landscape background images that change with light/dark mode
- Dark/light mode toggle in login page header
- Company branding with SmartBack logo and name in header

### System Status
- All systems operational
- Database migrations up to date
- Authentication services active

*For complete release history, please check the development environment or contact support.*`;return ie.useEffect(()=>{const c="/RELEASE_LOG.md";console.log("Fetching release log from:",c),fetch(c).then(h=>{if(console.log("Release log response status:",h.status,h.statusText),!h.ok)throw new Error(`Failed to fetch release log: ${h.status} ${h.statusText}`);return h.text()}).then(h=>{console.log("Release log loaded successfully, length:",h.length);const m=h.replace(/<!--[\s\S]*?-->/g,"").trim();t(m),d(!1)}).catch(h=>{console.error("Error fetching release log:",h),console.log("Using fallback content"),t(o),d(!1)}).finally(()=>l(!1))},[o]),e.jsx(ce,{sx:{height:"100%",minHeight:{xs:200,md:300}},children:e.jsxs(De,{sx:{display:"flex",flexDirection:"column",height:"100%"},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(Wr,{color:"primary"}),e.jsx(a,{level:"h4",children:"Release Log"})]}),e.jsxs(i,{sx:{flex:1,overflow:"auto"},children:[s&&e.jsx(a,{level:"body-sm",color:"neutral",children:"Loading release log..."}),!s&&e.jsx(i,{sx:{typography:"body-sm"},children:e.jsx("div",{dangerouslySetInnerHTML:{__html:ge(n)}})})]})]})})}function Ui(){return Pe(),e.jsx(ce,{sx:{height:"100%",minHeight:{xs:120,md:300}},children:e.jsxs(De,{sx:{display:"flex",flexDirection:"column",height:"100%"},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(sl,{color:"primary"}),e.jsx(a,{level:"h4",children:"Application Info"})]}),e.jsxs(K,{spacing:1.5,sx:{flex:1},children:[e.jsxs(a,{level:"title-md",sx:{fontWeight:"bold"},children:["smartback".charAt(0).toUpperCase()+"smartback".slice(1)," business System"]}),e.jsxs(K,{spacing:.5,children:[e.jsxs(a,{level:"body-sm",color:"neutral",children:[e.jsx("strong",{children:"Environment:"})," ","production"]}),e.jsxs(a,{level:"body-sm",color:"neutral",children:[e.jsx("strong",{children:"Version:"})," ","3.2.18"]}),e.jsxs(a,{level:"body-sm",color:"neutral",children:[e.jsx("strong",{children:"Build Date:"})," ",new Date().toLocaleDateString()]}),e.jsxs(a,{level:"body-sm",color:"neutral",children:[e.jsx("strong",{children:"Platform:"})," Web Application"]}),e.jsxs(a,{level:"body-sm",color:"neutral",children:[e.jsx("strong",{children:"Language:"})," English (US)"]}),e.jsxs(a,{level:"body-sm",color:"neutral",children:[e.jsx("strong",{children:"Currency:"})," ",Je.currency," (",Je.symbol,") - ",Je.locale]}),e.jsxs(a,{level:"body-sm",color:"neutral",children:[e.jsx("strong",{children:"Currency Precision:"})," Smart formatting (0-2 decimal places)"]})]})]}),e.jsxs(i,{sx:{mt:3,p:2,backgroundColor:"neutral.50",borderRadius:"md"},children:[e.jsx(a,{level:"title-sm",sx:{mb:1},children:"Currency Formatting Examples"}),e.jsxs(K,{spacing:.5,children:[e.jsxs(a,{level:"body-xs",color:"neutral",children:[e.jsx("strong",{children:"Whole numbers:"})," ",We(100)," • ",We(1500)," • ",We(25e3)]}),e.jsxs(a,{level:"body-xs",color:"neutral",children:[e.jsx("strong",{children:"With decimals:"})," ",We(99.5)," • ",We(1234.56)," • ",We(15.25)]})]})]}),e.jsx(q,{component:"a",href:"https://nicklasfangerfisk.github.io/Testflow/",target:"_blank",rel:"noopener noreferrer",startDecorator:e.jsx(rl,{}),variant:"outlined",color:"primary",sx:{mt:2,alignSelf:"flex-start"},children:"System Test"})]})})}const Bi=()=>{const{isMobile:n}=Pe(),[t,s]=u.useState(0),l=async()=>{try{const{error:c}=await N.auth.signOut();c?console.error("Error signing out:",c):window.location.href="/login"}catch(c){console.error("Error during logout:",c)}},r=[{label:"User",icon:e.jsx(ot,{}),content:e.jsx(qi,{})},{label:"App",icon:e.jsx(el,{}),content:e.jsx(Ui,{})},{label:"Releases",icon:e.jsx(Wr,{}),content:e.jsx(Fi,{})}],d=()=>e.jsx(i,{sx:{width:"100%",minHeight:"100vh"},children:e.jsxs(ke,{padding:"medium",children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(a,{level:"h2",sx:{fontSize:le.sizes.xlarge},children:"My profile"}),e.jsx(q,{variant:"outlined",color:"danger",size:"sm",startDecorator:e.jsx(er,{}),onClick:l,children:"Logout"})]}),e.jsxs(Vs,{value:t,onChange:(c,h)=>s(typeof h=="number"?h:0),sx:{bgcolor:"transparent"},children:[e.jsx(Gs,{sx:{bgcolor:"transparent"},children:r.map((c,h)=>e.jsx(Qs,{value:h,sx:{bgcolor:"transparent"},children:c.label},h))}),r.map((c,h)=>e.jsx(Ys,{value:h,sx:{p:0,pt:3,bgcolor:"transparent"},children:c.content},h))]})]})}),o=()=>e.jsxs(ke,{variant:"table-page",children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(a,{level:"h2",sx:{fontSize:le.sizes.xlarge},children:"My profile"}),e.jsx(q,{variant:"outlined",color:"danger",startDecorator:e.jsx(er,{}),onClick:l,children:"Logout"})]}),e.jsxs(Vs,{value:t,onChange:(c,h)=>s(typeof h=="number"?h:0),sx:{bgcolor:"transparent"},children:[e.jsx(Gs,{sx:{bgcolor:"transparent"},children:r.map((c,h)=>e.jsx(Qs,{value:h,sx:{bgcolor:"transparent"},children:c.label},h))}),r.map((c,h)=>e.jsx(Ys,{value:h,sx:{p:0,pt:3,bgcolor:"transparent"},children:c.content},h))]})]});return e.jsx(Fe,{children:n?e.jsx(d,{}):e.jsx(o,{})})},Hi=[{name:"Health Check",endpoint:"/api/health",method:"GET",description:"Check API health and status",parameters:[],category:"System"},{name:"Send Order Confirmation",endpoint:"/api/send-order-confirmation",method:"POST",description:"Send order confirmation email",parameters:[{name:"testEmail",type:"string",required:!1,description:"Email address for test email",defaultValue:"test@example.com"},{name:"orderUuid",type:"string",required:!1,description:"UUID of existing order"},{name:"storefrontId",type:"string",required:!1,description:"Storefront identifier"}],category:"Email"},{name:"Send SMS Campaign",endpoint:"/api/send-sms-campaign",method:"POST",description:"Send SMS campaign",parameters:[{name:"campaignId",type:"string",required:!0,description:"Campaign identifier"},{name:"message",type:"string",required:!0,description:"SMS message content"}],category:"SMS"}];function Vi(){const[n,t]=u.useState({}),[s,l]=u.useState({}),[r,d]=u.useState({}),o=async m=>{const b=m.name;l(y=>({...y,[b]:!0}));const f=Date.now();try{let y;const S=r[b]||{},g=m.parameters.reduce((w,E)=>{const k=S[E.name]??E.defaultValue;return k!==void 0&&k!==""&&(w[E.name]=k),w},{});m.endpoint==="/api/health"?y=await xt.healthCheck():m.endpoint==="/api/send-order-confirmation"?y=await xt.sendOrderConfirmation(g.orderUuid,g.testEmail,g.storefrontId):m.endpoint==="/api/send-sms-campaign"?y=await xt.sendSMSCampaign(g):y=await xt.request(m.endpoint,{method:m.method,body:Object.keys(g).length>0?g:void 0});const C=Date.now()-f;t(w=>({...w,[b]:{...y,duration:C,timestamp:new Date().toISOString()}}))}catch(y){const S=Date.now()-f;t(g=>({...g,[b]:{success:!1,error:y.message,statusCode:0,duration:S,timestamp:new Date().toISOString()}}))}finally{l(y=>({...y,[b]:!1}))}},c=(m,b,f)=>{d(y=>({...y,[m]:{...y[m],[b]:f}}))},h=Hi.reduce((m,b)=>(m[b.category]||(m[b.category]=[]),m[b.category].push(b),m),{});return e.jsxs(i,{sx:{p:3},children:[e.jsx(a,{level:"h2",sx:{mb:3},children:"Functions Console"}),e.jsx(He,{color:"primary",sx:{mb:3},children:e.jsx(a,{children:"This console allows you to test all API endpoints. Use this for development, debugging, and validation of API functionality across environments."})}),Object.entries(h).map(([m,b])=>e.jsx(ce,{sx:{mb:3},children:e.jsxs(De,{children:[e.jsxs(a,{level:"h3",sx:{mb:2},children:[m," APIs"]}),b.map(f=>{const y=f.name,S=n[y],g=s[y];return e.jsxs(wn,{sx:{mb:2},children:[e.jsx(Sn,{indicator:e.jsx(Nr,{}),children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2,width:"100%"},children:[e.jsx(re,{color:f.method==="GET"?"primary":"warning",children:f.method}),e.jsx(a,{level:"title-md",children:f.name}),e.jsx(a,{level:"body-sm",sx:{ml:"auto"},children:f.endpoint}),S&&e.jsx(re,{color:S.success?"success":"danger",startDecorator:S.success?e.jsx(gt,{}):e.jsx(Is,{}),children:S.success?"Success":"Failed"})]})}),e.jsxs(Cn,{children:[e.jsx(a,{level:"body-sm",sx:{mb:2},children:f.description}),f.parameters.length>0&&e.jsxs(i,{sx:{mb:3},children:[e.jsx(a,{level:"title-sm",sx:{mb:1},children:"Parameters:"}),e.jsx(je,{container:!0,spacing:2,children:f.parameters.map(C=>e.jsx(je,{xs:12,md:6,children:e.jsxs(i,{children:[e.jsxs(a,{level:"body-sm",sx:{mb:1},children:[C.name," ",C.required&&e.jsx("span",{style:{color:"red"},children:"*"})]}),e.jsx("input",{type:"text",placeholder:C.description,value:r[y]?.[C.name]??C.defaultValue??"",onChange:w=>c(y,C.name,w.target.value),style:{width:"100%",padding:"8px 12px",border:"1px solid #ccc",borderRadius:"6px",fontSize:"14px"}}),e.jsx(a,{level:"body-xs",sx:{mt:.5,color:"text.secondary"},children:`${C.type}${C.required?" (required)":" (optional)"}`})]})},C.name))})]}),e.jsx(q,{startDecorator:g?e.jsx(Wt,{size:"sm"}):e.jsx(nl,{}),onClick:()=>o(f),disabled:g,color:"primary",sx:{mb:2},children:g?"Testing...":"Test API"}),S&&e.jsx(ce,{variant:"outlined",children:e.jsxs(De,{children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",mb:2},children:[e.jsx(a,{level:"title-sm",children:"Test Result"}),e.jsxs(a,{level:"body-xs",children:[S.duration,"ms | ",new Date(S.timestamp).toLocaleTimeString()]})]}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2},children:[e.jsxs(re,{color:S.success?"success":"danger",children:["Status: ",S.statusCode]}),e.jsx(re,{color:S.success?"success":"danger",children:S.success?"Success":"Failed"})]}),S.error&&e.jsx(He,{color:"danger",sx:{mb:2},children:e.jsx(a,{level:"body-sm",children:S.error})}),S.data&&e.jsxs(i,{children:[e.jsx(a,{level:"title-sm",sx:{mb:1},children:"Response Data:"}),e.jsx(i,{component:"pre",sx:{background:"var(--joy-palette-neutral-50)",p:2,borderRadius:"sm",overflow:"auto",fontSize:"sm"},children:JSON.stringify(S.data,null,2)})]})]})})]})]},f.name)})]})},m))]})}function Gi(){const n=As(),{isMobile:t}=Pe(),s=Ps(),[l,r]=u.useState("dashboard"),d=[{label:"Dashboard",icon:e.jsx(vs,{}),value:"dashboard"},{label:"Orders",icon:e.jsx(ws,{}),value:"orders"},{label:"Customers",icon:e.jsx(Ss,{}),value:"customers"},{label:"My Profile",icon:e.jsx(ot,{}),value:"profile"},{label:"Settings",icon:e.jsx(ll,{}),value:"settings"}];return u.useEffect(()=>{r({"/":"dashboard","/dashboard":"dashboard","/orders":"orders","/products":"dashboard","/users":"users","/suppliers":"dashboard","/purchase-orders":"dashboard","/tickets":"dashboard","/sms-campaigns":"dashboard","/movements":"dashboard","/settings":"profile","/email-settings":"profile"}[n.pathname]||"dashboard")},[n.pathname]),console.log("isMobile:",t),e.jsxs(i,{sx:{display:"flex",height:"100vh",overflow:"hidden"},children:[n.pathname!=="/login"&&!t&&e.jsx(pl,{setView:o=>console.log(o),view:"home"}),e.jsxs(i,{component:"main",sx:{flexGrow:1,display:"flex",flexDirection:"column",height:"100%",bgcolor:"background.default",p:0,width:t?"100%":"calc(100% - var(--Sidebar-width, 240px))",marginBottom:t?"56px":0,overflow:"auto"},children:[t&&n.pathname!=="/login"&&e.jsx(Vl,{items:d,value:l,onChange:o=>{r(o);const h={home:"/",dashboard:"/dashboard",orders:"/orders",products:"/products",users:"/users",customers:"/customers",employees:"/employees",suppliers:"/suppliers",purchaseorders:"/purchase-orders",tickets:"/tickets",smscampaigns:"/sms-campaigns",movements:"/movements",profile:"/settings",settings:"/settings",emailsettings:"/email-settings",functions:"/functions"}[o]||`/${o}`;s(h)},toggleSidebar:()=>console.log("Sidebar toggled")}),e.jsxs(Es,{children:[e.jsx(_e,{path:"/",element:e.jsx(Bt,{to:"/dashboard",replace:!0})}),e.jsx(_e,{path:"/orders",element:e.jsx(Le,{children:e.jsx(Dl,{})})}),e.jsx(_e,{path:"/products",element:e.jsx(Le,{children:e.jsx(Pl,{})})}),e.jsx(_e,{path:"/users",element:e.jsx(Le,{children:e.jsx(El,{})})}),e.jsx(_e,{path:"/customers",element:e.jsx(Le,{children:e.jsx(Rl,{})})}),e.jsx(_e,{path:"/employees",element:e.jsx(Le,{children:e.jsx(Nl,{})})}),e.jsx(_e,{path:"/suppliers",element:e.jsx(Le,{children:e.jsx(Ml,{})})}),e.jsx(_e,{path:"/storefronts",element:e.jsx(Le,{children:e.jsx(ql,{})})}),e.jsx(_e,{path:"/purchase-orders",element:e.jsx(Le,{children:e.jsx(Hl,{})})}),e.jsx(_e,{path:"/tickets",element:e.jsx(Le,{children:e.jsx(Yl,{})})}),e.jsx(_e,{path:"/sms-campaigns",element:e.jsx(Le,{children:e.jsx(Jl,{})})}),e.jsx(_e,{path:"/dashboard",element:e.jsx(Le,{children:e.jsx(Xl,{})})}),e.jsx(_e,{path:"/movements",element:e.jsx(Le,{children:e.jsx(ri,{})})}),e.jsx(_e,{path:"/settings",element:e.jsx(Le,{children:e.jsx(Bi,{})})}),e.jsx(_e,{path:"/email-settings",element:e.jsx(Le,{children:e.jsx(ni,{})})}),e.jsx(_e,{path:"/functions",element:e.jsx(Le,{children:e.jsx(Vi,{})})}),e.jsx(_e,{path:"*",element:e.jsx(Bt,{to:"/",replace:!0})})]})]})]})}function Qi(){return e.jsx(Ar,{children:e.jsx(al,{children:e.jsxs(Es,{children:[e.jsx(_e,{path:"/login/*",element:e.jsx(si,{})}),e.jsx(_e,{path:"/*",element:e.jsx(Gi,{})})]})})})}console.log("Mounting React app...");const _r=document.getElementById("root");_r?(cl.createRoot(_r).render(e.jsx(Qi,{})),console.log("React app rendered!")):console.error("No #root element found in index.html!");

import{b as Zr,u as Sr,r as u,j as e,I as xe,R as ie,d as Yr,e as Ot,B as i,G as Cr,T as c,f as $,L as is,h as as,i as os,k as ft,l as Ts,m as Jr,D as Ae,A as he,M as Ne,n as $e,o as Fe,p as wt,q as St,s as Ct,F as te,t as ee,S as ye,v as F,w as q,x as Ue,y as Nt,z as X,C as bt,E as Ce,H as me,J as Re,K as kr,N as jt,O as ae,P as Ms,Q as Xr,U as Kr,V as el,W as tl,X as it,Y as Ht,Z as De,_ as ps,$ as ms,a0 as gs,a1 as Te,a2 as $t,a3 as sl,a4 as rl,a5 as ll,a6 as nl,a7 as il,a8 as al,a9 as Ws,aa as ol,ab as cl,ac as dl,ad as qs,ae as ul,af as _r,ag as hl,ah as xl,ai as Fs,aj as Us,ak as Bs,al as Hs}from"./mui-core-jzIMPNSh.js";import{D as Dr,L as pl,H as ml,a as fs,S as js,b as Ir,G as bs,B as Pr,c as zr,A as Ar,Q as Or,d as Tt,P as at,W as Mt,e as gl,K as fl,f as ve,g as ht,h as Vt,i as jl,j as bl,F as yl,C as Yt,k as Gt,E as vl,l as wl,m as Sl,n as Cl,o as Se,p as ys,q as Vs,r as yt,s as Gs,t as kt,I as Er,u as ot,v as Qs,w as Ke,x as ct,y as vs,M as ws,z as Ss,J as Zs,N as cs,O as kl,R as Rr,T as _l,U as Dl,V as Ys,X as Il,Y as Pl,Z as zl,_ as Al,$ as Ol,a0 as El,a1 as Rl,a2 as Ll,a3 as Nl,a4 as Js,a5 as $l,a6 as Lr,a7 as Tl,a8 as Ml,a9 as Wl,aa as ql}from"./mui-icons-DNhgYtln.js";import{c as Fl}from"./supabase-BGWZ6dh3.js";import{N as Wt,u as Cs,a as ks,R as _s,b as _e,B as Ul}from"./router-C8FAV-pK.js";import{f as Jt}from"./utils-CSQe5d3I.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const d of s)if(d.type==="childList")for(const a of d.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function r(s){const d={};return s.integrity&&(d.integrity=s.integrity),s.referrerPolicy&&(d.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?d.credentials="include":s.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function n(s){if(s.ep)return;s.ep=!0;const d=r(s);fetch(s.href,d)}})();var It={},Xs;function Bl(){if(Xs)return It;Xs=1;var l=Zr();return It.createRoot=l.createRoot,It.hydrateRoot=l.hydrateRoot,It}var Hl=Bl();function Vl(l){const{onClick:t,sx:r,...n}=l,{mode:s,setMode:d}=Sr(),[a,o]=u.useState(!1);return u.useEffect(()=>{o(!0)},[]),a?e.jsxs(xe,{"data-screenshot":"toggle-mode",size:"sm",variant:"outlined",color:"neutral",...n,onClick:x=>{d(s==="light"?"dark":"light"),t?.(x)},sx:[s==="dark"?{"& > *:first-of-type":{display:"none"}}:{"& > *:first-of-type":{display:"initial"}},s==="light"?{"& > *:last-of-type":{display:"none"}}:{"& > *:last-of-type":{display:"initial"}},...Array.isArray(r)?r:[r]],children:[e.jsx(Dr,{}),e.jsx(pl,{})]}):e.jsx(xe,{size:"sm",variant:"outlined",color:"neutral",...n,sx:r,disabled:!0})}const Nr="https://tfzvtzqybgbzxcxozdes.supabase.co",ds="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmenZ0enF5YmdienhjeG96ZGVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc4NTc2MDIsImV4cCI6MjA2MzQzMzYwMn0.hD2WdkvI8LY9N0IHP7HDQliyicQA0c-mspKjCJf0_Fc";console.log("[Supabase] URL:",Nr);console.log("[Supabase] Anon Key:",ds.slice(0,6)+"..."+ds.slice(-6));const T=Fl(Nr,ds);T.auth.onAuthStateChange((l,t)=>{console.log("[Auth State Change]",l,t),l==="SIGNED_IN"?console.log("User signed in:",t?.user):l==="SIGNED_OUT"&&console.log("User signed out")});let Xt=!1;T.auth.onAuthStateChange((l,t)=>{Xt||(Xt=!0,console.log("[Auth State Change]",l,t),l==="SIGNED_IN"?console.log("User signed in:",t?.user):l==="SIGNED_OUT"&&(console.log("User signed out"),window.location.pathname!=="/login"&&(window.location.href="/login")),Xt=!1)});const Ds=l=>t=>{const[r,n]=ie.useState(null),[s,d]=ie.useState(!0);return ie.useEffect(()=>{async function a(){const{data:o}=await T.auth.getSession();n(o?.session||null),d(!1)}a()},[]),s?e.jsx("div",{children:"Loading..."}):r?e.jsx(l,{...t}):e.jsx(Wt,{to:"/login",replace:!0})},Gl=[{label:"Home",icon:ie.createElement(ml),value:"home",route:"/",showInMobile:!0},{label:"Dashboard",icon:ie.createElement(fs),value:"dashboard",route:"/dashboard",showInMobile:!0},{label:"Orders",icon:ie.createElement(js),value:"orders",route:"/orders",showInMobile:!0},{label:"Products",icon:ie.createElement(Ir),value:"products",route:"/products",showInMobile:!0},{label:"Customers",icon:ie.createElement(bs),value:"customers",route:"/customers",showInMobile:!0},{label:"Employees",icon:ie.createElement(Pr),value:"employees",route:"/employees",showInMobile:!0},{label:"Suppliers",icon:ie.createElement(zr),value:"suppliers",route:"/suppliers",showInMobile:!0},{label:"Purchase Orders",icon:ie.createElement(Ar),value:"purchaseorders",route:"/purchase-orders",showInMobile:!0},{label:"Tickets",icon:ie.createElement(Or),value:"tickets",route:"/tickets",showInMobile:!0},{label:"SMS Campaigns",icon:ie.createElement(Tt),value:"smscampaigns",route:"/sms-campaigns",showInMobile:!0},{label:"Movements",icon:ie.createElement(Tt),value:"movements",route:"/movements",showInMobile:!0},{label:"My Profile",icon:ie.createElement(at),value:"profile",route:"/settings",showInMobile:!0}],Et={Sales:[{label:"Dashboard",icon:ie.createElement(fs),value:"dashboard",route:"/dashboard",showInMobile:!0},{label:"Orders",icon:ie.createElement(js),value:"orders",route:"/orders",showInMobile:!0},{label:"Storefronts",icon:ie.createElement(Mt),value:"storefronts",route:"/storefronts",showInMobile:!0},{label:"Customers",icon:ie.createElement(bs),value:"customers",route:"/customers",showInMobile:!0}],Support:[{label:"Tickets",icon:ie.createElement(Or),value:"tickets",route:"/tickets",showInMobile:!0}],Marketing:[{label:"Products",icon:ie.createElement(Ir),value:"products",route:"/products",showInMobile:!0},{label:"SMS Campaigns",icon:ie.createElement(Tt),value:"smscampaigns",route:"/sms-campaigns",showInMobile:!0}],Operations:[{label:"Suppliers",icon:ie.createElement(zr),value:"suppliers",route:"/suppliers",showInMobile:!0},{label:"Purchase Orders",icon:ie.createElement(Ar),value:"purchaseorders",route:"/purchase-orders",showInMobile:!0},{label:"Movements",icon:ie.createElement(Tt),value:"movements",route:"/movements",showInMobile:!0}],Administration:[{label:"Employees",icon:ie.createElement(Pr),value:"employees",route:"/employees",showInMobile:!0},{label:"My Profile",icon:ie.createElement(at),value:"profile",route:"/settings",showInMobile:!0}]};function Ie(){const l=Yr(),t=Ot("(max-width:600px)"),r=Ot("(min-width:601px) and (max-width:1024px)"),n=Ot("(min-width:1025px)");return{isMobile:t,isTablet:r,isDesktop:n,isSmallScreen:t,isMediumScreen:r,isLargeScreen:n,breakpoints:{mobile:"600px",tablet:"1024px",desktop:"1025px"},theme:l}}function $r(){const{isMobile:l,isTablet:t}=Ie();return{containerPadding:l?1:t?2:3,sectionPadding:l?2:t?3:4,itemPadding:l?1:2,smallGap:l?1:2,mediumGap:l?2:3,largeGap:l?3:4,sectionMargin:l?2:3,itemMargin:l?1:2}}function Ql(){const{isMobile:l}=Ie();return{getModalSize:(r="medium")=>l?{width:"95vw",height:r==="fullscreen"?"95vh":"auto",maxHeight:"90vh",margin:1}:{small:{width:400,maxWidth:"90vw"},medium:{width:600,maxWidth:"90vw"},large:{width:800,maxWidth:"90vw"},fullscreen:{width:"90vw",height:"90vh"}}[r]}}function Zl({setView:l,view:t}){const r=Cs(),n=ks(),{isMobile:s,isTablet:d,isDesktop:a}=Ie(),[o,x]=u.useState(!1),[m,v]=u.useState([]),[f,b]=u.useState(null),[C,g]=u.useState(null);u.useEffect(()=>{async function p(){const{data:I,error:U}=await T.from("users").select("*");!U&&I&&v(I)}p();async function k(I){if(b(I),I){let{data:U}=await T.from("users").select("*").eq("id",I.id).single();U||(await T.from("users").upsert({id:I.id,email:I.email,name:I.user_metadata?.full_name||null,avatar_url:I.user_metadata?.avatar_url||null,role:"employee"}),U={...I,role:"employee"}),g(U)}else g(null)}T.auth.getUser().then(({data:I})=>k(I.user));const{data:H}=T.auth.onAuthStateChange((I,U)=>{k(U?.user??null)});return()=>{H?.subscription.unsubscribe()}},[]),u.useEffect(()=>{d&&x(!0)},[d,a]);const w=p=>{r(p.route),l(p.value),d&&x(!0)},y=()=>{x(!o)},R=(p,k)=>{w({value:k,route:p})},S=p=>n.pathname===p;return e.jsxs(i,{className:"Sidebar",sx:{display:s?"none":"flex",position:{xs:"fixed",md:"sticky"},transform:{xs:"translateX(calc(100% * (var(--SideNavigation-slideIn, 0) - 1)))",md:"none"},transition:"transform 0.4s, width 0.4s",zIndex:1e4,height:"100vh",maxHeight:"100vh",minHeight:"100vh",width:"var(--Sidebar-width)",top:0,p:2,flexShrink:0,flexDirection:"column",gap:2,borderRight:"1px solid",borderColor:"divider",background:"var(--joy-palette-background-surface, #fff)",overflow:"hidden",boxSizing:"border-box"},children:[e.jsx(Cr,{styles:p=>({":root":{"--Sidebar-width":o?"60px":"220px",[p.breakpoints.up("lg")]:{"--Sidebar-width":o?"60px":"240px"}}})}),e.jsx(i,{className:"Sidebar-overlay",sx:{position:"fixed",zIndex:9998,top:0,left:0,width:"100vw",height:"100vh",opacity:"var(--SideNavigation-slideIn)",backgroundColor:"var(--joy-palette-background-backdrop)",transition:"opacity 0.4s",transform:{xs:"translateX(calc(100% * (var(--SideNavigation-slideIn, 0) - 1) + var(--SideNavigation-slideIn, 0) * var(--Sidebar-width, 0px)))",lg:"translateX(-100%)"}}}),e.jsxs(i,{sx:{display:"flex",gap:1,alignItems:"center",flexShrink:0},children:[e.jsx(xe,{size:"sm",variant:"plain",onClick:y,sx:{p:.5,borderRadius:1,"&:hover":{bgcolor:"neutral.100"}},children:e.jsx("img",{src:"/favicon.svg",alt:"Logo",style:{width:28,height:28,borderRadius:6}})}),!o&&e.jsxs(e.Fragment,{children:[e.jsx(c,{level:"title-lg",children:"Smartbuy"}),e.jsx(Vl,{sx:{ml:"auto"}})]})]}),!o&&e.jsx(i,{sx:{flexShrink:0},children:e.jsx($,{size:"sm",startDecorator:e.jsx(gl,{}),placeholder:"Search"})}),e.jsx(i,{sx:{minHeight:0,overflowY:"auto",overflowX:"hidden",flex:"1 1 auto",display:"flex",flexDirection:"column",[`& .${Jr.root}`]:{gap:1.5}},children:e.jsx(is,{size:"sm",sx:{gap:1,"--List-nestedInsetStart":"30px","--ListItem-radius":p=>p.vars.radius.sm},children:["Sales","Support","Operations","Marketing","Administration"].map(p=>e.jsx(as,{nested:!0,children:e.jsx(Yl,{defaultExpanded:!o,renderToggle:({open:k,setOpen:H})=>o?e.jsx(os,{title:p,placement:"right",arrow:!0,children:e.jsx(ft,{onClick:()=>H(!k),children:Et[p][0]?.icon})}):e.jsxs(ft,{onClick:()=>H(!k),children:[Et[p][0]?.icon,e.jsx(Ts,{children:e.jsx(c,{level:"title-sm",children:p})}),e.jsx(fl,{sx:[k?{transform:"rotate(180deg)"}:{transform:"none"}]})]}),children:e.jsx(is,{sx:{gap:.5},children:Et[p].map(k=>e.jsx(as,{children:o?e.jsx(os,{title:k.label,placement:"right",arrow:!0,children:e.jsx(ft,{selected:S(k.route),onClick:()=>R(k.route,k.value),sx:{justifyContent:"center",px:1,width:"100%"},children:k.icon})}):e.jsxs(ft,{selected:S(k.route),onClick:()=>R(k.route,k.value),sx:{justifyContent:"flex-start",px:2,width:"100%"},children:[k.icon,e.jsx(Ts,{children:e.jsx(c,{level:"body-sm",children:k.label})})]})},k.value))})})},p))})}),e.jsx(i,{sx:{flexShrink:0}}),e.jsx(Ae,{sx:{flexShrink:0}}),e.jsxs(i,{sx:{display:"flex",gap:1,alignItems:"center",minHeight:48,flexShrink:0,cursor:"pointer",borderRadius:"sm","&:hover":{bgcolor:"neutral.50"}},onClick:()=>R("/settings","settings"),children:[e.jsx(he,{variant:"outlined",size:"sm",src:C?.avatar_url||f?.user_metadata?.avatar_url||void 0,children:!C?.avatar_url&&!f?.user_metadata?.avatar_url&&(C?.first_name||C?.last_name?`${C.first_name?.[0]||""}${C.last_name?.[0]||""}`.toUpperCase():f?.user_metadata?.full_name?f.user_metadata.full_name.split(" ").map(p=>p[0]).slice(0,2).join("").toUpperCase():f?.email?f.email.substring(0,2).toUpperCase():"U")}),!o&&e.jsxs(i,{sx:{minWidth:0,flex:1},children:[e.jsx(c,{level:"title-sm",children:C?.first_name||C?.last_name?`${C.first_name||""} ${C.last_name||""}`.trim():f?.user_metadata?.full_name||f?.email||"Not signed in"}),e.jsx(c,{level:"body-xs",children:f?.email||""})]})]})]})}function Yl({defaultExpanded:l=!1,renderToggle:t,children:r}){const[n,s]=u.useState(l);return e.jsxs(u.Fragment,{children:[t({open:n,setOpen:s}),e.jsx(i,{sx:{display:"grid",transition:"0.2s ease","& > *":{overflow:"hidden"},gridTemplateRows:n?"1fr":"0fr"},children:r})]})}const Jl=Ds(Zl);function ke({children:l,variant:t="page",padding:r="medium",fullHeight:n=!1,className:s}){const{isMobile:d}=Ie(),a=$r(),o=()=>r==="none"?0:{small:a.itemPadding,medium:a.containerPadding,large:a.sectionPadding}[r]||a.containerPadding,x=()=>{const m={p:o(),boxSizing:"border-box"};switch(t){case"page":return{...m,height:n?"100%":"auto",overflow:"auto",width:"100%"};case"dialog":return{...m,height:"auto",overflow:"visible"};case"form":return{...m,display:"flex",flexDirection:"column",gap:a.mediumGap};case"card":return{...m,borderRadius:1,bgcolor:"background.surface"};case"table-page":return{width:"100%",overflow:"visible",pt:d?1:2,pl:d?1:2,pr:d?1:2,pb:d?1:2,boxSizing:"border-box"};default:return m}};return e.jsx(i,{sx:x(),className:s,children:l})}function qt({open:l,onClose:t,children:r,title:n,size:s="medium",showCloseButton:d=!0,actions:a}){const{getModalSize:o}=Ql();return e.jsx(Ne,{open:l,onClose:t,children:e.jsxs($e,{sx:o(s),children:[d&&e.jsx(Fe,{}),n&&e.jsx(wt,{children:n}),e.jsx(St,{children:r}),a&&e.jsx(Ct,{children:a})]})})}const qe=({children:l})=>e.jsx(i,{sx:{display:"flex",flexDirection:"column",width:"100%",flex:1,bgcolor:"background.body"},children:l}),Qe={currency:"DKK",locale:"da-DK",symbol:"kr"};function Me(l){if(l==null||isNaN(l))return"0 kr";const t=l%1!==0;return new Intl.NumberFormat(Qe.locale,{style:"currency",currency:Qe.currency,minimumFractionDigits:t?2:0,maximumFractionDigits:2}).format(l)}function be(l,t=!0){if(l==null||isNaN(l))return t?"0 kr":"kr 0";const r=l%1!==0,n=new Intl.NumberFormat(Qe.locale,{minimumFractionDigits:r?2:0,maximumFractionDigits:2}).format(l);return t?`${n} kr`:`kr ${n}`}function Ks(l){return{...l,salesprice_currency:Qe.currency,salesprice_exchrate:1,costprice_currency:Qe.currency,costprice_exchrate:1}}function Xl(l){return{...l,unit_price_currency:Qe.currency,unit_price_exchrate:1}}function Kl({open:l,onClose:t,order:r,mode:n="add",onSaved:s,fetchOrderItems:d}){const[a,o]=u.useState(""),[x,m]=u.useState(new Date().toISOString().slice(0,10)),[v,f]=u.useState("Draft"),[b,C]=u.useState(""),[g,w]=u.useState(""),[y,R]=u.useState("0"),[S,p]=u.useState(0),[k,H]=u.useState(""),[I,U]=u.useState([{id:crypto.randomUUID(),product:null,quantity:1,unitprice:0,discount:0}]),[j,A]=u.useState([]),[N,W]=u.useState([]),[G,h]=u.useState(!1),[E,B]=u.useState(!1),[O,D]=u.useState(!1),[M,se]=u.useState(null),[ue,le]=u.useState(null);u.useEffect(()=>{l&&r?(o(r.order_number||""),m(r.date||new Date().toISOString().slice(0,10)),f(r.status||"Draft"),C(r.customer_name||""),w(r.customer_email||""),R(r.total?String(r.total):"0"),p(r.discount||0),H(r.notes||"")):l&&n==="add"&&(o(J()),m(new Date().toISOString().slice(0,10)),f("Draft"),C(""),w(""),R("0"),p(0),H(""),U([{id:crypto.randomUUID(),product:null,quantity:1,unitprice:0,discount:0}])),se(null)},[l,r,n]),u.useEffect(()=>{l&&(n==="edit"||n==="view")&&r?.uuid&&d&&(D(!0),d(r.uuid).then(V=>{A(V)}).catch(V=>{console.error("Error loading order items:",V),se("Failed to load order items")}).finally(()=>D(!1)))},[l,n,r,d]),u.useEffect(()=>{l&&(n==="add"||n==="edit")&&(h(!0),le(null),T.from("Products").select("*").then(({data:V,error:_})=>{!_&&V?(V.length===0&&le("No products available. Please add products first."),W(V.map(K=>({id:K.uuid||K.id,ProductName:K.ProductName,SalesPrice:K.SalesPrice??0})))):le("Failed to load products. Please try again later."),h(!1)}))},[l,n]);const J=()=>{const V=new Date().toISOString().slice(0,10).replace(/-/g,""),_=Math.floor(1e3+Math.random()*9e3);return`ORD-${V}-${_}`},oe=()=>I.reduce((V,_)=>{const K=_.quantity*_.unitprice,z=K*(_.discount/100);return V+(K-z)},0);u.useEffect(()=>{if(n==="add"||n==="edit"){const V=oe(),_=V-V*(S/100);R(_.toFixed(2))}},[I,S,n]);const Q=()=>{U([...I,{id:crypto.randomUUID(),product:null,quantity:1,unitprice:0,discount:0}])},ce=V=>{I.length>1&&U(I.filter(_=>_.id!==V))},L=(V,_,K)=>{U(I.map(z=>z.id===V?{...z,[_]:K}:z))},Y=(V,_)=>{U(I.map(K=>K.id===V?{...K,product:_,unitprice:_?.SalesPrice||0}:K))},we=async()=>{if(!b.trim()||!g.trim()){se("Customer name and email are required");return}if(n==="add"&&I.filter(_=>_.product&&_.quantity>0).length===0){se("Please add at least one valid order item");return}B(!0),se(null);try{const V={order_number:a,date:x,status:v,customer_name:b.trim(),customer_email:g.trim(),total:parseFloat(y),discount:S,notes:k.trim()||null};if(n==="edit"&&r?.id){const{error:_}=await T.from("Orders").update(V).eq("id",r.id);if(_)throw _}else if(n==="add"){const{data:_,error:K}=await T.from("Orders").insert([V]).select().single();if(K)throw K;if(_){const z=I.filter(Z=>Z.product&&Z.quantity>0).map(Z=>({order_uuid:_.uuid,product_uuid:Z.product.id,quantity:Z.quantity,unitprice:Z.unitprice,discount:Z.discount,price:Z.quantity*Z.unitprice*(1-Z.discount/100)}));if(z.length>0){const{error:Z}=await T.from("OrderItems").insert(z);if(Z)throw Z}}}s&&s(),t()}catch(V){console.error("Error saving order:",V),se(V.message||"Failed to save order")}finally{B(!1)}},de=n==="view",Oe=n==="view";return e.jsx(Ne,{open:l,onClose:t,children:e.jsxs($e,{sx:{maxWidth:800,width:"100%",maxHeight:"90vh",overflow:"auto"},children:[e.jsx(Fe,{}),e.jsx(c,{level:"title-lg",sx:{mb:2},children:n==="add"?"Create Order":n==="edit"?"Edit Order":"Order Details"}),e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:3},children:[e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(c,{level:"title-sm",children:"Order Information"}),e.jsxs(i,{sx:{display:"flex",gap:2},children:[e.jsxs(te,{sx:{flex:1},children:[e.jsx(ee,{children:"Order Number"}),e.jsx($,{value:a,onChange:V=>o(V.target.value),disabled:de,placeholder:"Auto-generated"})]}),e.jsxs(te,{sx:{flex:1},children:[e.jsx(ee,{children:"Date"}),e.jsx($,{type:"date",value:x,onChange:V=>m(V.target.value),disabled:de})]}),e.jsxs(te,{sx:{flex:1},children:[e.jsx(ee,{children:"Status"}),e.jsxs(ye,{value:v,onChange:(V,_)=>f(_),disabled:de,children:[e.jsx(F,{value:"Draft",children:"Draft"}),e.jsx(F,{value:"Paid",children:"Paid"}),e.jsx(F,{value:"Refunded",children:"Refunded"}),e.jsx(F,{value:"Cancelled",children:"Cancelled"})]})]})]})]}),e.jsx(Ae,{}),e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(c,{level:"title-sm",children:"Customer Information"}),e.jsxs(i,{sx:{display:"flex",gap:2},children:[e.jsxs(te,{sx:{flex:1},children:[e.jsx(ee,{children:"Customer Name"}),e.jsx($,{value:b,onChange:V=>C(V.target.value),disabled:de,placeholder:"Customer name",required:!0})]}),e.jsxs(te,{sx:{flex:1},children:[e.jsx(ee,{children:"Customer Email"}),e.jsx($,{type:"email",value:g,onChange:V=>w(V.target.value),disabled:de,placeholder:"customer@example.com",required:!0})]})]})]}),e.jsx(Ae,{}),e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(c,{level:"title-sm",children:Oe?"Ordered Items":"Order Items"}),!de&&e.jsx(q,{startDecorator:e.jsx(ve,{}),onClick:Q,size:"sm",variant:"outlined",children:"Add Item"})]}),Oe?O?e.jsx(c,{children:"Loading items..."}):e.jsxs(Ue,{size:"sm",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Product"}),e.jsx("th",{style:{textAlign:"right"},children:"Quantity"}),e.jsx("th",{style:{textAlign:"right"},children:"Unit Price"}),e.jsx("th",{style:{textAlign:"right"},children:"Discount (%)"}),e.jsx("th",{style:{textAlign:"right"},children:"Total Price"})]})}),e.jsx("tbody",{children:j.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,style:{textAlign:"center",padding:"16px"},children:e.jsx(c,{level:"body-sm",color:"neutral",children:"No items found for this order."})})}):j.map((V,_)=>e.jsxs("tr",{children:[e.jsx("td",{children:V.ProductName||V.name||V.product_uuid}),e.jsx("td",{style:{textAlign:"right"},children:V.quantity}),e.jsx("td",{style:{textAlign:"right"},children:typeof V.unitprice=="number"||typeof V.unitprice=="string"?be(Number(V.unitprice)):"-"}),e.jsx("td",{style:{textAlign:"right"},children:typeof V.discount=="number"||typeof V.discount=="string"?`${Number(V.discount).toFixed(2)}%`:"-"}),e.jsx("td",{style:{textAlign:"right"},children:typeof V.price=="number"||typeof V.price=="string"?be(Number(V.price)):"-"})]},V.id||V.uuid||_))})]}):e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:1},children:[ue&&e.jsx(c,{color:"warning",level:"body-sm",children:ue}),I.map(V=>e.jsxs(i,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(Nt,{placeholder:"Select product",options:N,getOptionLabel:_=>_.ProductName,value:V.product,onChange:(_,K)=>Y(V.id,K),loading:G,sx:{flex:2}}),e.jsx($,{type:"number",placeholder:"Qty",value:V.quantity,onChange:_=>L(V.id,"quantity",parseInt(_.target.value)||0),sx:{width:80},slotProps:{input:{min:1}}}),e.jsx($,{type:"number",placeholder:"Price",value:V.unitprice,onChange:_=>L(V.id,"unitprice",parseFloat(_.target.value)||0),sx:{width:100},slotProps:{input:{min:0,step:.01}}}),e.jsx($,{type:"number",placeholder:"Discount %",value:V.discount,onChange:_=>L(V.id,"discount",parseFloat(_.target.value)||0),sx:{width:100},slotProps:{input:{min:0,max:100,step:.01}}}),e.jsx(xe,{onClick:()=>ce(V.id),disabled:I.length===1,color:"danger",size:"sm",children:e.jsx(ht,{})})]},V.id))]})]}),e.jsx(Ae,{}),e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsx(c,{level:"title-sm",children:"Order Summary"}),e.jsxs(i,{sx:{display:"flex",gap:2},children:[e.jsxs(te,{sx:{flex:1},children:[e.jsx(ee,{children:"Order Discount (%)"}),e.jsx($,{type:"number",value:S,onChange:V=>p(parseFloat(V.target.value)||0),disabled:de,slotProps:{input:{min:0,max:100,step:.01}}})]}),e.jsxs(te,{sx:{flex:1},children:[e.jsx(ee,{children:"Total Amount"}),e.jsx($,{value:be(parseFloat(y)),disabled:!0,sx:{fontWeight:"bold"}})]})]}),e.jsxs(te,{children:[e.jsx(ee,{children:"Notes"}),e.jsx($,{value:k,onChange:V=>H(V.target.value),disabled:de,placeholder:"Order notes (optional)"})]})]}),M&&e.jsx(c,{color:"danger",level:"body-sm",children:M}),e.jsxs(i,{sx:{display:"flex",gap:2,justifyContent:"flex-end"},children:[e.jsx(q,{variant:"plain",onClick:t,disabled:E,children:de?"Close":"Cancel"}),!de&&e.jsx(q,{onClick:we,loading:E,disabled:!b.trim()||!g.trim(),children:n==="edit"?"Update Order":"Create Order"})]})]})]})})}function en({customerInfo:l,onChange:t,onLogin:r}){const n=d=>a=>{t({...l,[d]:a.target.value})},s=()=>{r?r():console.log("Login functionality not available in this app")};return e.jsx(i,{sx:{width:"100%"},children:e.jsxs(X,{spacing:3,sx:{width:"100%"},children:[e.jsxs(i,{sx:{textAlign:"center"},children:[e.jsx(c,{level:"body-sm",color:"neutral",sx:{mb:2},children:"Already have an account? Sign in to auto-fill your information"}),e.jsx(q,{variant:"outlined",startDecorator:e.jsx(Vt,{}),onClick:s,disabled:!r,sx:{minWidth:150},children:"Login"})]}),e.jsx(Ae,{sx:{my:1},children:e.jsx(c,{level:"body-xs",color:"neutral",children:"or continue as guest"})}),e.jsxs(i,{children:[e.jsx(c,{level:"h4",sx:{mb:3},children:"Contact"}),e.jsxs(X,{spacing:2,children:[e.jsxs(te,{required:!0,children:[e.jsx(ee,{children:"Email *"}),e.jsx($,{type:"email",value:l.email,onChange:n("email"),placeholder:"Enter email",variant:"outlined"})]}),e.jsxs(te,{children:[e.jsx(ee,{children:"Phone Number *"}),e.jsx($,{value:l.phone||"",onChange:n("phone"),placeholder:"Enter phone number",variant:"outlined"})]}),e.jsx(bt,{checked:l.newsletter||!1,onChange:d=>t({...l,newsletter:d.target.checked}),label:"I would like to receive newsletters",sx:{mt:1}})]})]}),e.jsxs(i,{children:[e.jsx(c,{level:"h4",sx:{mb:3},children:"Address"}),e.jsxs(X,{spacing:2,children:[e.jsxs(Ce,{container:!0,spacing:2,sx:{width:"100%",m:0},children:[e.jsx(Ce,{xs:12,md:6,children:e.jsxs(te,{required:!0,children:[e.jsx(ee,{children:"First Name *"}),e.jsx($,{value:l.firstName||"",onChange:n("firstName"),placeholder:"Enter first name",variant:"outlined"})]})}),e.jsx(Ce,{xs:12,md:6,children:e.jsxs(te,{required:!0,children:[e.jsx(ee,{children:"Last Name *"}),e.jsx($,{value:l.lastName||"",onChange:n("lastName"),placeholder:"Enter last name",variant:"outlined"})]})})]}),e.jsx(Ce,{container:!0,spacing:2,sx:{width:"100%",m:0},children:e.jsx(Ce,{xs:12,children:e.jsxs(te,{required:!0,children:[e.jsx(ee,{children:"Address*"}),e.jsx($,{value:l.address||"",onChange:n("address"),placeholder:"Enter address and house number",variant:"outlined"})]})})}),e.jsxs(Ce,{container:!0,spacing:2,sx:{width:"100%",m:0},children:[e.jsx(Ce,{xs:12,md:4,children:e.jsxs(te,{required:!0,children:[e.jsx(ee,{children:"Postal Code *"}),e.jsx($,{value:l.postalCode||"",onChange:n("postalCode"),placeholder:"Enter postal code",variant:"outlined"})]})}),e.jsx(Ce,{xs:12,md:8,children:e.jsxs(te,{required:!0,children:[e.jsx(ee,{children:"City *"}),e.jsx($,{value:l.city||"",onChange:n("city"),placeholder:"Enter city",variant:"outlined"})]})})]}),e.jsxs(te,{children:[e.jsx(ee,{children:"Reference"}),e.jsx($,{value:l.reference||"",onChange:n("reference"),placeholder:"Reference/employee number",variant:"outlined"})]}),e.jsxs(X,{spacing:1,sx:{mt:2},children:[e.jsx(bt,{label:"Log me in so I can easily shop again",sx:{fontSize:"sm"}}),e.jsx(bt,{label:"The addess is not my home address",sx:{fontSize:"sm"}})]})]})]})]})})}const er=[{value:"standard",label:"Standard Delivery",description:"5-7 business days",cost:99,icon:e.jsx(jl,{})},{value:"express",label:"Express Delivery",description:"2-3 business days",cost:199,icon:e.jsx(bl,{})},{value:"overnight",label:"Overnight Delivery",description:"Next business day",cost:349,icon:e.jsx(yl,{})}];function tn({deliveryInfo:l,onChange:t,subtotal:r=0}){const s=r>=1e3,d=(o,x)=>x==="standard"&&s?0:o,a=o=>{const x=er.find(v=>v.value===o),m=d(x?.cost||0,o);t({...l,method:o,cost:m,estimatedDays:o==="overnight"?1:o==="express"?3:6})};return e.jsx(me,{variant:"outlined",children:e.jsxs(Re,{children:[e.jsx(c,{level:"h4",sx:{mb:2},children:"Delivery Method"}),(()=>{const o=Math.max(0,1e3-r),x=Math.min(100,r/1e3*100);return r<1e3?e.jsxs(i,{sx:{mb:3,p:2,backgroundColor:"neutral.50",borderRadius:"sm"},children:[e.jsxs(c,{level:"body-sm",sx:{mb:1,fontWeight:600},children:["ðŸšš Spend ",be(o)," more for free standard shipping"]}),e.jsx(i,{sx:{position:"relative",width:"100%",height:8,backgroundColor:"#e5e5e5",borderRadius:4,overflow:"hidden",border:"1px solid #d4d4d8"},children:e.jsx(i,{sx:{position:"absolute",top:0,left:0,width:`${x}%`,height:"100%",backgroundColor:"#22c55e",borderRadius:3,transition:"width 0.3s ease-in-out"}})}),e.jsxs(c,{level:"body-xs",color:"neutral",sx:{mt:.5},children:[be(r)," of ",be(1e3)]})]}):e.jsx(i,{sx:{mb:3,p:2,backgroundColor:"success.50",borderRadius:"sm"},children:e.jsx(c,{level:"body-sm",color:"success",sx:{fontWeight:600},children:"ðŸŽ‰ You qualify for free standard shipping!"})})})(),e.jsx(kr,{value:l.method,onChange:o=>a(o.target.value),children:e.jsx(X,{spacing:2,children:er.map(o=>e.jsx(me,{variant:l.method===o.value?"soft":"outlined",sx:{cursor:"pointer",transition:"all 0.2s","&:hover":{boxShadow:"sm"}},onClick:()=>a(o.value),children:e.jsxs(Re,{children:[e.jsx(jt,{value:o.value,sx:{display:"none"}}),e.jsxs(X,{direction:"row",spacing:2,alignItems:"center",children:[e.jsx(i,{sx:{color:"primary.500"},children:o.icon}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(c,{level:"title-md",children:o.label}),e.jsx(c,{level:"body-sm",sx:{color:"text.secondary"},children:o.description})]}),e.jsx(i,{children:(()=>{const x=d(o.cost,o.value),m=o.cost;return x===0&&m>0?e.jsxs(X,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(ae,{variant:"soft",color:"success",children:"Free"}),e.jsx(c,{level:"body-xs",sx:{textDecoration:"line-through",color:"text.secondary"},children:Me(m)})]}):x>0?e.jsx(ae,{variant:"soft",color:"primary",children:Me(x)}):e.jsx(ae,{variant:"soft",color:"success",children:"Free"})})()})]})]})},o.value))})})]})})}const sn=({sx:l})=>e.jsx(i,{component:"img",src:"/mobilepay-icon.svg",alt:"MobilePay",sx:{width:24,height:24,...l}});function rn({paymentInfo:l,onChange:t}){const r=s=>{t({...l,method:s,cardNumber:s==="card"?l.cardNumber:"",cardHolder:s==="card"?l.cardHolder:"",expiryDate:s==="card"?l.expiryDate:"",cvv:s==="card"?l.cvv:"",bankAccount:"",routingNumber:""})},n=s=>d=>{let a=d.target.value;s==="cardNumber"&&(a=a.replace(/\s/g,"").replace(/(\d{4})/g,"$1 ").trim(),a.length>19&&(a=a.substring(0,19))),s==="expiryDate"&&(a=a.replace(/\D/g,""),a.length>=2&&(a=a.substring(0,2)+"/"+a.substring(2,4)),a.length>5&&(a=a.substring(0,5))),s==="cvv"&&(a=a.replace(/\D/g,"").substring(0,3)),t({...l,[s]:a})};return e.jsx(i,{sx:{width:"100%"},children:e.jsxs(X,{spacing:3,sx:{width:"100%"},children:[e.jsxs(te,{children:[e.jsx(ee,{children:"Select Payment Method"}),e.jsx(kr,{value:l.method,onChange:s=>r(s.target.value),children:e.jsxs(X,{spacing:2,children:[e.jsx(me,{variant:l.method==="card"?"solid":"outlined",color:l.method==="card"?"primary":"neutral",sx:{cursor:"pointer"},onClick:()=>r("card"),children:e.jsx(Re,{children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(jt,{value:"card"}),e.jsxs(i,{children:[e.jsx(c,{level:"title-sm",children:"Cards"}),e.jsx(i,{sx:{display:"flex",justifyContent:"center",mt:1},children:e.jsx(Yt,{sx:{fontSize:32}})})]})]})})}),e.jsx(me,{variant:l.method==="mobilepay"?"solid":"outlined",color:l.method==="mobilepay"?"primary":"neutral",sx:{cursor:"pointer"},onClick:()=>r("mobilepay"),children:e.jsx(Re,{children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(jt,{value:"mobilepay"}),e.jsxs(i,{children:[e.jsx(c,{level:"title-sm",children:"MobilePay"}),e.jsx(i,{sx:{display:"flex",justifyContent:"center",mt:1},children:e.jsx(sn,{sx:{width:32,height:32}})})]})]})})}),e.jsx(me,{variant:l.method==="viabill"?"solid":"outlined",color:l.method==="viabill"?"primary":"neutral",sx:{cursor:"pointer"},onClick:()=>r("viabill"),children:e.jsx(Re,{children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(jt,{value:"viabill"}),e.jsxs(i,{children:[e.jsx(c,{level:"title-sm",children:"Apple Pay / Google Pay"}),e.jsxs(i,{sx:{display:"flex",justifyContent:"center",gap:2,mt:1},children:[e.jsx(i,{component:"span",sx:{fontWeight:700,fontSize:18,color:"#000",px:1,borderRadius:1,background:"#fff",border:"1px solid #eee"},children:"ï£¿ Pay"}),e.jsx(i,{component:"span",sx:{fontWeight:700,fontSize:18,color:"#4285F4",px:1,borderRadius:1,background:"#fff",border:"1px solid #eee"},children:"G Pay"})]})]})]})})}),e.jsx(me,{variant:l.method==="international"?"solid":"outlined",color:l.method==="international"?"primary":"neutral",sx:{cursor:"pointer"},onClick:()=>r("international"),children:e.jsx(Re,{children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(jt,{value:"international"}),e.jsxs(i,{children:[e.jsx(c,{level:"title-sm",children:"International Credit Cards"}),e.jsx(i,{sx:{display:"flex",justifyContent:"center",mt:1},children:e.jsx(Yt,{sx:{fontSize:32}})})]})]})})})]})})]}),l.method==="card"&&e.jsx(me,{variant:"outlined",children:e.jsx(Re,{children:e.jsxs(X,{spacing:2,children:[e.jsxs(te,{required:!0,children:[e.jsx(ee,{children:"Card Number"}),e.jsx($,{value:l.cardNumber||"",onChange:n("cardNumber"),placeholder:"1234 5678 9012 3456",startDecorator:e.jsx(Yt,{})})]}),e.jsxs(te,{required:!0,children:[e.jsx(ee,{children:"Cardholder Name"}),e.jsx($,{value:l.cardHolder||"",onChange:n("cardHolder"),placeholder:"John Doe"})]}),e.jsxs(Ce,{container:!0,spacing:2,sx:{width:"100%",m:0},children:[e.jsx(Ce,{xs:8,children:e.jsxs(te,{required:!0,children:[e.jsx(ee,{children:"Expiry Date"}),e.jsx($,{value:l.expiryDate||"",onChange:n("expiryDate"),placeholder:"MM/YY"})]})}),e.jsx(Ce,{xs:4,children:e.jsxs(te,{required:!0,children:[e.jsx(ee,{children:"CVV"}),e.jsx($,{value:l.cvv||"",onChange:n("cvv"),placeholder:"123",type:"password"})]})})]})]})})})]})})}const Kt=[{label:"Contact"},{label:"Delivery"},{label:"Payment"}];function ln({open:l,onClose:t,order:r,onSuccess:n}){const[s,d]=u.useState(0),[a,o]=u.useState([]),[x,m]=u.useState(!1),[v,f]=u.useState({name:r?.customer_name||"",email:r?.customer_email||"",phone:"",address:"",city:"",postalCode:"",country:"USA",firstName:"",lastName:"",newsletter:!1,reference:""}),[b,C]=u.useState({method:"standard"}),[g,w]=u.useState({method:"card",cardNumber:"",cardHolder:"",expiryDate:"",cvv:""}),[y,R]=u.useState(!1),[S,p]=u.useState(null),[k,H]=u.useState(!1);u.useEffect(()=>{l&&r&&(I(),d(0),H(!1),p(null),f(E=>{const B=r.customer_name||E.name,O=B.split(" ");return{...E,name:B,firstName:O[0]||"",lastName:O.slice(1).join(" ")||"",email:r.customer_email||E.email}}))},[l,r]);const I=async()=>{if(r){R(!0);try{const{data:E,error:B}=await T.from("OrderItems").select(`
          uuid,
          product_uuid,
          quantity,
          unitprice,
          discount,
          Products:product_uuid(ProductName)
        `).eq("order_uuid",r.uuid);if(B)throw B;const O=E?.map(D=>({...D,ProductName:D.Products?.ProductName||"Unknown Product"}))||[];o(O)}catch(E){p(E.message||"Failed to load order items")}finally{R(!1)}}},U=()=>{s<Kt.length-1?d(s+1):A()},j=()=>{d(s-1)},A=async()=>{if(r){R(!0),p(null);try{const E=v.firstName&&v.lastName?`${v.firstName} ${v.lastName}`:v.name||"",{error:B}=await T.from("Orders").update({customer_name:E,customer_email:v.email,status:"Paid"}).eq("uuid",r.uuid);if(B)throw B;if(a.length>0){const O=a.map(M=>({product_id:M.product_uuid,movement_type:"outgoing",quantity:M.quantity,date:new Date().toISOString(),reason:"Order Fulfillment",referenceuuid:r.uuid})),{error:D}=await T.from("stock_movements").insert(O);D&&console.warn("Failed to create stock movements:",D)}H(!0),setTimeout(()=>{n(),t()},2e3)}catch(E){p(E.message||"Failed to complete order")}finally{R(!1)}}},N=E=>{switch(E){case 0:return!!(v.email?.trim()&&v.phone?.trim()&&v.firstName?.trim()&&v.lastName?.trim()&&v.address?.trim()&&v.city?.trim()&&v.postalCode?.trim());case 1:return!0;case 2:return g.method==="card"?!!(g.cardNumber?.replace(/\s/g,"").length===16&&g.cardHolder?.trim()&&g.expiryDate?.length===5&&g.cvv?.length===3):!0;default:return!1}},W=E=>{switch(E){case 0:return e.jsx(en,{customerInfo:v,onChange:f});case 1:return e.jsx(tn,{deliveryInfo:b,onChange:C,subtotal:G()});case 2:return e.jsx(rn,{paymentInfo:g,onChange:w});default:return null}},G=()=>{const E=a.reduce((O,D)=>{const M=(D.unitprice||0)*D.quantity,se=(D.discount||0)*D.quantity;return O+M-se},0),B=r?.discount||0;return E-B},h=()=>{const E=G(),B=b.cost||0;return E+B};return r?e.jsx(Ne,{open:l,onClose:t,sx:{display:"flex",justifyContent:"center",alignItems:"center",p:{xs:0,md:2},zIndex:10001},children:e.jsxs($e,{size:"lg",sx:{width:{xs:"100vw",md:"90vw"},maxWidth:{xs:"none",md:1e3},height:{xs:"100vh",md:"90vh"},maxHeight:{xs:"none",md:750},overflow:"hidden",display:"flex",flexDirection:"column",m:0,borderRadius:{xs:0,md:"md"},p:0},children:[e.jsx(i,{sx:{display:{xs:"none",md:"flex"},justifyContent:"flex-end",alignItems:"center",p:2,borderBottom:"1px solid",borderColor:"divider"},children:e.jsx(Fe,{})}),e.jsx(i,{sx:{display:{xs:"flex",md:"none"},justifyContent:"flex-end",alignItems:"center",p:1,position:"absolute",top:0,right:0,zIndex:1e3,backgroundColor:"background.surface"},children:e.jsx(Fe,{})}),k?e.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",gap:2,p:3},children:[e.jsx(Gt,{sx:{fontSize:80,color:"success.main"}}),e.jsx(c,{level:"h2",children:"Order Completed!"}),e.jsxs(c,{level:"body-lg",textAlign:"center",color:"neutral",children:["Thank you for your order! Order #",r.order_number_display," has been processed successfully."]})]}):e.jsxs(i,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},height:"100%",overflow:"hidden"},children:[e.jsxs(i,{sx:{display:{xs:"block",md:"none"},borderBottom:"1px solid",borderColor:"divider"},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",p:2,pr:6},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(c,{level:"title-md",children:"Order Summary"}),e.jsx(c,{level:"body-sm",color:"primary",children:be(h())})]}),e.jsx(q,{variant:"plain",size:"sm",onClick:()=>m(!x),sx:{minWidth:"auto",p:1},children:x?e.jsx(vl,{}):e.jsx(wl,{})})]}),x&&e.jsxs(i,{sx:{p:2,backgroundColor:"background.level1",animation:"fadeIn 0.2s ease-in-out","@keyframes fadeIn":{from:{opacity:0,transform:"translateY(-10px)"},to:{opacity:1,transform:"translateY(0)"}}},children:[e.jsxs(c,{level:"body-sm",color:"neutral",sx:{mb:2},children:["Order #",r.order_number_display]}),y?e.jsx(i,{sx:{display:"flex",justifyContent:"center",my:2},children:e.jsx(Ms,{size:"sm"})}):e.jsx(X,{spacing:1,sx:{mb:2},children:a.map(E=>e.jsxs(i,{sx:{py:.5},children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",mb:.5},children:[e.jsx(c,{level:"body-sm",sx:{fontWeight:600},children:E.ProductName}),e.jsx(c,{level:"body-sm",sx:{fontWeight:600},children:be((E.unitprice||0)*E.quantity-(E.discount||0)*E.quantity)})]}),e.jsxs(c,{level:"body-xs",color:"neutral",children:["Qty: ",E.quantity," Ã— ",be(E.unitprice||0)]})]},E.uuid))}),e.jsx(Ae,{sx:{my:1}}),e.jsxs(X,{spacing:.5,children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(c,{level:"body-xs",children:"Shipping"}),e.jsx(c,{level:"body-xs",children:be(b.cost||0)})]}),e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(c,{level:"body-xs",children:"VAT included"}),e.jsx(c,{level:"body-xs",children:be(a.reduce((E,B)=>E+(B.unitprice||0)*B.quantity,0)*.2)})]})]}),e.jsx(Ae,{sx:{my:1}}),e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(c,{level:"title-sm",sx:{fontWeight:700},children:"Total:"}),e.jsx(c,{level:"title-sm",sx:{fontWeight:700,color:"primary.main"},children:be(h())})]})]})]}),e.jsxs(i,{sx:{display:{xs:"none",md:"block"},width:{md:"350px"},borderRight:"1px solid",borderColor:"divider",p:3,overflow:"auto"},children:[e.jsx(c,{level:"h4",sx:{mb:2},children:"Summary"}),e.jsxs(c,{level:"body-sm",color:"neutral",sx:{mb:2},children:["Order #",r.order_number_display]}),y?e.jsx(i,{sx:{display:"flex",justifyContent:"center",my:3},children:e.jsx(Ms,{})}):e.jsx(X,{spacing:1,sx:{mb:3},children:a.map(E=>e.jsxs(i,{sx:{py:1},children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",mb:.5},children:[e.jsx(c,{level:"body-sm",sx:{fontWeight:600},children:E.ProductName}),e.jsx(c,{level:"body-sm",sx:{fontWeight:600},children:be((E.unitprice||0)*E.quantity-(E.discount||0)*E.quantity)})]}),e.jsxs(c,{level:"body-xs",color:"neutral",children:["Qty: ",E.quantity," Ã— ",be(E.unitprice||0),(E.discount||0)>0&&e.jsxs(i,{component:"span",sx:{color:"warning.main",ml:1},children:["(",E.discount,"% off)"]})]})]},E.uuid))}),e.jsx(Ae,{sx:{my:2}}),e.jsxs(X,{spacing:.5,children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(c,{level:"body-sm",children:"Shipping: Delivery to your door"}),e.jsx(c,{level:"body-sm",children:be(b.cost||0)})]}),e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(c,{level:"body-sm",children:"Subtotal:"}),e.jsx(c,{level:"body-sm",children:be(a.reduce((E,B)=>E+(B.unitprice||0)*B.quantity,0))})]}),e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(c,{level:"body-sm",children:"VAT included:"}),e.jsx(c,{level:"body-sm",children:be(a.reduce((E,B)=>E+(B.unitprice||0)*B.quantity,0)*.2)})]})]}),e.jsx(Ae,{sx:{my:1}}),e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(c,{level:"title-md",sx:{fontWeight:700},children:"Total:"}),e.jsx(c,{level:"title-md",sx:{fontWeight:700,color:"primary.main"},children:be(h())})]})]}),e.jsxs(i,{sx:{flex:1,display:"flex",flexDirection:"column",minHeight:0,overflow:"hidden"},children:[e.jsx(i,{sx:{p:{xs:1,md:3},pb:{xs:1,md:2},borderBottom:"1px solid",borderColor:"divider",flexShrink:0},children:e.jsx(Xr,{sx:{mb:0},children:Kt.map((E,B)=>e.jsx(Kr,{indicator:e.jsx(tl,{variant:s===B||s>B?"solid":"outlined",color:s>B?"success":"primary",sx:{width:{xs:8,md:12},height:{xs:8,md:12},minWidth:{xs:8,md:12},fontSize:0,"--StepIndicator-size":{xs:"8px",md:"12px"}}}),children:e.jsx(el,{onClick:()=>d(B),children:e.jsx(c,{level:"body-sm",sx:{fontSize:{xs:"0.75rem",md:"0.875rem"}},children:E.label})})},E.label))})}),S&&e.jsx(i,{sx:{p:{xs:1,md:3},pt:0,flexShrink:0},children:e.jsx(it,{color:"danger",children:S})}),e.jsx(i,{sx:{flex:1,overflow:"auto",p:{xs:1,md:3},pt:{xs:2,md:3},minHeight:0},children:W(s)}),e.jsxs(i,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},justifyContent:{xs:"stretch",md:s===0?"flex-end":"space-between"},p:{xs:1,md:3},borderTop:"1px solid",borderColor:"divider",gap:{xs:1,md:2},backgroundColor:"background.surface",flexShrink:0,position:{xs:"sticky",md:"static"},bottom:0,zIndex:1e4},children:[e.jsx(q,{variant:"solid",endDecorator:e.jsx(Sl,{}),onClick:U,loading:y,disabled:!N(s)||y,size:"lg",sx:{width:{xs:"100%",md:"auto"},minHeight:"48px",order:{xs:1,md:2},fontWeight:600},children:s===Kt.length-1?"Approve and pay":"Next"}),s>0&&e.jsx(q,{variant:"outlined",startDecorator:e.jsx(Cl,{}),onClick:j,size:"lg",sx:{width:{xs:"100%",md:"auto"},minHeight:"48px",order:{xs:2,md:1}},children:"Back"})]})]})]})]})}):null}const re={sizes:{small:"0.875rem",xlarge:"1.5rem"}},Ee={fontSize:re.sizes.small},nn=()=>{const{isMobile:l}=Ie(),[t,r]=u.useState([]),[n,s]=u.useState(!1),[d,a]=u.useState(""),[o,x]=u.useState(""),[m,v]=u.useState(""),[f,b]=u.useState(""),[C,g]=u.useState(!1),[w,y]=u.useState(!1),[R,S]=u.useState(!1),[p,k]=u.useState(null),[H,I]=u.useState("add"),[U,j]=u.useState(!1),[A,N]=u.useState(!1),[W,G]=u.useState(""),[h,E]=u.useState("success"),B=(P,ne="success")=>{G(P),E(ne),N(!0)},O=P=>{switch(P){case"Draft":return"neutral";case"Paid":return"success";case"Refunded":return"warning";case"Cancelled":return"danger";default:return"neutral"}},D=P=>{switch(P){case"Draft":return e.jsx(yt,{});case"Paid":return e.jsx(Gs,{});case"Refunded":return e.jsx(Gs,{});case"Cancelled":return e.jsx(yt,{});default:return e.jsx(yt,{})}},M=async()=>{s(!0);try{const{data:P,error:ne}=await T.from("Orders").select("*");if(ne){console.error("Error fetching orders:",ne),B("Failed to fetch orders","danger");return}if(P){const fe=P.map(je=>({uuid:je.uuid,date:je.date||je.created_at||je["Created at"]||"",status:je.status||"Paid",customer:je.customer||{initial:je.customer_initial||(je.customer_name?je.customer_name[0]:"?"),name:je.customer_name||"Unknown",email:je.customer_email||""},order_number_display:je.order_number_display,order_total:typeof je.order_total=="number"?je.order_total:0,created_by:je.created_by||"",created_by_name:je.created_by_name||"",created_by_email:je.created_by_email||"",category:je.category||"purchase"})).sort((je,xt)=>{const et=new Date(je.date||0);return new Date(xt.date||0).getTime()-et.getTime()});r(fe)}}catch(P){console.error("Error fetching orders:",P),B("Failed to fetch orders","danger")}finally{s(!1)}},se=async P=>{try{const{data:ne,error:fe}=await T.from("OrderItems").select("*, Products:product_uuid(ProductName)").eq("order_uuid",P);return fe?(console.error("Error fetching order items:",fe),[]):ne?.map(je=>({...je,product_name:je.Products?.ProductName||je.product_uuid}))||[]}catch(ne){return console.error("Error fetching order items:",ne),[]}};u.useEffect(()=>{M()},[]);const ue=t.filter(P=>{const ne=!d||P.order_number_display?.toString().toLowerCase().includes(d.toLowerCase())||P.customer.name.toLowerCase().includes(d.toLowerCase())||P.customer.email.toLowerCase().includes(d.toLowerCase()),fe=!o||P.status===o,je=!m||P.category===m,xt=!f||P.customer.name===f;return ne&&fe&&je&&xt}),le=Array.from(new Set(t.map(P=>P.status))),J=Array.from(new Set(t.map(P=>P.category||"purchase"))),oe=Array.from(new Set(t.map(P=>P.customer.name))),Q=()=>{k(null),I("add"),y(!0)},ce=P=>{k(P),I("view"),y(!0)},L=()=>{y(!1),k(null)},Y=()=>{M()},we=P=>({id:P.uuid,uuid:P.uuid,order_number:P.order_number_display,date:P.date,status:P.status,customer_name:P.customer.name,customer_email:P.customer.email,total:P.order_total}),de=P=>{const ne=t.find(fe=>fe.uuid===P||fe.order_number_display===P);ne&&ce(ne)},Oe=P=>{k(P),S(!0)},V=()=>{Q()},_=()=>{g(!1)},K=()=>{x(""),v(""),b("")},z=()=>e.jsxs(i,{sx:{pb:2},children:[e.jsxs(ke,{variant:"page",padding:"medium",children:[e.jsxs(i,{sx:{display:"flex",gap:1,mb:2},children:[e.jsx($,{placeholder:"Search orders...",value:d,onChange:P=>a(P.target.value),startDecorator:e.jsx(Se,{}),sx:{flex:1,fontSize:"16px"}}),e.jsx(xe,{variant:"soft",onClick:()=>g(!0),sx:{flexShrink:0},children:e.jsx(ys,{})})]}),(o||m||f)&&e.jsxs(i,{sx:{display:"flex",gap:1,mb:2,flexWrap:"wrap"},children:[o&&e.jsxs(ae,{size:"sm",variant:"soft",color:"primary",children:["Status: ",o]}),m&&e.jsxs(ae,{size:"sm",variant:"soft",color:"primary",children:["Category: ",m]}),f&&e.jsxs(ae,{size:"sm",variant:"soft",color:"primary",children:["Customer: ",f]})]}),n&&e.jsx(De,{sx:{mb:2}})]}),e.jsx(i,{children:ue.length===0?e.jsx(i,{sx:{textAlign:"center",py:6},children:e.jsx(c,{color:"neutral",children:n?"Loading orders...":"No orders found"})}):ue.map(P=>e.jsxs(i,{sx:{p:2,borderBottom:"1px solid",borderColor:"divider"},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:[e.jsx(i,{sx:{width:32,height:32,borderRadius:"50%",bgcolor:`${O(P.status)}.100`,color:`${O(P.status)}.600`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"14px",fontWeight:"bold",flexShrink:0},children:D(P.status)}),e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:.5},children:[e.jsxs(c,{level:"title-sm",sx:{fontWeight:"bold",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"60%"},children:["Order #",P.order_number_display||P.uuid.substring(0,8)]}),e.jsx(ae,{size:"sm",color:O(P.status),variant:"soft",sx:{fontWeight:"bold",minWidth:"fit-content"},children:P.status})]}),e.jsxs(c,{level:"body-xs",color:"neutral",sx:{mb:.5},children:[P.customer.name," â€¢ ",new Date(P.date).toLocaleDateString()]}),P.order_total&&e.jsx(c,{level:"body-xs",sx:{fontWeight:"bold",color:"primary.600"},children:Me(P.order_total)})]})]}),e.jsxs(i,{sx:{display:"flex",gap:1,justifyContent:"flex-end"},children:[e.jsx(q,{size:"sm",variant:"soft",onClick:()=>de(P.uuid),children:"View"}),P.status==="Draft"&&e.jsx(q,{size:"sm",variant:"solid",color:"primary",onClick:()=>Oe(P),startDecorator:e.jsx(Vs,{}),children:"Checkout"})]})]},P.uuid))}),e.jsx(xe,{color:"primary",variant:"soft",size:"sm",sx:{position:"fixed",bottom:80,right:16,zIndex:1e3,borderRadius:"8px",width:40,height:40,boxShadow:"sm",bgcolor:"primary.100","&:hover":{bgcolor:"primary.200",boxShadow:"md"}},onClick:V,children:e.jsx(ve,{fontSize:"small"})})]}),Z=()=>e.jsxs(ke,{variant:"table-page",children:[e.jsx(c,{level:"h2",sx:{mb:2,fontSize:re.sizes.xlarge},children:"Orders"}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx($,{placeholder:"Search orders...",sx:{flex:1,fontSize:re.sizes.small},value:d,onChange:P=>a(P.target.value),startDecorator:e.jsx(Se,{})}),e.jsxs(ye,{placeholder:"Filter status",value:o,onChange:(P,ne)=>x(ne||""),sx:{minWidth:160,fontSize:re.sizes.small},children:[e.jsx(F,{value:"",children:"All Statuses"}),le.map(P=>e.jsx(F,{value:P,children:P},P))]}),e.jsx(q,{variant:"solid",startDecorator:e.jsx(ve,{}),onClick:V,sx:{fontSize:re.sizes.small},children:"Create Order"})]}),e.jsxs(me,{sx:{overflow:"visible"},children:[n&&e.jsx(De,{}),e.jsxs(Ue,{"aria-label":"Orders",sx:{tableLayout:"auto"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:Ee,children:"Order #"}),e.jsx("th",{style:Ee,children:"Date"}),e.jsx("th",{style:Ee,children:"Customer"}),e.jsx("th",{style:Ee,children:"Status"}),e.jsx("th",{style:Ee,children:"Total"}),e.jsx("th",{style:Ee,children:"Actions"})]})}),e.jsxs("tbody",{children:[ue.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,style:{textAlign:"center",color:"#888",...Ee},children:n?"Loading orders...":"No orders found."})}),ue.map(P=>e.jsxs("tr",{style:{cursor:"pointer"},children:[e.jsx("td",{style:Ee,children:P.order_number_display||P.uuid.substring(0,8)}),e.jsx("td",{style:Ee,children:new Date(P.date).toLocaleDateString()}),e.jsx("td",{style:Ee,children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(i,{sx:{width:24,height:24,borderRadius:"50%",bgcolor:"primary.100",color:"primary.600",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"12px",fontWeight:"bold"},children:P.customer.initial}),e.jsxs(i,{children:[e.jsx(c,{level:"body-sm",sx:{fontWeight:"bold"},children:P.customer.name}),e.jsx(c,{level:"body-xs",color:"neutral",children:P.customer.email})]})]})}),e.jsx("td",{style:Ee,children:e.jsx(ae,{size:"sm",variant:"soft",color:O(P.status),children:P.status})}),e.jsx("td",{style:Ee,children:e.jsx(c,{level:"body-sm",sx:{fontWeight:"bold"},children:P.order_total?Me(P.order_total):"N/A"})}),e.jsx("td",{style:Ee,children:e.jsxs(i,{sx:{display:"flex",gap:1},children:[e.jsx(q,{size:"sm",variant:"soft",onClick:()=>de(P.uuid),children:"View"}),P.status==="Draft"&&e.jsx(q,{size:"sm",variant:"solid",color:"primary",onClick:()=>Oe(P),startDecorator:e.jsx(Vs,{}),children:"Checkout"})]})})]},P.uuid))]})]})]})]});return e.jsxs(qe,{children:[l?e.jsx(z,{}):e.jsx(Z,{}),e.jsx(Kl,{open:w,onClose:L,order:p?we(p):void 0,mode:H,onSaved:Y,fetchOrderItems:se}),e.jsx(ln,{open:R,onClose:()=>S(!1),order:p?{uuid:p.uuid,order_number_display:p.order_number_display,order_total:p.order_total,customer_name:p.customer.name,customer_email:p.customer.email}:null,onSuccess:()=>{S(!1),M(),B("Order completed successfully!","success")}}),l&&e.jsx(qt,{open:C,onClose:_,title:"Filter Orders",size:"medium",actions:e.jsxs(i,{sx:{display:"flex",gap:2},children:[e.jsx(q,{variant:"plain",onClick:K,sx:Ee,children:"Clear All"}),e.jsx(q,{variant:"solid",onClick:_,sx:Ee,children:"Apply"})]}),children:e.jsxs(X,{spacing:2,children:[e.jsxs(te,{children:[e.jsx(ee,{children:"Status"}),e.jsxs(ye,{placeholder:"All statuses",value:o,onChange:(P,ne)=>x(ne||""),children:[e.jsx(F,{value:"",children:"All Statuses"}),le.map(P=>e.jsx(F,{value:P,children:P},P))]})]}),e.jsxs(te,{children:[e.jsx(ee,{children:"Category"}),e.jsxs(ye,{placeholder:"All categories",value:m,onChange:(P,ne)=>v(ne||""),children:[e.jsx(F,{value:"",children:"All Categories"}),J.map(P=>e.jsx(F,{value:P,children:P},P))]})]}),e.jsxs(te,{children:[e.jsx(ee,{children:"Customer"}),e.jsxs(ye,{placeholder:"All customers",value:f,onChange:(P,ne)=>b(ne||""),children:[e.jsx(F,{value:"",children:"All Customers"}),oe.map(P=>e.jsx(F,{value:P,children:P},P))]})]})]})}),e.jsx(Ht,{open:A,onClose:()=>N(!1),autoHideDuration:4e3,anchorOrigin:{vertical:"top",horizontal:"center"},sx:{top:16,zIndex:2e3},children:e.jsx(it,{color:h,variant:"solid",sx:{width:"100%"},children:W})})]})};function an({open:l,onClose:t,product:r,onSave:n,mode:s="add",onEdit:d}){const[a,o]=u.useState({ProductName:r?.ProductName||"",SalesPrice:r?.SalesPrice?.toString()||"",CostPrice:r?.CostPrice?.toString()||"",image_url:r?.image_url||"",min_stock:r?.min_stock?.toString()||"",max_stock:r?.max_stock?.toString()||"",reorder_amount:r?.reorder_amount?.toString()||""}),[x,m]=u.useState(!1),[v,f]=u.useState(!1),b=u.useRef(null);u.useEffect(()=>{o({ProductName:r?.ProductName||"",SalesPrice:r?.SalesPrice?.toString()||"",CostPrice:r?.CostPrice?.toString()||"",image_url:r?.image_url||"",min_stock:r?.min_stock?.toString()||"",max_stock:r?.max_stock?.toString()||"",reorder_amount:r?.reorder_amount?.toString()||""})},[r]);const C=async y=>{const R=y.target.files?.[0];if(R){if(!R.type.startsWith("image/")){alert("Please select a valid image file");return}if(R.size>5*1024*1024){alert("Image size must be less than 5MB");return}try{f(!0);const S=R.name.split(".").pop(),k=`products/${`product-${Date.now()}.${S}`}`,{data:H,error:I}=await T.storage.from("productimages").upload(k,R,{cacheControl:"3600",upsert:!0});if(I)throw new Error(`Upload failed: ${I.message}`);const{data:{publicUrl:U}}=T.storage.from("productimages").getPublicUrl(k);o(j=>({...j,image_url:U}))}catch(S){console.error("Image upload failed:",S),alert("Failed to upload image. Please try again.")}finally{f(!1),y.target&&(y.target.value="")}}},g=()=>{o(y=>({...y,image_url:""}))},w=async()=>{m(!0),await n(a),m(!1)};return e.jsx(Ne,{open:l,onClose:t,"aria-labelledby":"dialog-products-title",children:e.jsxs($e,{sx:{minWidth:{xs:"90vw",sm:500}},children:[e.jsx(wt,{id:"dialog-products-title",children:s==="view"?"Product Details":r?"Edit Product":"Add Product"}),e.jsx(St,{children:e.jsxs(X,{spacing:2,children:[e.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:1},children:[e.jsx(c,{level:"body-sm",sx:{alignSelf:"flex-start"},children:"Product Image"}),a.image_url?e.jsxs(i,{sx:{position:"relative"},children:[e.jsx(he,{src:a.image_url,alt:"Product",variant:"soft",sx:{width:120,height:120,borderRadius:2,border:"2px solid",borderColor:"neutral.300"}}),s!=="view"&&e.jsx(xe,{size:"sm",variant:"solid",color:"danger",onClick:g,sx:{position:"absolute",top:-8,right:-8,minHeight:24,minWidth:24},children:e.jsx(ht,{fontSize:"small"})})]}):e.jsx(i,{sx:{width:120,height:120,borderRadius:2,border:"2px dashed",borderColor:"neutral.300",display:"flex",alignItems:"center",justifyContent:"center",cursor:s==="view"?"default":"pointer","&:hover":s==="view"?{}:{borderColor:"primary.500",backgroundColor:"primary.50"}},onClick:s==="view"?void 0:()=>b.current?.click(),children:e.jsx(kt,{sx:{fontSize:32,color:"neutral.400"}})}),e.jsx("input",{ref:b,type:"file",accept:"image/*",onChange:C,style:{display:"none"},disabled:s==="view"}),s!=="view"&&e.jsxs(X,{direction:"row",spacing:1,children:[e.jsx(q,{size:"sm",variant:"outlined",onClick:()=>b.current?.click(),loading:v,disabled:v,children:a.image_url?"Change Image":"Upload Image"}),a.image_url&&e.jsx(q,{size:"sm",variant:"plain",color:"danger",onClick:g,children:"Remove"})]})]}),e.jsx($,{name:"ProductName",value:a.ProductName,onChange:y=>o({...a,ProductName:y.target.value}),placeholder:"Product Name",readOnly:s==="view"}),e.jsx($,{name:"SalesPrice",value:a.SalesPrice,onChange:y=>o({...a,SalesPrice:y.target.value}),placeholder:"Sales Price",type:"number",readOnly:s==="view"}),e.jsx($,{name:"CostPrice",value:a.CostPrice,onChange:y=>o({...a,CostPrice:y.target.value}),placeholder:"Cost Price",type:"number",readOnly:s==="view"}),e.jsxs(i,{sx:{mt:3,mb:2},children:[e.jsxs(c,{level:"title-md",sx:{mb:2,display:"flex",alignItems:"center",gap:1},children:[e.jsx(Er,{}),"Inventory Management"]}),e.jsxs(X,{spacing:2,children:[e.jsx($,{name:"min_stock",value:a.min_stock,onChange:y=>o({...a,min_stock:y.target.value}),placeholder:"Minimum Stock Level",type:"number",startDecorator:e.jsx(c,{level:"body-sm",children:"Min:"}),readOnly:s==="view"}),e.jsx($,{name:"max_stock",value:a.max_stock,onChange:y=>o({...a,max_stock:y.target.value}),placeholder:"Maximum Stock Level",type:"number",startDecorator:e.jsx(c,{level:"body-sm",children:"Max:"}),readOnly:s==="view"}),e.jsx($,{name:"reorder_amount",value:a.reorder_amount,onChange:y=>o({...a,reorder_amount:y.target.value}),placeholder:"Reorder Amount",type:"number",startDecorator:e.jsx(c,{level:"body-sm",children:"Reorder:"}),readOnly:s==="view"})]})]})]})}),e.jsxs(Ct,{children:[e.jsx(q,{onClick:t,variant:"plain",disabled:x||v,children:s==="view"?"Close":"Cancel"}),s==="view"?d&&e.jsx(q,{onClick:d,variant:"solid",startDecorator:e.jsx(ot,{}),children:"Edit"}):e.jsx(q,{onClick:w,variant:"solid",loading:x,disabled:x||v,children:"Save"})]})]})})}const es=Ds(an),Pe={fontSize:re.sizes.small},on=()=>{const{isMobile:l}=Ie(),[t,r]=u.useState([]),[n,s]=u.useState({}),[d,a]=u.useState(!1),[o,x]=u.useState(!1),[m,v]=u.useState(!1),[f,b]=u.useState(""),[C,g]=u.useState(""),[w,y]=u.useState(!1),[R,S]=u.useState(!1),[p,k]=u.useState(!1),[H,I]=u.useState(!1),[U,j]=u.useState(null),[A,N]=u.useState(null),[W,G]=u.useState(!1),[h,E]=u.useState(""),[B,O]=u.useState("success"),D=(z,Z="success")=>{E(z),O(Z),G(!0)},M=z=>z<=0?{status:"Out of Stock",color:"danger"}:z<=10?{status:"Low Stock",color:"warning"}:{status:"In Stock",color:"success"},se=z=>{const Z=M(z);return e.jsx(i,{sx:{width:20,height:20,borderRadius:"50%",bgcolor:`${Z.color}.100`,color:`${Z.color}.600`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"12px",fontWeight:"bold"},children:e.jsx(Er,{sx:{fontSize:"12px"}})})},ue=async()=>{a(!0);try{const{data:z,error:Z}=await T.from("Products").select("*").order("CreatedAt",{ascending:!1});if(Z){console.error("Error fetching products:",Z),D("Failed to fetch products","danger");return}z&&(r(z),await le(z))}catch(z){console.error("Error fetching products:",z),D("Failed to fetch products","danger")}finally{a(!1)}},le=async z=>{x(!0);try{const{data:Z,error:P}=await T.from("stock_movements").select("product_id, movement_type, quantity");if(P){console.error("Error fetching stock data:",P);return}if(Z){const ne={};z.forEach(fe=>{const xt=Z.filter(et=>et.product_id===fe.uuid).reduce((et,Dt)=>{switch(Dt.movement_type){case"incoming":case"adjustment":return et+(Dt.quantity||0);case"outgoing":return et-(Dt.quantity||0);default:return et}},0);ne[fe.uuid]=xt}),s(ne)}}catch(Z){console.error("Error fetching stock levels:",Z)}finally{x(!1)}};u.useEffect(()=>{ue()},[]);const J=t.filter(z=>{const Z=!f||z.ProductName.toLowerCase().includes(f.toLowerCase())||z.ProductID?.toLowerCase().includes(f.toLowerCase()),P=n[z.uuid]||0,ne=!C||C==="in-stock"&&P>10||C==="low-stock"&&P>0&&P<=10||C==="out-of-stock"&&P<=0;return Z&&ne}),oe=()=>{S(!0)},Q=z=>{j(z),k(!0)},ce=z=>{N(z),I(!0)},L=()=>{A&&(j(A),I(!1),N(null),k(!0))},Y=async z=>{if(confirm("Are you sure you want to delete this product?")){v(!0);try{const{error:Z}=await T.from("Products").delete().eq("uuid",z);if(Z){console.error("Error deleting product:",Z),D("Failed to delete product","danger");return}r(t.filter(P=>P.uuid!==z)),D("Product deleted successfully","success")}catch(Z){console.error("Error deleting product:",Z),D("Failed to delete product","danger")}finally{v(!1)}}},we=async z=>{v(!0);try{const Z=Ks({ProductName:z.ProductName,SalesPrice:parseFloat(z.SalesPrice),CostPrice:parseFloat(z.CostPrice),image_url:z.image_url||null,min_stock:z.min_stock?parseInt(z.min_stock):null,max_stock:z.max_stock?parseInt(z.max_stock):null,reorder_amount:z.reorder_amount?parseInt(z.reorder_amount):null,CreatedAt:new Date().toISOString()}),{data:P,error:ne}=await T.from("Products").insert([Z]).select().single();if(ne){console.error("Error adding product:",ne),D("Failed to add product","danger");return}D("Product added successfully","success"),S(!1),ue()}catch(Z){console.error("Error adding product:",Z),D("Failed to add product","danger")}finally{v(!1)}},de=async z=>{if(U){v(!0);try{const Z=Ks({ProductName:z.ProductName,SalesPrice:parseFloat(z.SalesPrice),CostPrice:parseFloat(z.CostPrice),image_url:z.image_url||null,min_stock:z.min_stock?parseInt(z.min_stock):null,max_stock:z.max_stock?parseInt(z.max_stock):null,reorder_amount:z.reorder_amount?parseInt(z.reorder_amount):null}),{error:P}=await T.from("Products").update(Z).eq("uuid",U.uuid);if(P){console.error("Error updating product:",P),D("Failed to update product","danger");return}D("Product updated successfully","success"),k(!1),j(null),ue()}catch(Z){console.error("Error updating product:",Z),D("Failed to update product","danger")}finally{v(!1)}}},Oe=()=>{y(!1)},V=()=>{g("")},_=()=>e.jsxs(i,{sx:{pb:2},children:[e.jsxs(ke,{variant:"page",padding:"medium",children:[e.jsxs(i,{sx:{display:"flex",gap:1,mb:2},children:[e.jsx($,{placeholder:"Search products...",value:f,onChange:z=>b(z.target.value),startDecorator:e.jsx(Se,{}),sx:{flex:1,fontSize:"16px"}}),e.jsx(xe,{variant:"soft",onClick:()=>y(!0),sx:{flexShrink:0},children:e.jsx(ys,{})})]}),C&&e.jsx(i,{sx:{display:"flex",gap:1,mb:2,flexWrap:"wrap"},children:e.jsxs(ae,{size:"sm",variant:"soft",color:"primary",children:["Stock: ",C.replace("-"," ")]})}),d&&e.jsx(De,{sx:{mb:2}})]}),e.jsx(i,{children:J.length===0?e.jsx(i,{sx:{textAlign:"center",py:6},children:e.jsx(c,{color:"neutral",children:d?"Loading products...":"No products found"})}):J.map(z=>e.jsx(i,{sx:{p:2,borderBottom:"1px solid",borderColor:"divider",cursor:"pointer","&:hover":{bgcolor:"background.level1"}},onClick:()=>ce(z),children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(i,{sx:{flexShrink:0},children:z.image_url?e.jsx(he,{src:z.image_url,sx:{width:48,height:48},alt:z.ProductName}):e.jsx(he,{sx:{width:48,height:48,bgcolor:"neutral.100"},children:e.jsx(Qs,{})})}),e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:.5},children:[e.jsx(c,{level:"title-sm",sx:{fontWeight:"bold",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"60%"},children:z.ProductName}),e.jsx(i,{sx:{display:"flex",alignItems:"center",gap:1},children:o?e.jsx(c,{level:"body-xs",color:"neutral",children:"..."}):e.jsxs(e.Fragment,{children:[se(n[z.uuid]||0),e.jsx(ae,{size:"sm",color:M(n[z.uuid]||0).color,variant:"soft",sx:{fontSize:"10px",minWidth:"fit-content"},children:n[z.uuid]||0})]})})]}),e.jsxs(c,{level:"body-xs",color:"neutral",sx:{mb:.5},children:["ID: ",z.ProductID||"N/A"," â€¢ ",new Date(z.CreatedAt).toLocaleDateString()]}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(i,{children:[e.jsxs(c,{level:"body-xs",sx:{fontWeight:"bold",color:"success.600"},children:["Sale: ",Me(z.SalesPrice)]}),e.jsxs(c,{level:"body-xs",color:"neutral",children:["Cost: ",Me(z.CostPrice)]})]}),e.jsxs(i,{sx:{display:"flex",gap:.5},children:[e.jsx(xe,{size:"sm",variant:"soft",color:"primary",onClick:Z=>{Z.stopPropagation(),Q(z)},children:e.jsx(ot,{})}),e.jsx(xe,{size:"sm",variant:"soft",color:"danger",onClick:Z=>{Z.stopPropagation(),Y(z.uuid)},disabled:m,children:e.jsx(ht,{})})]})]})]})]})},z.uuid))}),e.jsx(xe,{color:"primary",variant:"soft",size:"sm",sx:{position:"fixed",bottom:80,right:16,zIndex:1e3,borderRadius:"8px",width:40,height:40,boxShadow:"sm",bgcolor:"primary.100","&:hover":{bgcolor:"primary.200",boxShadow:"md"}},onClick:oe,children:e.jsx(ve,{fontSize:"small"})})]}),K=()=>e.jsxs(ke,{variant:"table-page",children:[e.jsx(c,{level:"h2",sx:{mb:2,fontSize:re.sizes.xlarge},children:"Products"}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx($,{placeholder:"Search products...",sx:{flex:1,fontSize:re.sizes.small},value:f,onChange:z=>b(z.target.value),startDecorator:e.jsx(Se,{})}),e.jsxs(ye,{placeholder:"Filter by stock",value:C,onChange:(z,Z)=>g(Z||""),sx:{minWidth:160,fontSize:re.sizes.small},children:[e.jsx(F,{value:"",children:"All Stock Levels"}),e.jsx(F,{value:"in-stock",children:"In Stock"}),e.jsx(F,{value:"low-stock",children:"Low Stock"}),e.jsx(F,{value:"out-of-stock",children:"Out of Stock"})]}),e.jsx(q,{variant:"solid",startDecorator:e.jsx(ve,{}),onClick:oe,sx:{fontSize:re.sizes.small},children:"Add Product"})]}),e.jsxs(me,{sx:{overflow:"visible"},children:[d&&e.jsx(De,{}),e.jsxs(Ue,{"aria-label":"Products",sx:{tableLayout:"auto","& tbody tr":{cursor:"pointer","&:hover":{backgroundColor:"background.level1"}}},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:Pe,children:"Image"}),e.jsx("th",{style:Pe,children:"Name"}),e.jsx("th",{style:Pe,children:"Stock"}),e.jsx("th",{style:Pe,children:"Sales Price"}),e.jsx("th",{style:Pe,children:"Cost Price"}),e.jsx("th",{style:Pe,children:"Created"}),e.jsx("th",{style:Pe,children:"Actions"})]})}),e.jsxs("tbody",{children:[J.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,style:{textAlign:"center",color:"#888",...Pe},children:d?"Loading products...":"No products found."})}),J.map(z=>e.jsxs("tr",{onClick:()=>ce(z),children:[e.jsx("td",{style:Pe,children:z.image_url?e.jsx(he,{src:z.image_url,sx:{width:32,height:32},alt:z.ProductName}):e.jsx(he,{sx:{width:32,height:32,bgcolor:"neutral.100"},children:e.jsx(Qs,{sx:{fontSize:"16px"}})})}),e.jsx("td",{style:Pe,children:e.jsxs(i,{children:[e.jsx(c,{level:"body-sm",sx:{fontWeight:"bold"},children:z.ProductName}),e.jsxs(c,{level:"body-xs",color:"neutral",children:["ID: ",z.ProductID||"N/A"]})]})}),e.jsx("td",{style:Pe,children:o?e.jsx(c,{level:"body-sm",sx:{color:"neutral.500"},children:"Loading..."}):e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ae,{size:"sm",variant:"soft",color:M(n[z.uuid]||0).color,children:M(n[z.uuid]||0).status}),e.jsx(os,{title:`Current stock level: ${n[z.uuid]||0} units`,arrow:!0,children:e.jsx(c,{level:"body-sm",sx:{fontWeight:"bold",color:M(n[z.uuid]||0).color==="danger"?"danger.500":M(n[z.uuid]||0).color==="warning"?"warning.600":"success.600"},children:n[z.uuid]||0})}),e.jsx(i,{sx:{width:40,height:4,bgcolor:"neutral.200",borderRadius:2,overflow:"hidden"},children:e.jsx(i,{sx:{width:`${Math.min(100,Math.max(0,(n[z.uuid]||0)/50*100))}%`,height:"100%",bgcolor:M(n[z.uuid]||0).color==="danger"?"danger.400":M(n[z.uuid]||0).color==="warning"?"warning.400":"success.400",borderRadius:2}})})]})}),e.jsx("td",{style:Pe,children:e.jsx(c,{level:"body-sm",sx:{fontWeight:"bold",color:"success.600"},children:Me(z.SalesPrice)})}),e.jsx("td",{style:Pe,children:e.jsx(c,{level:"body-sm",color:"neutral",children:Me(z.CostPrice)})}),e.jsx("td",{style:Pe,children:new Date(z.CreatedAt).toLocaleDateString()}),e.jsx("td",{style:Pe,children:e.jsxs(i,{sx:{display:"flex",gap:.5},children:[e.jsx(xe,{size:"sm",variant:"soft",color:"primary",onClick:Z=>{Z.stopPropagation(),Q(z)},children:e.jsx(ot,{})}),e.jsx(xe,{size:"sm",variant:"soft",color:"danger",onClick:Z=>{Z.stopPropagation(),Y(z.uuid)},disabled:m,children:e.jsx(ht,{})})]})})]},z.uuid))]})]})]})]});return e.jsxs(qe,{children:[l?e.jsx(_,{}):e.jsx(K,{}),e.jsx(es,{open:R,onClose:()=>S(!1),product:null,mode:"add",onSave:we}),e.jsx(es,{open:p,onClose:()=>{k(!1),j(null)},product:U,mode:"edit",onSave:de}),e.jsx(es,{open:H,onClose:()=>{I(!1),N(null)},product:A,mode:"view",onSave:()=>{},onEdit:L}),l&&e.jsx(qt,{open:w,onClose:Oe,title:"Filter Products",size:"medium",actions:e.jsxs(i,{sx:{display:"flex",gap:2},children:[e.jsx(q,{variant:"plain",onClick:V,sx:Pe,children:"Clear All"}),e.jsx(q,{variant:"solid",onClick:Oe,sx:Pe,children:"Apply"})]}),children:e.jsx(X,{spacing:2,children:e.jsxs(te,{children:[e.jsx(ee,{children:"Stock Level"}),e.jsxs(ye,{placeholder:"All stock levels",value:C,onChange:(z,Z)=>g(Z||""),children:[e.jsx(F,{value:"",children:"All Stock Levels"}),e.jsx(F,{value:"in-stock",children:"In Stock"}),e.jsx(F,{value:"low-stock",children:"Low Stock"}),e.jsx(F,{value:"out-of-stock",children:"Out of Stock"})]})]})})}),e.jsx(Ht,{open:W,onClose:()=>G(!1),autoHideDuration:4e3,anchorOrigin:{vertical:"top",horizontal:"center"},sx:{top:16,zIndex:2e3},children:e.jsx(it,{color:B,variant:"solid",sx:{width:"100%"},children:h})})]})},Ze={fontSize:re.sizes.small},tt={...Ze,fontWeight:600,borderBottom:"1.5px solid #e0e0e0",background:"inherit"},tr=l=>{switch(l?.toLowerCase()){case"admin":return"danger";case"manager":return"warning";case"user":return"primary";case"staff":return"success";default:return"neutral"}},sr=(l,t,r)=>{const s=`${l||""} ${t||""}`.trim()||r;let d=0;for(let o=0;o<s.length;o++)d=s.charCodeAt(o)+((d<<5)-d);const a=["primary","success","warning","danger","neutral"];return a[Math.abs(d)%a.length]},rr=(l,t,r)=>{if(l||t){const n=l?.[0]||"",s=t?.[0]||"";return(n+s).toUpperCase()}return r.substring(0,2).toUpperCase()};function cn(){return e.jsxs(ps,{children:[e.jsx(ms,{slots:{root:xe},slotProps:{root:{variant:"plain",color:"neutral",size:"sm"}},children:e.jsx(ws,{})}),e.jsxs(gs,{size:"sm",sx:{minWidth:140},children:[e.jsx(Te,{children:"Edit"}),e.jsx(Te,{children:"Reset Password"}),e.jsx(Te,{children:"Disable"}),e.jsx(Te,{color:"danger",children:"Delete"})]})]})}const dn=()=>{const{isMobile:l}=Ie(),[t,r]=u.useState([]),[n,s]=u.useState(!1),[d,a]=u.useState(null),[o,x]=u.useState(""),[m,v]=u.useState("all"),[f,b]=u.useState(!1),C=async()=>{s(!0),a(null);try{const{data:p,error:k}=await T.from("users").select("*");if(k)throw k;if(p){const H=p.map(I=>({id:I.id,first_name:I.first_name||null,last_name:I.last_name||null,email:I.email,role:I.role||null,created_at:I.created_at||null,last_login:I.last_login||null,phone_number:I.phone_number||null,avatar_url:I.avatar_url||null}));console.log("User avatar URLs:",H.map(I=>({email:I.email,avatar_url:I.avatar_url}))),r(H)}}catch(p){console.error("Error fetching users:",p),a(p.message||"Failed to fetch users")}finally{s(!1)}},g=Array.from(new Set(t.map(p=>p.role).filter(Boolean))),y=[...t.filter(p=>{const H=`${p.first_name||""} ${p.last_name||""}`.trim().toLowerCase().includes(o.toLowerCase())||p.email.toLowerCase().includes(o.toLowerCase()),I=m==="all"||p.role===m;return H&&I})].sort((p,k)=>{const H=`${p.first_name||""} ${p.last_name||""}`.trim()||p.email,I=`${k.first_name||""} ${k.last_name||""}`.trim()||k.email;return H.localeCompare(I)});u.useEffect(()=>{C()},[]);const R=()=>e.jsxs(i,{sx:{width:"100%",minHeight:"100vh"},children:[e.jsxs(ke,{padding:"medium",children:[e.jsx(c,{level:"h2",sx:{mb:2,fontSize:re.sizes.xlarge},children:"Users"}),e.jsxs(i,{sx:{display:"flex",gap:1,mb:2},children:[e.jsx($,{placeholder:"Search users...",value:o,onChange:p=>x(p.target.value),startDecorator:e.jsx(Se,{}),sx:{flex:1}}),e.jsxs(ye,{placeholder:"Role",value:m,onChange:(p,k)=>v(k??"all"),sx:{minWidth:120},children:[e.jsx(F,{value:"all",children:"All"}),g.map(p=>e.jsx(F,{value:p,children:p},p))]})]}),e.jsx(q,{variant:"solid",startDecorator:e.jsx(ve,{}),onClick:()=>b(!0),sx:{width:"100%",mb:2},children:"Create User"})]}),n&&e.jsx(De,{}),d&&e.jsx(i,{sx:{p:2},children:e.jsxs(c,{color:"danger",children:["Error: ",d]})}),e.jsx(i,{children:y.length===0?e.jsx(i,{sx:{textAlign:"center",py:6},children:e.jsx(c,{color:"neutral",children:"No users found"})}):y.map(p=>e.jsx(i,{sx:{p:2,borderBottom:"1px solid",borderColor:"divider","&:hover":{bgcolor:"background.level1"}},children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(he,{size:"md",src:p.avatar_url||void 0,color:sr(p.first_name,p.last_name,p.email),sx:{flexShrink:0},children:!p.avatar_url&&rr(p.first_name,p.last_name,p.email)}),e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:.5},children:[e.jsx(c,{level:"title-sm",sx:{fontWeight:"bold",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"60%"},children:`${p.first_name||""} ${p.last_name||""}`.trim()||"Unnamed User"}),p.role&&e.jsx(ae,{size:"sm",color:tr(p.role),variant:"soft",sx:{fontWeight:"bold",minWidth:"fit-content",textTransform:"capitalize"},children:p.role})]}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(Ke,{sx:{fontSize:14,color:"text.tertiary"}}),e.jsx(c,{level:"body-xs",color:"neutral",children:p.email})]}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:.5},children:[p.phone_number&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(ct,{sx:{fontSize:14,color:"text.tertiary"}}),e.jsx(c,{level:"body-xs",color:"neutral",children:p.phone_number})]}),p.last_login&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(Vt,{sx:{fontSize:14,color:"text.tertiary"}}),e.jsx(c,{level:"body-xs",color:"neutral",children:new Date(p.last_login).toLocaleDateString()})]})]}),p.created_at&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(vs,{sx:{fontSize:14,color:"text.tertiary"}}),e.jsxs(c,{level:"body-xs",color:"neutral",children:["Joined ",new Date(p.created_at).toLocaleDateString()]})]})]})]})},p.id))})]}),S=()=>e.jsxs(ke,{variant:"table-page",children:[e.jsx(c,{level:"h2",sx:{mb:2,fontSize:re.sizes.xlarge},children:"Users"}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx($,{placeholder:"Search users...",sx:{flex:1},value:o,onChange:p=>x(p.target.value),startDecorator:e.jsx(Se,{})}),e.jsxs(ye,{placeholder:"Filter role",value:m,onChange:(p,k)=>v(k??"all"),sx:{minWidth:160},children:[e.jsx(F,{value:"all",children:"All Roles"}),g.map(p=>e.jsx(F,{value:p,children:p},p))]}),e.jsx(q,{onClick:()=>b(!0),variant:"solid",startDecorator:e.jsx(ve,{}),children:"Create User"})]}),e.jsxs(me,{sx:{overflow:"visible"},children:[n&&e.jsx(De,{}),d&&e.jsxs(c,{color:"danger",children:["Error: ",d]}),e.jsxs(Ue,{"aria-label":"Users",sx:{tableLayout:"auto"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:tt,children:"Name"}),e.jsx("th",{style:tt,children:"Email"}),e.jsx("th",{style:tt,children:"Role"}),e.jsx("th",{style:tt,children:"Created At"}),e.jsx("th",{style:tt,children:"Last Login"}),e.jsx("th",{style:tt,children:"Phone"}),e.jsx("th",{style:{width:120,...tt},children:"Actions"})]})}),e.jsxs("tbody",{children:[y.length===0&&!n&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,style:{textAlign:"center",color:"#888",...Ze},children:"No users found."})}),y.map(p=>e.jsxs("tr",{style:{cursor:"pointer",height:48},children:[e.jsx("td",{style:Ze,children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:["                ",e.jsx(he,{size:"sm",src:p.avatar_url||void 0,color:sr(p.first_name,p.last_name,p.email),children:!p.avatar_url&&rr(p.first_name,p.last_name,p.email)}),e.jsx(c,{level:"body-sm",fontWeight:"md",children:`${p.first_name||""} ${p.last_name||""}`.trim()||"Unnamed User"})]})}),e.jsx("td",{style:Ze,children:p.email}),e.jsx("td",{style:Ze,children:p.role?e.jsx(ae,{size:"sm",color:tr(p.role),variant:"soft",sx:{textTransform:"capitalize"},children:p.role}):"-"}),e.jsx("td",{style:Ze,children:p.created_at?new Date(p.created_at).toLocaleDateString():"-"}),e.jsx("td",{style:Ze,children:p.last_login?new Date(p.last_login).toLocaleDateString():"-"}),e.jsx("td",{style:Ze,children:p.phone_number||"-"}),e.jsx("td",{children:e.jsx(cn,{})})]},p.id))]})]})]})]});return e.jsxs(qe,{children:[l?e.jsx(R,{}):e.jsx(S,{}),e.jsx(Ne,{open:f,onClose:()=>b(!1),"aria-labelledby":"create-user-modal",children:e.jsxs($e,{"aria-labelledby":"create-user-modal",sx:{maxWidth:600,width:"100%"},children:[e.jsx(Fe,{}),e.jsx(c,{id:"create-user-modal",level:"title-md",fontWeight:"lg",sx:{mb:2},children:"Create User"}),e.jsx(c,{level:"body-sm",sx:{mb:2},children:"User creation functionality will be implemented here."}),e.jsx(q,{onClick:()=>b(!1),variant:"outlined",children:"Close"})]})})]})};function un({open:l,onClose:t,customer:r,mode:n="add",onSaved:s}){const[d,a]=u.useState(r?.first_name||""),[o,x]=u.useState(r?.last_name||""),[m,v]=u.useState(r?.email||""),[f,b]=u.useState(r?.phone_number||""),[C,g]=u.useState(r?.role||"customer"),[w,y]=u.useState(r?.address||""),[R,S]=u.useState(r?.city||""),[p,k]=u.useState(r?.postal_code||""),[H,I]=u.useState(r?.country||""),[U,j]=u.useState(r?.notes||""),[A,N]=u.useState(r?.avatar_url||""),[W,G]=u.useState(!1),[h,E]=u.useState(!1),[B,O]=u.useState(null),D=u.useRef(null);u.useEffect(()=>{l&&r?(a(r.first_name||""),x(r.last_name||""),v(r.email||""),b(r.phone_number||""),g(r.role||"customer"),y(r.address||""),S(r.city||""),k(r.postal_code||""),I(r.country||""),j(r.notes||""),N(r.avatar_url||"")):l&&n==="add"&&(a(""),x(""),v(""),b(""),g("customer"),y(""),S(""),k(""),I(""),j(""),N("")),O(null)},[l,r,n]);const M=async J=>{const oe=J.target.files?.[0];if(oe){if(!oe.type.startsWith("image/")){O("Please select a valid image file");return}if(oe.size>5*1024*1024){O("Image size must be less than 5MB");return}E(!0),O(null);try{const Q=oe.name.split(".").pop()?.replace(/\./,"")||"png",ce=`avatars/customer_${Date.now()}.${Q}`,L=await T.storage.from("avatars").upload(ce,oe,{upsert:!0,contentType:oe.type});if(L.error)throw L.error;const{data:{publicUrl:Y}}=T.storage.from("avatars").getPublicUrl(ce);Y&&N(Y)}catch(Q){O("Failed to upload avatar. Please try again."),console.error("Avatar upload failed:",Q)}finally{E(!1)}}},se=async()=>{if(!d.trim()||!o.trim()||!m.trim()){O("First name, last name, and email are required");return}G(!0),O(null);try{const J={first_name:d.trim(),last_name:o.trim(),email:m.trim(),phone_number:f.trim()||null,role:C,address:w.trim()||null,city:R.trim()||null,postal_code:p.trim()||null,country:H.trim()||null,notes:U.trim()||null,avatar_url:A||null};if(n==="edit"&&r?.id){const{error:oe}=await T.from("users").update(J).eq("id",r.id);if(oe)throw oe}else{const{error:oe}=await T.from("users").insert([J]);if(oe)throw oe}s&&s(),t()}catch(J){console.error("Error saving customer:",J),O(J.message||"Failed to save customer")}finally{G(!1)}},ue=`${d} ${o}`.trim()||"Customer",le=n==="view";return e.jsx(Ne,{open:l,onClose:t,children:e.jsxs($e,{sx:{maxWidth:700,width:"100%",maxHeight:"90vh",overflow:"auto"},children:[e.jsx(wt,{children:n==="add"?"Add Customer":n==="edit"?"Edit Customer":"Customer Details"}),e.jsxs(St,{sx:{display:"flex",flexDirection:"column",gap:3},children:[e.jsxs(i,{sx:{display:"flex",flexDirection:"row",gap:3,alignItems:"flex-start"},children:[e.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",minWidth:110},children:[e.jsx(he,{src:A,alt:ue,sx:{width:96,height:96,mb:1},children:!A&&ue.substring(0,2).toUpperCase()}),!le&&e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"file",accept:"image/*",style:{display:"none"},ref:D,onChange:M,disabled:h}),e.jsx(xe,{component:"span",onClick:()=>D.current?.click(),disabled:h,title:"Upload avatar",size:"sm",sx:{mt:1},children:e.jsx(kt,{})})]}),r?.last_login&&e.jsxs(c,{level:"body-xs",sx:{mt:1,textAlign:"center"},children:["Last login:",e.jsx("br",{}),new Date(r.last_login).toLocaleString()]})]}),e.jsx(Ae,{orientation:"vertical",sx:{mx:1,alignSelf:"stretch"}}),e.jsxs(i,{sx:{flex:1,display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(i,{sx:{display:"flex",gap:2},children:[e.jsxs(i,{sx:{flex:1},children:[e.jsx(c,{level:"body-sm",sx:{mb:1},children:"First Name"}),e.jsx($,{placeholder:"First name",value:d,onChange:J=>a(J.target.value),disabled:le,required:!0})]}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(c,{level:"body-sm",sx:{mb:1},children:"Last Name"}),e.jsx($,{placeholder:"Last name",value:o,onChange:J=>x(J.target.value),disabled:le,required:!0})]})]}),e.jsxs(i,{children:[e.jsx(c,{level:"body-sm",sx:{mb:1},children:"Email"}),e.jsx($,{placeholder:"Email address",type:"email",value:m,onChange:J=>v(J.target.value),disabled:le,required:!0})]}),e.jsxs(i,{sx:{display:"flex",gap:2},children:[e.jsxs(i,{sx:{flex:1},children:[e.jsx(c,{level:"body-sm",sx:{mb:1},children:"Phone Number"}),e.jsx($,{placeholder:"Phone number",type:"tel",value:f,onChange:J=>b(J.target.value),disabled:le})]}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(c,{level:"body-sm",sx:{mb:1},children:"Customer Tier"}),e.jsxs(ye,{value:C,onChange:(J,oe)=>g(oe),disabled:le,children:[e.jsx(F,{value:"customer",children:"Customer"}),e.jsx(F,{value:"vip",children:"VIP"}),e.jsx(F,{value:"premium",children:"Premium"})]})]})]})]})]}),e.jsxs(i,{children:[e.jsx(c,{level:"title-sm",sx:{mb:2},children:"Address Information"}),e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(i,{children:[e.jsx(c,{level:"body-sm",sx:{mb:1},children:"Street Address"}),e.jsx($,{placeholder:"Street address",value:w,onChange:J=>y(J.target.value),disabled:le})]}),e.jsxs(i,{sx:{display:"flex",gap:2},children:[e.jsxs(i,{sx:{flex:1},children:[e.jsx(c,{level:"body-sm",sx:{mb:1},children:"City"}),e.jsx($,{placeholder:"City",value:R,onChange:J=>S(J.target.value),disabled:le})]}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(c,{level:"body-sm",sx:{mb:1},children:"Postal Code"}),e.jsx($,{placeholder:"Postal code",value:p,onChange:J=>k(J.target.value),disabled:le})]}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(c,{level:"body-sm",sx:{mb:1},children:"Country"}),e.jsx($,{placeholder:"Country",value:H,onChange:J=>I(J.target.value),disabled:le})]})]})]})]}),e.jsxs(i,{children:[e.jsx(c,{level:"title-sm",sx:{mb:2},children:"Additional Information"}),e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(i,{children:[e.jsx(c,{level:"body-sm",sx:{mb:1},children:"Avatar URL"}),e.jsx($,{placeholder:"Avatar image URL",value:A,onChange:J=>N(J.target.value),disabled:le})]}),e.jsxs(i,{children:[e.jsx(c,{level:"body-sm",sx:{mb:1},children:"Notes"}),e.jsx($t,{placeholder:"Customer notes or special instructions...",value:U,onChange:J=>j(J.target.value),disabled:le,minRows:3})]})]})]}),B&&e.jsx(c,{color:"danger",sx:{mt:1},children:B})]}),e.jsxs(Ct,{children:[e.jsx(q,{variant:"plain",onClick:t,disabled:W||h,children:"Cancel"}),!le&&e.jsxs(q,{onClick:se,disabled:W||h||!d.trim()||!o.trim()||!m.trim(),loading:W,children:[n==="edit"?"Update":"Create"," Customer"]})]})]})})}const Ye={fontSize:re.sizes.small},st={...Ye,fontWeight:600,borderBottom:"1.5px solid #e0e0e0",background:"inherit"},lr=l=>{switch(l?.toLowerCase()){case"customer":return"primary";case"vip":return"warning";case"premium":return"success";default:return"neutral"}},nr=(l,t,r)=>{const s=`${l||""} ${t||""}`.trim()||r;let d=0;for(let o=0;o<s.length;o++)d=s.charCodeAt(o)+((d<<5)-d);const a=["primary","success","warning","danger","neutral"];return a[Math.abs(d)%a.length]},ir=(l,t,r)=>{if(l||t){const n=l?.[0]||"",s=t?.[0]||"";return(n+s).toUpperCase()}return r.substring(0,2).toUpperCase()};function hn({onEdit:l,onView:t}){return e.jsxs(ps,{children:[e.jsx(ms,{slots:{root:xe},slotProps:{root:{variant:"plain",color:"neutral",size:"sm"}},children:e.jsx(ws,{})}),e.jsxs(gs,{size:"sm",sx:{minWidth:140},children:[e.jsx(Te,{onClick:t,children:"View Orders"}),e.jsx(Te,{onClick:l,children:"Edit Customer"}),e.jsx(Te,{children:"Send Message"}),e.jsx(Te,{color:"danger",children:"Deactivate"})]})]})}const xn=()=>{const{isMobile:l}=Ie(),[t,r]=u.useState([]),[n,s]=u.useState(!1),[d,a]=u.useState(null),[o,x]=u.useState(""),[m,v]=u.useState("all"),[f,b]=u.useState(!1),[C,g]=u.useState(),[w,y]=u.useState("add"),R=async()=>{s(!0),a(null);try{const{data:h,error:E}=await T.from("users").select("*").in("role",["customer","vip","premium",null]);if(E)throw E;if(h){const B=h.map(O=>({id:O.id,first_name:O.first_name||null,last_name:O.last_name||null,email:O.email,role:O.role||"customer",created_at:O.created_at||null,last_login:O.last_login||null,phone_number:O.phone_number||null,avatar_url:O.avatar_url||null}));r(B)}}catch(h){console.error("Error fetching customers:",h),a(h.message||"Failed to fetch customers")}finally{s(!1)}},S=()=>{g(void 0),y("add"),b(!0)},p=h=>{g(h),y("edit"),b(!0)},k=h=>{g(h),y("view"),b(!0)},H=()=>{b(!1),g(void 0)},I=()=>{R()},U=h=>({id:h.id,first_name:h.first_name||void 0,last_name:h.last_name||void 0,email:h.email,role:h.role,avatar_url:h.avatar_url||void 0,last_login:h.last_login||void 0,phone_number:h.phone_number||void 0}),j=Array.from(new Set(t.map(h=>h.role).filter(Boolean))),N=[...t.filter(h=>{const B=`${h.first_name||""} ${h.last_name||""}`.trim().toLowerCase().includes(o.toLowerCase())||h.email.toLowerCase().includes(o.toLowerCase()),O=m==="all"||h.role===m;return B&&O})].sort((h,E)=>{const B=`${h.first_name||""} ${h.last_name||""}`.trim()||h.email,O=`${E.first_name||""} ${E.last_name||""}`.trim()||E.email;return B.localeCompare(O)});u.useEffect(()=>{R()},[]);const W=()=>e.jsxs(i,{sx:{width:"100%",minHeight:"100vh"},children:[e.jsxs(ke,{padding:"medium",children:[e.jsx(c,{level:"h2",sx:{mb:2,fontSize:re.sizes.xlarge},children:"Customers"}),e.jsxs(i,{sx:{display:"flex",gap:1,mb:2},children:[e.jsx($,{placeholder:"Search customers...",value:o,onChange:h=>x(h.target.value),startDecorator:e.jsx(Se,{}),sx:{flex:1}}),e.jsxs(ye,{placeholder:"Type",value:m,onChange:(h,E)=>v(E??"all"),sx:{minWidth:120},children:[e.jsx(F,{value:"all",children:"All"}),j.map(h=>e.jsx(F,{value:h,children:h},h))]})]}),e.jsx(q,{variant:"solid",startDecorator:e.jsx(ve,{}),onClick:S,sx:{width:"100%",mb:2},children:"Add Customer"})]}),n&&e.jsx(De,{}),d&&e.jsx(i,{sx:{p:2},children:e.jsxs(c,{color:"danger",children:["Error: ",d]})}),e.jsx(i,{children:N.length===0?e.jsx(i,{sx:{textAlign:"center",py:6},children:e.jsx(c,{color:"neutral",children:"No customers found"})}):N.map(h=>e.jsx(i,{sx:{p:2,borderBottom:"1px solid",borderColor:"divider","&:hover":{bgcolor:"background.level1"}},children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(he,{size:"md",src:h.avatar_url||void 0,color:nr(h.first_name,h.last_name,h.email),sx:{flexShrink:0},children:!h.avatar_url&&ir(h.first_name,h.last_name,h.email)}),e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:.5},children:[e.jsx(c,{level:"title-sm",sx:{fontWeight:"bold",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"60%"},children:`${h.first_name||""} ${h.last_name||""}`.trim()||"Unnamed Customer"}),h.role&&e.jsx(ae,{size:"sm",color:lr(h.role),variant:"soft",sx:{fontWeight:"bold",minWidth:"fit-content",textTransform:"capitalize"},children:h.role})]}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(Ke,{sx:{fontSize:14,color:"text.tertiary"}}),e.jsx(c,{level:"body-xs",color:"neutral",children:h.email})]}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:.5},children:[h.phone_number&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(ct,{sx:{fontSize:14,color:"text.tertiary"}}),e.jsx(c,{level:"body-xs",color:"neutral",children:h.phone_number})]}),h.last_login&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(Vt,{sx:{fontSize:14,color:"text.tertiary"}}),e.jsx(c,{level:"body-xs",color:"neutral",children:new Date(h.last_login).toLocaleDateString()})]})]}),h.created_at&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(vs,{sx:{fontSize:14,color:"text.tertiary"}}),e.jsxs(c,{level:"body-xs",color:"neutral",children:["Joined ",new Date(h.created_at).toLocaleDateString()]})]})]})]})},h.id))})]}),G=()=>e.jsxs(ke,{variant:"table-page",children:[e.jsx(c,{level:"h2",sx:{mb:2,fontSize:re.sizes.xlarge},children:"Customers"}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx($,{placeholder:"Search customers...",sx:{flex:1},value:o,onChange:h=>x(h.target.value),startDecorator:e.jsx(Se,{})}),e.jsxs(ye,{placeholder:"Filter type",value:m,onChange:(h,E)=>v(E??"all"),sx:{minWidth:160},children:[e.jsx(F,{value:"all",children:"All Types"}),j.map(h=>e.jsx(F,{value:h,children:h},h))]}),e.jsx(q,{onClick:S,variant:"solid",startDecorator:e.jsx(ve,{}),children:"Add Customer"})]}),e.jsxs(me,{sx:{overflow:"visible"},children:[n&&e.jsx(De,{}),d&&e.jsxs(c,{color:"danger",children:["Error: ",d]}),e.jsxs(Ue,{"aria-label":"Customers",sx:{tableLayout:"auto"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:st,children:"Name"}),e.jsx("th",{style:st,children:"Email"}),e.jsx("th",{style:st,children:"Type"}),e.jsx("th",{style:st,children:"Joined"}),e.jsx("th",{style:st,children:"Last Login"}),e.jsx("th",{style:st,children:"Phone"}),e.jsx("th",{style:{width:120,...st},children:"Actions"})]})}),e.jsxs("tbody",{children:[N.length===0&&!n&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,style:{textAlign:"center",color:"#888",...Ye},children:"No customers found."})}),N.map(h=>e.jsxs("tr",{style:{cursor:"pointer",height:48},children:[e.jsx("td",{style:Ye,children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(he,{size:"sm",src:h.avatar_url||void 0,color:nr(h.first_name,h.last_name,h.email),children:!h.avatar_url&&ir(h.first_name,h.last_name,h.email)}),e.jsx(c,{level:"body-sm",fontWeight:"md",children:`${h.first_name||""} ${h.last_name||""}`.trim()||"Unnamed Customer"})]})}),e.jsx("td",{style:Ye,children:h.email}),e.jsx("td",{style:Ye,children:h.role?e.jsx(ae,{size:"sm",color:lr(h.role),variant:"soft",sx:{textTransform:"capitalize"},children:h.role}):"-"}),e.jsx("td",{style:Ye,children:h.created_at?new Date(h.created_at).toLocaleDateString():"-"}),e.jsx("td",{style:Ye,children:h.last_login?new Date(h.last_login).toLocaleDateString():"-"}),e.jsx("td",{style:Ye,children:h.phone_number||"-"}),e.jsx("td",{children:e.jsx(hn,{onEdit:()=>p(h),onView:()=>k(h)})})]},h.id))]})]})]})]});return e.jsxs(qe,{children:[l?e.jsx(W,{}):e.jsx(G,{}),e.jsx(un,{open:f,onClose:H,customer:C?U(C):void 0,mode:w,onSaved:I})]})};function pn({open:l,onClose:t,employee:r,mode:n="add",onSaved:s}){const[d,a]=u.useState(r?.first_name||""),[o,x]=u.useState(r?.last_name||""),[m,v]=u.useState(r?.email||""),[f,b]=u.useState(r?.phone_number||""),[C,g]=u.useState(r?.role||"employee"),[w,y]=u.useState(r?.department||""),[R,S]=u.useState(r?.position||""),[p,k]=u.useState(r?.avatar_url||""),[H,I]=u.useState(!1),[U,j]=u.useState(!1),[A,N]=u.useState(null),W=u.useRef(null);u.useEffect(()=>{l&&r?(a(r.first_name||""),x(r.last_name||""),v(r.email||""),b(r.phone_number||""),g(r.role||"employee"),y(r.department||""),S(r.position||""),k(r.avatar_url||"")):l&&n==="add"&&(a(""),x(""),v(""),b(""),g("employee"),y(""),S(""),k("")),N(null)},[l,r,n]);const G=async O=>{const D=O.target.files?.[0];if(D){if(!D.type.startsWith("image/")){N("Please select a valid image file");return}if(D.size>5*1024*1024){N("Image size must be less than 5MB");return}j(!0),N(null);try{const M=D.name.split(".").pop()?.replace(/\./,"")||"png",se=`avatars/employee_${Date.now()}.${M}`,ue=await T.storage.from("avatars").upload(se,D,{upsert:!0,contentType:D.type});if(ue.error)throw ue.error;const{data:{publicUrl:le}}=T.storage.from("avatars").getPublicUrl(se);le&&k(le)}catch(M){N("Failed to upload avatar. Please try again."),console.error("Avatar upload failed:",M)}finally{j(!1)}}},h=async()=>{if(!d.trim()||!o.trim()||!m.trim()){N("First name, last name, and email are required");return}I(!0),N(null);try{const O={first_name:d.trim(),last_name:o.trim(),email:m.trim(),phone_number:f.trim()||null,role:C,department:w.trim()||null,position:R.trim()||null,avatar_url:p||null};if(n==="edit"&&r?.id){const{error:D}=await T.from("users").update(O).eq("id",r.id);if(D)throw D}else{const{error:D}=await T.from("users").insert([O]);if(D)throw D}s&&s(),t()}catch(O){console.error("Error saving employee:",O),N(O.message||"Failed to save employee")}finally{I(!1)}},E=`${d} ${o}`.trim()||"Employee",B=n==="view";return e.jsx(Ne,{open:l,onClose:t,children:e.jsxs($e,{sx:{maxWidth:600,width:"100%"},children:[e.jsx(wt,{children:n==="add"?"Add Employee":n==="edit"?"Edit Employee":"Employee Details"}),e.jsxs(St,{sx:{display:"flex",flexDirection:"row",gap:3,alignItems:"flex-start"},children:[e.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",minWidth:110},children:[e.jsx(he,{src:p,alt:E,sx:{width:96,height:96,mb:1},children:!p&&E.substring(0,2).toUpperCase()}),!B&&e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"file",accept:"image/*",style:{display:"none"},ref:W,onChange:G,disabled:U}),e.jsx(xe,{component:"span",onClick:()=>W.current?.click(),disabled:U,title:"Upload avatar",size:"sm",sx:{mt:1},children:e.jsx(kt,{})})]}),r?.last_login&&e.jsxs(c,{level:"body-xs",sx:{mt:1,textAlign:"center"},children:["Last login:",e.jsx("br",{}),new Date(r.last_login).toLocaleString()]})]}),e.jsx(Ae,{orientation:"vertical",sx:{mx:1,alignSelf:"stretch"}}),e.jsxs(i,{sx:{flex:1,display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(i,{sx:{display:"flex",gap:2},children:[e.jsxs(i,{sx:{flex:1},children:[e.jsx(c,{level:"body-sm",sx:{mb:1},children:"First Name"}),e.jsx($,{placeholder:"First name",value:d,onChange:O=>a(O.target.value),disabled:B,required:!0})]}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(c,{level:"body-sm",sx:{mb:1},children:"Last Name"}),e.jsx($,{placeholder:"Last name",value:o,onChange:O=>x(O.target.value),disabled:B,required:!0})]})]}),e.jsxs(i,{children:[e.jsx(c,{level:"body-sm",sx:{mb:1},children:"Email"}),e.jsx($,{placeholder:"Email address",type:"email",value:m,onChange:O=>v(O.target.value),disabled:B,required:!0})]}),e.jsxs(i,{children:[e.jsx(c,{level:"body-sm",sx:{mb:1},children:"Phone Number"}),e.jsx($,{placeholder:"Phone number",type:"tel",value:f,onChange:O=>b(O.target.value),disabled:B})]}),e.jsxs(i,{sx:{display:"flex",gap:2},children:[e.jsxs(i,{sx:{flex:1},children:[e.jsx(c,{level:"body-sm",sx:{mb:1},children:"Role"}),e.jsxs(ye,{value:C,onChange:(O,D)=>g(D),disabled:B,children:[e.jsx(F,{value:"employee",children:"Employee"}),e.jsx(F,{value:"staff",children:"Staff"}),e.jsx(F,{value:"manager",children:"Manager"}),e.jsx(F,{value:"admin",children:"Admin"})]})]}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(c,{level:"body-sm",sx:{mb:1},children:"Department"}),e.jsx($,{placeholder:"Department",value:w,onChange:O=>y(O.target.value),disabled:B})]})]}),e.jsxs(i,{children:[e.jsx(c,{level:"body-sm",sx:{mb:1},children:"Position"}),e.jsx($,{placeholder:"Job position",value:R,onChange:O=>S(O.target.value),disabled:B})]}),e.jsxs(i,{children:[e.jsx(c,{level:"body-sm",sx:{mb:1},children:"Avatar URL"}),e.jsx($,{placeholder:"Avatar image URL",value:p,onChange:O=>k(O.target.value),disabled:B})]}),A&&e.jsx(c,{color:"danger",sx:{mt:1},children:A})]})]}),e.jsxs(Ct,{children:[e.jsx(q,{variant:"plain",onClick:t,disabled:H||U,children:"Cancel"}),!B&&e.jsxs(q,{onClick:h,disabled:H||U||!d.trim()||!o.trim()||!m.trim(),loading:H,children:[n==="edit"?"Update":"Create"," Employee"]})]})]})})}const Je={fontSize:re.sizes.small},rt={...Je,fontWeight:600,borderBottom:"1.5px solid #e0e0e0",background:"inherit"},ar=l=>{switch(l?.toLowerCase()){case"admin":return"danger";case"manager":return"warning";case"staff":return"success";case"employee":return"primary";case"user":return"neutral";default:return"neutral"}},or=(l,t,r)=>{const s=`${l||""} ${t||""}`.trim()||r;let d=0;for(let o=0;o<s.length;o++)d=s.charCodeAt(o)+((d<<5)-d);const a=["primary","success","warning","danger","neutral"];return a[Math.abs(d)%a.length]},cr=(l,t,r)=>{if(l||t){const n=l?.[0]||"",s=t?.[0]||"";return(n+s).toUpperCase()}return r.substring(0,2).toUpperCase()};function mn({employee:l,onEdit:t,onView:r}){return e.jsxs(ps,{children:[e.jsx(ms,{slots:{root:xe},slotProps:{root:{variant:"plain",color:"neutral",size:"sm"}},children:e.jsx(ws,{})}),e.jsxs(gs,{size:"sm",sx:{minWidth:140},children:[e.jsx(Te,{onClick:()=>t(l),children:"Edit Employee"}),e.jsx(Te,{onClick:()=>r(l),children:"View Details"}),e.jsx(Te,{children:"Change Role"}),e.jsx(Te,{children:"Reset Password"}),e.jsx(Te,{children:"Deactivate"}),e.jsx(Te,{color:"danger",children:"Remove"})]})]})}const gn=()=>{const{isMobile:l}=Ie(),[t,r]=u.useState([]),[n,s]=u.useState(!1),[d,a]=u.useState(null),[o,x]=u.useState(""),[m,v]=u.useState("all"),[f,b]=u.useState(!1),[C,g]=u.useState(),[w,y]=u.useState("add"),R=async()=>{s(!0),a(null);try{const{data:h,error:E}=await T.from("users").select("*").in("role",["admin","manager","staff","employee","user"]);if(E)throw E;if(h){const B=h.map(O=>({id:O.id,first_name:O.first_name||null,last_name:O.last_name||null,email:O.email,role:O.role||"employee",created_at:O.created_at||null,last_login:O.last_login||null,phone_number:O.phone_number||null,avatar_url:O.avatar_url||null}));r(B)}}catch(h){console.error("Error fetching employees:",h),a(h.message||"Failed to fetch employees")}finally{s(!1)}},S=()=>{g(void 0),y("add"),b(!0)},p=h=>{g(h),y("edit"),b(!0)},k=h=>{g(h),y("view"),b(!0)},H=()=>{b(!1),g(void 0)},I=()=>{R()},U=h=>({id:h.id,first_name:h.first_name||void 0,last_name:h.last_name||void 0,email:h.email,role:h.role,avatar_url:h.avatar_url||void 0,last_login:h.last_login||void 0,phone_number:h.phone_number||void 0}),j=Array.from(new Set(t.map(h=>h.role).filter(Boolean))),N=[...t.filter(h=>{const B=`${h.first_name||""} ${h.last_name||""}`.trim().toLowerCase().includes(o.toLowerCase())||h.email.toLowerCase().includes(o.toLowerCase()),O=m==="all"||h.role===m;return B&&O})].sort((h,E)=>{const B=`${h.first_name||""} ${h.last_name||""}`.trim()||h.email,O=`${E.first_name||""} ${E.last_name||""}`.trim()||E.email;return B.localeCompare(O)});u.useEffect(()=>{R()},[]);const W=()=>e.jsxs(i,{sx:{width:"100%",minHeight:"100vh"},children:[e.jsxs(ke,{padding:"medium",children:[e.jsx(c,{level:"h2",sx:{mb:2,fontSize:re.sizes.xlarge},children:"Employees"}),e.jsxs(i,{sx:{display:"flex",gap:1,mb:2},children:[e.jsx($,{placeholder:"Search employees...",value:o,onChange:h=>x(h.target.value),startDecorator:e.jsx(Se,{}),sx:{flex:1}}),e.jsxs(ye,{placeholder:"Role",value:m,onChange:(h,E)=>v(E??"all"),sx:{minWidth:120},children:[e.jsx(F,{value:"all",children:"All"}),j.map(h=>e.jsx(F,{value:h,children:h},h))]})]}),e.jsx(q,{variant:"solid",startDecorator:e.jsx(ve,{}),onClick:S,sx:{width:"100%",mb:2},children:"Add Employee"})]}),n&&e.jsx(De,{}),d&&e.jsx(i,{sx:{p:2},children:e.jsxs(c,{color:"danger",children:["Error: ",d]})}),e.jsx(i,{children:N.length===0?e.jsx(i,{sx:{textAlign:"center",py:6},children:e.jsx(c,{color:"neutral",children:"No employees found"})}):N.map(h=>e.jsx(i,{sx:{p:2,borderBottom:"1px solid",borderColor:"divider","&:hover":{bgcolor:"background.level1"}},children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(he,{size:"md",src:h.avatar_url||void 0,color:or(h.first_name,h.last_name,h.email),sx:{flexShrink:0},children:!h.avatar_url&&cr(h.first_name,h.last_name,h.email)}),e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:.5},children:[e.jsx(c,{level:"title-sm",sx:{fontWeight:"bold",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"60%"},children:`${h.first_name||""} ${h.last_name||""}`.trim()||"Unnamed Employee"}),h.role&&e.jsx(ae,{size:"sm",color:ar(h.role),variant:"soft",sx:{fontWeight:"bold",minWidth:"fit-content",textTransform:"capitalize"},children:h.role})]}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(Ke,{sx:{fontSize:14,color:"text.tertiary"}}),e.jsx(c,{level:"body-xs",color:"neutral",children:h.email})]}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:.5},children:[h.phone_number&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(ct,{sx:{fontSize:14,color:"text.tertiary"}}),e.jsx(c,{level:"body-xs",color:"neutral",children:h.phone_number})]}),h.last_login&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(Vt,{sx:{fontSize:14,color:"text.tertiary"}}),e.jsx(c,{level:"body-xs",color:"neutral",children:new Date(h.last_login).toLocaleDateString()})]})]}),h.created_at&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(vs,{sx:{fontSize:14,color:"text.tertiary"}}),e.jsxs(c,{level:"body-xs",color:"neutral",children:["Hired ",new Date(h.created_at).toLocaleDateString()]})]})]})]})},h.id))})]}),G=()=>e.jsxs(ke,{variant:"table-page",children:[e.jsx(c,{level:"h2",sx:{mb:2,fontSize:re.sizes.xlarge},children:"Employees"}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx($,{placeholder:"Search employees...",sx:{flex:1},value:o,onChange:h=>x(h.target.value),startDecorator:e.jsx(Se,{})}),e.jsxs(ye,{placeholder:"Filter role",value:m,onChange:(h,E)=>v(E??"all"),sx:{minWidth:160},children:[e.jsx(F,{value:"all",children:"All Roles"}),j.map(h=>e.jsx(F,{value:h,children:h},h))]}),e.jsx(q,{onClick:S,variant:"solid",startDecorator:e.jsx(ve,{}),children:"Add Employee"})]}),e.jsxs(me,{sx:{overflow:"visible"},children:[n&&e.jsx(De,{}),d&&e.jsxs(c,{color:"danger",children:["Error: ",d]}),e.jsxs(Ue,{"aria-label":"Employees",sx:{tableLayout:"auto"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:rt,children:"Name"}),e.jsx("th",{style:rt,children:"Email"}),e.jsx("th",{style:rt,children:"Role"}),e.jsx("th",{style:rt,children:"Hired"}),e.jsx("th",{style:rt,children:"Last Login"}),e.jsx("th",{style:rt,children:"Phone"}),e.jsx("th",{style:{width:120,...rt},children:"Actions"})]})}),e.jsxs("tbody",{children:[N.length===0&&!n&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,style:{textAlign:"center",color:"#888",...Je},children:"No employees found."})}),N.map(h=>e.jsxs("tr",{style:{cursor:"pointer",height:48},children:[e.jsx("td",{style:Je,children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(he,{size:"sm",src:h.avatar_url||void 0,color:or(h.first_name,h.last_name,h.email),children:!h.avatar_url&&cr(h.first_name,h.last_name,h.email)}),e.jsx(c,{level:"body-sm",fontWeight:"md",children:`${h.first_name||""} ${h.last_name||""}`.trim()||"Unnamed Employee"})]})}),e.jsx("td",{style:Je,children:h.email}),e.jsx("td",{style:Je,children:h.role?e.jsx(ae,{size:"sm",color:ar(h.role),variant:"soft",sx:{textTransform:"capitalize"},children:h.role}):"-"}),e.jsx("td",{style:Je,children:h.created_at?new Date(h.created_at).toLocaleDateString():"-"}),e.jsx("td",{style:Je,children:h.last_login?new Date(h.last_login).toLocaleDateString():"-"}),e.jsx("td",{style:Je,children:h.phone_number||"-"}),e.jsx("td",{children:e.jsx(mn,{employee:h,onEdit:p,onView:k})})]},h.id))]})]})]})]});return e.jsxs(qe,{children:[l?e.jsx(W,{}):e.jsx(G,{}),e.jsx(pn,{open:f,onClose:H,employee:C?U(C):void 0,mode:w,onSaved:I})]})};function fn({orderId:l,editable:t,onItemsChange:r,initialItems:n=[]}){const[s,d]=u.useState(n),[a,o]=u.useState([]),[x,m]=u.useState(!1);u.useEffect(()=>{m(!0),T.from("Products").select("uuid, ProductName").then(({data:g,error:w})=>{w?console.error("Failed to fetch products:",w.message):o(g||[]),m(!1)})},[]);const v=(g,w,y)=>{d(R=>{const S=R.map((p,k)=>k===g?{...p,[w]:y}:p);return r&&r(S),S})},f=()=>{d(g=>{const w=[...g,{product_id:null,quantity_ordered:1,unit_price:0}];return r&&r(w),w})},b=g=>{d(w=>{const y=w.filter((R,S)=>S!==g);return r&&r(y),y})},C=()=>s.reduce((g,w)=>g+w.quantity_ordered*w.unit_price,0);return e.jsxs(i,{sx:{mt:0},children:[e.jsxs(i,{sx:{display:{xs:"block",md:"none"}},children:[s.length===0?e.jsx(c,{color:"neutral",textAlign:"center",sx:{py:4},children:"No items added yet"}):s.map((g,w)=>e.jsxs(i,{sx:{mb:2,p:2,border:"1px solid",borderColor:"divider",borderRadius:"md"},children:[e.jsxs(i,{sx:{mb:2},children:[e.jsx(c,{level:"body-sm",sx:{mb:1},children:"Product:"}),e.jsx(Nt,{options:a,getOptionLabel:y=>y.ProductName,value:a.find(y=>y.uuid===g.product_id)||null,onChange:(y,R)=>v(w,"product_id",R?R.uuid:null),disabled:!t,sx:{width:"100%"},isOptionEqualToValue:(y,R)=>y.uuid===R.uuid,required:!0})]}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2},children:[e.jsxs(i,{sx:{flex:1},children:[e.jsx(c,{level:"body-sm",sx:{mb:1},children:"Quantity:"}),e.jsx($,{type:"number",value:g.quantity_ordered??1,onChange:y=>v(w,"quantity_ordered",Math.max(1,Number(y.target.value))),disabled:!t,sx:{width:"100%"},required:!0})]}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(c,{level:"body-sm",sx:{mb:1},children:"Unit Price:"}),e.jsx($,{type:"number",value:g.unit_price??0,onChange:y=>v(w,"unit_price",Math.max(0,Number(y.target.value))),disabled:!t,sx:{width:"100%"},required:!0})]})]}),e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(i,{children:[e.jsx(c,{level:"body-sm",color:"neutral",children:"Total:"}),e.jsx(c,{level:"title-sm",children:be(g.quantity_ordered*g.unit_price)})]}),t&&e.jsx(q,{size:"sm",color:"danger",onClick:()=>b(w),children:"Remove"})]})]},w)),s.length>0&&e.jsx(i,{sx:{mt:2,p:2,backgroundColor:"background.level1",borderRadius:"md",border:"1px solid",borderColor:"divider"},children:e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(c,{level:"title-sm",sx:{fontWeight:600},children:"Total:"}),e.jsx(c,{level:"title-sm",sx:{fontWeight:600,color:"primary.main"},children:be(C())})]})}),t&&e.jsx(q,{size:"sm",variant:"soft",onClick:f,sx:{mt:1},fullWidth:!0,children:"Add Item"})]}),e.jsxs(i,{sx:{display:{xs:"none",md:"block"}},children:[e.jsxs(Ue,{size:"sm",sx:{minWidth:500,"& th":{padding:"12px 8px",fontSize:"0.875rem",fontWeight:600,borderBottom:"2px solid",borderColor:"divider"},"& td":{padding:"8px",verticalAlign:"middle"}},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:"40%"},children:"Product"}),e.jsx("th",{style:{width:"15%",textAlign:"center"},children:"Qty"}),e.jsx("th",{style:{width:"20%",textAlign:"center"},children:"Unit Price"}),e.jsx("th",{style:{width:"15%",textAlign:"right"},children:"Total"}),t&&e.jsx("th",{style:{width:"10%",textAlign:"center"}})]})}),e.jsx("tbody",{children:s.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:t?5:4,style:{textAlign:"center",padding:"2rem",color:"#888"},children:"No items added yet"})}):s.map((g,w)=>e.jsxs("tr",{children:[e.jsx("td",{style:{padding:"8px"},children:e.jsx(Nt,{options:a,getOptionLabel:y=>y.ProductName,value:a.find(y=>y.uuid===g.product_id)||null,onChange:(y,R)=>v(w,"product_id",R?R.uuid:null),disabled:!t,sx:{width:"100%"},isOptionEqualToValue:(y,R)=>y.uuid===R.uuid,required:!0})}),e.jsx("td",{style:{padding:"8px",textAlign:"center"},children:e.jsx($,{type:"number",value:g.quantity_ordered??1,onChange:y=>v(w,"quantity_ordered",Math.max(1,Number(y.target.value))),disabled:!t,sx:{width:"100%",maxWidth:100},required:!0})}),e.jsx("td",{style:{padding:"8px",textAlign:"center"},children:e.jsx($,{type:"number",value:g.unit_price??0,onChange:y=>v(w,"unit_price",Math.max(0,Number(y.target.value))),disabled:!t,sx:{width:"100%",maxWidth:120},required:!0})}),e.jsx("td",{style:{padding:"8px",textAlign:"right",fontWeight:500},children:be(g.quantity_ordered*g.unit_price)}),t&&e.jsx("td",{style:{padding:"8px",textAlign:"center"},children:e.jsx(q,{size:"sm",color:"danger",onClick:()=>b(w),children:"Remove"})})]},w))})]}),t&&e.jsx(q,{size:"sm",variant:"soft",onClick:f,sx:{mt:2},children:"Add Item"})]})]})}const ts=["Pending","Approved","Received","Cancelled"];function Rt({open:l,onClose:t,onCreated:r,mode:n="add",order:s}){const[d,a]=u.useState(s?.order_number||""),[o,x]=u.useState(s?.order_date||new Date().toISOString().slice(0,10)),[m,v]=u.useState(s?.status||"Pending"),[f,b]=u.useState(s?.total?String(s.total):""),[C,g]=u.useState(s?.notes||""),[w,y]=u.useState(s?.supplier_id||null),[R,S]=u.useState(!1),[p,k]=u.useState(null),[H,I]=u.useState([]),[U,j]=u.useState(""),[A,N]=u.useState(!1),[W,G]=u.useState([{product_id:null,quantity_ordered:1,unit_price:0}]);u.useRef(null),u.useEffect(()=>{l?(console.log("[DialogPurchaseOrder] Modal opened"),T.from("Suppliers").select("id, name").then(({data:D})=>{I(D||[])}),(n==="edit"||n==="view")&&s?.id?T.from("purchaseorderitems").select("*").eq("purchase_order_id",s.id).then(({data:D})=>{G(D||[])}):n==="add"&&G([{product_id:null,quantity_ordered:1,unit_price:0}])):console.log("[DialogPurchaseOrder] Modal closed")},[l,n,s]),u.useEffect(()=>{l&&s?(a(s.order_number||""),x(s.order_date||new Date().toISOString().slice(0,10)),v(s.status||"Pending"),b(s.total?String(s.total):""),g(s.notes||""),y(s.supplier_id||null)):l&&n==="add"&&(a(""),x(new Date().toISOString().slice(0,10)),v("Pending"),b(""),g(""),y(null),j(""))},[l,s,n]);const h=async D=>{console.log("[DialogPurchaseOrder] handleSupplierAdded called");const{data:M}=await T.from("Suppliers").select("id, name");I(M||[]),D&&(y(String(D)),console.log("[DialogPurchaseOrder] New supplier set:",D)),N(!1),console.log("[DialogPurchaseOrder] DialogSupplier closed")},E=()=>{const D=new Date().toISOString().slice(0,10).replace(/-/g,""),M=Math.floor(1e3+Math.random()*9e3);return`PO-${D}-${M}`},B=()=>W.reduce((D,M)=>D+M.quantity_ordered*M.unit_price,0);u.useEffect(()=>{const D=B();b(D.toString())},[W]);const O=async()=>{console.log("[DialogPurchaseOrder] handleSave called"),S(!0),k(null);const D={order_date:o,status:m,notes:C,supplier_id:w,total:f?parseFloat(f):null};n==="edit"?D.order_number=d:n==="add"&&(D.order_number=E());let M,se=s?.id;if(n==="add"?(M=await T.from("PurchaseOrders").insert([D]).select(),!M.error&&M.data&&M.data[0]&&(se=M.data[0].id)):s&&(M=await T.from("PurchaseOrders").update(D).eq("id",s.id)),M&&!M.error&&n==="add"&&se&&W.length>0){const ue=W.filter(J=>J.product_id).map(J=>Xl({purchase_order_id:se,product_id:J.product_id,quantity_ordered:J.quantity_ordered,unit_price:J.unit_price,notes:J.notes||null}));if(ue.length===0){k("Please select a product for each item before saving."),S(!1);return}const le=await T.from("purchaseorderitems").insert(ue);if(le.error){k("Failed to save items: "+le.error.message),S(!1);return}}S(!1),M?.error?(k(M.error.message),console.log("[DialogPurchaseOrder] Save error:",M.error.message)):(r(),t(),a(""),x(new Date().toISOString().slice(0,10)),v("Pending"),b(""),g(""),y(null),j(""),console.log("[DialogPurchaseOrder] Purchase order saved and modal closed"))};return e.jsx(Ne,{open:l,onClose:t,"aria-labelledby":"purchase-order-form-title",children:e.jsxs($e,{size:"lg",sx:{width:{xs:"100vw",md:"90vw"},maxWidth:{xs:"none",md:1200},height:{xs:"100vh",md:"90vh"},maxHeight:{xs:"none",md:800},overflow:"hidden",display:"flex",flexDirection:"column",m:0,borderRadius:{xs:0,md:"md"},p:0},children:[e.jsxs(i,{sx:{display:{xs:"none",md:"flex"},justifyContent:"space-between",alignItems:"center",p:2,borderBottom:"1px solid",borderColor:"divider"},children:[e.jsxs(c,{id:"purchase-order-form-title",level:"title-md",children:[n==="edit"?"Edit":n==="view"?"View":"Add"," Purchase Order"]}),e.jsx(Fe,{})]}),e.jsxs(i,{sx:{display:{xs:"flex",md:"none"},justifyContent:"space-between",alignItems:"center",p:2,borderBottom:"1px solid",borderColor:"divider"},children:[e.jsxs(c,{id:"purchase-order-form-title",level:"title-md",children:[n==="edit"?"Edit":n==="view"?"View":"Add"," Purchase Order"]}),e.jsx(Fe,{})]}),e.jsxs(i,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},height:"100%",overflow:"hidden"},children:[e.jsxs(i,{sx:{width:{xs:"100%",md:"400px"},borderRight:{xs:"none",md:"1px solid"},borderBottom:{xs:"1px solid",md:"none"},borderColor:"divider",p:3,overflow:"auto",flexShrink:0},children:[e.jsx(c,{level:"title-sm",sx:{mb:2},children:"Order Information"}),e.jsxs("form",{onSubmit:D=>{D.preventDefault(),n!=="view"&&O()},children:[e.jsx($,{type:"date",value:o,onChange:D=>x(D.target.value),sx:{mb:2},required:!0,readOnly:n==="view",startDecorator:e.jsx(c,{level:"body-sm",sx:{minWidth:80},children:"Date:"})}),(n==="edit"||n==="view")&&e.jsxs(i,{sx:{mb:2},children:[e.jsx(c,{level:"body-sm",sx:{mb:1},children:"Status:"}),e.jsx(ae,{variant:"soft",color:m==="Approved"?"success":m==="Received"?"primary":m==="Cancelled"?"danger":"neutral",sx:{textTransform:"capitalize",fontWeight:600,fontSize:"md",px:1.5,py:.5},onClick:n==="view"?void 0:()=>{const D=ts.indexOf(m);v(ts[(D+1)%ts.length])},children:m})]}),e.jsxs(i,{sx:{mb:2},children:[e.jsx(c,{level:"body-sm",sx:{mb:1},children:"Supplier:"}),e.jsxs(i,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(Nt,{options:H,getOptionLabel:D=>D.name,value:H.find(D=>D.id===w)||null,onChange:(D,M)=>y(M?M.id:null),inputValue:U,onInputChange:(D,M)=>j(M),placeholder:"Select supplier",sx:{flex:1,mb:0},isOptionEqualToValue:(D,M)=>D.id===M.id,required:!0,readOnly:n==="view"}),n!=="view"&&e.jsx(xe,{color:"primary",sx:{ml:1},onClick:()=>N(!0),children:e.jsx(ve,{})})]})]}),(n==="edit"||n==="view")&&e.jsxs(e.Fragment,{children:[e.jsx($,{placeholder:"Order Number",value:d,onChange:D=>a(D.target.value),sx:{mb:2},readOnly:n==="view",startDecorator:e.jsx(c,{level:"body-sm",sx:{minWidth:80},children:"Number:"})}),e.jsx($,{placeholder:"Total",value:f,onChange:D=>b(D.target.value),sx:{mb:2},type:"number",readOnly:!0,startDecorator:e.jsx(c,{level:"body-sm",sx:{minWidth:80},children:"Total:"})})]}),e.jsx($,{placeholder:"Notes",value:C,onChange:D=>g(D.target.value),sx:{mb:2},readOnly:n==="view",startDecorator:e.jsx(c,{level:"body-sm",sx:{minWidth:80},children:"Notes:"})}),n!=="view"&&e.jsxs(i,{sx:{mt:3},children:[p&&e.jsx(c,{color:"danger",sx:{mb:2},children:p}),e.jsx(q,{type:"submit",loading:R,disabled:R,variant:"solid",fullWidth:!0,children:"Save Purchase Order"})]})]}),e.jsx(Is,{open:A,onClose:()=>N(!1),onSaved:h,mode:"add"})]}),e.jsxs(i,{sx:{flex:1,display:"flex",flexDirection:"column",minHeight:0,overflow:"hidden"},children:[e.jsx(i,{sx:{p:1,borderBottom:"0px solid",borderColor:"divider",flexShrink:0},children:e.jsx(c,{level:"title-sm",children:"Order Items"})}),e.jsx(i,{sx:{flex:1,overflow:"auto",p:2,paddingBottom:0},children:e.jsx(fn,{orderId:s?.id,editable:n==="add"||n==="edit",onItemsChange:G,initialItems:W})}),e.jsx(i,{sx:{borderTop:"1px solid",borderColor:"divider",p:3,flexShrink:0,backgroundColor:"background.level1"},children:e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",maxWidth:{xs:"100%",md:"400px"},ml:"auto"},children:[e.jsx(c,{level:"title-md",sx:{fontWeight:600},children:"Total:"}),e.jsx(c,{level:"title-md",sx:{fontWeight:600,color:"primary.main"},children:be(B())})]})})]})]})]})})}function Is({open:l,onClose:t,onSaved:r,mode:n="add",supplier:s,onDelete:d,onEdit:a}){const[o,x]=u.useState(s?.name||""),[m,v]=u.useState(s?.contact_name||""),[f,b]=u.useState(s?.email||""),[C,g]=u.useState(s?.phone||""),[w,y]=u.useState(s?.address||""),[R,S]=u.useState(s?.image_url||""),[p,k]=u.useState(!1),[H,I]=u.useState(!1),[U,j]=u.useState(null),A=u.useRef(null),[N,W]=u.useState([]),[G,h]=u.useState(!1),[E,B]=u.useState(null),[O,D]=u.useState(!1);u.useEffect(()=>{l&&(n==="edit"||n==="view")&&s?(x(s.name||""),v(s.contact_name||""),b(s.email||""),g(s.phone||""),y(s.address||""),S(s.image_url||""),n==="view"&&M()):l&&n==="add"&&(x(""),v(""),b(""),g(""),y(""),S(""))},[l,n,s]);const M=async()=>{if(s?.id){h(!0),B(null);try{const{data:Q,error:ce}=await T.from("PurchaseOrders").select("id, order_number, order_date, status, total, notes").eq("supplier_id",s.id).order("order_date",{ascending:!1});if(ce)throw ce;Q&&W(Q)}catch(Q){console.error("Error fetching purchase orders:",Q),B(Q.message||"Failed to fetch purchase orders")}finally{h(!1)}}},se=()=>{D(!1),n==="view"&&M()},ue=async Q=>{const ce=Q.target.files?.[0];if(ce){if(!ce.type.startsWith("image/")){j("Please select a valid image file");return}if(ce.size>5*1024*1024){j("Image size must be less than 5MB");return}try{I(!0),j(null);const L=ce.name.split(".").pop(),Y=`${Date.now()}-${Math.random().toString(36).substring(2)}.${L}`,{data:we,error:de}=await T.storage.from("supplierimages").upload(Y,ce);if(de)throw de;const{data:{publicUrl:Oe}}=T.storage.from("supplierimages").getPublicUrl(Y);S(Oe)}catch(L){console.error("Error uploading image:",L),j(L.message||"Failed to upload image")}finally{I(!1)}}},le=async()=>{if(R)try{I(!0);const Q=R.split("/").pop();Q&&await T.storage.from("supplierimages").remove([Q]),S("")}catch(Q){console.error("Error removing image:",Q),j(Q.message||"Failed to remove image")}finally{I(!1)}},J=async()=>{if(!o.trim()||!f.trim()){j("Name and email are required");return}try{k(!0),j(null);const Q={name:o.trim(),contact_name:m.trim()||null,email:f.trim(),phone:C.trim()||null,address:w.trim()||null,image_url:R||null};if(n==="edit"&&s?.id){const{error:ce}=await T.from("Suppliers").update(Q).eq("id",s.id);if(ce)throw ce}else{const{data:ce,error:L}=await T.from("Suppliers").insert([Q]).select();if(L)throw L;ce?.[0]&&r(ce[0].id)}r(),t()}catch(Q){console.error("Error saving supplier:",Q),j(Q.message||"Failed to save supplier")}finally{k(!1)}},oe=async()=>{if(!(!s?.id||!d)&&confirm("Are you sure you want to delete this supplier?"))try{const{error:Q}=await T.from("Suppliers").delete().eq("id",s.id);if(Q)throw Q;d(s.id),t()}catch(Q){j(Q.message||"Failed to delete supplier")}};return e.jsxs(e.Fragment,{children:[e.jsx(Ne,{open:l,onClose:t,children:e.jsxs($e,{sx:{minWidth:n==="view"?{xs:"90vw",sm:"80vw",md:"1000px"}:400,maxWidth:n==="view"?{xs:"95vw",sm:"90vw",md:"1200px"}:500,minHeight:n==="view"?"70vh":"auto",maxHeight:"90vh",overflow:"hidden"},children:[e.jsx(Fe,{}),e.jsxs(c,{level:"title-md",sx:{mb:2},children:[n==="view"?"Supplier Details":n==="edit"?"Edit":"Add",n!=="view"?" Supplier":""]}),n==="view"?e.jsxs(i,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},gap:3,height:"100%",overflow:"hidden"},children:[e.jsxs(i,{sx:{flex:1,display:"flex",flexDirection:"column",gap:3,minWidth:{xs:"100%",md:"340px"},maxWidth:{xs:"100%",md:"420px"},borderRight:{md:"1px solid"},borderColor:"divider",pr:{md:3}},children:[e.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:[e.jsx(he,{size:"lg",src:R,sx:{width:80,height:80},children:!R&&o&&o.substring(0,2).toUpperCase()}),e.jsx(c,{level:"h3",textAlign:"center",children:o})]}),e.jsxs(me,{variant:"soft",children:[e.jsx(c,{level:"h4",sx:{mb:0},children:"Company"}),e.jsx(Ae,{sx:{mb:0}}),e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:1},children:[e.jsxs(c,{level:"body-md",children:[e.jsx("strong",{children:"Name:"})," ",o]}),e.jsxs(c,{level:"body-md",children:[e.jsx("strong",{children:"Address:"})," ",w||"N/A"]})]})]}),e.jsxs(me,{variant:"soft",children:[e.jsx(c,{level:"h4",sx:{mb:0},children:"Contact"}),e.jsx(Ae,{sx:{mb:0}}),e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:1},children:[e.jsxs(c,{level:"body-md",children:[e.jsx("strong",{children:"Contact Name:"})," ",m||"N/A"]}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1},children:[e.jsxs(c,{level:"body-md",sx:{flex:1,minWidth:0},children:[e.jsx("strong",{children:"Email:"})," ",f||"N/A"]}),f&&e.jsx(q,{size:"sm",variant:"outlined",startDecorator:e.jsx(Ke,{}),onClick:()=>window.open(`mailto:${f}`,"_self"),sx:{flexShrink:0},children:"Email"})]}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1},children:[e.jsxs(c,{level:"body-md",sx:{flex:1,minWidth:0},children:[e.jsx("strong",{children:"Phone:"})," ",C||"N/A"]}),C&&e.jsx(q,{size:"sm",variant:"outlined",startDecorator:e.jsx(ct,{}),onClick:()=>window.open(`tel:${C}`,"_self"),sx:{flexShrink:0},children:"Call"})]})]})]}),e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:2,mt:"auto"},children:[e.jsx(q,{variant:"solid",startDecorator:e.jsx(ve,{}),onClick:()=>D(!0),sx:{width:"100%"},children:"Add Purchase Order"}),e.jsx(q,{variant:"outlined",startDecorator:e.jsx(ot,{}),onClick:a,sx:{width:"100%"},children:"Edit Supplier"})]})]}),e.jsxs(i,{sx:{flex:2,display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsx(c,{level:"h3",sx:{mb:2},children:"Purchase Orders"}),G&&e.jsx(c,{children:"Loading purchase orders..."}),E&&e.jsxs(c,{color:"danger",children:["Error: ",E]}),e.jsx(i,{sx:{flex:1,overflow:"auto"},children:e.jsxs(Ue,{stickyHeader:!0,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Order #"}),e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Total"}),e.jsx("th",{children:"Notes"})]})}),e.jsxs("tbody",{children:[N.map(Q=>e.jsxs("tr",{children:[e.jsx("td",{children:Q.order_number}),e.jsx("td",{children:Q.order_date}),e.jsx("td",{children:Q.status}),e.jsx("td",{children:Q.total!=null?be(Q.total):"â€”"}),e.jsx("td",{children:Q.notes||""})]},Q.id)),N.length===0&&!G&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,style:{textAlign:"center",color:"#888"},children:"No purchase orders for this supplier."})})]})]})})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",mb:3,gap:2},children:[e.jsx(c,{level:"body-sm",children:"Supplier Avatar"}),e.jsxs(i,{sx:{position:"relative"},children:[e.jsx(he,{size:"lg",src:R,sx:{width:80,height:80},children:!R&&o&&o.substring(0,2).toUpperCase()}),R&&e.jsx(xe,{size:"sm",variant:"solid",color:"danger",sx:{position:"absolute",top:-8,right:-8,width:24,height:24},onClick:le,children:e.jsx(Ss,{sx:{fontSize:14}})})]}),e.jsxs(i,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx("input",{type:"file",accept:"image/*",onChange:ue,style:{display:"none"},ref:A,disabled:H}),e.jsx(q,{variant:"outlined",size:"sm",loading:H,onClick:()=>A.current?.click(),startDecorator:e.jsx(kt,{}),children:R?"Change Image":"Upload Image"})]}),e.jsx(c,{level:"body-xs",color:"neutral",sx:{textAlign:"center"},children:"Max 5MB (JPG, PNG, GIF)"})]}),e.jsxs("form",{onSubmit:Q=>{Q.preventDefault(),Q.stopPropagation(),J()},children:[e.jsx($,{placeholder:"Name",value:o,onChange:Q=>x(Q.target.value),sx:{mb:2},required:!0}),e.jsx($,{placeholder:"Contact Name",value:m,onChange:Q=>v(Q.target.value),sx:{mb:2}}),e.jsx($,{placeholder:"Email",value:f,onChange:Q=>b(Q.target.value),sx:{mb:2},type:"email",required:!0}),e.jsx($,{placeholder:"Phone",value:C,onChange:Q=>g(Q.target.value),sx:{mb:2},type:"tel"}),e.jsx($,{placeholder:"Address",value:w,onChange:Q=>y(Q.target.value),sx:{mb:2}}),U&&e.jsx(c,{color:"danger",sx:{mb:1},children:U}),e.jsxs(i,{sx:{display:"flex",gap:1,justifyContent:"space-between"},children:[e.jsx(q,{type:"submit",loading:p,disabled:p,variant:"solid",sx:{flex:1},children:n==="edit"?"Update":"Save"}),n==="edit"&&s?.id&&d&&e.jsx(q,{variant:"outlined",color:"danger",startDecorator:e.jsx(ht,{}),onClick:oe,disabled:p,children:"Delete"})]})]})]})]})}),e.jsx(Rt,{open:O,onClose:()=>D(!1),onCreated:se,mode:"add",order:s?.id?{id:"",order_number:"",order_date:"",status:"",total:0,notes:"",supplier_id:s.id.toString()}:void 0})]})}const dr=l=>{let t=0;for(let n=0;n<l.length;n++)t=l.charCodeAt(n)+((t<<5)-t);const r=["primary","success","warning","danger","neutral"];return r[Math.abs(t)%r.length]},ur=l=>{const t=l.split(" ");return t.length>=2?(t[0][0]+t[1][0]).toUpperCase():l.substring(0,2).toUpperCase()},jn=()=>{const{isMobile:l}=Ie(),[t,r]=u.useState([]),[n,s]=u.useState(!1),[d,a]=u.useState(null),[o,x]=u.useState(""),[m,v]=u.useState(!1),[f,b]=u.useState(null),[C,g]=u.useState("view"),w=async()=>{s(!0),a(null);try{const{data:j,error:A}=await T.from("Suppliers").select("*");if(A)throw A;j&&r(j)}catch(j){console.error("Error fetching suppliers:",j),a(j.message||"Failed to fetch suppliers")}finally{s(!1)}},y=j=>{b(j),g("view"),v(!0)},R=()=>{g("edit")},S=async j=>{await w()},p=async()=>{v(!1),await w()},H=[...t.filter(j=>j.name?.toLowerCase().includes(o.toLowerCase())||j.contact_name?.toLowerCase().includes(o.toLowerCase())||j.email?.toLowerCase().includes(o.toLowerCase())||j.phone?.toLowerCase().includes(o.toLowerCase())||j.address?.toLowerCase().includes(o.toLowerCase()))].sort((j,A)=>j.name.localeCompare(A.name));u.useEffect(()=>{w()},[]);const I=()=>e.jsxs(i,{sx:{pb:2},children:[e.jsxs(ke,{padding:"medium",children:[e.jsx(c,{level:"h2",sx:{mb:2,fontSize:re.sizes.xlarge},children:"Suppliers"}),e.jsx(i,{sx:{display:"flex",gap:1,mb:2},children:e.jsx($,{placeholder:"Search suppliers...",value:o,onChange:j=>x(j.target.value),startDecorator:e.jsx(Se,{}),sx:{flex:1}})}),e.jsx(q,{variant:"solid",startDecorator:e.jsx(ve,{}),onClick:()=>{b(null),g("add"),v(!0)},sx:{width:"100%",mb:2},children:"Add Supplier"})]}),n&&e.jsx(De,{}),d&&e.jsx(i,{sx:{p:2},children:e.jsxs(c,{color:"danger",children:["Error: ",d]})}),e.jsx(i,{children:H.length===0?e.jsx(i,{sx:{textAlign:"center",py:6},children:e.jsx(c,{color:"neutral",children:"No suppliers found"})}):H.map(j=>e.jsx(me,{variant:"outlined",sx:{mx:2,mb:2,cursor:"pointer","&:hover":{boxShadow:"md",transform:"translateY(-2px)",transition:"all 0.2s ease-in-out"}},onClick:()=>y(j),children:e.jsx(Re,{sx:{p:2},children:e.jsxs(i,{sx:{display:"flex",alignItems:"flex-start",gap:2},children:[e.jsx(he,{size:"md",src:j.image_url,color:dr(j.name),sx:{flexShrink:0},children:!j.image_url&&ur(j.name)}),e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsx(i,{sx:{mb:1},children:e.jsx(c,{level:"title-md",sx:{fontWeight:"bold",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:j.name})}),e.jsxs(X,{spacing:.5,children:[j.contact_name&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(at,{sx:{fontSize:16,color:"text.tertiary"}}),e.jsx(c,{level:"body-sm",color:"neutral",children:j.contact_name})]}),j.email&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ke,{sx:{fontSize:16,color:"text.tertiary"}}),e.jsx(c,{level:"body-sm",color:"neutral",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:j.email})]}),j.phone&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ct,{sx:{fontSize:16,color:"text.tertiary"}}),e.jsx(c,{level:"body-sm",color:"neutral",children:j.phone})]}),j.address&&e.jsxs(i,{sx:{display:"flex",alignItems:"flex-start",gap:1,mt:.5},children:[e.jsx(Zs,{sx:{fontSize:16,color:"text.tertiary",mt:.25}}),e.jsx(c,{level:"body-sm",color:"neutral",sx:{overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",lineHeight:1.2},children:j.address})]})]})]})]})})},j.id))})]}),U=()=>e.jsxs(ke,{variant:"table-page",children:[e.jsx(c,{level:"h2",sx:{mb:2,fontSize:re.sizes.xlarge},children:"Suppliers"}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2,alignItems:"center"},children:[e.jsx($,{placeholder:"Search suppliers...",value:o,onChange:j=>x(j.target.value),startDecorator:e.jsx(Se,{}),sx:{flex:1}}),e.jsx(q,{variant:"solid",startDecorator:e.jsx(ve,{}),onClick:()=>{b(null),g("add"),v(!0)},sx:{minWidth:140,flexShrink:0},children:"Add Supplier"})]}),n&&e.jsx(De,{sx:{mb:2}}),d&&e.jsxs(c,{color:"danger",sx:{mb:2},children:["Error: ",d]}),e.jsx(Ce,{container:!0,spacing:2,sx:{width:"calc(100% + 16px)",ml:"-8px",mt:"-8px"},children:H.length===0?e.jsx(Ce,{xs:12,sx:{width:"100%"},children:e.jsx(i,{sx:{textAlign:"center",py:6},children:e.jsx(c,{color:"neutral",children:"No suppliers found"})})}):H.map(j=>e.jsx(Ce,{xs:12,sm:6,lg:4,xl:3,sx:{display:"flex",width:"100%"},children:e.jsx(me,{variant:"outlined",sx:{width:"100%",minHeight:"200px",cursor:"pointer",display:"flex",flexDirection:"column","&:hover":{boxShadow:"md",transform:"translateY(-2px)",transition:"all 0.2s ease-in-out"}},onClick:()=>y(j),children:e.jsxs(Re,{sx:{flex:1,display:"flex",flexDirection:"column",p:2},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:[e.jsx(he,{size:"md",src:j.image_url,color:dr(j.name),sx:{flexShrink:0},children:!j.image_url&&ur(j.name)}),e.jsx(c,{level:"title-md",fontWeight:"bold",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1,minWidth:0},children:j.name})]}),e.jsxs(X,{spacing:1.5,sx:{flex:1},children:[j.contact_name&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(at,{sx:{fontSize:16,color:"text.tertiary",flexShrink:0}}),e.jsx(c,{level:"body-sm",color:"neutral",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1,minWidth:0},children:j.contact_name})]}),j.email&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(Ke,{sx:{fontSize:16,color:"text.tertiary",flexShrink:0}}),e.jsx(c,{level:"body-sm",color:"neutral",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1,minWidth:0},children:j.email})]}),j.phone&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(ct,{sx:{fontSize:16,color:"text.tertiary",flexShrink:0}}),e.jsx(c,{level:"body-sm",color:"neutral",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1,minWidth:0},children:j.phone})]}),j.address&&e.jsxs(i,{sx:{display:"flex",alignItems:"flex-start",gap:1.5},children:[e.jsx(Zs,{sx:{fontSize:16,color:"text.tertiary",flexShrink:0,mt:.25}}),e.jsx(c,{level:"body-sm",color:"neutral",sx:{overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",lineHeight:1.3,flex:1,minWidth:0},children:j.address})]})]})]})})},j.id))})]});return e.jsxs(qe,{children:[l?e.jsx(I,{}):e.jsx(U,{}),e.jsx(Is,{open:m,onClose:()=>v(!1),supplier:f,onSaved:p,mode:C==="edit"||C==="add"||C==="view"?C:void 0,onDelete:C==="edit"?S:void 0,onEdit:R})]})};function bn({open:l,onClose:t,onSaved:r,mode:n="add",storefront:s,onDelete:d,onEdit:a}){const[o,x]=u.useState(s?.name||""),[m,v]=u.useState(s?.url||""),[f,b]=u.useState(s?.logo_url||""),[C,g]=u.useState(s?.is_online||!1),[w,y]=u.useState(!1),[R,S]=u.useState(!1),[p,k]=u.useState(null),H=u.useRef(null);u.useEffect(()=>{l&&(n==="edit"||n==="view")&&s?(x(s.name||""),v(s.url||""),b(s.logo_url||""),g(s.is_online||!1)):l&&n==="add"&&(x(""),v(""),b(""),g(!1)),k(null)},[l,n,s]);const I=async G=>{const h=G.target.files?.[0];if(h){if(!h.type.startsWith("image/")){k("Please select a valid image file");return}if(h.size>5*1024*1024){k("Image size must be less than 5MB");return}try{S(!0),k(null);const E=h.name.split(".").pop(),B=`${Date.now()}-${Math.random().toString(36).substring(2)}.${E}`,{data:O,error:D}=await T.storage.from("storefrontlogos").upload(B,h);if(D)throw D;const{data:{publicUrl:M}}=T.storage.from("storefrontlogos").getPublicUrl(B);b(M)}catch(E){console.error("Error uploading logo:",E),k(E.message||"Failed to upload logo")}finally{S(!1)}}},U=async()=>{if(f)try{S(!0);const G=f.split("/").pop();G&&await T.storage.from("storefrontlogos").remove([G]),b("")}catch(G){console.error("Error removing logo:",G),k(G.message||"Failed to remove logo")}finally{S(!1)}},j=async()=>{if(!o.trim()){k("Name is required");return}try{y(!0),k(null);const G={name:o.trim(),url:m.trim()||null,logo_url:f||null,is_online:C};if(n==="edit"&&s?.id){const{error:h}=await T.from("storefronts").update(G).eq("id",s.id);if(h)throw h}else{const{data:h,error:E}=await T.from("storefronts").insert([G]).select();if(E)throw E;h?.[0]&&r(h[0].id)}r(),t()}catch(G){console.error("Error saving storefront:",G),k(G.message||"Failed to save storefront")}finally{y(!1)}},A=async()=>{if(!(!s?.id||!d)&&confirm("Are you sure you want to delete this storefront?"))try{const{error:G}=await T.from("storefronts").delete().eq("id",s.id);if(G)throw G;d(s.id),t()}catch(G){k(G.message||"Failed to delete storefront")}},N=G=>G.split(" ").map(h=>h.charAt(0)).join("").toUpperCase().substring(0,2),W=G=>{const h=["primary","danger","success","warning","neutral"],E=G.split("").reduce((B,O)=>O.charCodeAt(0)+B,0);return h[E%h.length]};return e.jsx(Ne,{open:l,onClose:t,children:e.jsxs($e,{sx:{minWidth:n==="view"?{xs:"90vw",sm:"600px"}:400,maxWidth:n==="view"?{xs:"95vw",sm:"800px"}:500,maxHeight:"90vh",overflow:"auto"},children:[e.jsx(Fe,{}),e.jsxs(c,{level:"title-md",sx:{mb:2},children:[n==="view"?"Storefront Details":n==="edit"?"Edit":"Add",n!=="view"?" Storefront":""]}),n==="view"?e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:3},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:3},children:[e.jsx(he,{size:"lg",src:f,color:W(o),sx:{width:80,height:80},children:!f&&N(o)}),e.jsxs(i,{sx:{flex:1},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2,mb:1},children:[e.jsx(c,{level:"title-lg",fontWeight:"bold",children:o}),e.jsx(ae,{size:"sm",color:C?"success":"neutral",startDecorator:e.jsx(cs,{sx:{fontSize:12}}),children:C?"Online":"Offline"})]}),m&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(Mt,{sx:{fontSize:16,color:"text.tertiary"}}),e.jsx(c,{level:"body-sm",color:"neutral",component:"a",href:m.startsWith("http")?m:`https://${m}`,target:"_blank",rel:"noopener noreferrer",sx:{textDecoration:"none","&:hover":{textDecoration:"underline"}},children:m}),e.jsx(xe,{size:"sm",variant:"plain",component:"a",href:m.startsWith("http")?m:`https://${m}`,target:"_blank",rel:"noopener noreferrer",children:e.jsx(kl,{sx:{fontSize:16}})})]})]})]}),e.jsx(Ae,{}),e.jsxs(i,{sx:{display:"flex",gap:2,justifyContent:"flex-end"},children:[a&&e.jsx(q,{variant:"outlined",startDecorator:e.jsx(ot,{}),onClick:a,children:"Edit"}),d&&e.jsx(q,{variant:"outlined",color:"danger",startDecorator:e.jsx(ht,{}),onClick:A,children:"Delete"})]})]}):e.jsxs(X,{spacing:2,children:[e.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:[e.jsx(he,{size:"lg",src:f,color:o?W(o):"neutral",sx:{width:80,height:80},children:!f&&o&&N(o)}),e.jsxs(i,{sx:{display:"flex",gap:1},children:[e.jsx("input",{type:"file",accept:"image/*",onChange:I,style:{display:"none"},ref:H}),e.jsx(q,{size:"sm",variant:"outlined",startDecorator:e.jsx(kt,{}),onClick:()=>H.current?.click(),disabled:R,loading:R,children:"Upload Logo"}),f&&e.jsx(xe,{size:"sm",variant:"outlined",color:"danger",onClick:U,disabled:R,children:e.jsx(Ss,{})})]})]}),e.jsxs(te,{required:!0,children:[e.jsx(ee,{children:"Name"}),e.jsx($,{value:o,onChange:G=>x(G.target.value),placeholder:"Enter storefront name"})]}),e.jsxs(te,{children:[e.jsx(ee,{children:"Website URL"}),e.jsx($,{value:m,onChange:G=>v(G.target.value),placeholder:"https://example.com"})]}),e.jsxs(te,{children:[e.jsx(ee,{children:"Status"}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(sl,{checked:C,onChange:G=>g(G.target.checked)}),e.jsx(c,{level:"body-sm",children:C?"Online":"Offline"})]})]}),p&&e.jsx(c,{color:"danger",level:"body-sm",children:p}),e.jsxs(i,{sx:{display:"flex",gap:2,justifyContent:"flex-end",mt:2},children:[e.jsx(q,{variant:"outlined",onClick:t,children:"Cancel"}),e.jsxs(q,{variant:"solid",onClick:j,loading:w,disabled:!o.trim(),children:[n==="edit"?"Update":"Add"," Storefront"]})]})]})]})})}const hr=l=>{const t=["primary","danger","success","warning","neutral"],r=l.split("").reduce((n,s)=>s.charCodeAt(0)+n,0);return t[r%t.length]},xr=l=>l.split(" ").map(t=>t.charAt(0)).join("").toUpperCase().substring(0,2),yn=()=>{const[l,t]=u.useState([]),[r,n]=u.useState(!0),[s,d]=u.useState(null),[a,o]=u.useState(""),[x,m]=u.useState(!1),[v,f]=u.useState(null),[b,C]=u.useState("add"),{isMobile:g}=Ie(),w=async()=>{try{n(!0);const{data:j,error:A}=await T.from("storefronts").select("*").order("name",{ascending:!0});if(A)throw A;t(j||[])}catch(j){d(j.message)}finally{n(!1)}};u.useEffect(()=>{w()},[]);const R=[...l.filter(j=>j.name.toLowerCase().includes(a.toLowerCase())||j.url&&j.url.toLowerCase().includes(a.toLowerCase()))].sort((j,A)=>j.is_online!==A.is_online?j.is_online?-1:1:j.name.localeCompare(A.name)),S=j=>{f(j),C("view"),m(!0)},p=()=>{C("edit")},k=()=>{w(),m(!1)},H=()=>{w(),m(!1)},I=()=>e.jsxs(i,{sx:{p:2},children:[e.jsx(c,{level:"h2",sx:{mb:2,fontSize:re.sizes.xlarge},children:"Storefronts"}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2,alignItems:"center"},children:[e.jsx($,{placeholder:"Search storefronts...",value:a,onChange:j=>o(j.target.value),startDecorator:e.jsx(Se,{}),sx:{flex:1}}),e.jsx(q,{variant:"solid",startDecorator:e.jsx(ve,{}),onClick:()=>{f(null),C("add"),m(!0)},sx:{minWidth:100,flexShrink:0},children:"Add"})]}),r&&e.jsx(De,{sx:{mb:2}}),s&&e.jsxs(c,{color:"danger",sx:{mb:2},children:["Error: ",s]}),e.jsx(i,{children:R.length===0?e.jsx(i,{sx:{textAlign:"center",py:6},children:e.jsx(c,{color:"neutral",children:"No storefronts found"})}):R.map(j=>e.jsx(me,{variant:"outlined",sx:{mx:2,mb:2,cursor:"pointer","&:hover":{boxShadow:"md",transform:"translateY(-2px)",transition:"all 0.2s ease-in-out"}},onClick:()=>S(j),children:e.jsx(Re,{sx:{p:2},children:e.jsxs(i,{sx:{display:"flex",alignItems:"flex-start",gap:2},children:[e.jsx(he,{size:"md",src:j.logo_url,color:hr(j.name),sx:{flexShrink:0},children:!j.logo_url&&xr(j.name)}),e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsxs(i,{sx:{mb:1,display:"flex",alignItems:"center",gap:1},children:[e.jsx(c,{level:"title-md",sx:{fontWeight:"bold",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1},children:j.name}),e.jsx(ae,{size:"sm",color:j.is_online?"success":"neutral",startDecorator:e.jsx(cs,{sx:{fontSize:12}}),children:j.is_online?"Online":"Offline"})]}),e.jsx(X,{spacing:.5,children:j.url&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Mt,{sx:{fontSize:16,color:"text.tertiary"}}),e.jsx(c,{level:"body-sm",color:"neutral",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:j.url})]})})]})]})})},j.id))})]}),U=()=>e.jsxs(ke,{variant:"table-page",children:[e.jsx(c,{level:"h2",sx:{mb:2,fontSize:re.sizes.xlarge},children:"Storefronts"}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2,alignItems:"center"},children:[e.jsx($,{placeholder:"Search storefronts...",value:a,onChange:j=>o(j.target.value),startDecorator:e.jsx(Se,{}),sx:{flex:1}}),e.jsx(q,{variant:"solid",startDecorator:e.jsx(ve,{}),onClick:()=>{f(null),C("add"),m(!0)},sx:{minWidth:140,flexShrink:0},children:"Add Storefront"})]}),r&&e.jsx(De,{sx:{mb:2}}),s&&e.jsxs(c,{color:"danger",sx:{mb:2},children:["Error: ",s]}),e.jsx(Ce,{container:!0,spacing:2,sx:{width:"calc(100% + 16px)",ml:"-8px",mt:"-8px"},children:R.length===0?e.jsx(Ce,{xs:12,sx:{width:"100%"},children:e.jsx(i,{sx:{textAlign:"center",py:6},children:e.jsx(c,{color:"neutral",children:"No storefronts found"})})}):R.map(j=>e.jsx(Ce,{xs:12,sm:6,lg:4,xl:3,sx:{display:"flex",width:"100%"},children:e.jsx(me,{variant:"outlined",sx:{width:"100%",minHeight:"160px",cursor:"pointer",display:"flex",flexDirection:"column","&:hover":{boxShadow:"md",transform:"translateY(-2px)",transition:"all 0.2s ease-in-out"}},onClick:()=>S(j),children:e.jsxs(Re,{sx:{flex:1,display:"flex",flexDirection:"column",p:2},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:[e.jsx(he,{size:"md",src:j.logo_url,color:hr(j.name),sx:{flexShrink:0},children:!j.logo_url&&xr(j.name)}),e.jsx(c,{level:"title-md",fontWeight:"bold",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1,minWidth:0},children:j.name})]}),e.jsxs(X,{spacing:1.5,sx:{flex:1},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(cs,{sx:{fontSize:16,color:j.is_online?"success.main":"neutral.main",flexShrink:0}}),e.jsx(ae,{size:"sm",color:j.is_online?"success":"neutral",children:j.is_online?"Online":"Offline"})]}),j.url&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(Mt,{sx:{fontSize:16,color:"text.tertiary",flexShrink:0}}),e.jsx(c,{level:"body-sm",color:"neutral",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1,minWidth:0},children:j.url})]})]})]})})},j.id))})]});return e.jsxs(qe,{children:[g?e.jsx(I,{}):e.jsx(U,{}),e.jsx(bn,{open:x,onClose:()=>m(!1),storefront:v,onSaved:k,mode:b==="edit"||b==="add"||b==="view"?b:void 0,onDelete:b==="edit"?H:void 0,onEdit:p})]})};async function vn(l,t){try{console.log("Receiving purchase order:",{purchaseOrderId:l,items:t});for(const s of t){const{error:d}=await T.from("purchaseorderitems").update({quantity_received:s.quantity_received}).eq("purchase_order_id",l).eq("product_id",s.product_id);if(d)throw console.error("Error updating purchase order item:",d),new Error(`Failed to update purchase order item: ${d.message}`)}const r=t.filter(s=>s.quantity_received>0).map(s=>({product_id:s.product_id,movement_type:"incoming",quantity:s.quantity_received,date:new Date().toISOString(),reason:"PO Receipt",referenceuuid:l}));if(r.length>0){const{error:s}=await T.from("stock_movements").insert(r);if(s)throw console.error("Error inserting stock movements:",s),new Error(`Failed to insert stock movements: ${s.message}`)}const{error:n}=await T.from("PurchaseOrders").update({status:"Received"}).eq("id",l);if(n)throw console.error("Error updating purchase order status:",n),new Error(`Failed to update purchase order status: ${n.message}`);console.log("Purchase order received successfully")}catch(r){throw console.error("Error receiving purchase order:",r),r}}const wn=({open:l,onClose:t,poId:r,orderNumber:n,items:s,onConfirm:d})=>{const[a,o]=u.useState([]),[x,m]=u.useState(!0),[v,f]=u.useState(!1);u.useEffect(()=>{l&&(m(!0),o(s.map(g=>({id:g.id,product_id:g.product_id,ProductName:g.ProductName,quantity_ordered:g.quantity_ordered??0,quantity_received:g.quantity_received??g.quantity_ordered??0}))),m(!1))},[s,l]);const b=(g,w)=>{let y=0;if(w==="")y=0;else if(/^\d+$/.test(w))y=parseInt(w,10);else return;o(R=>R.map(S=>S.id===g?{...S,quantity_received:y}:S))},C=async()=>{try{const g=a.map(({product_id:w,quantity_received:y})=>({product_id:String(w),quantity_received:y}));await vn(String(r),g),d(a.map(w=>({id:w.id,quantity_received:w.quantity_received}))),f(!0),t()}catch(g){console.error("Error receiving purchase order:",g),alert("Failed to receive purchase order. Please try again.")}};return e.jsxs(e.Fragment,{children:[e.jsx(Ne,{open:l,onClose:t,"aria-labelledby":"receive-po-dialog-title",children:e.jsxs($e,{sx:{minWidth:400},children:[e.jsx(Fe,{}),e.jsxs(c,{id:"receive-po-dialog-title",level:"h4",sx:{mb:2},children:["Receive Purchase Order #",n??r]}),x?e.jsx(c,{children:"Loading items..."}):a.length===0?e.jsx(c,{children:"No items found for this purchase order."}):e.jsxs(Ue,{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Product"}),e.jsx("th",{children:"Ordered"}),e.jsx("th",{children:"Received"}),e.jsx("th",{children:"Status"})]})}),e.jsx("tbody",{children:a.map(g=>e.jsxs("tr",{children:[e.jsx("td",{children:g.ProductName}),e.jsx("td",{children:g.quantity_ordered}),e.jsx("td",{children:e.jsx($,{type:"number",value:g.quantity_received===0&&a.find(w=>w.id===g.id)?.quantity_received===0?"0":g.quantity_received,onChange:w=>b(g.id,w.target.value),sx:{width:80},slotProps:{input:{min:0,max:g.quantity_ordered}}})}),e.jsx("td",{style:{textAlign:"center"},children:g.quantity_received===g.quantity_ordered?e.jsx(Gt,{sx:{color:"#2e7d32"},titleAccess:"Received in full"}):e.jsx(Rr,{sx:{color:"#d32f2f"},titleAccess:"Not fully received"})})]},g.id))})]}),e.jsxs(i,{sx:{display:"flex",justifyContent:"flex-end",gap:2,mt:3},children:[e.jsx(q,{variant:"plain",onClick:t,children:"Cancel"}),e.jsx(q,{variant:"solid",onClick:C,children:"Receive"})]})]})}),e.jsx(Ht,{open:v,autoHideDuration:3e3,onClose:()=>f(!1),color:"success",variant:"soft",anchorOrigin:{vertical:"top",horizontal:"center"},children:"Purchase order received successfully!"})]})};function Sn({open:l,onClose:t,order:r,onConfirm:n}){const[s,d]=u.useState(null),[a,o]=u.useState(!1),[x,m]=u.useState(!1),[v,f]=u.useState(null),[b,C]=u.useState(!1),[g,w]=u.useState(""),[y,R]=u.useState("");u.useEffect(()=>{l&&r?.supplier_id&&S()},[l,r]);const S=async()=>{if(r?.supplier_id){o(!0),f(null);try{const{data:I,error:U}=await T.from("Suppliers").select("*").eq("id",r.supplier_id).single();if(U)throw U;d(I);const{data:{user:j}}=await T.auth.getUser();j?.email&&R(j.email)}catch(I){console.error("Error fetching data:",I),f(I.message||"Failed to fetch supplier information")}finally{o(!1)}}},p=async()=>{if(!(!r||!s)){m(!0),f(null);try{const{error:I}=await T.from("PurchaseOrders").update({status:"Ordered"}).eq("id",r.id);if(I)throw I;console.log("Purchase order would be emailed to:",{to:s.email,cc:k(),subject:`Purchase Order ${r.order_number}`,orderDetails:r}),n(),t()}catch(I){console.error("Error submitting order:",I),f(I.message||"Failed to submit purchase order")}finally{m(!1)}}},k=()=>{const I=[];if(b&&y&&I.push(y),g.trim()){const U=g.split(",").map(j=>j.trim()).filter(j=>j.length>0);I.push(...U)}return I},H=()=>{C(!1),w(""),d(null),f(null),t()};return r?e.jsx(Ne,{open:l,onClose:H,children:e.jsxs($e,{size:"md",sx:{maxWidth:600,width:"100%"},children:[e.jsx(Fe,{}),e.jsx(c,{level:"h3",sx:{mb:2},children:"Submit Purchase Order"}),a?e.jsx(i,{sx:{p:3,textAlign:"center"},children:e.jsx(c,{children:"Loading supplier information..."})}):e.jsxs(X,{spacing:3,children:[e.jsxs(it,{startDecorator:e.jsx(_l,{}),variant:"soft",color:"warning",children:[e.jsx(c,{level:"title-sm",children:"Email Submission"}),e.jsx(c,{level:"body-sm",children:"This will submit the purchase order via email to the supplier. Make sure all order details are correct before proceeding."})]}),s&&e.jsxs(me,{variant:"soft",children:[e.jsx(c,{level:"title-md",sx:{mb:2},children:"Supplier Information"}),e.jsxs(X,{spacing:2,children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(Dl,{sx:{color:"text.tertiary"}}),e.jsxs(i,{children:[e.jsx(c,{level:"body-sm",color:"neutral",children:"Company"}),e.jsx(c,{level:"title-sm",children:s.name})]})]}),s.contact_name&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(at,{sx:{color:"text.tertiary"}}),e.jsxs(i,{children:[e.jsx(c,{level:"body-sm",color:"neutral",children:"Contact Person"}),e.jsx(c,{level:"title-sm",children:s.contact_name})]})]}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(Ke,{sx:{color:"text.tertiary"}}),e.jsxs(i,{children:[e.jsx(c,{level:"body-sm",color:"neutral",children:"Email"}),e.jsx(c,{level:"title-sm",color:s.email?void 0:"danger",children:s.email||"No email address on file"})]})]}),s.phone&&e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(ct,{sx:{color:"text.tertiary"}}),e.jsxs(i,{children:[e.jsx(c,{level:"body-sm",color:"neutral",children:"Phone"}),e.jsx(c,{level:"title-sm",children:s.phone})]})]})]})]}),e.jsx(Ae,{}),e.jsxs(i,{children:[e.jsx(c,{level:"title-md",sx:{mb:2},children:"Order Details"}),e.jsxs(X,{spacing:1,children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(c,{level:"body-sm",color:"neutral",children:"Order Number:"}),e.jsx(c,{level:"body-sm",children:r.order_number})]}),e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(c,{level:"body-sm",color:"neutral",children:"Order Date:"}),e.jsx(c,{level:"body-sm",children:new Date(r.order_date).toLocaleDateString()})]}),e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(c,{level:"body-sm",color:"neutral",children:"Total:"}),e.jsx(c,{level:"body-sm",sx:{fontWeight:"bold"},children:be(r.total)})]})]})]}),e.jsx(Ae,{}),e.jsxs(i,{children:[e.jsx(c,{level:"title-md",sx:{mb:2},children:"Email Options"}),e.jsxs(X,{spacing:2,children:[y&&e.jsx(bt,{checked:b,onChange:I=>C(I.target.checked),label:`CC me (${y})`}),e.jsxs(te,{children:[e.jsx(ee,{children:"Additional CC Recipients"}),e.jsx($,{placeholder:"email1@example.com, email2@example.com",value:g,onChange:I=>w(I.target.value),sx:{width:"100%"}}),e.jsx(c,{level:"body-xs",color:"neutral",sx:{mt:.5},children:"Separate multiple email addresses with commas"})]})]})]}),v&&e.jsx(it,{variant:"soft",color:"danger",children:e.jsx(c,{level:"body-sm",children:v})}),e.jsxs(i,{sx:{display:"flex",gap:2,justifyContent:"flex-end"},children:[e.jsx(q,{variant:"plain",onClick:H,disabled:x,children:"Cancel"}),e.jsx(q,{variant:"solid",color:"primary",onClick:p,loading:x,disabled:x||!s?.email,startDecorator:e.jsx(Ke,{}),children:"Submit Order"})]})]})]})}):null}const pr={Pending:0,Ordered:1,Approved:2,Received:3,Cancelled:4},Xe={fontSize:re.sizes.small},lt={...Xe,fontWeight:600,borderBottom:"1.5px solid #e0e0e0",background:"inherit"},Pt=l=>{switch(l){case"Pending":return"warning";case"Ordered":return"primary";case"Approved":return"primary";case"Received":return"success";case"Cancelled":return"danger";default:return"neutral"}},Cn=l=>{switch(l){case"Pending":return e.jsx(Ys,{});case"Ordered":return e.jsx(yt,{});case"Approved":return e.jsx(yt,{});case"Received":return e.jsx(Gt,{});case"Cancelled":return e.jsx(Rr,{});default:return e.jsx(Ys,{})}},kn=()=>{const{isMobile:l}=Ie(),[t,r]=u.useState([]),[n,s]=u.useState(!1),[d,a]=u.useState(null),[o,x]=u.useState(""),[m,v]=u.useState(""),[f,b]=u.useState(!1),[C,g]=u.useState(!1),[w,y]=u.useState(!1),[R,S]=u.useState(!1),[p,k]=u.useState(null),[H,I]=u.useState([]),[U,j]=u.useState(!1),[A,N]=u.useState(null),[W,G]=u.useState(!1),h=async()=>{s(!0),a(null);try{const{data:L,error:Y}=await T.from("PurchaseOrders").select(`
          id, 
          order_number, 
          order_date, 
          status, 
          total, 
          notes,
          supplier_id,
          Suppliers(name)
        `).order("order_date",{ascending:!1});if(Y)throw Y;if(L){const we=L.map(de=>({...de,supplier_name:de.Suppliers?.name||"N/A",Suppliers:void 0}));r(we)}}catch(L){a(L.message||"Failed to fetch purchase orders")}finally{s(!1)}},E=async L=>{try{const{data:Y,error:we}=await T.from("purchaseorderitems").select("id, product_id, Products(ProductName), quantity_ordered, quantity_received").eq("purchase_order_id",L);if(we)throw we;if(Y){const de=Y.map(Oe=>({...Oe,ProductName:Oe.Products?.ProductName||"Unknown Product"}));I(de)}}catch(Y){console.error("Error fetching PO items:",Y)}},B=async()=>{await h()},O=async(L,Y)=>{{const we=t.find(de=>de.id===L);we&&(k(we),G(!0))}},D=async()=>{await h()},M=async L=>{k(L),await E(L.id),y(!0)},se=async L=>{try{y(!1),k(null),await h()}catch(Y){a(Y.message||"Failed to receive order")}},ue=async L=>{if(L)try{const{data:Y,error:we}=await T.from("Suppliers").select("*").eq("id",L).single();if(we)throw we;Y&&(N(Y),j(!0))}catch(Y){console.error("Error fetching supplier:",Y),a(Y.message||"Failed to fetch supplier details")}},le=L=>{k(L),L.status==="Pending"?g(!0):S(!0)},oe=[...t.filter(L=>{const Y=L.order_number?.toString().toLowerCase().includes(o.toLowerCase())||L.supplier_name?.toLowerCase().includes(o.toLowerCase()),we=m?L.status===m:!0;return Y&&we})].sort((L,Y)=>{const we=pr[L.status]??99,de=pr[Y.status]??99;return we!==de?we-de:new Date(Y.order_date).getTime()-new Date(L.order_date).getTime()});u.useEffect(()=>{h()},[]);const Q=()=>e.jsxs(i,{sx:{width:"100%",minHeight:"100vh"},children:[e.jsxs(ke,{padding:"medium",children:[e.jsx(c,{level:"h2",sx:{mb:2,fontSize:re.sizes.xlarge},children:"Purchase Orders"}),e.jsxs(i,{sx:{display:"flex",gap:1,mb:2},children:[e.jsx($,{placeholder:"Search orders...",value:o,onChange:L=>x(L.target.value),startDecorator:e.jsx(Se,{}),sx:{flex:1}}),e.jsxs(ye,{placeholder:"Status",value:m,onChange:(L,Y)=>v(Y??""),sx:{minWidth:120},children:[e.jsx(F,{value:"",children:"All"}),e.jsx(F,{value:"Pending",children:"Pending"}),e.jsx(F,{value:"Ordered",children:"Ordered"}),e.jsx(F,{value:"Approved",children:"Approved"}),e.jsx(F,{value:"Received",children:"Received"}),e.jsx(F,{value:"Cancelled",children:"Cancelled"})]})]}),e.jsx(q,{variant:"solid",startDecorator:e.jsx(ve,{}),onClick:()=>b(!0),sx:{width:"100%",mb:2},children:"Add Purchase Order"})]}),n&&e.jsx(De,{}),d&&e.jsx(i,{sx:{p:2},children:e.jsxs(c,{color:"danger",children:["Error: ",d]})}),e.jsx(i,{children:oe.length===0?e.jsx(i,{sx:{textAlign:"center",py:6},children:e.jsx(c,{color:"neutral",children:"No purchase orders found"})}):oe.map(L=>e.jsx(i,{sx:{p:2,borderBottom:"1px solid",borderColor:"divider","&:hover":{bgcolor:"background.level1"}},onClick:()=>le(L),title:L.status==="Pending"?"Tap to edit (pending orders are editable)":"Tap to view details",children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(i,{sx:{width:32,height:32,borderRadius:"50%",bgcolor:`${Pt(L.status)}.100`,color:`${Pt(L.status)}.600`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"18px",flexShrink:0},children:Cn(L.status)}),e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:.5},children:[e.jsx(c,{level:"title-sm",sx:{fontWeight:"bold",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"60%"},children:L.order_number?`Order #${L.order_number}`:e.jsx(c,{component:"span",sx:{color:"neutral.400",fontStyle:"italic"},children:"No order number"})}),e.jsx(ae,{size:"sm",color:Pt(L.status),variant:"soft",sx:{fontWeight:"bold",minWidth:"fit-content"},children:L.status})]}),e.jsxs(c,{level:"body-xs",color:"neutral",sx:{mb:.5},children:[e.jsx(c,{component:"span",sx:{cursor:L.supplier_id?"pointer":"default",color:L.supplier_id?"primary.600":"inherit",textDecoration:L.supplier_id?"underline":"none","&:hover":L.supplier_id?{color:"primary.800"}:{}},onClick:Y=>{L.supplier_id&&(Y.stopPropagation(),ue(L.supplier_id))},children:L.supplier_name})," â€¢ ",new Date(L.order_date).toLocaleDateString()]}),e.jsxs(c,{level:"body-sm",sx:{fontWeight:"bold",color:"text.primary"},children:["Total: ",be(L.total||0)]}),e.jsx(i,{sx:{display:"flex",gap:1,mt:1},children:L.status==="Pending"?e.jsx(q,{size:"sm",variant:"outlined",onClick:Y=>{Y.stopPropagation(),O(L.id)},children:"Order"}):e.jsx(q,{size:"sm",variant:"outlined",onClick:Y=>{Y.stopPropagation(),M(L)},disabled:L.status!=="Approved"&&L.status!=="Ordered",children:"Receive"})})]})]})},L.id))})]}),ce=()=>e.jsxs(ke,{variant:"table-page",children:[e.jsx(c,{level:"h2",sx:{mb:2,fontSize:re.sizes.xlarge},children:"Purchase Orders"}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx($,{placeholder:"Search purchase orders...",sx:{flex:1},value:o,onChange:L=>x(L.target.value),startDecorator:e.jsx(Se,{})}),e.jsxs(ye,{placeholder:"Filter status",value:m,onChange:(L,Y)=>v(Y??""),sx:{minWidth:160},children:[e.jsx(F,{value:"",children:"All Statuses"}),e.jsx(F,{value:"Pending",children:"Pending"}),e.jsx(F,{value:"Ordered",children:"Ordered"}),e.jsx(F,{value:"Approved",children:"Approved"}),e.jsx(F,{value:"Received",children:"Received"}),e.jsx(F,{value:"Cancelled",children:"Cancelled"})]}),e.jsx(q,{onClick:()=>b(!0),variant:"solid",startDecorator:e.jsx(ve,{}),children:"Add Purchase Order"})]}),e.jsxs(me,{sx:{overflow:"visible"},children:[n&&e.jsx(De,{}),d&&e.jsxs(c,{color:"danger",children:["Error: ",d]}),e.jsxs(Ue,{"aria-label":"Purchase Orders",sx:{tableLayout:"auto"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:lt,children:"Order Number"}),e.jsx("th",{style:lt,children:"Order Date"}),e.jsx("th",{style:lt,children:"Status"}),e.jsx("th",{style:lt,children:"Total"}),e.jsx("th",{style:lt,children:"Supplier"}),e.jsx("th",{style:lt,children:"Notes"}),e.jsx("th",{style:{width:120,...lt},children:"Actions"})]})}),e.jsxs("tbody",{children:[oe.length===0&&!n&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,style:{textAlign:"center",color:"#888",...Xe},children:"No purchase orders found."})}),oe.map(L=>e.jsxs("tr",{style:{cursor:"pointer",height:48},onClick:()=>le(L),title:L.status==="Pending"?"Click to edit (pending orders are editable)":"Click to view details",children:[e.jsx("td",{style:Xe,children:L.order_number||e.jsx(c,{component:"span",sx:{color:"neutral.400",fontStyle:"italic"},children:"No order number"})}),e.jsx("td",{style:Xe,children:new Date(L.order_date).toLocaleDateString()}),e.jsx("td",{style:Xe,children:e.jsx(ae,{size:"sm",color:Pt(L.status),variant:"soft",children:L.status})}),e.jsx("td",{style:Xe,children:be(L.total||0)}),e.jsx("td",{style:Xe,children:e.jsx(c,{component:"span",sx:{cursor:L.supplier_id?"pointer":"default",color:L.supplier_id?"primary.600":"inherit",textDecoration:L.supplier_id?"underline":"none",fontSize:re.sizes.small,"&:hover":L.supplier_id?{color:"primary.800"}:{}},onClick:Y=>{L.supplier_id&&(Y.stopPropagation(),ue(L.supplier_id))},children:L.supplier_name})}),e.jsx("td",{style:Xe,children:L.notes||"-"}),e.jsx("td",{children:L.status==="Pending"?e.jsx(q,{size:"sm",variant:"outlined",onClick:Y=>{Y.stopPropagation(),O(L.id)},children:"Order"}):e.jsx(q,{size:"sm",variant:"outlined",onClick:Y=>{Y.stopPropagation(),M(L)},disabled:L.status!=="Approved"&&L.status!=="Ordered",children:"Receive"})})]},L.id))]})]})]})]});return e.jsxs(qe,{children:[l?e.jsx(Q,{}):e.jsx(ce,{}),e.jsx(Rt,{open:f,onClose:()=>b(!1),onCreated:B,mode:"add",order:void 0}),e.jsx(Rt,{open:C,onClose:()=>{g(!1),k(null)},onCreated:B,mode:"edit",order:p?{id:p.id,order_number:p.order_number,order_date:p.order_date,status:p.status,total:p.total,notes:p.notes||"",supplier_id:p.supplier_id||""}:void 0}),e.jsx(Rt,{open:R,onClose:()=>{S(!1),k(null)},onCreated:()=>{},mode:"view",order:p?{id:p.id,order_number:p.order_number,order_date:p.order_date,status:p.status,total:p.total,notes:p.notes||"",supplier_id:p.supplier_id||""}:void 0}),e.jsx(wn,{open:w&&!!p?.id,onClose:()=>{y(!1),k(null)},poId:p?.id||"",orderNumber:p?.order_number||"",items:H.filter(L=>!!L.id&&!!L.product_id),onConfirm:se}),e.jsx(Is,{open:U,onClose:()=>{j(!1),N(null)},supplier:A,onSaved:()=>{},mode:"view",onEdit:()=>{}}),e.jsx(Sn,{open:W,onClose:()=>{G(!1),k(null)},order:p?{id:p.id,order_number:p.order_number,supplier_id:p.supplier_id||"",order_date:p.order_date,total:p.total||0}:null,onConfirm:D})]})};function _n({value:l,onChange:t,toggleSidebar:r}){const n=ks(),[s,d]=u.useState(!1),[a,o]=u.useState("Sales");if(n.pathname==="/login")return null;const x=u.useMemo(()=>rl({components:{MuiTableRow:{styleOverrides:{root:{"&:hover":{backgroundColor:"rgba(0, 0, 0, 0.04)"}}}}}}),[]);Gl.filter(f=>f.showInMobile);const m=a?Et[a].filter(f=>f.showInMobile):[],v=async f=>{const{data:b}=await T.auth.getSession();if(!b&&["orders","products","users","suppliers","purchaseorders","tickets","smscampaigns","movements"].includes(f)){console.warn("Authentication required for this page"),t("home");return}t(f)};return e.jsxs(ll,{theme:x,children:[e.jsxs(nl,{open:s,onClose:()=>d(!1),children:[e.jsx(il,{children:"Select Area"}),e.jsx(al,{children:["Sales","Support","Marketing","Operations"].map(f=>e.jsx(Ws,{fullWidth:!0,variant:a===f?"contained":"outlined",onClick:()=>{o(f),d(!1)},sx:{my:1},children:f},f))}),e.jsx(ol,{children:e.jsx(Ws,{onClick:()=>d(!1),children:"Close"})})]}),e.jsx(cl,{sx:{position:"fixed",bottom:0,left:0,right:0,zIndex:9999,backgroundColor:"rgba(0, 0, 255, 0.2)",overflow:"hidden"},children:e.jsx("div",{style:{display:"flex",flexDirection:"row",overflowX:"auto"},children:e.jsxs(dl,{showLabels:!0,value:l,onChange:(f,b)=>{v(b)},sx:{minWidth:"max-content",flex:1},children:[m.map(f=>e.jsx(qs,{label:f.label,icon:f.icon,value:f.value,onClick:()=>v(f.value)},f.value)),e.jsx(qs,{label:a||"",icon:e.jsx(Il,{}),onClick:f=>{f.stopPropagation(),d(!0)}})]})})})]})}function ss({open:l,onClose:t,onCreated:r}){const[n,s]=u.useState(""),[d,a]=u.useState(""),[o,x]=u.useState(!1),[m,v]=u.useState(null),f=async b=>{b.preventDefault(),x(!0),v(null);const C={subject:n,requester_name:d,status:"Open"};console.log("[ActionDialogTicketCreate] Creating ticket with payload:",C);const{error:g,data:w}=await T.from("tickets").insert(C);g&&(v(g.message||JSON.stringify(g)),console.error("[ActionDialogTicketCreate] Error creating ticket:",g)),x(!1),g||(s(""),a(""),t(),r&&r())};return e.jsx(Ne,{open:l,onClose:t,children:e.jsxs($e,{sx:{minWidth:400},children:[e.jsx(c,{level:"title-md",sx:{mb:2},children:"Create Ticket"}),e.jsxs("form",{onSubmit:f,children:[e.jsx($,{placeholder:"Subject",value:n,onChange:b=>s(b.target.value),sx:{mb:2},required:!0}),e.jsx($,{placeholder:"Requester Name",value:d,onChange:b=>a(b.target.value),sx:{mb:2},required:!0}),m&&e.jsx(c,{color:"danger",sx:{mb:1},children:m}),e.jsx(q,{type:"submit",loading:o,disabled:o||!n||!d,variant:"solid",children:"Create"})]})]})})}const Dn=["Refund issued","Replacement sent","Order cancelled","Technical support provided","Information provided","Awaiting customer response","Other"],In=({open:l,onClose:t,onSubmit:r})=>{const[n,s]=ie.useState(""),[d,a]=ie.useState("");return ie.useEffect(()=>{l||(s(""),a(""))},[l]),e.jsx(Ne,{open:l,onClose:t,children:e.jsxs($e,{children:[e.jsx(wt,{children:"Resolve Ticket"}),e.jsxs(St,{sx:{display:"flex",flexDirection:"column",gap:2,minWidth:320},children:[e.jsx(ye,{value:n,onChange:(o,x)=>s(x||""),placeholder:"Select resolution",required:!0,children:Dn.map(o=>e.jsx(F,{value:o,children:o},o))}),e.jsx($t,{minRows:3,placeholder:"Resolution comment to customer...",value:d,onChange:o=>a(o.target.value)})]}),e.jsxs(Ct,{children:[e.jsx(q,{variant:"plain",onClick:t,children:"Cancel"}),e.jsx(q,{variant:"solid",color:"primary",disabled:!n,onClick:()=>{try{r(n,d),t()}catch(o){console.error("Error during form submission:",o)}},children:"Submit"})]})]})})},rs=Ds(In),mr=l=>{if(!l)return"";const t=new Date(l),n=Math.floor((new Date().getTime()-t.getTime())/1e3);if(n<60)return"Just now";const s=Math.floor(n/60);if(s<60)return`${s} min ago`;const d=Math.floor(s/60);if(d<24)return`${d} hour${d>1?"s":""} ago`;const a=Math.floor(d/24);if(a<7)return`${a} day${a>1?"s":""} ago`;const o=Math.floor(a/7);if(o<4)return`${o} week${o>1?"s":""} ago`;const x=Math.floor(a/30);return`${x} month${x>1?"s":""} ago`},pt={Open:{color:"success",label:"Open"},Pending:{color:"warning",label:"Pending"},Closed:{color:"neutral",label:"Closed"}};function Pn(){const{isMobile:l}=Ie(),[t,r]=u.useState([]),[n,s]=u.useState(null),[d,a]=u.useState([]),[o,x]=u.useState(""),[m,v]=u.useState(""),[f,b]=u.useState("Open"),[C,g]=u.useState(!1),[w,y]=u.useState(!1),[R,S]=u.useState(!1);u.useEffect(()=>{(async()=>{const{data:N,error:W}=await T.from("tickets").select("*").order("created_at",{ascending:!1});W||r(N||[])})()},[]),u.useEffect(()=>{if(!n){a([]);return}(async()=>{const{data:N,error:W}=await T.from("ticketactivities").select("*").eq("ticket_id",n).order("timestamp",{ascending:!0});W||a(N||[])})()},[n]);const p=async()=>{const{data:A,error:N}=await T.from("tickets").select("*").order("created_at",{ascending:!1});N||r(A||[])},k=async()=>{if(o.trim()&&n){console.log("Sending message:",{ticket_id:n,message:o,activity_type:"chat",sender_name:"You"});const{error:A,data:N}=await T.from("ticketactivities").insert({ticket_id:n,message:o,activity_type:"chat",sender_name:"You"}).select();if(A){console.error("Error sending message:",A),alert("Failed to send message: "+A.message);return}console.log("Message sent successfully:",N),x("");const{data:W,error:G}=await T.from("ticketactivities").select("*").eq("ticket_id",n).order("timestamp",{ascending:!0});G?console.error("Error fetching activities:",G):(console.log("Refreshed activities:",W),a(W||[]))}},H=async(A,N)=>{if(n)try{const{error:W}=await T.from("tickets").update({status:"Closed"}).eq("id",n);if(W){console.error("Error updating ticket status:",W),alert("Failed to resolve ticket: "+W.message);return}const{error:G}=await T.from("ticketactivities").insert({ticket_id:n,message:`Ticket resolved: ${A}${N?` - ${N}`:""}`,activity_type:"chat",sender_name:"You"});G&&console.error("Error adding resolution activity:",G),await p();const{data:h}=await T.from("ticketactivities").select("*").eq("ticket_id",n).order("timestamp",{ascending:!0});a(h||[])}catch(W){console.error("Error resolving ticket:",W),alert("Failed to resolve ticket")}},I=A=>{s(A),S(!0)},U=()=>{S(!1),s(null)},j=t.filter(A=>{if(f!=="All"&&A.status!==f)return!1;if(!m)return!0;const N=m.toLowerCase();return A.subject?.toLowerCase().includes(N)||A.requester_name?.toLowerCase().includes(N)||A.status?.toLowerCase().includes(N)});if(l){const A=t.length>0&&t.every(N=>N.status==="Closed")&&f==="Open";if(R&&n){const N=t.find(W=>W.id===n);return e.jsxs(qe,{children:[e.jsxs(i,{sx:{display:"flex",flexDirection:"column",height:"100vh"},children:[e.jsxs(i,{sx:{px:2,py:1.5,borderBottom:"1px solid",borderColor:"divider",display:"flex",alignItems:"center",gap:2,bgcolor:"background.surface"},children:[e.jsx(xe,{size:"sm",variant:"plain",onClick:U,children:e.jsx(Pl,{})}),e.jsx(he,{size:"sm",sx:{bgcolor:"primary.100",color:"primary.700",fontWeight:600},children:N?.requester_name?.[0]?.toUpperCase()||"?"}),e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsx(c,{level:"title-sm",sx:{fontWeight:600,mb:.5},children:N?.subject||"Untitled"}),e.jsx(c,{level:"body-xs",color:"neutral",children:N?.requester_name})]}),e.jsx(ae,{variant:"soft",size:"sm",color:pt[N?.status||"Open"]?.color,sx:{fontWeight:600},children:pt[N?.status||"Open"]?.label}),N?.status!=="Closed"&&e.jsx(q,{variant:"solid",color:"primary",size:"sm",onClick:()=>y(!0),children:"Resolve"})]}),e.jsx(i,{sx:{flex:1,overflowY:"auto",px:2,py:2},children:e.jsx(X,{spacing:3,children:d.map((W,G)=>{const h=W.sender_name==="You";return e.jsxs(i,{children:[G===0||new Date(W.timestamp||"").toDateString()!==new Date(d[G-1]?.timestamp||"").toDateString()?e.jsxs(i,{sx:{display:"flex",alignItems:"center",mb:2},children:[e.jsx(i,{sx:{flex:1,height:"1px",bgcolor:"divider"}}),e.jsx(c,{level:"body-xs",sx:{mx:2,color:"text.secondary"},children:W.timestamp?new Date(W.timestamp).toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"}):""}),e.jsx(i,{sx:{flex:1,height:"1px",bgcolor:"divider"}})]}):null,e.jsxs(X,{direction:"row",spacing:1,sx:{alignItems:"flex-start"},children:[!h&&e.jsx(he,{size:"sm",sx:{bgcolor:"primary.100",color:"primary.700",fontWeight:600},children:W.sender_name?.[0]?.toUpperCase()||"?"}),e.jsx(i,{sx:{flex:1,display:"flex",flexDirection:h?"row-reverse":"row"},children:e.jsxs(i,{sx:{maxWidth:"85%",bgcolor:h?"primary.500":"neutral.50",color:h?"white":"text.primary",borderRadius:h?"18px 18px 4px 18px":"18px 18px 18px 4px",px:2,py:1.5,position:"relative",boxShadow:"sm"},children:[!h&&e.jsx(c,{level:"body-xs",sx:{fontWeight:600,mb:.5,color:h?"white":"text.primary"},children:W.sender_name}),e.jsx(c,{level:"body-sm",sx:{lineHeight:1.4,color:h?"white":"text.primary"},children:W.message})]})}),h&&e.jsx(he,{size:"sm",sx:{bgcolor:"primary.100",color:"primary.700",fontWeight:600},children:W.sender_name?.[0]?.toUpperCase()||"?"})]}),e.jsx(i,{sx:{display:"flex",justifyContent:h?"flex-end":"flex-start",mt:.5,ml:h?0:5},children:e.jsx(c,{level:"body-xs",sx:{color:"text.tertiary"},children:W.timestamp?new Date(W.timestamp).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0}):""})})]},W.id)})})}),e.jsx(i,{sx:{px:2,py:1.5,borderTop:"1px solid",borderColor:"divider",bgcolor:"background.surface"},children:e.jsxs(X,{direction:"row",spacing:1,alignItems:"flex-end",children:[e.jsx(i,{sx:{flex:1},children:e.jsx($t,{placeholder:"Type something here...",value:o,onChange:W=>x(W.target.value),minRows:1,maxRows:3,sx:{borderRadius:"20px",border:"1px solid",borderColor:"neutral.300","&:focus-within":{borderColor:"primary.500"},"& textarea":{border:"none",outline:"none",resize:"none",px:2,py:1}},onKeyDown:W=>{W.key==="Enter"&&!W.shiftKey&&(W.preventDefault(),k())}})}),e.jsx(q,{onClick:k,disabled:!o.trim(),variant:"solid",color:"primary",size:"sm",sx:{borderRadius:"20px",minWidth:50,height:36,fontWeight:600},children:"Send"})]})})]}),e.jsx(ss,{open:C,onClose:()=>g(!1),onCreated:p}),e.jsx(rs,{open:w,onClose:()=>y(!1),onSubmit:H})]})}return e.jsxs(qe,{children:[e.jsxs(i,{sx:{p:2},children:[e.jsx(c,{level:"h2",sx:{mb:3,fontWeight:600},children:"Tickets"}),e.jsxs(X,{spacing:2,sx:{mb:2},children:[e.jsxs(X,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx($,{placeholder:"Search tickets...",startDecorator:e.jsx(Se,{}),value:m,onChange:N=>v(N.target.value),size:"sm",sx:{flex:1}}),e.jsx(xe,{size:"sm",variant:"soft",color:"primary",onClick:()=>g(!0),children:e.jsx(ve,{})})]}),e.jsxs(ye,{value:f,onChange:(N,W)=>b(W),size:"sm",placeholder:"Filter by status",children:[e.jsx(F,{value:"All",children:"All Tickets"}),e.jsx(F,{value:"Open",children:"Open"}),e.jsx(F,{value:"Pending",children:"Pending"}),e.jsx(F,{value:"Closed",children:"Closed"})]})]}),A?e.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"60vh",gap:2},children:[e.jsx(zl,{sx:{fontSize:80,color:"primary.500"}}),e.jsx(c,{level:"h3",sx:{fontWeight:700,textAlign:"center"},children:"All done, you can now go to the beach"})]}):e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:0},children:[j.map((N,W)=>e.jsxs(u.Fragment,{children:[e.jsxs(i,{sx:{p:2,display:"flex",alignItems:"flex-start",gap:2,cursor:"pointer",background:"transparent",borderRadius:1,transition:"all 0.2s","&:hover":{bgcolor:"neutral.50"}},onClick:()=>I(N.id),children:[e.jsx(he,{size:"sm",sx:{bgcolor:"primary.100",color:"primary.700",fontWeight:600,mt:.5},children:N.requester_name?.[0]?.toUpperCase()||"?"}),e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsx(c,{level:"title-sm",sx:{fontWeight:600,mb:.5,wordBreak:"break-word"},children:N.subject||"Untitled"}),e.jsx(c,{level:"body-xs",color:"neutral",sx:{mb:.5,wordBreak:"break-word"},children:N.requester_name}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(c,{level:"body-xs",color:"neutral",children:mr(N.updated_at)}),e.jsx(c,{level:"body-xs",color:"neutral",children:"â€¢"}),e.jsxs(c,{level:"body-xs",color:"neutral",sx:{wordBreak:"break-all"},children:[N.id?.slice(0,8),"..."]})]})]}),e.jsx(ae,{variant:"soft",size:"sm",color:pt[N.status||"Open"]?.color,sx:{fontWeight:600,px:1.5,py:.5,ml:1},children:pt[N.status||"Open"]?.label})]}),W<j.length-1&&e.jsx(Ae,{sx:{my:.5}})]},N.id)),j.length===0&&e.jsx(c,{color:"neutral",sx:{textAlign:"center",mt:4},children:"No tickets found."})]})]}),e.jsx(ss,{open:C,onClose:()=>g(!1),onCreated:p}),e.jsx(rs,{open:w,onClose:()=>y(!1),onSubmit:H})]})}return e.jsxs(i,{sx:{display:"flex",flexDirection:"column",minHeight:"100vh"},children:[e.jsxs(i,{sx:{display:"flex",flex:1},children:[e.jsxs(i,{sx:{width:390,borderRight:"1px solid",borderColor:"divider",display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsxs(i,{sx:{px:2,py:1,borderBottom:"1px solid",borderColor:"divider",flexShrink:0},children:[e.jsxs(X,{direction:"row",justifyContent:"space-between",alignItems:"center",sx:{mb:2},children:[e.jsxs(X,{direction:"row",alignItems:"center",spacing:1,children:[e.jsx(c,{level:"title-lg",children:"Messages"}),e.jsx(ae,{size:"sm",variant:"soft",color:"neutral",children:j.length})]}),e.jsx(xe,{size:"sm",variant:"soft",color:"primary",onClick:()=>g(!0),children:e.jsx(ve,{})})]}),e.jsx($,{placeholder:"Search",startDecorator:e.jsx(Se,{}),value:m,onChange:A=>v(A.target.value),size:"sm",sx:{width:"100%",mb:1}}),e.jsxs(ye,{value:f,onChange:(A,N)=>b(N),size:"sm",sx:{width:"100%"},placeholder:"Filter by status",children:[e.jsx(F,{value:"All",children:"All Tickets"}),e.jsx(F,{value:"Open",children:"Open"}),e.jsx(F,{value:"Pending",children:"Pending"}),e.jsx(F,{value:"Closed",children:"Closed"})]})]}),e.jsx(i,{sx:{flex:1,overflowY:"auto",overflowX:"hidden",pt:1},children:e.jsx(is,{size:"sm",sx:{gap:0},children:j.map(A=>e.jsxs(u.Fragment,{children:[e.jsx(as,{sx:{p:0},children:e.jsx(ft,{selected:n===A.id,onClick:()=>s(A.id),sx:{py:1,px:2},children:e.jsxs(X,{direction:"row",spacing:1.5,alignItems:"flex-start",sx:{width:"100%"},children:[e.jsx(i,{sx:{position:"relative"},children:e.jsx(he,{size:"sm",sx:{bgcolor:"primary.100",color:"primary.700",fontWeight:600},children:A.requester_name?.[0]?.toUpperCase()||"?"})}),e.jsxs(i,{sx:{flex:1,minWidth:0,pr:1},children:[e.jsxs(X,{direction:"row",justifyContent:"space-between",alignItems:"flex-start",sx:{mb:.5},children:[e.jsx(c,{level:"body-md",noWrap:!0,sx:{flex:1,pr:1},children:A.subject||"Untitled"}),A.status&&e.jsx(ae,{size:"sm",color:pt[A.status]?.color,variant:"soft",sx:{flexShrink:0},children:A.status})]}),e.jsx(c,{level:"body-sm",sx:{display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden",textOverflow:"ellipsis",mb:.5},children:A.requester_name||""}),e.jsx(i,{sx:{display:"flex",justifyContent:"flex-end"},children:e.jsx(c,{level:"body-xs",sx:{color:"text.tertiary"},children:mr(A.updated_at)})})]})]})})}),e.jsx(ul,{component:"li",sx:{margin:0}})]},A.id))})})]}),e.jsxs(i,{sx:{flex:1,display:"flex",flexDirection:"column"},children:[n&&e.jsx(i,{sx:{px:3,py:2,borderBottom:"1px solid",borderColor:"divider",flexShrink:0},children:e.jsxs(X,{direction:"row",alignItems:"center",spacing:2,children:[e.jsx(he,{size:"sm",sx:{bgcolor:"primary.100",color:"primary.700",fontWeight:600},children:t.find(A=>A.id===n)?.requester_name?.[0]?.toUpperCase()||"?"}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(c,{level:"title-sm",sx:{fontWeight:600},children:t.find(A=>A.id===n)?.requester_name||"Unknown User"}),e.jsx(c,{level:"body-xs",sx:{color:"text.secondary"},children:t.find(A=>A.id===n)?.status||"Unknown Status"})]}),e.jsx(q,{variant:"outlined",size:"sm",sx:{borderRadius:"16px"},children:"View profile"}),t.find(A=>A.id===n)?.status!=="Closed"&&e.jsx(q,{variant:"solid",color:"primary",size:"sm",sx:{borderRadius:"16px"},onClick:()=>y(!0),children:"Resolve"})]})}),e.jsx(i,{sx:{flex:1,overflowY:"auto",px:3,py:2},children:n?e.jsx(X,{spacing:3,children:d.map((A,N)=>{const W=A.sender_name==="You";return e.jsxs(i,{children:[N===0||new Date(A.timestamp||"").toDateString()!==new Date(d[N-1]?.timestamp||"").toDateString()?e.jsxs(i,{sx:{display:"flex",alignItems:"center",mb:2},children:[e.jsx(i,{sx:{flex:1,height:"1px",bgcolor:"divider"}}),e.jsx(c,{level:"body-xs",sx:{mx:2,color:"text.secondary"},children:A.timestamp?new Date(A.timestamp).toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"}):""}),e.jsx(i,{sx:{flex:1,height:"1px",bgcolor:"divider"}})]}):null,e.jsxs(X,{direction:"row",spacing:1,sx:{alignItems:"flex-start"},children:[!W&&e.jsx(he,{size:"sm",sx:{bgcolor:"primary.100",color:"primary.700",fontWeight:600},children:A.sender_name?.[0]?.toUpperCase()||"?"}),e.jsx(i,{sx:{flex:1,display:"flex",flexDirection:W?"row-reverse":"row"},children:e.jsxs(i,{sx:{maxWidth:"70%",bgcolor:W?"primary.500":"neutral.50",color:W?"white":"text.primary",borderRadius:W?"18px 18px 4px 18px":"18px 18px 18px 4px",px:2,py:1.5,position:"relative",boxShadow:"sm"},children:[!W&&e.jsx(c,{level:"body-xs",sx:{fontWeight:600,mb:.5,color:W?"white":"text.primary"},children:A.sender_name}),e.jsx(c,{level:"body-sm",sx:{lineHeight:1.4,color:W?"white":"text.primary"},children:A.message})]})}),W&&e.jsx(he,{size:"sm",sx:{bgcolor:"primary.100",color:"primary.700",fontWeight:600},children:A.sender_name?.[0]?.toUpperCase()||"?"})]}),e.jsx(i,{sx:{display:"flex",justifyContent:W?"flex-end":"flex-start",mt:.5,ml:W?0:5},children:e.jsx(c,{level:"body-xs",sx:{color:"text.tertiary"},children:A.timestamp?new Date(A.timestamp).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0}):""})})]},A.id)})}):e.jsx(i,{sx:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%"},children:e.jsx(c,{level:"body-md",sx:{color:"text.secondary"},children:"Select a ticket to view messages"})})}),n&&e.jsx(i,{sx:{px:3,py:2,borderTop:"1px solid",borderColor:"divider",flexShrink:0},children:e.jsxs(X,{direction:"row",spacing:1,alignItems:"flex-end",children:[e.jsx(i,{sx:{flex:1},children:e.jsx($t,{placeholder:"Type something here...",value:o,onChange:A=>x(A.target.value),minRows:1,maxRows:4,sx:{borderRadius:"20px",border:"1px solid",borderColor:"neutral.300","&:focus-within":{borderColor:"primary.500"},"& textarea":{border:"none",outline:"none",resize:"none",px:2,py:1}},onKeyDown:A=>{A.key==="Enter"&&!A.shiftKey&&(A.preventDefault(),k())}})}),e.jsx(q,{onClick:k,disabled:!o.trim(),variant:"solid",color:"primary",sx:{borderRadius:"20px",minWidth:60,height:40,fontWeight:600},children:"Send"})]})})]})]}),e.jsx(ss,{open:C,onClose:()=>g(!1),onCreated:p}),e.jsx(rs,{open:w,onClose:()=>y(!1),onSubmit:H})]})}const gr={draft:0,scheduled:1,sent:2,failed:3},He={fontSize:re.sizes.small},nt={...He,fontWeight:600,borderBottom:"1.5px solid #e0e0e0",background:"inherit"},zt=l=>{switch(l){case"draft":return"neutral";case"scheduled":return"warning";case"sent":return"success";case"failed":return"danger";default:return"neutral"}},zn=l=>{switch(l){case"draft":return e.jsx(Rl,{});case"scheduled":return e.jsx(El,{});case"sent":return e.jsx(Gt,{});case"failed":return e.jsx(Ol,{});default:return e.jsx(Al,{})}},An=()=>{const{isMobile:l}=Ie(),[t,r]=u.useState([]),[n,s]=u.useState(!1),[d,a]=u.useState(null),[o,x]=u.useState(""),[m,v]=u.useState(""),[f,b]=u.useState(!1),C=async()=>{s(!0),a(null);try{const{data:S,error:p}=await T.from("sms_campaigns").select("*").order("created_at",{ascending:!1});if(p)throw p;S&&r(S)}catch(S){console.error("Error fetching campaigns:",S),a(S.message||"Failed to fetch campaigns")}finally{s(!1)}},w=[...t.filter(S=>{const p=S.name.toLowerCase().includes(o.toLowerCase())||S.CampaignNumber?.toLowerCase().includes(o.toLowerCase()),k=m?S.status===m:!0;return p&&k})].sort((S,p)=>{const k=gr[S.status]??99,H=gr[p.status]??99;return k!==H?k-H:new Date(p.created_at).getTime()-new Date(S.created_at).getTime()});u.useEffect(()=>{C()},[]);const y=()=>e.jsxs(i,{sx:{width:"100%",minHeight:"100vh"},children:[e.jsxs(ke,{padding:"medium",children:[e.jsx(c,{level:"h2",sx:{mb:2,fontSize:re.sizes.xlarge},children:"SMS Campaigns"}),e.jsxs(i,{sx:{display:"flex",gap:1,mb:2},children:[e.jsx($,{placeholder:"Search campaigns...",value:o,onChange:S=>x(S.target.value),startDecorator:e.jsx(Se,{}),sx:{flex:1}}),e.jsxs(ye,{placeholder:"Status",value:m,onChange:(S,p)=>v(p??""),sx:{minWidth:120},children:[e.jsx(F,{value:"",children:"All"}),e.jsx(F,{value:"draft",children:"Draft"}),e.jsx(F,{value:"scheduled",children:"Scheduled"}),e.jsx(F,{value:"sent",children:"Sent"}),e.jsx(F,{value:"failed",children:"Failed"})]})]}),e.jsx(q,{variant:"solid",startDecorator:e.jsx(ve,{}),onClick:()=>b(!0),sx:{width:"100%",mb:2},children:"Create Campaign"})]}),n&&e.jsx(De,{}),d&&e.jsx(i,{sx:{p:2},children:e.jsxs(c,{color:"danger",children:["Error: ",d]})}),e.jsx(i,{children:w.length===0?e.jsx(i,{sx:{textAlign:"center",py:6},children:e.jsx(c,{color:"neutral",children:"No SMS campaigns found"})}):w.map(S=>e.jsx(i,{sx:{p:2,borderBottom:"1px solid",borderColor:"divider","&:hover":{bgcolor:"background.level1"}},children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(i,{sx:{width:32,height:32,borderRadius:"50%",bgcolor:`${zt(S.status)}.100`,color:`${zt(S.status)}.600`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"18px",flexShrink:0},children:zn(S.status)}),e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:.5},children:[e.jsx(c,{level:"title-sm",sx:{fontWeight:"bold",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"60%"},children:S.name}),e.jsx(ae,{size:"sm",color:zt(S.status),variant:"soft",sx:{fontWeight:"bold",minWidth:"fit-content",textTransform:"capitalize"},children:S.status})]}),e.jsxs(c,{level:"body-xs",color:"neutral",sx:{mb:.5},children:["Campaign #",S.CampaignNumber," â€¢ ",new Date(S.created_at).toLocaleDateString()]}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:.5},children:[e.jsxs(c,{level:"body-xs",color:"neutral",children:["Recipients: ",S.recipients?.length??0]}),S.scheduled_at&&e.jsxs(c,{level:"body-xs",color:"neutral",children:["Scheduled: ",Jt(new Date(S.scheduled_at),"MMM dd, HH:mm")]})]}),S.message&&e.jsxs(c,{level:"body-xs",color:"neutral",sx:{fontStyle:"italic",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"100%"},children:['"',S.message,'"']})]})]})},S.id))})]}),R=()=>e.jsxs(ke,{variant:"table-page",children:[e.jsx(c,{level:"h2",sx:{mb:2,fontSize:re.sizes.xlarge},children:"SMS Campaigns"}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx($,{placeholder:"Search campaigns...",sx:{flex:1},value:o,onChange:S=>x(S.target.value),startDecorator:e.jsx(Se,{})}),e.jsxs(ye,{placeholder:"Filter status",value:m,onChange:(S,p)=>v(p??""),sx:{minWidth:160},children:[e.jsx(F,{value:"",children:"All Statuses"}),e.jsx(F,{value:"draft",children:"Draft"}),e.jsx(F,{value:"scheduled",children:"Scheduled"}),e.jsx(F,{value:"sent",children:"Sent"}),e.jsx(F,{value:"failed",children:"Failed"})]}),e.jsx(q,{onClick:()=>b(!0),variant:"solid",startDecorator:e.jsx(ve,{}),children:"Create Campaign"})]}),e.jsxs(me,{sx:{overflow:"visible"},children:[n&&e.jsx(De,{}),d&&e.jsxs(c,{color:"danger",children:["Error: ",d]}),e.jsxs(Ue,{"aria-label":"SMS Campaigns",sx:{tableLayout:"auto"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:nt,children:"Campaign #"}),e.jsx("th",{style:nt,children:"Name"}),e.jsx("th",{style:nt,children:"Status"}),e.jsx("th",{style:nt,children:"Scheduled"}),e.jsx("th",{style:nt,children:"Sent"}),e.jsx("th",{style:nt,children:"Recipients"}),e.jsx("th",{style:nt,children:"Message"})]})}),e.jsxs("tbody",{children:[w.length===0&&!n&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,style:{textAlign:"center",color:"#888",...He},children:"No campaigns found."})}),w.map(S=>e.jsxs("tr",{style:{cursor:"pointer",height:48},children:[e.jsx("td",{style:He,children:S.CampaignNumber}),e.jsx("td",{style:He,children:S.name}),e.jsx("td",{style:He,children:e.jsx(ae,{size:"sm",color:zt(S.status),variant:"soft",sx:{textTransform:"capitalize"},children:S.status})}),e.jsx("td",{style:He,children:S.scheduled_at?Jt(new Date(S.scheduled_at),"yyyy-MM-dd HH:mm"):"-"}),e.jsx("td",{style:He,children:S.sent_at?Jt(new Date(S.sent_at),"yyyy-MM-dd HH:mm"):"-"}),e.jsx("td",{style:He,children:S.recipients?.length??0}),e.jsx("td",{style:He,children:e.jsx(c,{level:"body-sm",sx:{maxWidth:200,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:S.message||"-"})})]},S.id))]})]})]})]});return e.jsxs(qe,{children:[l?e.jsx(y,{}):e.jsx(R,{}),e.jsx(Ne,{open:f,onClose:()=>b(!1),children:e.jsxs($e,{children:[e.jsx(Fe,{}),e.jsx(c,{level:"h4",children:"Create New Campaign"}),e.jsx(c,{level:"body-sm",sx:{mt:1,mb:2},children:"Campaign creation functionality will be implemented here."}),e.jsx(q,{onClick:()=>b(!1),variant:"outlined",children:"Close"})]})})]})};function ls(l,t){return t===0?l>0?100:0:(l-t)/t*100}function ns(l){return l==null?"â€”":`${l>0?"+":l<0?"âˆ’":""}${Math.abs(Math.round(l))}%`}async function On(){const l=new Date,t=l.toISOString().slice(0,10),r=new Date(l.getTime()-30*24*60*60*1e3).toISOString().slice(0,10),n=new Date(l.getTime()-60*24*60*60*1e3).toISOString().slice(0,10),s=new Date(l.getTime()-30*24*60*60*1e3-1).toISOString().slice(0,10),d=await T.from("Orders").select("order_total, customer_email, date",{count:"exact"}).not("order_total","is",null);if(d.error||!d.data)throw new Error("Failed to fetch order stats");const a=d.data,o=a.filter(w=>w.date&&w.date>=r&&w.date<=t),x=a.filter(w=>w.date&&w.date>=n&&w.date<=s),m=o.reduce((w,y)=>w+(typeof y.order_total=="number"?y.order_total:0),0),v=x.reduce((w,y)=>w+(typeof y.order_total=="number"?y.order_total:0),0),f=o.length,b=x.length,C=new Set(o.map(w=>w.customer_email).filter(Boolean)),g=new Set(x.map(w=>w.customer_email).filter(Boolean));return{totalSales:m,orderCount:f,customerCount:C.size,salesChange:ls(m,v),ordersChange:ls(f,b),customersChange:ls(C.size,g.size)}}const En=()=>{const[l,t]=u.useState(null),[r,n]=u.useState(null),[s,d]=u.useState(null),[a,o]=u.useState(null),[x,m]=u.useState(null),[v,f]=u.useState(null),[b,C]=u.useState(!0),[g,w]=u.useState(null);return Ot("(max-width:600px)"),u.useEffect(()=>{let y=!0,R=!0;async function S(){R&&C(!0),w(null);try{const{totalSales:k,orderCount:H,customerCount:I,salesChange:U,ordersChange:j,customersChange:A}=await On();y&&(t(k),n(H),d(I),o(U),m(j),f(A))}catch(k){y&&w(k.message)}finally{R&&C(!1),R=!1}}S();const p=setInterval(S,1e4);return()=>{y=!1,clearInterval(p)}},[]),e.jsxs(i,{sx:{p:{xs:2,md:3},pt:{xs:2,md:3},height:"100%",overflow:"auto"},children:[e.jsx(c,{level:"h2",sx:{mb:2},children:"Dashboard"}),e.jsxs(Ce,{container:!0,spacing:2,children:[e.jsx(Ce,{xs:12,md:4,children:e.jsxs(me,{variant:"outlined",children:[e.jsx(c,{level:"h4",children:"Total Sales"}),e.jsx(c,{level:"h2",color:"success",children:b?"Loading...":g?"â€”":be(l)}),e.jsxs(c,{level:"body-sm",color:"neutral",children:[b?"":ns(a)," from last 30 days"]})]})}),e.jsx(Ce,{xs:12,md:4,children:e.jsxs(me,{variant:"outlined",children:[e.jsx(c,{level:"h4",children:"Orders"}),e.jsx(c,{level:"h2",color:"primary",children:b?"Loading...":g?"â€”":r?.toLocaleString()}),e.jsxs(c,{level:"body-sm",color:"neutral",children:[b?"":ns(x)," from last 30 days"]})]})}),e.jsx(Ce,{xs:12,md:4,children:e.jsxs(me,{variant:"outlined",children:[e.jsx(c,{level:"h4",children:"Customers"}),e.jsx(c,{level:"h2",color:"warning",children:b?"Loading...":g?"â€”":s?.toLocaleString()}),e.jsxs(c,{level:"body-sm",color:"neutral",children:[b?"":ns(v)," new last 30 days"]})]})})]})]})},We=({children:l})=>{const[t,r]=u.useState(null),[n,s]=u.useState(!0);return u.useEffect(()=>{async function d(){const{data:a}=await T.auth.getSession();r(a?.session||null),s(!1)}d()},[]),n?e.jsx("div",{children:"Loading..."}):t?e.jsx(e.Fragment,{children:l}):e.jsx(Wt,{to:"/",replace:!0})};function Rn(l){const{onClick:t,...r}=l,{mode:n,setMode:s}=Sr(),[d,a]=u.useState(!1);return u.useEffect(()=>a(!0),[]),e.jsx(xe,{"aria-label":"toggle light/dark mode",size:"sm",variant:"outlined",disabled:!d,onClick:o=>{s(n==="light"?"dark":"light"),t?.(o)},...r,children:n==="light"?e.jsx(Dr,{}):e.jsx(Nl,{})})}function Ln({onLogin:l}){const t=Cs(),[r,n]=u.useState(""),[s,d]=u.useState(""),[a,o]=u.useState(!1),[x,m]=u.useState(null);u.useEffect(()=>{if(window.location.pathname==="/login"){async function f(){const{data:b}=await T.auth.getSession();b?.session&&t("/dashboard")}f()}},[t]);async function v(f){f.preventDefault(),o(!0),m(null);const{data:b,error:C}=await T.auth.signInWithPassword({email:r,password:s});if(C){console.error("[Login] Auth error:",C),m(C.message),o(!1);return}const g=b.user?.id;if(!g){m("Login failed: No user ID."),o(!1);return}let{data:w,error:y}=await T.from("users").select("*").eq("id",g).single();if(y||!w){console.error("[Login] User fetch error:",y);const S=(b.user.user_metadata?.full_name||b.user.user_metadata?.name||"").split(" "),{error:p}=await T.from("users").upsert({id:g,email:b.user.email,first_name:S[0]||"",last_name:S.slice(1).join(" ")||null,role:"employee"});if(p){console.error("Upsert failed:",p),m("Upsert failed: "+p.message),o(!1);return}let k=3,H,I;for(;k>0;){await new Promise(A=>setTimeout(A,300));const{data:U,error:j}=await T.from("users").select("*").eq("id",g).single();if(H=U,I=j,I&&console.error("[Login] Retry user fetch error:",I),H&&!I){w=H,y=null;break}k--}if(y||!w){m("Access denied: User not found."),await T.auth.signOut(),o(!1);return}}if(w.role!=="employee"){m("Access denied: Only employees can access this app."),await T.auth.signOut(),o(!1);return}o(!1),l(),t("/dashboard")}return e.jsxs(_r,{disableTransitionOnChange:!0,children:[e.jsx(hl,{}),e.jsx(Cr,{styles:{":root":{"--Form-maxWidth":"800px","--Transition-duration":"0.4s"}}}),e.jsx(i,{sx:f=>({width:{xs:"100%",md:"50vw"},transition:"width var(--Transition-duration)",transitionDelay:"calc(var(--Transition-duration) + 0.1s)",position:"relative",zIndex:1,display:"flex",justifyContent:"flex-end",backdropFilter:"blur(12px)",backgroundColor:"rgba(255 255 255 / 0.2)",[f.getColorSchemeSelector("dark")]:{backgroundColor:"rgba(19 19 24 / 0.4)"}}),children:e.jsxs(i,{sx:{display:"flex",flexDirection:"column",minHeight:"100dvh",width:"100%",px:2},children:[e.jsxs(i,{component:"header",sx:{py:3,display:"flex",justifyContent:"space-between"},children:[e.jsxs(i,{sx:{gap:2,display:"flex",alignItems:"center"},children:[e.jsx(xe,{variant:"soft",color:"primary",size:"sm",children:e.jsx(Ll,{})}),e.jsx(c,{level:"title-lg",children:"SmartBack"})]}),e.jsx(Rn,{})]}),e.jsxs(i,{component:"main",sx:{my:"auto",py:2,pb:5,display:"flex",flexDirection:"column",gap:2,width:400,maxWidth:"100%",mx:"auto",borderRadius:"sm","& form":{display:"flex",flexDirection:"column",gap:2},"& .MuiFormLabel-asterisk":{visibility:"hidden"}},children:[e.jsx(X,{sx:{gap:4,mb:2},children:e.jsxs(X,{sx:{gap:1},children:[e.jsx(c,{component:"h1",level:"h3",children:"Sign in"}),e.jsx(c,{level:"body-sm",children:"Welcome back to SmartBack! Please sign in to continue."})]})}),e.jsx(X,{sx:{gap:4,mt:2},children:e.jsxs("form",{onSubmit:v,children:[e.jsxs(te,{required:!0,children:[e.jsx(ee,{children:"Email"}),e.jsx($,{type:"email",name:"email",value:r,onChange:f=>n(f.target.value),placeholder:"your@email.com",disabled:a})]}),e.jsxs(te,{required:!0,children:[e.jsx(ee,{children:"Password"}),e.jsx($,{type:"password",name:"password",value:s,onChange:f=>d(f.target.value),placeholder:"â€¢â€¢â€¢â€¢â€¢â€¢",disabled:a})]}),e.jsxs(X,{sx:{gap:4,mt:2},children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(bt,{size:"sm",label:"Remember me",name:"persistent"}),e.jsx(xl,{level:"title-sm",href:"#forgot-password",children:"Forgot your password?"})]}),e.jsx(q,{type:"submit",fullWidth:!0,loading:a,children:"Sign in"})]})]})}),x&&e.jsx(i,{sx:{mt:2},children:e.jsx(c,{level:"body-sm",color:"danger",children:x})})]}),e.jsx(i,{component:"footer",sx:{py:3},children:e.jsxs(c,{level:"body-xs",sx:{textAlign:"center"},children:["Â© SmartBack ",new Date().getFullYear()]})})]})}),e.jsx(i,{sx:f=>({height:"100%",position:"fixed",right:0,top:0,bottom:0,left:{xs:0,md:"50vw"},transition:"background-image var(--Transition-duration), left var(--Transition-duration) !important",transitionDelay:"calc(var(--Transition-duration) + 0.1s)",backgroundColor:"background.level1",backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat",backgroundImage:"url(https://images.unsplash.com/photo-1527181152855-fc03fc7949c8?auto=format&w=1000&dpr=2)",[f.getColorSchemeSelector("dark")]:{backgroundImage:"url(https://images.unsplash.com/photo-1572072393749-3ca9c8ea0831?auto=format&w=1000&dpr=2)"}})})]})}function Nn(){return e.jsx(_s,{children:e.jsx(_e,{path:"*",element:e.jsx(Ln,{onLogin:()=>{}})})})}const ze={fontSize:re.sizes.small},$n=()=>{const{isMobile:l}=Ie();$r();const[t,r]=u.useState([]),[n,s]=u.useState([]),[d,a]=u.useState(""),[o,x]=u.useState(!1),[m,v]=u.useState(!1),[f,b]=u.useState(""),[C,g]=u.useState(""),[w,y]=u.useState(""),[R,S]=u.useState(""),[p,k]=u.useState(null),[H,I]=u.useState(!1),[U,j]=u.useState(""),[A,N]=u.useState(""),[W,G]=u.useState(!1),[h,E]=u.useState(!1),[B,O]=u.useState(""),[D,M]=u.useState("success"),se=(_,K="success")=>{O(_),M(K),E(!0)},ue=async()=>{try{const{data:_,error:K}=await T.from("stock_movements").select(`
                    *,
                    Products (
                        ProductName,
                        ProductID
                    )
                `).order("date",{ascending:!1});K?(console.error("Error fetching movements:",K),r([]),se("Failed to load movements","danger")):r(_||[])}catch(_){console.error("Unexpected error:",_),r([]),se("An unexpected error occurred","danger")}},le=async()=>{try{const{data:_,error:K}=await T.from("Products").select("*").order("ProductName");K?(console.error("Error fetching products:",K),s([])):s(_||[])}catch(_){console.error("Unexpected error:",_),s([])}},J=async _=>{if(!_){k(null);return}I(!0);try{const{data:K,error:z}=await T.from("stock_movements").select("movement_type, quantity").eq("product_id",_);if(z)console.error("Error fetching stock movements:",z),k(null);else{const Z=(K||[]).reduce((P,ne)=>{switch(ne.movement_type){case"incoming":return P+ne.quantity;case"outgoing":return P-ne.quantity;case"adjustment":return P+ne.quantity;default:return P}},0);k(Z)}}catch(K){console.error("Error calculating stock:",K),k(null)}finally{I(!1)}};u.useEffect(()=>{R?J(R):k(null)},[R]);const oe=async()=>{if(!R||U===""||p===null){se("Please select a product and enter a valid stock level","warning");return}const K=Number(U)-p;if(K===0){se("No adjustment needed - the stock level is already at the specified amount","warning");return}G(!0);try{const{error:z}=await T.from("stock_movements").insert({product_id:R,movement_type:"adjustment",quantity:K,reason:`Manual adjustment: ${A||"Stock level correction"}`,date:new Date().toISOString()});z?(console.error("Error creating adjustment:",z),se("Failed to create adjustment: "+z.message,"danger")):(S(""),j(""),N(""),k(null),x(!1),ue(),se("Stock adjustment created successfully!","success"))}catch(z){console.error("Unexpected error:",z),se("An unexpected error occurred","danger")}finally{G(!1)}};u.useEffect(()=>{ue(),le()},[]);const Q=t.filter(_=>{const K=d.toLowerCase(),z=d===""||_.id.toLowerCase().includes(K)||_.product_id.toLowerCase().includes(K)||_.movement_type.toLowerCase().includes(K)||(_.reason?.toLowerCase().includes(K)??!1)||(_.Products?.ProductName?.toLowerCase().includes(K)??!1),Z=f===""||_.movement_type===f,P=C===""||_.product_id===C,ne=w===""||(()=>{const fe=_.reason?.toLowerCase()||"";switch(w){case"manual":return fe.includes("manual")||fe.includes("adjustment")||fe.includes("correction");case"damage":return fe.includes("damage")||fe.includes("broken")||fe.includes("defect");case"loss":return fe.includes("loss")||fe.includes("lost")||fe.includes("missing");case"found":return fe.includes("found")||fe.includes("surplus")||fe.includes("extra");case"po":return fe.includes("po")||fe.includes("purchase")||fe.includes("receipt");default:return!0}})();return z&&Z&&P&&ne}),ce=_=>{switch(_.movement_type){case"incoming":return"success";case"outgoing":return"danger";case"adjustment":return _.quantity>=0?"success":"danger";default:return"neutral"}},L=_=>{switch(_.movement_type){case"incoming":return"â†‘";case"outgoing":return"â†“";case"adjustment":return"âš–";default:return"â€¢"}},Y=_=>{switch(_.movement_type){case"incoming":return`+${_.quantity}`;case"outgoing":return`-${_.quantity}`;case"adjustment":return _.quantity>=0?`+${_.quantity}`:`${_.quantity}`;default:return _.quantity}},we=()=>{b(""),g(""),y("")},de=f!==""||C!==""||w!=="",Oe=()=>e.jsxs(i,{sx:{width:"100%",minHeight:"100vh"},children:[e.jsxs(ke,{padding:"medium",children:[e.jsx(c,{level:"h2",sx:{mb:2,fontSize:re.sizes.xlarge},children:"Stock Movements"}),e.jsxs(i,{sx:{display:"flex",gap:1,mb:2},children:[e.jsx($,{placeholder:"Search movements...",value:d,onChange:_=>a(_.target.value),startDecorator:e.jsx(Se,{}),sx:{flex:1}}),e.jsx(xe,{variant:de?"solid":"soft",color:de?"primary":"neutral",size:"sm",onClick:()=>v(!0),children:e.jsx(ys,{})})]}),de&&e.jsxs(i,{sx:{mb:2,display:"flex",gap:1,flexWrap:"wrap"},children:[f&&e.jsxs(ae,{size:"sm",variant:"soft",color:"primary",children:["Type: ",f]}),C&&e.jsxs(ae,{size:"sm",variant:"soft",color:"primary",children:["Product: ",n.find(_=>_.uuid===C)?.ProductName||"Selected"]}),w&&e.jsxs(ae,{size:"sm",variant:"soft",color:"primary",children:["Reason: ",w]})]})]}),e.jsx(i,{children:Q.length===0?e.jsx(i,{sx:{textAlign:"center",py:6},children:e.jsx(c,{color:"neutral",children:"No stock movements found"})}):Q.map(_=>e.jsx(i,{sx:{p:2,borderBottom:"1px solid",borderColor:"divider","&:hover":{bgcolor:"background.level1"}},children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(i,{sx:{width:32,height:32,borderRadius:"50%",bgcolor:`${ce(_)}.100`,color:`${ce(_)}.600`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"14px",fontWeight:"bold",flexShrink:0},children:L(_)}),e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:.5},children:[e.jsx(c,{level:"title-sm",sx:{fontWeight:"bold",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"60%"},children:_.Products?.ProductName||"Unknown Product"}),e.jsx(ae,{size:"sm",color:ce(_),variant:"soft",sx:{fontWeight:"bold",minWidth:"fit-content"},children:Y(_)})]}),e.jsxs(c,{level:"body-xs",color:"neutral",sx:{mb:.5},children:["ID: ",_.Products?.ProductID||"N/A"," â€¢ ",new Date(_.date).toLocaleDateString()]}),_.reason&&e.jsx(c,{level:"body-xs",color:"neutral",sx:{fontStyle:"italic",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:_.reason})]})]})},_.id))}),e.jsx(xe,{color:"primary",variant:"soft",size:"sm",sx:{position:"fixed",bottom:80,right:16,zIndex:1e3,borderRadius:"8px",width:40,height:40,boxShadow:"sm",bgcolor:"primary.100","&:hover":{bgcolor:"primary.200",boxShadow:"md"}},onClick:()=>x(!0),children:e.jsx(ve,{fontSize:"small"})})]}),V=()=>e.jsxs(ke,{variant:"table-page",children:[e.jsx(c,{level:"h2",sx:{mb:2,fontSize:re.sizes.xlarge},children:"Stock Movements"}),e.jsxs(i,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx($,{placeholder:"Search movements...",sx:{flex:1,fontSize:re.sizes.small},value:d,onChange:_=>a(_.target.value),startDecorator:e.jsx(Se,{})}),e.jsx(q,{variant:"solid",startDecorator:e.jsx(ve,{}),onClick:()=>x(!0),sx:{fontSize:re.sizes.small},children:"Adjust"})]}),e.jsx(me,{sx:{overflow:"visible"},children:e.jsxs(Ue,{"aria-label":"Stock Movements",sx:{tableLayout:"auto"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:ze,children:"ID"}),e.jsx("th",{style:ze,children:"Product"}),e.jsx("th",{style:ze,children:"Movement Type"}),e.jsx("th",{style:ze,children:"Quantity"}),e.jsx("th",{style:ze,children:"Reason"}),e.jsx("th",{style:ze,children:"Date"})]})}),e.jsxs("tbody",{children:[Q.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,style:{textAlign:"center",color:"#888",...ze},children:"No stock movements found."})}),Q.map(_=>e.jsxs("tr",{style:{cursor:"pointer"},children:[e.jsxs("td",{style:ze,children:[_.id.substring(0,8),"..."]}),e.jsx("td",{style:ze,children:_.Products?e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:"bold"},children:_.Products.ProductName}),e.jsxs("div",{style:{fontSize:"0.8em",color:"#666"},children:["ID: ",_.Products.ProductID]})]}):e.jsx("span",{style:{color:"#999",fontStyle:"italic"},children:"Unknown Product"})}),e.jsx("td",{style:ze,children:e.jsx(ae,{size:"sm",variant:"soft",color:ce(_),children:_.movement_type==="incoming"?"â†‘ Incoming":_.movement_type==="outgoing"?"â†“ Outgoing":"âš– Adjustment"})}),e.jsx("td",{style:ze,children:e.jsx("span",{style:{fontWeight:"bold",color:ce(_)==="success"?"#059669":ce(_)==="danger"?"#dc2626":"#666"},children:Y(_)})}),e.jsx("td",{style:ze,children:_.reason||"N/A"}),e.jsx("td",{style:ze,children:new Date(_.date).toLocaleString()})]},_.id))]})]})})]});return e.jsxs(qe,{children:[l?e.jsx(Oe,{}):e.jsx(V,{}),e.jsx(qt,{open:o,onClose:()=>x(!1),title:"Manual Stock Adjustment",size:"medium",actions:e.jsxs(i,{sx:{display:"flex",gap:2},children:[e.jsx(q,{variant:"plain",onClick:()=>x(!1),sx:ze,children:"Cancel"}),e.jsx(q,{variant:"solid",onClick:oe,loading:W,disabled:!R||U===""||p===null||Number(U)===p,sx:ze,children:"Create Adjustment"})]}),children:e.jsxs(X,{spacing:2,children:[e.jsxs(te,{children:[e.jsx(ee,{children:"Product"}),e.jsx(ye,{placeholder:"Select a product...",value:R,onChange:(_,K)=>S(K||""),children:n.map(_=>e.jsxs(F,{value:_.uuid,children:[_.ProductName," (ID: ",_.ProductID,")"]},_.uuid))})]}),R&&e.jsxs(te,{children:[e.jsx(ee,{children:"Current Stock Level"}),e.jsx($,{value:H?"Loading...":p!==null?p:"N/A",readOnly:!0,sx:{bgcolor:"neutral.100",color:p!==null&&p<=0?"danger.500":"neutral.600"}}),p!==null&&p<=0&&e.jsx(c,{level:"body-sm",sx:{color:"danger.500",mt:.5},children:"âš ï¸ Warning: Product is at or below zero stock level"})]}),p!==null&&e.jsxs(te,{children:[e.jsx(ee,{children:"Actual Stock Level"}),e.jsx($,{type:"number",placeholder:"Enter the actual stock level...",value:U,onChange:_=>j(_.target.value),sx:{...ze},slotProps:{input:{min:0,max:999999}}}),U!==""&&p!==null&&e.jsx(c,{level:"body-sm",sx:{mt:.5,color:Number(U)>p?"success.600":Number(U)<p?"danger.600":"neutral.600"},children:Number(U)>p?`+${Number(U)-p} (increase)`:Number(U)<p?`${Number(U)-p} (decrease)`:"No change needed"})]}),e.jsxs(te,{children:[e.jsx(ee,{children:"Reason for Adjustment"}),e.jsx($,{placeholder:"e.g., damage, loss, found inventory, physical count correction...",value:A,onChange:_=>N(_.target.value),sx:{...ze}})]})]})}),l&&e.jsx(qt,{open:m,onClose:()=>v(!1),title:"Filter Movements",size:"medium",actions:e.jsxs(i,{sx:{display:"flex",gap:1,justifyContent:"space-between",width:"100%"},children:[e.jsx(q,{variant:"plain",color:"neutral",onClick:we,disabled:!de,children:"Clear All"}),e.jsx(q,{onClick:()=>v(!1),children:"Apply Filters"})]}),children:e.jsxs(X,{spacing:2,children:[e.jsxs(te,{children:[e.jsx(ee,{children:"Movement Type"}),e.jsxs(ye,{placeholder:"All types",value:f,onChange:(_,K)=>b(K||""),children:[e.jsx(F,{value:"",children:"All Types"}),e.jsx(F,{value:"incoming",children:"Incoming"}),e.jsx(F,{value:"outgoing",children:"Outgoing"}),e.jsx(F,{value:"adjustment",children:"Adjustment"})]})]}),e.jsxs(te,{children:[e.jsx(ee,{children:"Product"}),e.jsxs(ye,{placeholder:"All products",value:C,onChange:(_,K)=>g(K||""),children:[e.jsx(F,{value:"",children:"All Products"}),n.map(_=>e.jsx(F,{value:_.uuid,children:_.ProductName},_.uuid))]})]}),e.jsxs(te,{children:[e.jsx(ee,{children:"Reason Category"}),e.jsxs(ye,{placeholder:"All reasons",value:w,onChange:(_,K)=>y(K||""),children:[e.jsx(F,{value:"",children:"All Reasons"}),e.jsx(F,{value:"manual",children:"Manual Adjustment"}),e.jsx(F,{value:"damage",children:"Damage/Defect"}),e.jsx(F,{value:"loss",children:"Loss/Missing"}),e.jsx(F,{value:"found",children:"Found/Surplus"}),e.jsx(F,{value:"po",children:"Purchase Order"})]})]})]})}),e.jsx(Ht,{open:h,onClose:()=>E(!1),autoHideDuration:4e3,anchorOrigin:{vertical:"top",horizontal:"center"},sx:{top:16,zIndex:2e3},children:e.jsx(it,{color:D,variant:"solid",sx:{width:"100%"},children:B})})]})};function Ps(){return{async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null}}var ut=Ps();function Tr(l){ut=l}var vt={exec:()=>null};function pe(l,t=""){let r=typeof l=="string"?l:l.source,n={replace:(s,d)=>{let a=typeof d=="string"?d:d.source;return a=a.replace(Le.caret,"$1"),r=r.replace(s,a),n},getRegex:()=>new RegExp(r,t)};return n}var Le={codeRemoveIndent:/^(?: {1,4}| {0,3}\t)/gm,outputLinkReplace:/\\([\[\]])/g,indentCodeCompensation:/^(\s+)(?:```)/,beginningSpace:/^\s+/,endingHash:/#$/,startingSpaceChar:/^ /,endingSpaceChar:/ $/,nonSpaceChar:/[^ ]/,newLineCharGlobal:/\n/g,tabCharGlobal:/\t/g,multipleSpaceGlobal:/\s+/g,blankLine:/^[ \t]*$/,doubleBlankLine:/\n[ \t]*\n[ \t]*$/,blockquoteStart:/^ {0,3}>/,blockquoteSetextReplace:/\n {0,3}((?:=+|-+) *)(?=\n|$)/g,blockquoteSetextReplace2:/^ {0,3}>[ \t]?/gm,listReplaceTabs:/^\t+/,listReplaceNesting:/^ {1,4}(?=( {4})*[^ ])/g,listIsTask:/^\[[ xX]\] /,listReplaceTask:/^\[[ xX]\] +/,anyLine:/\n.*\n/,hrefBrackets:/^<(.*)>$/,tableDelimiter:/[:|]/,tableAlignChars:/^\||\| *$/g,tableRowBlankLine:/\n[ \t]*$/,tableAlignRight:/^ *-+: *$/,tableAlignCenter:/^ *:-+: *$/,tableAlignLeft:/^ *:-+ *$/,startATag:/^<a /i,endATag:/^<\/a>/i,startPreScriptTag:/^<(pre|code|kbd|script)(\s|>)/i,endPreScriptTag:/^<\/(pre|code|kbd|script)(\s|>)/i,startAngleBracket:/^</,endAngleBracket:/>$/,pedanticHrefTitle:/^([^'"]*[^\s])\s+(['"])(.*)\2/,unicodeAlphaNumeric:/[\p{L}\p{N}]/u,escapeTest:/[&<>"']/,escapeReplace:/[&<>"']/g,escapeTestNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/,escapeReplaceNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/g,unescapeTest:/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/ig,caret:/(^|[^\[])\^/g,percentDecode:/%25/g,findPipe:/\|/g,splitPipe:/ \|/,slashPipe:/\\\|/g,carriageReturn:/\r\n|\r/g,spaceLine:/^ +$/gm,notSpaceStart:/^\S*/,endingNewline:/\n$/,listItemRegex:l=>new RegExp(`^( {0,3}${l})((?:[	 ][^\\n]*)?(?:\\n|$))`),nextBulletRegex:l=>new RegExp(`^ {0,${Math.min(3,l-1)}}(?:[*+-]|\\d{1,9}[.)])((?:[ 	][^\\n]*)?(?:\\n|$))`),hrRegex:l=>new RegExp(`^ {0,${Math.min(3,l-1)}}((?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$)`),fencesBeginRegex:l=>new RegExp(`^ {0,${Math.min(3,l-1)}}(?:\`\`\`|~~~)`),headingBeginRegex:l=>new RegExp(`^ {0,${Math.min(3,l-1)}}#`),htmlBeginRegex:l=>new RegExp(`^ {0,${Math.min(3,l-1)}}<(?:[a-z].*>|!--)`,"i")},Tn=/^(?:[ \t]*(?:\n|$))+/,Mn=/^((?: {4}| {0,3}\t)[^\n]+(?:\n(?:[ \t]*(?:\n|$))*)?)+/,Wn=/^ {0,3}(`{3,}(?=[^`\n]*(?:\n|$))|~{3,})([^\n]*)(?:\n|$)(?:|([\s\S]*?)(?:\n|$))(?: {0,3}\1[~`]* *(?=\n|$)|$)/,_t=/^ {0,3}((?:-[\t ]*){3,}|(?:_[ \t]*){3,}|(?:\*[ \t]*){3,})(?:\n+|$)/,qn=/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,zs=/(?:[*+-]|\d{1,9}[.)])/,Mr=/^(?!bull |blockCode|fences|blockquote|heading|html|table)((?:.|\n(?!\s*?\n|bull |blockCode|fences|blockquote|heading|html|table))+?)\n {0,3}(=+|-+) *(?:\n+|$)/,Wr=pe(Mr).replace(/bull/g,zs).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/\|table/g,"").getRegex(),Fn=pe(Mr).replace(/bull/g,zs).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/table/g,/ {0,3}\|?(?:[:\- ]*\|)+[\:\- ]*\n/).getRegex(),As=/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,Un=/^[^\n]+/,Os=/(?!\s*\])(?:\\.|[^\[\]\\])+/,Bn=pe(/^ {0,3}\[(label)\]: *(?:\n[ \t]*)?([^<\s][^\s]*|<.*?>)(?:(?: +(?:\n[ \t]*)?| *\n[ \t]*)(title))? *(?:\n+|$)/).replace("label",Os).replace("title",/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/).getRegex(),Hn=pe(/^( {0,3}bull)([ \t][^\n]+?)?(?:\n|$)/).replace(/bull/g,zs).getRegex(),Qt="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|search|section|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",Es=/<!--(?:-?>|[\s\S]*?(?:-->|$))/,Vn=pe("^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$))","i").replace("comment",Es).replace("tag",Qt).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),qr=pe(As).replace("hr",_t).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",Qt).getRegex(),Gn=pe(/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/).replace("paragraph",qr).getRegex(),Rs={blockquote:Gn,code:Mn,def:Bn,fences:Wn,heading:qn,hr:_t,html:Vn,lheading:Wr,list:Hn,newline:Tn,paragraph:qr,table:vt,text:Un},fr=pe("^ *([^\\n ].*)\\n {0,3}((?:\\| *)?:?-+:? *(?:\\| *:?-+:? *)*(?:\\| *)?)(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)").replace("hr",_t).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("blockquote"," {0,3}>").replace("code","(?: {4}| {0,3}	)[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",Qt).getRegex(),Qn={...Rs,lheading:Fn,table:fr,paragraph:pe(As).replace("hr",_t).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("table",fr).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",Qt).getRegex()},Zn={...Rs,html:pe(`^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:"[^"]*"|'[^']*'|\\s[^'"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))`).replace("comment",Es).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:vt,lheading:/^(.+?)\n {0,3}(=+|-+) *(?:\n+|$)/,paragraph:pe(As).replace("hr",_t).replace("heading",` *#{1,6} *[^
]`).replace("lheading",Wr).replace("|table","").replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").replace("|tag","").getRegex()},Yn=/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,Jn=/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,Fr=/^( {2,}|\\)\n(?!\s*$)/,Xn=/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,Zt=/[\p{P}\p{S}]/u,Ls=/[\s\p{P}\p{S}]/u,Ur=/[^\s\p{P}\p{S}]/u,Kn=pe(/^((?![*_])punctSpace)/,"u").replace(/punctSpace/g,Ls).getRegex(),Br=/(?!~)[\p{P}\p{S}]/u,ei=/(?!~)[\s\p{P}\p{S}]/u,ti=/(?:[^\s\p{P}\p{S}]|~)/u,si=/\[[^[\]]*?\]\((?:\\.|[^\\\(\)]|\((?:\\.|[^\\\(\)])*\))*\)|`[^`]*?`|<[^<>]*?>/g,Hr=/^(?:\*+(?:((?!\*)punct)|[^\s*]))|^_+(?:((?!_)punct)|([^\s_]))/,ri=pe(Hr,"u").replace(/punct/g,Zt).getRegex(),li=pe(Hr,"u").replace(/punct/g,Br).getRegex(),Vr="^[^_*]*?__[^_*]*?\\*[^_*]*?(?=__)|[^*]+(?=[^*])|(?!\\*)punct(\\*+)(?=[\\s]|$)|notPunctSpace(\\*+)(?!\\*)(?=punctSpace|$)|(?!\\*)punctSpace(\\*+)(?=notPunctSpace)|[\\s](\\*+)(?!\\*)(?=punct)|(?!\\*)punct(\\*+)(?!\\*)(?=punct)|notPunctSpace(\\*+)(?=notPunctSpace)",ni=pe(Vr,"gu").replace(/notPunctSpace/g,Ur).replace(/punctSpace/g,Ls).replace(/punct/g,Zt).getRegex(),ii=pe(Vr,"gu").replace(/notPunctSpace/g,ti).replace(/punctSpace/g,ei).replace(/punct/g,Br).getRegex(),ai=pe("^[^_*]*?\\*\\*[^_*]*?_[^_*]*?(?=\\*\\*)|[^_]+(?=[^_])|(?!_)punct(_+)(?=[\\s]|$)|notPunctSpace(_+)(?!_)(?=punctSpace|$)|(?!_)punctSpace(_+)(?=notPunctSpace)|[\\s](_+)(?!_)(?=punct)|(?!_)punct(_+)(?!_)(?=punct)","gu").replace(/notPunctSpace/g,Ur).replace(/punctSpace/g,Ls).replace(/punct/g,Zt).getRegex(),oi=pe(/\\(punct)/,"gu").replace(/punct/g,Zt).getRegex(),ci=pe(/^<(scheme:[^\s\x00-\x1f<>]*|email)>/).replace("scheme",/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/).replace("email",/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/).getRegex(),di=pe(Es).replace("(?:-->|$)","-->").getRegex(),ui=pe("^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>").replace("comment",di).replace("attribute",/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/).getRegex(),Ft=/(?:\[(?:\\.|[^\[\]\\])*\]|\\.|`[^`]*`|[^\[\]\\`])*?/,hi=pe(/^!?\[(label)\]\(\s*(href)(?:(?:[ \t]*(?:\n[ \t]*)?)(title))?\s*\)/).replace("label",Ft).replace("href",/<(?:\\.|[^\n<>\\])+>|[^ \t\n\x00-\x1f]*/).replace("title",/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/).getRegex(),Gr=pe(/^!?\[(label)\]\[(ref)\]/).replace("label",Ft).replace("ref",Os).getRegex(),Qr=pe(/^!?\[(ref)\](?:\[\])?/).replace("ref",Os).getRegex(),xi=pe("reflink|nolink(?!\\()","g").replace("reflink",Gr).replace("nolink",Qr).getRegex(),Ns={_backpedal:vt,anyPunctuation:oi,autolink:ci,blockSkip:si,br:Fr,code:Jn,del:vt,emStrongLDelim:ri,emStrongRDelimAst:ni,emStrongRDelimUnd:ai,escape:Yn,link:hi,nolink:Qr,punctuation:Kn,reflink:Gr,reflinkSearch:xi,tag:ui,text:Xn,url:vt},pi={...Ns,link:pe(/^!?\[(label)\]\((.*?)\)/).replace("label",Ft).getRegex(),reflink:pe(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",Ft).getRegex()},us={...Ns,emStrongRDelimAst:ii,emStrongLDelim:li,url:pe(/^((?:ftp|https?):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/,"i").replace("email",/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/).getRegex(),_backpedal:/(?:[^?!.,:;*_'"~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_'"~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])((?:\\.|[^\\])*?(?:\\.|[^\s~\\]))\1(?=[^~]|$)/,text:/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|https?:\/\/|ftp:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/},mi={...us,br:pe(Fr).replace("{2,}","*").getRegex(),text:pe(us.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()},At={normal:Rs,gfm:Qn,pedantic:Zn},mt={normal:Ns,gfm:us,breaks:mi,pedantic:pi},gi={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},jr=l=>gi[l];function Be(l,t){if(t){if(Le.escapeTest.test(l))return l.replace(Le.escapeReplace,jr)}else if(Le.escapeTestNoEncode.test(l))return l.replace(Le.escapeReplaceNoEncode,jr);return l}function br(l){try{l=encodeURI(l).replace(Le.percentDecode,"%")}catch{return null}return l}function yr(l,t){let r=l.replace(Le.findPipe,(d,a,o)=>{let x=!1,m=a;for(;--m>=0&&o[m]==="\\";)x=!x;return x?"|":" |"}),n=r.split(Le.splitPipe),s=0;if(n[0].trim()||n.shift(),n.length>0&&!n.at(-1)?.trim()&&n.pop(),t)if(n.length>t)n.splice(t);else for(;n.length<t;)n.push("");for(;s<n.length;s++)n[s]=n[s].trim().replace(Le.slashPipe,"|");return n}function gt(l,t,r){let n=l.length;if(n===0)return"";let s=0;for(;s<n&&l.charAt(n-s-1)===t;)s++;return l.slice(0,n-s)}function fi(l,t){if(l.indexOf(t[1])===-1)return-1;let r=0;for(let n=0;n<l.length;n++)if(l[n]==="\\")n++;else if(l[n]===t[0])r++;else if(l[n]===t[1]&&(r--,r<0))return n;return r>0?-2:-1}function vr(l,t,r,n,s){let d=t.href,a=t.title||null,o=l[1].replace(s.other.outputLinkReplace,"$1");n.state.inLink=!0;let x={type:l[0].charAt(0)==="!"?"image":"link",raw:r,href:d,title:a,text:o,tokens:n.inlineTokens(o)};return n.state.inLink=!1,x}function ji(l,t,r){let n=l.match(r.other.indentCodeCompensation);if(n===null)return t;let s=n[1];return t.split(`
`).map(d=>{let a=d.match(r.other.beginningSpace);if(a===null)return d;let[o]=a;return o.length>=s.length?d.slice(s.length):d}).join(`
`)}var Ut=class{options;rules;lexer;constructor(l){this.options=l||ut}space(l){let t=this.rules.block.newline.exec(l);if(t&&t[0].length>0)return{type:"space",raw:t[0]}}code(l){let t=this.rules.block.code.exec(l);if(t){let r=t[0].replace(this.rules.other.codeRemoveIndent,"");return{type:"code",raw:t[0],codeBlockStyle:"indented",text:this.options.pedantic?r:gt(r,`
`)}}}fences(l){let t=this.rules.block.fences.exec(l);if(t){let r=t[0],n=ji(r,t[3]||"",this.rules);return{type:"code",raw:r,lang:t[2]?t[2].trim().replace(this.rules.inline.anyPunctuation,"$1"):t[2],text:n}}}heading(l){let t=this.rules.block.heading.exec(l);if(t){let r=t[2].trim();if(this.rules.other.endingHash.test(r)){let n=gt(r,"#");(this.options.pedantic||!n||this.rules.other.endingSpaceChar.test(n))&&(r=n.trim())}return{type:"heading",raw:t[0],depth:t[1].length,text:r,tokens:this.lexer.inline(r)}}}hr(l){let t=this.rules.block.hr.exec(l);if(t)return{type:"hr",raw:gt(t[0],`
`)}}blockquote(l){let t=this.rules.block.blockquote.exec(l);if(t){let r=gt(t[0],`
`).split(`
`),n="",s="",d=[];for(;r.length>0;){let a=!1,o=[],x;for(x=0;x<r.length;x++)if(this.rules.other.blockquoteStart.test(r[x]))o.push(r[x]),a=!0;else if(!a)o.push(r[x]);else break;r=r.slice(x);let m=o.join(`
`),v=m.replace(this.rules.other.blockquoteSetextReplace,`
    $1`).replace(this.rules.other.blockquoteSetextReplace2,"");n=n?`${n}
${m}`:m,s=s?`${s}
${v}`:v;let f=this.lexer.state.top;if(this.lexer.state.top=!0,this.lexer.blockTokens(v,d,!0),this.lexer.state.top=f,r.length===0)break;let b=d.at(-1);if(b?.type==="code")break;if(b?.type==="blockquote"){let C=b,g=C.raw+`
`+r.join(`
`),w=this.blockquote(g);d[d.length-1]=w,n=n.substring(0,n.length-C.raw.length)+w.raw,s=s.substring(0,s.length-C.text.length)+w.text;break}else if(b?.type==="list"){let C=b,g=C.raw+`
`+r.join(`
`),w=this.list(g);d[d.length-1]=w,n=n.substring(0,n.length-b.raw.length)+w.raw,s=s.substring(0,s.length-C.raw.length)+w.raw,r=g.substring(d.at(-1).raw.length).split(`
`);continue}}return{type:"blockquote",raw:n,tokens:d,text:s}}}list(l){let t=this.rules.block.list.exec(l);if(t){let r=t[1].trim(),n=r.length>1,s={type:"list",raw:"",ordered:n,start:n?+r.slice(0,-1):"",loose:!1,items:[]};r=n?`\\d{1,9}\\${r.slice(-1)}`:`\\${r}`,this.options.pedantic&&(r=n?r:"[*+-]");let d=this.rules.other.listItemRegex(r),a=!1;for(;l;){let x=!1,m="",v="";if(!(t=d.exec(l))||this.rules.block.hr.test(l))break;m=t[0],l=l.substring(m.length);let f=t[2].split(`
`,1)[0].replace(this.rules.other.listReplaceTabs,R=>" ".repeat(3*R.length)),b=l.split(`
`,1)[0],C=!f.trim(),g=0;if(this.options.pedantic?(g=2,v=f.trimStart()):C?g=t[1].length+1:(g=t[2].search(this.rules.other.nonSpaceChar),g=g>4?1:g,v=f.slice(g),g+=t[1].length),C&&this.rules.other.blankLine.test(b)&&(m+=b+`
`,l=l.substring(b.length+1),x=!0),!x){let R=this.rules.other.nextBulletRegex(g),S=this.rules.other.hrRegex(g),p=this.rules.other.fencesBeginRegex(g),k=this.rules.other.headingBeginRegex(g),H=this.rules.other.htmlBeginRegex(g);for(;l;){let I=l.split(`
`,1)[0],U;if(b=I,this.options.pedantic?(b=b.replace(this.rules.other.listReplaceNesting,"  "),U=b):U=b.replace(this.rules.other.tabCharGlobal,"    "),p.test(b)||k.test(b)||H.test(b)||R.test(b)||S.test(b))break;if(U.search(this.rules.other.nonSpaceChar)>=g||!b.trim())v+=`
`+U.slice(g);else{if(C||f.replace(this.rules.other.tabCharGlobal,"    ").search(this.rules.other.nonSpaceChar)>=4||p.test(f)||k.test(f)||S.test(f))break;v+=`
`+b}!C&&!b.trim()&&(C=!0),m+=I+`
`,l=l.substring(I.length+1),f=U.slice(g)}}s.loose||(a?s.loose=!0:this.rules.other.doubleBlankLine.test(m)&&(a=!0));let w=null,y;this.options.gfm&&(w=this.rules.other.listIsTask.exec(v),w&&(y=w[0]!=="[ ] ",v=v.replace(this.rules.other.listReplaceTask,""))),s.items.push({type:"list_item",raw:m,task:!!w,checked:y,loose:!1,text:v,tokens:[]}),s.raw+=m}let o=s.items.at(-1);if(o)o.raw=o.raw.trimEnd(),o.text=o.text.trimEnd();else return;s.raw=s.raw.trimEnd();for(let x=0;x<s.items.length;x++)if(this.lexer.state.top=!1,s.items[x].tokens=this.lexer.blockTokens(s.items[x].text,[]),!s.loose){let m=s.items[x].tokens.filter(f=>f.type==="space"),v=m.length>0&&m.some(f=>this.rules.other.anyLine.test(f.raw));s.loose=v}if(s.loose)for(let x=0;x<s.items.length;x++)s.items[x].loose=!0;return s}}html(l){let t=this.rules.block.html.exec(l);if(t)return{type:"html",block:!0,raw:t[0],pre:t[1]==="pre"||t[1]==="script"||t[1]==="style",text:t[0]}}def(l){let t=this.rules.block.def.exec(l);if(t){let r=t[1].toLowerCase().replace(this.rules.other.multipleSpaceGlobal," "),n=t[2]?t[2].replace(this.rules.other.hrefBrackets,"$1").replace(this.rules.inline.anyPunctuation,"$1"):"",s=t[3]?t[3].substring(1,t[3].length-1).replace(this.rules.inline.anyPunctuation,"$1"):t[3];return{type:"def",tag:r,raw:t[0],href:n,title:s}}}table(l){let t=this.rules.block.table.exec(l);if(!t||!this.rules.other.tableDelimiter.test(t[2]))return;let r=yr(t[1]),n=t[2].replace(this.rules.other.tableAlignChars,"").split("|"),s=t[3]?.trim()?t[3].replace(this.rules.other.tableRowBlankLine,"").split(`
`):[],d={type:"table",raw:t[0],header:[],align:[],rows:[]};if(r.length===n.length){for(let a of n)this.rules.other.tableAlignRight.test(a)?d.align.push("right"):this.rules.other.tableAlignCenter.test(a)?d.align.push("center"):this.rules.other.tableAlignLeft.test(a)?d.align.push("left"):d.align.push(null);for(let a=0;a<r.length;a++)d.header.push({text:r[a],tokens:this.lexer.inline(r[a]),header:!0,align:d.align[a]});for(let a of s)d.rows.push(yr(a,d.header.length).map((o,x)=>({text:o,tokens:this.lexer.inline(o),header:!1,align:d.align[x]})));return d}}lheading(l){let t=this.rules.block.lheading.exec(l);if(t)return{type:"heading",raw:t[0],depth:t[2].charAt(0)==="="?1:2,text:t[1],tokens:this.lexer.inline(t[1])}}paragraph(l){let t=this.rules.block.paragraph.exec(l);if(t){let r=t[1].charAt(t[1].length-1)===`
`?t[1].slice(0,-1):t[1];return{type:"paragraph",raw:t[0],text:r,tokens:this.lexer.inline(r)}}}text(l){let t=this.rules.block.text.exec(l);if(t)return{type:"text",raw:t[0],text:t[0],tokens:this.lexer.inline(t[0])}}escape(l){let t=this.rules.inline.escape.exec(l);if(t)return{type:"escape",raw:t[0],text:t[1]}}tag(l){let t=this.rules.inline.tag.exec(l);if(t)return!this.lexer.state.inLink&&this.rules.other.startATag.test(t[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&this.rules.other.endATag.test(t[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&this.rules.other.startPreScriptTag.test(t[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&this.rules.other.endPreScriptTag.test(t[0])&&(this.lexer.state.inRawBlock=!1),{type:"html",raw:t[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,block:!1,text:t[0]}}link(l){let t=this.rules.inline.link.exec(l);if(t){let r=t[2].trim();if(!this.options.pedantic&&this.rules.other.startAngleBracket.test(r)){if(!this.rules.other.endAngleBracket.test(r))return;let d=gt(r.slice(0,-1),"\\");if((r.length-d.length)%2===0)return}else{let d=fi(t[2],"()");if(d===-2)return;if(d>-1){let a=(t[0].indexOf("!")===0?5:4)+t[1].length+d;t[2]=t[2].substring(0,d),t[0]=t[0].substring(0,a).trim(),t[3]=""}}let n=t[2],s="";if(this.options.pedantic){let d=this.rules.other.pedanticHrefTitle.exec(n);d&&(n=d[1],s=d[3])}else s=t[3]?t[3].slice(1,-1):"";return n=n.trim(),this.rules.other.startAngleBracket.test(n)&&(this.options.pedantic&&!this.rules.other.endAngleBracket.test(r)?n=n.slice(1):n=n.slice(1,-1)),vr(t,{href:n&&n.replace(this.rules.inline.anyPunctuation,"$1"),title:s&&s.replace(this.rules.inline.anyPunctuation,"$1")},t[0],this.lexer,this.rules)}}reflink(l,t){let r;if((r=this.rules.inline.reflink.exec(l))||(r=this.rules.inline.nolink.exec(l))){let n=(r[2]||r[1]).replace(this.rules.other.multipleSpaceGlobal," "),s=t[n.toLowerCase()];if(!s){let d=r[0].charAt(0);return{type:"text",raw:d,text:d}}return vr(r,s,r[0],this.lexer,this.rules)}}emStrong(l,t,r=""){let n=this.rules.inline.emStrongLDelim.exec(l);if(!(!n||n[3]&&r.match(this.rules.other.unicodeAlphaNumeric))&&(!(n[1]||n[2])||!r||this.rules.inline.punctuation.exec(r))){let s=[...n[0]].length-1,d,a,o=s,x=0,m=n[0][0]==="*"?this.rules.inline.emStrongRDelimAst:this.rules.inline.emStrongRDelimUnd;for(m.lastIndex=0,t=t.slice(-1*l.length+s);(n=m.exec(t))!=null;){if(d=n[1]||n[2]||n[3]||n[4]||n[5]||n[6],!d)continue;if(a=[...d].length,n[3]||n[4]){o+=a;continue}else if((n[5]||n[6])&&s%3&&!((s+a)%3)){x+=a;continue}if(o-=a,o>0)continue;a=Math.min(a,a+o+x);let v=[...n[0]][0].length,f=l.slice(0,s+n.index+v+a);if(Math.min(s,a)%2){let C=f.slice(1,-1);return{type:"em",raw:f,text:C,tokens:this.lexer.inlineTokens(C)}}let b=f.slice(2,-2);return{type:"strong",raw:f,text:b,tokens:this.lexer.inlineTokens(b)}}}}codespan(l){let t=this.rules.inline.code.exec(l);if(t){let r=t[2].replace(this.rules.other.newLineCharGlobal," "),n=this.rules.other.nonSpaceChar.test(r),s=this.rules.other.startingSpaceChar.test(r)&&this.rules.other.endingSpaceChar.test(r);return n&&s&&(r=r.substring(1,r.length-1)),{type:"codespan",raw:t[0],text:r}}}br(l){let t=this.rules.inline.br.exec(l);if(t)return{type:"br",raw:t[0]}}del(l){let t=this.rules.inline.del.exec(l);if(t)return{type:"del",raw:t[0],text:t[2],tokens:this.lexer.inlineTokens(t[2])}}autolink(l){let t=this.rules.inline.autolink.exec(l);if(t){let r,n;return t[2]==="@"?(r=t[1],n="mailto:"+r):(r=t[1],n=r),{type:"link",raw:t[0],text:r,href:n,tokens:[{type:"text",raw:r,text:r}]}}}url(l){let t;if(t=this.rules.inline.url.exec(l)){let r,n;if(t[2]==="@")r=t[0],n="mailto:"+r;else{let s;do s=t[0],t[0]=this.rules.inline._backpedal.exec(t[0])?.[0]??"";while(s!==t[0]);r=t[0],t[1]==="www."?n="http://"+t[0]:n=t[0]}return{type:"link",raw:t[0],text:r,href:n,tokens:[{type:"text",raw:r,text:r}]}}}inlineText(l){let t=this.rules.inline.text.exec(l);if(t){let r=this.lexer.state.inRawBlock;return{type:"text",raw:t[0],text:t[0],escaped:r}}}},Ve=class hs{tokens;options;state;tokenizer;inlineQueue;constructor(t){this.tokens=[],this.tokens.links=Object.create(null),this.options=t||ut,this.options.tokenizer=this.options.tokenizer||new Ut,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};let r={other:Le,block:At.normal,inline:mt.normal};this.options.pedantic?(r.block=At.pedantic,r.inline=mt.pedantic):this.options.gfm&&(r.block=At.gfm,this.options.breaks?r.inline=mt.breaks:r.inline=mt.gfm),this.tokenizer.rules=r}static get rules(){return{block:At,inline:mt}}static lex(t,r){return new hs(r).lex(t)}static lexInline(t,r){return new hs(r).inlineTokens(t)}lex(t){t=t.replace(Le.carriageReturn,`
`),this.blockTokens(t,this.tokens);for(let r=0;r<this.inlineQueue.length;r++){let n=this.inlineQueue[r];this.inlineTokens(n.src,n.tokens)}return this.inlineQueue=[],this.tokens}blockTokens(t,r=[],n=!1){for(this.options.pedantic&&(t=t.replace(Le.tabCharGlobal,"    ").replace(Le.spaceLine,""));t;){let s;if(this.options.extensions?.block?.some(a=>(s=a.call({lexer:this},t,r))?(t=t.substring(s.raw.length),r.push(s),!0):!1))continue;if(s=this.tokenizer.space(t)){t=t.substring(s.raw.length);let a=r.at(-1);s.raw.length===1&&a!==void 0?a.raw+=`
`:r.push(s);continue}if(s=this.tokenizer.code(t)){t=t.substring(s.raw.length);let a=r.at(-1);a?.type==="paragraph"||a?.type==="text"?(a.raw+=`
`+s.raw,a.text+=`
`+s.text,this.inlineQueue.at(-1).src=a.text):r.push(s);continue}if(s=this.tokenizer.fences(t)){t=t.substring(s.raw.length),r.push(s);continue}if(s=this.tokenizer.heading(t)){t=t.substring(s.raw.length),r.push(s);continue}if(s=this.tokenizer.hr(t)){t=t.substring(s.raw.length),r.push(s);continue}if(s=this.tokenizer.blockquote(t)){t=t.substring(s.raw.length),r.push(s);continue}if(s=this.tokenizer.list(t)){t=t.substring(s.raw.length),r.push(s);continue}if(s=this.tokenizer.html(t)){t=t.substring(s.raw.length),r.push(s);continue}if(s=this.tokenizer.def(t)){t=t.substring(s.raw.length);let a=r.at(-1);a?.type==="paragraph"||a?.type==="text"?(a.raw+=`
`+s.raw,a.text+=`
`+s.raw,this.inlineQueue.at(-1).src=a.text):this.tokens.links[s.tag]||(this.tokens.links[s.tag]={href:s.href,title:s.title});continue}if(s=this.tokenizer.table(t)){t=t.substring(s.raw.length),r.push(s);continue}if(s=this.tokenizer.lheading(t)){t=t.substring(s.raw.length),r.push(s);continue}let d=t;if(this.options.extensions?.startBlock){let a=1/0,o=t.slice(1),x;this.options.extensions.startBlock.forEach(m=>{x=m.call({lexer:this},o),typeof x=="number"&&x>=0&&(a=Math.min(a,x))}),a<1/0&&a>=0&&(d=t.substring(0,a+1))}if(this.state.top&&(s=this.tokenizer.paragraph(d))){let a=r.at(-1);n&&a?.type==="paragraph"?(a.raw+=`
`+s.raw,a.text+=`
`+s.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=a.text):r.push(s),n=d.length!==t.length,t=t.substring(s.raw.length);continue}if(s=this.tokenizer.text(t)){t=t.substring(s.raw.length);let a=r.at(-1);a?.type==="text"?(a.raw+=`
`+s.raw,a.text+=`
`+s.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=a.text):r.push(s);continue}if(t){let a="Infinite loop on byte: "+t.charCodeAt(0);if(this.options.silent){console.error(a);break}else throw new Error(a)}}return this.state.top=!0,r}inline(t,r=[]){return this.inlineQueue.push({src:t,tokens:r}),r}inlineTokens(t,r=[]){let n=t,s=null;if(this.tokens.links){let o=Object.keys(this.tokens.links);if(o.length>0)for(;(s=this.tokenizer.rules.inline.reflinkSearch.exec(n))!=null;)o.includes(s[0].slice(s[0].lastIndexOf("[")+1,-1))&&(n=n.slice(0,s.index)+"["+"a".repeat(s[0].length-2)+"]"+n.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;(s=this.tokenizer.rules.inline.anyPunctuation.exec(n))!=null;)n=n.slice(0,s.index)+"++"+n.slice(this.tokenizer.rules.inline.anyPunctuation.lastIndex);for(;(s=this.tokenizer.rules.inline.blockSkip.exec(n))!=null;)n=n.slice(0,s.index)+"["+"a".repeat(s[0].length-2)+"]"+n.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);let d=!1,a="";for(;t;){d||(a=""),d=!1;let o;if(this.options.extensions?.inline?.some(m=>(o=m.call({lexer:this},t,r))?(t=t.substring(o.raw.length),r.push(o),!0):!1))continue;if(o=this.tokenizer.escape(t)){t=t.substring(o.raw.length),r.push(o);continue}if(o=this.tokenizer.tag(t)){t=t.substring(o.raw.length),r.push(o);continue}if(o=this.tokenizer.link(t)){t=t.substring(o.raw.length),r.push(o);continue}if(o=this.tokenizer.reflink(t,this.tokens.links)){t=t.substring(o.raw.length);let m=r.at(-1);o.type==="text"&&m?.type==="text"?(m.raw+=o.raw,m.text+=o.text):r.push(o);continue}if(o=this.tokenizer.emStrong(t,n,a)){t=t.substring(o.raw.length),r.push(o);continue}if(o=this.tokenizer.codespan(t)){t=t.substring(o.raw.length),r.push(o);continue}if(o=this.tokenizer.br(t)){t=t.substring(o.raw.length),r.push(o);continue}if(o=this.tokenizer.del(t)){t=t.substring(o.raw.length),r.push(o);continue}if(o=this.tokenizer.autolink(t)){t=t.substring(o.raw.length),r.push(o);continue}if(!this.state.inLink&&(o=this.tokenizer.url(t))){t=t.substring(o.raw.length),r.push(o);continue}let x=t;if(this.options.extensions?.startInline){let m=1/0,v=t.slice(1),f;this.options.extensions.startInline.forEach(b=>{f=b.call({lexer:this},v),typeof f=="number"&&f>=0&&(m=Math.min(m,f))}),m<1/0&&m>=0&&(x=t.substring(0,m+1))}if(o=this.tokenizer.inlineText(x)){t=t.substring(o.raw.length),o.raw.slice(-1)!=="_"&&(a=o.raw.slice(-1)),d=!0;let m=r.at(-1);m?.type==="text"?(m.raw+=o.raw,m.text+=o.text):r.push(o);continue}if(t){let m="Infinite loop on byte: "+t.charCodeAt(0);if(this.options.silent){console.error(m);break}else throw new Error(m)}}return r}},Bt=class{options;parser;constructor(l){this.options=l||ut}space(l){return""}code({text:l,lang:t,escaped:r}){let n=(t||"").match(Le.notSpaceStart)?.[0],s=l.replace(Le.endingNewline,"")+`
`;return n?'<pre><code class="language-'+Be(n)+'">'+(r?s:Be(s,!0))+`</code></pre>
`:"<pre><code>"+(r?s:Be(s,!0))+`</code></pre>
`}blockquote({tokens:l}){return`<blockquote>
${this.parser.parse(l)}</blockquote>
`}html({text:l}){return l}heading({tokens:l,depth:t}){return`<h${t}>${this.parser.parseInline(l)}</h${t}>
`}hr(l){return`<hr>
`}list(l){let t=l.ordered,r=l.start,n="";for(let a=0;a<l.items.length;a++){let o=l.items[a];n+=this.listitem(o)}let s=t?"ol":"ul",d=t&&r!==1?' start="'+r+'"':"";return"<"+s+d+`>
`+n+"</"+s+`>
`}listitem(l){let t="";if(l.task){let r=this.checkbox({checked:!!l.checked});l.loose?l.tokens[0]?.type==="paragraph"?(l.tokens[0].text=r+" "+l.tokens[0].text,l.tokens[0].tokens&&l.tokens[0].tokens.length>0&&l.tokens[0].tokens[0].type==="text"&&(l.tokens[0].tokens[0].text=r+" "+Be(l.tokens[0].tokens[0].text),l.tokens[0].tokens[0].escaped=!0)):l.tokens.unshift({type:"text",raw:r+" ",text:r+" ",escaped:!0}):t+=r+" "}return t+=this.parser.parse(l.tokens,!!l.loose),`<li>${t}</li>
`}checkbox({checked:l}){return"<input "+(l?'checked="" ':"")+'disabled="" type="checkbox">'}paragraph({tokens:l}){return`<p>${this.parser.parseInline(l)}</p>
`}table(l){let t="",r="";for(let s=0;s<l.header.length;s++)r+=this.tablecell(l.header[s]);t+=this.tablerow({text:r});let n="";for(let s=0;s<l.rows.length;s++){let d=l.rows[s];r="";for(let a=0;a<d.length;a++)r+=this.tablecell(d[a]);n+=this.tablerow({text:r})}return n&&(n=`<tbody>${n}</tbody>`),`<table>
<thead>
`+t+`</thead>
`+n+`</table>
`}tablerow({text:l}){return`<tr>
${l}</tr>
`}tablecell(l){let t=this.parser.parseInline(l.tokens),r=l.header?"th":"td";return(l.align?`<${r} align="${l.align}">`:`<${r}>`)+t+`</${r}>
`}strong({tokens:l}){return`<strong>${this.parser.parseInline(l)}</strong>`}em({tokens:l}){return`<em>${this.parser.parseInline(l)}</em>`}codespan({text:l}){return`<code>${Be(l,!0)}</code>`}br(l){return"<br>"}del({tokens:l}){return`<del>${this.parser.parseInline(l)}</del>`}link({href:l,title:t,tokens:r}){let n=this.parser.parseInline(r),s=br(l);if(s===null)return n;l=s;let d='<a href="'+l+'"';return t&&(d+=' title="'+Be(t)+'"'),d+=">"+n+"</a>",d}image({href:l,title:t,text:r,tokens:n}){n&&(r=this.parser.parseInline(n,this.parser.textRenderer));let s=br(l);if(s===null)return Be(r);l=s;let d=`<img src="${l}" alt="${r}"`;return t&&(d+=` title="${Be(t)}"`),d+=">",d}text(l){return"tokens"in l&&l.tokens?this.parser.parseInline(l.tokens):"escaped"in l&&l.escaped?l.text:Be(l.text)}},$s=class{strong({text:l}){return l}em({text:l}){return l}codespan({text:l}){return l}del({text:l}){return l}html({text:l}){return l}text({text:l}){return l}link({text:l}){return""+l}image({text:l}){return""+l}br(){return""}},Ge=class xs{options;renderer;textRenderer;constructor(t){this.options=t||ut,this.options.renderer=this.options.renderer||new Bt,this.renderer=this.options.renderer,this.renderer.options=this.options,this.renderer.parser=this,this.textRenderer=new $s}static parse(t,r){return new xs(r).parse(t)}static parseInline(t,r){return new xs(r).parseInline(t)}parse(t,r=!0){let n="";for(let s=0;s<t.length;s++){let d=t[s];if(this.options.extensions?.renderers?.[d.type]){let o=d,x=this.options.extensions.renderers[o.type].call({parser:this},o);if(x!==!1||!["space","hr","heading","code","table","blockquote","list","html","paragraph","text"].includes(o.type)){n+=x||"";continue}}let a=d;switch(a.type){case"space":{n+=this.renderer.space(a);continue}case"hr":{n+=this.renderer.hr(a);continue}case"heading":{n+=this.renderer.heading(a);continue}case"code":{n+=this.renderer.code(a);continue}case"table":{n+=this.renderer.table(a);continue}case"blockquote":{n+=this.renderer.blockquote(a);continue}case"list":{n+=this.renderer.list(a);continue}case"html":{n+=this.renderer.html(a);continue}case"paragraph":{n+=this.renderer.paragraph(a);continue}case"text":{let o=a,x=this.renderer.text(o);for(;s+1<t.length&&t[s+1].type==="text";)o=t[++s],x+=`
`+this.renderer.text(o);r?n+=this.renderer.paragraph({type:"paragraph",raw:x,text:x,tokens:[{type:"text",raw:x,text:x,escaped:!0}]}):n+=x;continue}default:{let o='Token with "'+a.type+'" type was not found.';if(this.options.silent)return console.error(o),"";throw new Error(o)}}}return n}parseInline(t,r=this.renderer){let n="";for(let s=0;s<t.length;s++){let d=t[s];if(this.options.extensions?.renderers?.[d.type]){let o=this.options.extensions.renderers[d.type].call({parser:this},d);if(o!==!1||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(d.type)){n+=o||"";continue}}let a=d;switch(a.type){case"escape":{n+=r.text(a);break}case"html":{n+=r.html(a);break}case"link":{n+=r.link(a);break}case"image":{n+=r.image(a);break}case"strong":{n+=r.strong(a);break}case"em":{n+=r.em(a);break}case"codespan":{n+=r.codespan(a);break}case"br":{n+=r.br(a);break}case"del":{n+=r.del(a);break}case"text":{n+=r.text(a);break}default:{let o='Token with "'+a.type+'" type was not found.';if(this.options.silent)return console.error(o),"";throw new Error(o)}}}return n}},Lt=class{options;block;constructor(l){this.options=l||ut}static passThroughHooks=new Set(["preprocess","postprocess","processAllTokens"]);preprocess(l){return l}postprocess(l){return l}processAllTokens(l){return l}provideLexer(){return this.block?Ve.lex:Ve.lexInline}provideParser(){return this.block?Ge.parse:Ge.parseInline}},bi=class{defaults=Ps();options=this.setOptions;parse=this.parseMarkdown(!0);parseInline=this.parseMarkdown(!1);Parser=Ge;Renderer=Bt;TextRenderer=$s;Lexer=Ve;Tokenizer=Ut;Hooks=Lt;constructor(...l){this.use(...l)}walkTokens(l,t){let r=[];for(let n of l)switch(r=r.concat(t.call(this,n)),n.type){case"table":{let s=n;for(let d of s.header)r=r.concat(this.walkTokens(d.tokens,t));for(let d of s.rows)for(let a of d)r=r.concat(this.walkTokens(a.tokens,t));break}case"list":{let s=n;r=r.concat(this.walkTokens(s.items,t));break}default:{let s=n;this.defaults.extensions?.childTokens?.[s.type]?this.defaults.extensions.childTokens[s.type].forEach(d=>{let a=s[d].flat(1/0);r=r.concat(this.walkTokens(a,t))}):s.tokens&&(r=r.concat(this.walkTokens(s.tokens,t)))}}return r}use(...l){let t=this.defaults.extensions||{renderers:{},childTokens:{}};return l.forEach(r=>{let n={...r};if(n.async=this.defaults.async||n.async||!1,r.extensions&&(r.extensions.forEach(s=>{if(!s.name)throw new Error("extension name required");if("renderer"in s){let d=t.renderers[s.name];d?t.renderers[s.name]=function(...a){let o=s.renderer.apply(this,a);return o===!1&&(o=d.apply(this,a)),o}:t.renderers[s.name]=s.renderer}if("tokenizer"in s){if(!s.level||s.level!=="block"&&s.level!=="inline")throw new Error("extension level must be 'block' or 'inline'");let d=t[s.level];d?d.unshift(s.tokenizer):t[s.level]=[s.tokenizer],s.start&&(s.level==="block"?t.startBlock?t.startBlock.push(s.start):t.startBlock=[s.start]:s.level==="inline"&&(t.startInline?t.startInline.push(s.start):t.startInline=[s.start]))}"childTokens"in s&&s.childTokens&&(t.childTokens[s.name]=s.childTokens)}),n.extensions=t),r.renderer){let s=this.defaults.renderer||new Bt(this.defaults);for(let d in r.renderer){if(!(d in s))throw new Error(`renderer '${d}' does not exist`);if(["options","parser"].includes(d))continue;let a=d,o=r.renderer[a],x=s[a];s[a]=(...m)=>{let v=o.apply(s,m);return v===!1&&(v=x.apply(s,m)),v||""}}n.renderer=s}if(r.tokenizer){let s=this.defaults.tokenizer||new Ut(this.defaults);for(let d in r.tokenizer){if(!(d in s))throw new Error(`tokenizer '${d}' does not exist`);if(["options","rules","lexer"].includes(d))continue;let a=d,o=r.tokenizer[a],x=s[a];s[a]=(...m)=>{let v=o.apply(s,m);return v===!1&&(v=x.apply(s,m)),v}}n.tokenizer=s}if(r.hooks){let s=this.defaults.hooks||new Lt;for(let d in r.hooks){if(!(d in s))throw new Error(`hook '${d}' does not exist`);if(["options","block"].includes(d))continue;let a=d,o=r.hooks[a],x=s[a];Lt.passThroughHooks.has(d)?s[a]=m=>{if(this.defaults.async)return Promise.resolve(o.call(s,m)).then(f=>x.call(s,f));let v=o.call(s,m);return x.call(s,v)}:s[a]=(...m)=>{let v=o.apply(s,m);return v===!1&&(v=x.apply(s,m)),v}}n.hooks=s}if(r.walkTokens){let s=this.defaults.walkTokens,d=r.walkTokens;n.walkTokens=function(a){let o=[];return o.push(d.call(this,a)),s&&(o=o.concat(s.call(this,a))),o}}this.defaults={...this.defaults,...n}}),this}setOptions(l){return this.defaults={...this.defaults,...l},this}lexer(l,t){return Ve.lex(l,t??this.defaults)}parser(l,t){return Ge.parse(l,t??this.defaults)}parseMarkdown(l){return(t,r)=>{let n={...r},s={...this.defaults,...n},d=this.onError(!!s.silent,!!s.async);if(this.defaults.async===!0&&n.async===!1)return d(new Error("marked(): The async option was set to true by an extension. Remove async: false from the parse options object to return a Promise."));if(typeof t>"u"||t===null)return d(new Error("marked(): input parameter is undefined or null"));if(typeof t!="string")return d(new Error("marked(): input parameter is of type "+Object.prototype.toString.call(t)+", string expected"));s.hooks&&(s.hooks.options=s,s.hooks.block=l);let a=s.hooks?s.hooks.provideLexer():l?Ve.lex:Ve.lexInline,o=s.hooks?s.hooks.provideParser():l?Ge.parse:Ge.parseInline;if(s.async)return Promise.resolve(s.hooks?s.hooks.preprocess(t):t).then(x=>a(x,s)).then(x=>s.hooks?s.hooks.processAllTokens(x):x).then(x=>s.walkTokens?Promise.all(this.walkTokens(x,s.walkTokens)).then(()=>x):x).then(x=>o(x,s)).then(x=>s.hooks?s.hooks.postprocess(x):x).catch(d);try{s.hooks&&(t=s.hooks.preprocess(t));let x=a(t,s);s.hooks&&(x=s.hooks.processAllTokens(x)),s.walkTokens&&this.walkTokens(x,s.walkTokens);let m=o(x,s);return s.hooks&&(m=s.hooks.postprocess(m)),m}catch(x){return d(x)}}}onError(l,t){return r=>{if(r.message+=`
Please report this to https://github.com/markedjs/marked.`,l){let n="<p>An error occurred:</p><pre>"+Be(r.message+"",!0)+"</pre>";return t?Promise.resolve(n):n}if(t)return Promise.reject(r);throw r}}},dt=new bi;function ge(l,t){return dt.parse(l,t)}ge.options=ge.setOptions=function(l){return dt.setOptions(l),ge.defaults=dt.defaults,Tr(ge.defaults),ge};ge.getDefaults=Ps;ge.defaults=ut;ge.use=function(...l){return dt.use(...l),ge.defaults=dt.defaults,Tr(ge.defaults),ge};ge.walkTokens=function(l,t){return dt.walkTokens(l,t)};ge.parseInline=dt.parseInline;ge.Parser=Ge;ge.parser=Ge.parse;ge.Renderer=Bt;ge.TextRenderer=$s;ge.Lexer=Ve;ge.lexer=Ve.lex;ge.Tokenizer=Ut;ge.Hooks=Lt;ge.parse=ge;ge.options;ge.setOptions;ge.use;ge.walkTokens;ge.parseInline;Ge.parse;Ve.lex;function yi(){const[l,t]=u.useState(null),[r,n]=u.useState(null),[s,d]=u.useState(!0),[a,o]=u.useState(!1),[x,m]=u.useState(!1),[v,f]=u.useState(!1),[b,C]=u.useState(null),[g,w]=u.useState(""),[y,R]=u.useState(""),[S,p]=u.useState(""),[k,H]=u.useState(""),[I,U]=u.useState(""),[j,A]=u.useState(""),[N,W]=u.useState("");u.useEffect(()=>{G()},[]);const G=async()=>{try{d(!0);const{data:O}=await T.auth.getUser(),D=O.user;if(D){t(D),p(D.email||"");const{data:M}=await T.from("users").select("*").eq("id",D.id).single();M&&(n(M),w(M.first_name||""),R(M.last_name||""),H(M.role||"UI Developer"),U(M.department||""),A(M.avatar_url||""),W(M.phone_number||"")),!M?.phone_number&&D.user_metadata?.phone_number&&W(D.user_metadata.phone_number),D.user_metadata&&(!M?.first_name&&D.user_metadata.first_name&&w(D.user_metadata.first_name),!M?.last_name&&D.user_metadata.last_name&&R(D.user_metadata.last_name))}}catch(O){console.error("Error loading user data:",O),C({type:"danger",text:"Failed to load user data"})}finally{d(!1)}},h=async()=>{if(!l)return;if(N&&!/^\+[1-9]\d{7,}$/.test(N)){C({type:"danger",text:"Phone number must include country code and be valid (e.g., +4512345678, +1234567890)"});return}if(!g.trim()){C({type:"danger",text:"First name is required"});return}try{m(!0);const{error:D}=await T.from("users").update({role:k.trim()||null,department:I.trim()||null,avatar_url:j.trim()||null,phone_number:N.trim()||null,first_name:g.trim(),last_name:y.trim()||null}).eq("id",l.id);if(D)throw D;const{error:M}=await T.auth.updateUser({data:{first_name:g.trim(),last_name:y.trim()||null,full_name:`${g.trim()} ${y.trim()}`.trim(),phone_number:N.trim()||null}});M&&console.warn("Failed to update auth.users metadata:",M),await G(),o(!1),C({type:"success",text:"Profile updated successfully"}),setTimeout(()=>C(null),3e3)}catch(D){console.error("Error saving profile:",D);let M="Failed to save profile";D instanceof Error&&(D.message.includes("phone_number_format_check")?M="Phone number format is invalid. Please use international format with country code (e.g., +4512345678)":M=`Failed to save profile: ${D.message}`),C({type:"danger",text:M})}finally{m(!1)}},E=async O=>{const D=O.target.files?.[0];if(!(!D||!l)){if(!D.type.startsWith("image/")){C({type:"danger",text:"Please select a valid image file"});return}if(D.size>5*1024*1024){C({type:"danger",text:"Image size must be less than 5MB"});return}try{f(!0),C(null);const M=D.name.split(".").pop(),ue=`${l.id}-${Date.now()}.${M}`,{data:le,error:J}=await T.storage.from("avatars").upload(ue,D,{cacheControl:"3600",upsert:!0});if(J)throw new Error(`Upload failed: ${J.message}`);const{data:{publicUrl:oe}}=T.storage.from("avatars").getPublicUrl(ue);A(oe);const{error:Q}=await T.from("users").update({avatar_url:oe}).eq("id",l.id);if(Q)throw new Error(`Database update failed: ${Q.message}`);await G(),C({type:"success",text:"Avatar uploaded successfully"}),setTimeout(()=>C(null),3e3)}catch(M){let se="Failed to upload avatar";M instanceof Error&&(M.message.includes("not found")?se="Storage bucket not configured. Please contact admin.":M.message.includes("permission")?se="Permission denied. Please contact admin.":se=`Upload failed: ${M.message}`),C({type:"danger",text:se})}finally{f(!1),O.target.value=""}}},B=()=>{w(r?.first_name||""),R(r?.last_name||""),H(r?.role||"UI Developer"),U(r?.department||""),A(r?.avatar_url||""),W(r?.phone_number||""),o(!1),C(null)};return s?e.jsx(me,{children:e.jsx(Re,{children:e.jsx(c,{level:"body-sm",color:"neutral",children:"Loading profile..."})})}):e.jsx(me,{children:e.jsxs(Re,{children:[e.jsx(c,{level:"h4",sx:{mb:1},children:"Personal info"}),e.jsx(c,{level:"body-sm",color:"neutral",sx:{mb:3},children:"Your profile information."}),b&&e.jsx(it,{color:b.type,sx:{mb:2},children:b.text}),e.jsxs(i,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},gap:3,alignItems:{xs:"center",sm:"stretch"},width:"100%",maxWidth:"100%",overflow:"hidden"},children:[e.jsx(i,{sx:{flex:{xs:"none",sm:"1"},maxWidth:{xs:"100%",sm:"300px"},display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",position:"relative",minHeight:{xs:"auto",sm:"400px"},width:{xs:"100%",sm:"auto"}},children:e.jsxs(i,{sx:{position:"relative",display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsxs(he,{size:"lg",src:j||r?.avatar_url||l?.user_metadata?.avatar_url,sx:{width:160,height:160},children:[g?.[0],y?.[0]]},`avatar-${j}-${r?.avatar_url}`),a&&e.jsxs(i,{sx:{mt:2,display:"flex",flexDirection:"column",alignItems:"center",gap:1},children:[e.jsxs(xe,{component:"label",size:"sm",variant:"solid",color:"primary",loading:v,sx:{borderRadius:"8px",px:2,py:1},children:[e.jsx(ot,{fontSize:"small",sx:{mr:1}}),"Upload Avatar",e.jsx("input",{type:"file",accept:"image/*",onChange:E,style:{display:"none"}})]}),e.jsx(c,{level:"body-xs",color:"neutral",sx:{textAlign:"center",maxWidth:180,lineHeight:1.4},children:"Max 5MB (JPG, PNG, GIF)"})]})]})}),e.jsxs(i,{sx:{flex:{xs:"none",sm:"2"},maxWidth:{xs:"100%",sm:"calc(100% - 300px - 24px)"},width:{xs:"100%",sm:"auto"},minWidth:0},children:[e.jsxs(X,{spacing:2,children:[e.jsxs(i,{children:[e.jsx(ee,{sx:{mb:1},children:"Name"}),e.jsxs(i,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},gap:2},children:[e.jsx($,{placeholder:"First name",value:g,onChange:O=>w(O.target.value),disabled:!a,sx:{flex:1}}),e.jsx($,{placeholder:"Last name",value:y,onChange:O=>R(O.target.value),disabled:!a,sx:{flex:1}})]})]}),e.jsxs(te,{children:[e.jsx(ee,{children:"Phone Number"}),e.jsx($,{value:N,onChange:O=>W(O.target.value),disabled:!a,placeholder:"e.g., +4512345678, +1234567890",startDecorator:"ðŸ“ž"}),a&&e.jsx(c,{level:"body-xs",color:"neutral",sx:{mt:.5},children:"Include country code (e.g., +45 for Denmark, +1 for US/Canada)"})]}),e.jsxs(i,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},gap:2},children:[e.jsxs(te,{sx:{flex:1},children:[e.jsx(ee,{children:"Role"}),e.jsx($,{value:k,onChange:O=>H(O.target.value),disabled:!a})]}),e.jsxs(te,{sx:{flex:1},children:[e.jsx(ee,{children:"Department"}),e.jsx($,{value:I,onChange:O=>U(O.target.value),disabled:!a,placeholder:"e.g., Engineering, Sales, Marketing"})]})]}),e.jsxs(te,{children:[e.jsx(ee,{children:"Email"}),e.jsx($,{value:S,disabled:!0,startDecorator:"âœ‰ï¸"})]}),e.jsxs(te,{children:[e.jsx(ee,{children:"Avatar URL"}),e.jsx($,{value:j,onChange:O=>A(O.target.value),disabled:!a,placeholder:"https://example.com/avatar.jpg",startDecorator:"ðŸ–¼ï¸"})]}),r&&e.jsxs(i,{sx:{mt:2,p:2,bgcolor:"background.level1",borderRadius:"sm"},children:[e.jsx(c,{level:"body-sm",color:"neutral",sx:{mb:1},children:"Account Information"}),e.jsxs(X,{spacing:1,children:[r.created_at&&e.jsxs(c,{level:"body-sm",children:[e.jsx("strong",{children:"Member since:"})," ",new Date(r.created_at).toLocaleDateString()]}),r.last_login&&e.jsxs(c,{level:"body-sm",children:[e.jsx("strong",{children:"Last login:"})," ",new Date(r.last_login).toLocaleDateString()]}),(r.phone_number||N)&&e.jsxs(c,{level:"body-sm",children:[e.jsx("strong",{children:"Phone (stored):"})," ",r.phone_number||N]}),e.jsxs(c,{level:"body-sm",children:[e.jsx("strong",{children:"User ID:"})," ",r.id]})]})]})]}),e.jsx(i,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},gap:1,mt:3,justifyContent:{xs:"stretch",sm:"flex-end"}},children:a?e.jsxs(e.Fragment,{children:[e.jsx(q,{variant:"outlined",onClick:B,disabled:x,startDecorator:e.jsx(Ss,{}),sx:{order:{xs:2,sm:1}},children:"Cancel"}),e.jsx(q,{variant:"solid",onClick:h,loading:x,startDecorator:e.jsx(Tl,{}),sx:{order:{xs:1,sm:2}},children:"Save"})]}):e.jsx(q,{variant:"outlined",onClick:()=>o(!0),startDecorator:e.jsx(ot,{}),children:"Edit Profile"})})]})]})]})})}function vi(){const[l,t]=ie.useState(""),[r,n]=ie.useState(!0),[s,d]=ie.useState(!1),a=`## Latest Release
**Version 2.1.2** - July 6, 2025

### Recent Updates
- Modern Login Page Redesign with Split Layout
- Glassmorphism effect with backdrop blur and semi-transparent backgrounds
- Dynamic mountain landscape background images that change with light/dark mode
- Dark/light mode toggle in login page header
- Company branding with SmartBack logo and name in header

### System Status
- All systems operational
- Database migrations up to date
- Authentication services active

*For complete release history, please check the development environment or contact support.*`;return ie.useEffect(()=>{const o="/RELEASE_LOG.md";console.log("Fetching release log from:",o),fetch(o).then(x=>{if(console.log("Release log response status:",x.status,x.statusText),!x.ok)throw new Error(`Failed to fetch release log: ${x.status} ${x.statusText}`);return x.text()}).then(x=>{console.log("Release log loaded successfully, length:",x.length);const m=x.replace(/<!--[\s\S]*?-->/g,"").trim();t(m),d(!1)}).catch(x=>{console.error("Error fetching release log:",x),console.log("Using fallback content"),t(a),d(!1)}).finally(()=>n(!1))},[a]),e.jsx(me,{sx:{height:"100%",minHeight:{xs:200,md:300}},children:e.jsxs(Re,{sx:{display:"flex",flexDirection:"column",height:"100%"},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(Lr,{color:"primary"}),e.jsx(c,{level:"h4",children:"Release Log"})]}),e.jsxs(i,{sx:{flex:1,overflow:"auto"},children:[r&&e.jsx(c,{level:"body-sm",color:"neutral",children:"Loading release log..."}),!r&&e.jsx(i,{sx:{typography:"body-sm"},children:e.jsx("div",{dangerouslySetInnerHTML:{__html:ge(l)}})})]})]})})}function wi(){return Ie(),e.jsx(me,{sx:{height:"100%",minHeight:{xs:120,md:300}},children:e.jsxs(Re,{sx:{display:"flex",flexDirection:"column",height:"100%"},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(Ml,{color:"primary"}),e.jsx(c,{level:"h4",children:"Application Info"})]}),e.jsxs(X,{spacing:1.5,sx:{flex:1},children:[e.jsxs(c,{level:"title-md",sx:{fontWeight:"bold"},children:["smartback".charAt(0).toUpperCase()+"smartback".slice(1)," business System"]}),e.jsxs(X,{spacing:.5,children:[e.jsxs(c,{level:"body-sm",color:"neutral",children:[e.jsx("strong",{children:"Environment:"})," ","production"]}),e.jsxs(c,{level:"body-sm",color:"neutral",children:[e.jsx("strong",{children:"Version:"})," ","3.2.15"]}),e.jsxs(c,{level:"body-sm",color:"neutral",children:[e.jsx("strong",{children:"Build Date:"})," ",new Date().toLocaleDateString()]}),e.jsxs(c,{level:"body-sm",color:"neutral",children:[e.jsx("strong",{children:"Platform:"})," Web Application"]}),e.jsxs(c,{level:"body-sm",color:"neutral",children:[e.jsx("strong",{children:"Language:"})," English (US)"]}),e.jsxs(c,{level:"body-sm",color:"neutral",children:[e.jsx("strong",{children:"Currency:"})," ",Qe.currency," (",Qe.symbol,") - ",Qe.locale]}),e.jsxs(c,{level:"body-sm",color:"neutral",children:[e.jsx("strong",{children:"Currency Precision:"})," Smart formatting (0-2 decimal places)"]})]})]}),e.jsxs(i,{sx:{mt:3,p:2,backgroundColor:"neutral.50",borderRadius:"md"},children:[e.jsx(c,{level:"title-sm",sx:{mb:1},children:"Currency Formatting Examples"}),e.jsxs(X,{spacing:.5,children:[e.jsxs(c,{level:"body-xs",color:"neutral",children:[e.jsx("strong",{children:"Whole numbers:"})," ",Me(100)," â€¢ ",Me(1500)," â€¢ ",Me(25e3)]}),e.jsxs(c,{level:"body-xs",color:"neutral",children:[e.jsx("strong",{children:"With decimals:"})," ",Me(99.5)," â€¢ ",Me(1234.56)," â€¢ ",Me(15.25)]})]})]}),e.jsx(q,{component:"a",href:"https://nicklasfangerfisk.github.io/Testflow/",target:"_blank",rel:"noopener noreferrer",startDecorator:e.jsx(Wl,{}),variant:"outlined",color:"primary",sx:{mt:2,alignSelf:"flex-start"},children:"System Test"})]})})}const Si=()=>{const{isMobile:l}=Ie(),[t,r]=u.useState(0),n=async()=>{try{const{error:o}=await T.auth.signOut();o?console.error("Error signing out:",o):window.location.href="/login"}catch(o){console.error("Error during logout:",o)}},s=[{label:"User",icon:e.jsx(at,{}),content:e.jsx(yi,{})},{label:"App",icon:e.jsx($l,{}),content:e.jsx(wi,{})},{label:"Releases",icon:e.jsx(Lr,{}),content:e.jsx(vi,{})}],d=()=>e.jsx(i,{sx:{width:"100%",minHeight:"100vh"},children:e.jsxs(ke,{padding:"medium",children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(c,{level:"h2",sx:{fontSize:re.sizes.xlarge},children:"My profile"}),e.jsx(q,{variant:"outlined",color:"danger",size:"sm",startDecorator:e.jsx(Js,{}),onClick:n,children:"Logout"})]}),e.jsxs(Fs,{value:t,onChange:(o,x)=>r(typeof x=="number"?x:0),sx:{bgcolor:"transparent"},children:[e.jsx(Us,{sx:{bgcolor:"transparent"},children:s.map((o,x)=>e.jsx(Bs,{value:x,sx:{bgcolor:"transparent"},children:o.label},x))}),s.map((o,x)=>e.jsx(Hs,{value:x,sx:{p:0,pt:3,bgcolor:"transparent"},children:o.content},x))]})]})}),a=()=>e.jsxs(ke,{variant:"table-page",children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(c,{level:"h2",sx:{fontSize:re.sizes.xlarge},children:"My profile"}),e.jsx(q,{variant:"outlined",color:"danger",startDecorator:e.jsx(Js,{}),onClick:n,children:"Logout"})]}),e.jsxs(Fs,{value:t,onChange:(o,x)=>r(typeof x=="number"?x:0),sx:{bgcolor:"transparent"},children:[e.jsx(Us,{sx:{bgcolor:"transparent"},children:s.map((o,x)=>e.jsx(Bs,{value:x,sx:{bgcolor:"transparent"},children:o.label},x))}),s.map((o,x)=>e.jsx(Hs,{value:x,sx:{p:0,pt:3,bgcolor:"transparent"},children:o.content},x))]})]});return e.jsx(qe,{children:l?e.jsx(d,{}):e.jsx(a,{})})};function Ci(){const l=ks(),{isMobile:t}=Ie(),r=Cs(),[n,s]=u.useState("dashboard"),d=[{label:"Dashboard",icon:e.jsx(fs,{}),value:"dashboard"},{label:"Orders",icon:e.jsx(js,{}),value:"orders"},{label:"Customers",icon:e.jsx(bs,{}),value:"customers"},{label:"My Profile",icon:e.jsx(at,{}),value:"profile"},{label:"Settings",icon:e.jsx(ql,{}),value:"settings"}];return u.useEffect(()=>{s({"/":"dashboard","/dashboard":"dashboard","/orders":"orders","/products":"dashboard","/users":"users","/suppliers":"dashboard","/purchase-orders":"dashboard","/tickets":"dashboard","/sms-campaigns":"dashboard","/movements":"dashboard","/settings":"profile"}[l.pathname]||"dashboard")},[l.pathname]),console.log("isMobile:",t),e.jsxs(i,{sx:{display:"flex",height:"100vh",overflow:"hidden"},children:[l.pathname!=="/login"&&!t&&e.jsx(Jl,{setView:a=>console.log(a),view:"home"}),e.jsxs(i,{component:"main",sx:{flexGrow:1,display:"flex",flexDirection:"column",height:"100%",bgcolor:"background.default",p:0,width:t?"100%":"calc(100% - var(--Sidebar-width, 240px))",marginBottom:t?"56px":0,overflow:"auto"},children:[t&&l.pathname!=="/login"&&e.jsx(_n,{items:d,value:n,onChange:a=>{s(a);const x={home:"/",dashboard:"/dashboard",orders:"/orders",products:"/products",users:"/users",customers:"/customers",employees:"/employees",suppliers:"/suppliers",purchaseorders:"/purchase-orders",tickets:"/tickets",smscampaigns:"/sms-campaigns",movements:"/movements",profile:"/settings",settings:"/settings"}[a]||`/${a}`;r(x)},toggleSidebar:()=>console.log("Sidebar toggled")}),e.jsxs(_s,{children:[e.jsx(_e,{path:"/",element:e.jsx(Wt,{to:"/dashboard",replace:!0})}),e.jsx(_e,{path:"/orders",element:e.jsx(We,{children:e.jsx(nn,{})})}),e.jsx(_e,{path:"/products",element:e.jsx(We,{children:e.jsx(on,{})})}),e.jsx(_e,{path:"/users",element:e.jsx(We,{children:e.jsx(dn,{})})}),e.jsx(_e,{path:"/customers",element:e.jsx(We,{children:e.jsx(xn,{})})}),e.jsx(_e,{path:"/employees",element:e.jsx(We,{children:e.jsx(gn,{})})}),e.jsx(_e,{path:"/suppliers",element:e.jsx(We,{children:e.jsx(jn,{})})}),e.jsx(_e,{path:"/storefronts",element:e.jsx(We,{children:e.jsx(yn,{})})}),e.jsx(_e,{path:"/purchase-orders",element:e.jsx(We,{children:e.jsx(kn,{})})}),e.jsx(_e,{path:"/tickets",element:e.jsx(We,{children:e.jsx(Pn,{})})}),e.jsx(_e,{path:"/sms-campaigns",element:e.jsx(We,{children:e.jsx(An,{})})}),e.jsx(_e,{path:"/dashboard",element:e.jsx(We,{children:e.jsx(En,{})})}),e.jsx(_e,{path:"/movements",element:e.jsx(We,{children:e.jsx($n,{})})}),e.jsx(_e,{path:"/settings",element:e.jsx(We,{children:e.jsx(Si,{})})}),e.jsx(_e,{path:"*",element:e.jsx(Wt,{to:"/",replace:!0})})]})]})]})}function ki(){return e.jsx(_r,{children:e.jsx(Ul,{children:e.jsxs(_s,{children:[e.jsx(_e,{path:"/login/*",element:e.jsx(Nn,{})}),e.jsx(_e,{path:"/*",element:e.jsx(Ci,{})})]})})})}console.log("Mounting React app...");const wr=document.getElementById("root");wr?(Hl.createRoot(wr).render(e.jsx(ki,{})),console.log("React app rendered!")):console.error("No #root element found in index.html!");
